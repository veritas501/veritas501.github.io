<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="影响范围 引入commit：fdb9c405e35bdc6e305b9b4e20ebc141ed14fc81 修复commit：7e6bc1f6cabcd30aba0b11219d8e01b952eacbb6 时间跨度：2020&#x2F;04&#x2F;28 ~ 2022&#x2F;07&#x2F;03 版本跨度：v5.8 ~ v5.19  简介在netfilter模块的nft_setelem_">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2022-34918 netfilter 分析笔记">
<meta property="og:url" content="https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="veritas501&#39;s blog">
<meta property="og:description" content="影响范围 引入commit：fdb9c405e35bdc6e305b9b4e20ebc141ed14fc81 修复commit：7e6bc1f6cabcd30aba0b11219d8e01b952eacbb6 时间跨度：2020&#x2F;04&#x2F;28 ~ 2022&#x2F;07&#x2F;03 版本跨度：v5.8 ~ v5.19  简介在netfilter模块的nft_setelem_">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802165516046.png">
<meta property="og:image" content="https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802165924035.png">
<meta property="og:image" content="https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802170139279.png">
<meta property="og:image" content="https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802170923279.png">
<meta property="og:image" content="https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802174129707.png">
<meta property="article:published_time" content="2022-08-01T16:00:00.000Z">
<meta property="article:modified_time" content="2023-12-08T03:09:28.454Z">
<meta property="article:author" content="veritas501">
<meta property="article:tag" content="kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802165516046.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2022-34918 netfilter 分析笔记</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/veritas501">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022_08_11_%E5%9F%BA%E4%BA%8EUSMA%E7%9A%84%E5%86%85%E6%A0%B8%E9%80%9A%E7%94%A8EXP%E7%BC%96%E5%86%99%E6%80%9D%E8%B7%AF%E5%9C%A8%20CVE-2022-34918%20%E4%B8%8A%E7%9A%84%E5%AE%9E%E8%B7%B5/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022_03_16-CVE_2022_0185%E5%88%86%E6%9E%90%E5%8F%8A%E5%88%A9%E7%94%A8%E4%B8%8Epipe%E6%96%B0%E5%8E%9F%E8%AF%AD%E6%80%9D%E8%80%83%E4%B8%8E%E5%AE%9E%E8%B7%B5/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&text=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&is_video=false&description=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2022-34918 netfilter 分析笔记&body=Check out this article: https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&name=CVE-2022-34918 netfilter 分析笔记&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&t=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-number">1.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88"><span class="toc-number">3.</span> <span class="toc-text">修复方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        CVE-2022-34918 netfilter 分析笔记
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">veritas501</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-08-01T16:00:00.000Z" class="dt-published" itemprop="datePublished">2022-08-02</time>
        
        (Updated: <time datetime="2023-12-08T03:09:28.454Z" class="dt-updated" itemprop="dateModified">2023-12-08</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/kernel/" rel="tag">kernel</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><ul>
<li>引入commit：<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/fdb9c405e35bdc6e305b9b4e20ebc141ed14fc81">fdb9c405e35bdc6e305b9b4e20ebc141ed14fc81</a></li>
<li>修复commit：<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/7e6bc1f6cabcd30aba0b11219d8e01b952eacbb6">7e6bc1f6cabcd30aba0b11219d8e01b952eacbb6</a></li>
<li>时间跨度：2020&#x2F;04&#x2F;28 ~ 2022&#x2F;07&#x2F;03</li>
<li>版本跨度：v5.8 ~ v5.19</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在netfilter模块的<code>nft_setelem_parse_data() </code>中存在一处类型混淆(type confusion)，从而在<code>nft_set_elem_init() </code>中产生了堆越界问题。</p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><p>更新内核或使用下面命令禁止普通用户改变user namspace。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl kernel.unprivileged_userns_clone=0</span><br></pre></td></tr></table></figure>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞的patch如链接：<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/7e6bc1f6cab.diff">https://github.com/torvalds/linux/commit/7e6bc1f6cab.diff</a></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c</span></span><br><span class="line"><span class="comment">index 51144fc66889b5..d6b59beab3a986 100644</span></span><br><span class="line"><span class="comment">--- a/net/netfilter/nf_tables_api.c</span></span><br><span class="line"><span class="comment">+++ b/net/netfilter/nf_tables_api.c</span></span><br><span class="line"><span class="meta">@@ -5213,13 +5213,20 @@</span> static int nft_setelem_parse_data(struct nft_ctx *ctx, struct nft_set *set,</span><br><span class="line"> 				  struct nft_data *data,</span><br><span class="line"> 				  struct nlattr *attr)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="addition">+	u32 dtype;</span></span><br><span class="line"> 	int err;</span><br><span class="line"> </span><br><span class="line"> 	err = nft_data_init(ctx, data, NFT_DATA_VALUE_MAXLEN, desc, attr);</span><br><span class="line"> 	if (err &lt; 0)</span><br><span class="line"> 		return err;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-	if (desc-&gt;type != NFT_DATA_VERDICT &amp;&amp; desc-&gt;len != set-&gt;dlen) &#123;</span></span><br><span class="line"><span class="addition">+	if (set-&gt;dtype == NFT_DATA_VERDICT)</span></span><br><span class="line"><span class="addition">+		dtype = NFT_DATA_VERDICT;</span></span><br><span class="line"><span class="addition">+	else</span></span><br><span class="line"><span class="addition">+		dtype = NFT_DATA_VALUE;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	if (dtype != desc-&gt;type ||</span></span><br><span class="line"><span class="addition">+	    set-&gt;dlen != desc-&gt;len) &#123;</span></span><br><span class="line"> 		nft_data_release(data, desc-&gt;type);</span><br><span class="line"> 		return -EINVAL;</span><br><span class="line"> 	&#125;</span><br></pre></td></tr></table></figure>

<p>变化不是很大。仔细看的话，原代码其实强制把<code>set-&gt;dtype</code>当做<code>NFT_DATA_VERDICT</code>，但实际上<code>set-&gt;dtype</code>有其他类型的可能性（类型混淆）。</p>
<blockquote>
<p>这个函数其实是在5.8加入的。在5.8之前，调用逻辑是这样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; net/netfilter/nf_tables_api.c:4488</span></span><br><span class="line"><span class="comment">/* 4488 */</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">nft_add_set_elem</span><span class="params">(<span class="keyword">struct</span> nft_ctx *ctx, <span class="keyword">struct</span> nft_set *<span class="built_in">set</span>,</span></span><br><span class="line"><span class="params"><span class="comment">/* 4489 */</span> 			    <span class="type">const</span> <span class="keyword">struct</span> nlattr *attr, u32 nlmsg_flags)</span></span><br><span class="line"><span class="comment">/* 4490 */</span> &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 4500 */</span> 	<span class="class"><span class="keyword">struct</span> <span class="title">nft_data</span> <span class="title">data</span>;</span></span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 4595 */</span> 	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_DATA] != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="comment">/* 4596 */</span> 		err = nft_data_init(ctx, &amp;data, <span class="keyword">sizeof</span>(data), &amp;d2,</span><br><span class="line"><span class="comment">/* 4597 */</span> 				    nla[NFTA_SET_ELEM_DATA]);</span><br><span class="line"><span class="comment">/* 4598 */</span> 		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="comment">/* 4599 */</span> 			<span class="keyword">goto</span> err2;</span><br><span class="line"><span class="comment">/* 4600 */</span> </span><br><span class="line"><span class="comment">/* 4601 */</span> 		err = -EINVAL;</span><br><span class="line"><span class="comment">/* 4602 */</span> 		<span class="keyword">if</span> (<span class="built_in">set</span>-&gt;dtype != NFT_DATA_VERDICT &amp;&amp; d2.len != <span class="built_in">set</span>-&gt;dlen)</span><br><span class="line"><span class="comment">/* 4603 */</span> 			<span class="keyword">goto</span> err3;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 4629 */</span> </span><br><span class="line"><span class="comment">/* 4630 */</span> 		nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_DATA, d2.len);</span><br><span class="line"><span class="comment">/* 4631 */</span> 	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在5.8之后添加了<code>nft_setelem_parse_data()</code>，逻辑变成如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; net/netfilter/nf_tables_api.c:5697</span></span><br><span class="line"><span class="comment">/* 5697 */</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">nft_add_set_elem</span><span class="params">(<span class="keyword">struct</span> nft_ctx *ctx, <span class="keyword">struct</span> nft_set *<span class="built_in">set</span>,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5698 */</span> 			    <span class="type">const</span> <span class="keyword">struct</span> nlattr *attr, u32 nlmsg_flags)</span></span><br><span class="line"><span class="comment">/* 5699 */</span> &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 5706 */</span> 	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_elem</span> <span class="title">elem</span>;</span></span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 5884 */</span> 	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_DATA] != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="comment">/* 5885 */</span> 		err = nft_setelem_parse_data(ctx, <span class="built_in">set</span>, &amp;desc, &amp;elem.data.val,</span><br><span class="line"><span class="comment">/* 5886 */</span> 					     nla[NFTA_SET_ELEM_DATA]);</span><br><span class="line"><span class="comment">/* 5887 */</span> 		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="comment">/* 5888 */</span> 			<span class="keyword">goto</span> err_parse_key_end;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 5914 */</span> </span><br><span class="line"><span class="comment">/* 5915 */</span> 		nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_DATA, desc.len);</span><br><span class="line"><span class="comment">/* 5916 */</span> 	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &gt;&gt;&gt; net/netfilter/nf_tables_api.c:5116</span></span><br><span class="line"><span class="comment">/* 5116 */</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">nft_setelem_parse_data</span><span class="params">(<span class="keyword">struct</span> nft_ctx *ctx, <span class="keyword">struct</span> nft_set *<span class="built_in">set</span>,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5117 */</span> 				  <span class="keyword">struct</span> nft_data_desc *desc,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5118 */</span> 				  <span class="keyword">struct</span> nft_data *data,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5119 */</span> 				  <span class="keyword">struct</span> nlattr *attr)</span></span><br><span class="line"><span class="comment">/* 5120 */</span> &#123;</span><br><span class="line"><span class="comment">/* 5121 */</span> 	<span class="type">int</span> err;</span><br><span class="line"><span class="comment">/* 5122 */</span> </span><br><span class="line"><span class="comment">/* 5123 */</span> 	err = nft_data_init(ctx, data, NFT_DATA_VALUE_MAXLEN, desc, attr);</span><br><span class="line"><span class="comment">/* 5124 */</span> 	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="comment">/* 5125 */</span> 		<span class="keyword">return</span> err;</span><br><span class="line"><span class="comment">/* 5126 */</span> </span><br><span class="line"><span class="comment">/* 5127 */</span> 	<span class="keyword">if</span> (desc-&gt;type != NFT_DATA_VERDICT &amp;&amp; desc-&gt;len != <span class="built_in">set</span>-&gt;dlen) &#123;</span><br><span class="line"><span class="comment">/* 5128 */</span> 		nft_data_release(data, desc-&gt;type);</span><br><span class="line"><span class="comment">/* 5129 */</span> 		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="comment">/* 5130 */</span> 	&#125;</span><br><span class="line"><span class="comment">/* 5131 */</span> </span><br><span class="line"><span class="comment">/* 5132 */</span> 	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* 5133 */</span> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>仔细看</strong>！5.8之前调用<code>nft_data_init()</code>时第3个参数是值为sizeof(data)，即16bytes。但到了5.8之后第3个参数莫名变成了<code>NFT_DATA_VALUE_MAXLEN</code>，即64bytes。其实patch修复的那一行在5.8之前已经存在，但5.8前却不受影响，因为<code>nft_data_init()</code>的第三个参数保证了datalen不会大于16bytes，从而不会导致溢出。</p>
</blockquote>
<p>先看<code>nft_setelem_parse_data()</code>函数的参数部分，<code>attr</code>是用户可控的数据，将attr传入<code>nft_data_init()</code>中对<code>data</code>和<code>desc</code>进行初始化。因此<code>data</code>和<code>desc</code>也是用户可控的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; net/netfilter/nf_tables_api.c:5116</span></span><br><span class="line"><span class="comment">/* 5116 */</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">nft_setelem_parse_data</span><span class="params">(<span class="keyword">struct</span> nft_ctx *ctx, <span class="keyword">struct</span> nft_set *<span class="built_in">set</span>,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5117 */</span> 				  <span class="keyword">struct</span> nft_data_desc *desc,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5118 */</span> 				  <span class="keyword">struct</span> nft_data *data,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5119 */</span> 				  <span class="keyword">struct</span> nlattr *attr)</span></span><br><span class="line"><span class="comment">/* 5120 */</span> &#123;</span><br><span class="line"><span class="comment">/* 5121 */</span> 	<span class="type">int</span> err;</span><br><span class="line"><span class="comment">/* 5122 */</span> </span><br><span class="line"><span class="comment">/* 5123 */</span> 	err = nft_data_init(ctx, data, NFT_DATA_VALUE_MAXLEN, desc, attr);</span><br></pre></td></tr></table></figure>



<p>下面是初始化的过程。</p>
<p>先进入<code>nla_parse_nested_deprecated()</code>将<code>nla</code>（即上层的attr）中的数据解析到tb中。然后根据tb中的值在设置<code>data</code>和<code>desc</code>（Line 9543 和 Line 9546）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; net/netfilter/nf_tables_api.c:9530</span></span><br><span class="line"><span class="comment">/* 9530 */</span> <span class="type">int</span> <span class="title function_">nft_data_init</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> nft_ctx *ctx,</span></span><br><span class="line"><span class="params"><span class="comment">/* 9531 */</span> 		  <span class="keyword">struct</span> nft_data *data, <span class="type">unsigned</span> <span class="type">int</span> size,</span></span><br><span class="line"><span class="params"><span class="comment">/* 9532 */</span> 		  <span class="keyword">struct</span> nft_data_desc *desc, <span class="type">const</span> <span class="keyword">struct</span> nlattr *nla)</span></span><br><span class="line"><span class="comment">/* 9533 */</span> &#123;</span><br><span class="line"><span class="comment">/* 9534 */</span> 	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tb</span>[<span class="title">NFTA_DATA_MAX</span> + 1];</span></span><br><span class="line">------</span><br><span class="line">    		<span class="comment">// 通过 nla 初始化 tb</span></span><br><span class="line"><span class="comment">/* 9537 */</span> 	err = nla_parse_nested_deprecated(tb, NFTA_DATA_MAX, nla,</span><br><span class="line"><span class="comment">/* 9538 */</span> 					  nft_data_policy, <span class="literal">NULL</span>);</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 9540 */</span> 		<span class="keyword">return</span> err;</span><br><span class="line">------</span><br><span class="line">    		<span class="comment">// 初始化 data 和 desc</span></span><br><span class="line"><span class="comment">/* 9542 */</span> 	<span class="keyword">if</span> (tb[NFTA_DATA_VALUE])</span><br><span class="line"><span class="comment">/* 9543 */</span> 		<span class="keyword">return</span> nft_value_init(ctx, data, size, desc,</span><br><span class="line"><span class="comment">/* 9544 */</span> 				      tb[NFTA_DATA_VALUE]);</span><br><span class="line"><span class="comment">/* 9545 */</span> 	<span class="keyword">if</span> (tb[NFTA_DATA_VERDICT] &amp;&amp; ctx != <span class="literal">NULL</span>)</span><br><span class="line"><span class="comment">/* 9546 */</span> 		<span class="keyword">return</span> nft_verdict_init(ctx, data, desc, tb[NFTA_DATA_VERDICT]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; net/netfilter/nf_tables_api.c:9486</span></span><br><span class="line"><span class="comment">/* 9486 */</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">nft_value_init</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> nft_ctx *ctx,</span></span><br><span class="line"><span class="params"><span class="comment">/* 9487 */</span> 			  <span class="keyword">struct</span> nft_data *data, <span class="type">unsigned</span> <span class="type">int</span> size,</span></span><br><span class="line"><span class="params"><span class="comment">/* 9488 */</span> 			  <span class="keyword">struct</span> nft_data_desc *desc, <span class="type">const</span> <span class="keyword">struct</span> nlattr *nla)</span></span><br><span class="line"><span class="comment">/* 9489 */</span> &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 9495 */</span> 	<span class="keyword">if</span> (len &gt; size)</span><br><span class="line"><span class="comment">/* 9496 */</span> 		<span class="keyword">return</span> -EOVERFLOW;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 9498 */</span> 	nla_memcpy(data-&gt;data, nla, len);</span><br><span class="line"><span class="comment">/* 9499 */</span> 	desc-&gt;type = NFT_DATA_VALUE;</span><br><span class="line"><span class="comment">/* 9500 */</span> 	desc-&gt;len  = len;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>初始化完<code>data</code>和<code>desc</code>后就是下面这段判断了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; net/netfilter/nf_tables_api.c:5116</span></span><br><span class="line"><span class="comment">/* 5116 */</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">nft_setelem_parse_data</span><span class="params">(<span class="keyword">struct</span> nft_ctx *ctx, <span class="keyword">struct</span> nft_set *<span class="built_in">set</span>,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5117 */</span> 				  <span class="keyword">struct</span> nft_data_desc *desc,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5118 */</span> 				  <span class="keyword">struct</span> nft_data *data,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5119 */</span> 				  <span class="keyword">struct</span> nlattr *attr)</span></span><br><span class="line"><span class="comment">/* 5120 */</span> &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 5123 */</span> 	err = nft_data_init(ctx, data, NFT_DATA_VALUE_MAXLEN, desc, attr);</span><br><span class="line">------</span><br><span class="line">    		<span class="comment">// 判断是否畸形，但可以绕过</span></span><br><span class="line"><span class="comment">/* 5127 */</span> 	<span class="keyword">if</span> (desc-&gt;type != NFT_DATA_VERDICT &amp;&amp; desc-&gt;len != <span class="built_in">set</span>-&gt;dlen) &#123;</span><br><span class="line"><span class="comment">/* 5128 */</span> 		nft_data_release(data, desc-&gt;type);</span><br><span class="line"><span class="comment">/* 5129 */</span> 		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="comment">/* 5130 */</span> 	&#125;</span><br></pre></td></tr></table></figure>

<p>由于上面说了，<code>desc</code>和<code>data</code>是通过解析用户提供的<code>attr</code>得到的，而<code>set-&gt;dlen</code>又是用户在创建netfilter的set时可以控制的（但上层存在一个限制，即<code>set-&gt;dlen &lt; 64</code>）。</p>
<p><strong>重点来了</strong>，假设此时<code>set-&gt;dtype == NFT_DATA_VALUE</code>且<code>desc-&gt;type == NFT_DATA_VERDICT</code>，则<code>desc-&gt;len == 16</code>，<code>set-&gt;dlen</code>和<code>desc-&gt;len</code>可以不同，但由于这两个判断中间是“与”逻辑，因此并不会走到错误分支。</p>
<p><code>nft_setelem_parse_data()</code>外层由<code>nft_add_set_elem()</code>调用，在其下还调用<code>nft_set_elem_init()</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; net/netfilter/nf_tables_api.c:5697</span></span><br><span class="line"><span class="comment">/* 5697 */</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">nft_add_set_elem</span><span class="params">(<span class="keyword">struct</span> nft_ctx *ctx, <span class="keyword">struct</span> nft_set *<span class="built_in">set</span>,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5698 */</span> 			    <span class="type">const</span> <span class="keyword">struct</span> nlattr *attr, u32 nlmsg_flags)</span></span><br><span class="line"><span class="comment">/* 5699 */</span> &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 5704 */</span> 	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext_tmpl</span> <span class="title">tmpl</span>;</span></span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 5710 */</span> 	<span class="class"><span class="keyword">struct</span> <span class="title">nft_data_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 5884 */</span> 	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_DATA] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    			<span class="comment">// 调用`nft_setelem_parse_data`，存在类型混淆问题</span></span><br><span class="line"><span class="comment">/* 5885 */</span> 		err = nft_setelem_parse_data(ctx, <span class="built_in">set</span>, &amp;desc, &amp;elem.data.val,</span><br><span class="line"><span class="comment">/* 5886 */</span> 					     nla[NFTA_SET_ELEM_DATA]);</span><br><span class="line"><span class="comment">/* 5887 */</span> 		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">    				<span class="comment">// err就挂了，直接走到return</span></span><br><span class="line"><span class="comment">/* 5888 */</span> 			<span class="keyword">goto</span> err_parse_key_end;</span><br><span class="line">------</span><br><span class="line">    			<span class="comment">// 根据 desc.len 修改 tmpl</span></span><br><span class="line"><span class="comment">/* 5915 */</span> 		nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_DATA, desc.len);</span><br><span class="line"><span class="comment">/* 5916 */</span> 	&#125;</span><br><span class="line">------</span><br><span class="line">    		<span class="comment">// 调用`nft_set_elem_init`，存在由类型混淆导致堆越界写</span></span><br><span class="line"><span class="comment">/* 5931 */</span> 	elem.priv = nft_set_elem_init(<span class="built_in">set</span>, &amp;tmpl, elem.key.val.data,</span><br><span class="line"><span class="comment">/* 5932 */</span> 				      elem.key_end.val.data, elem.data.val.data,</span><br><span class="line"><span class="comment">/* 5933 */</span> 				      timeout, expiration, GFP_KERNEL);</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 6010 */</span> err_parse_key_end:</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 6018 */</span> 	<span class="keyword">return</span> err;</span><br><span class="line"><span class="comment">/* 6019 */</span> &#125;</span><br></pre></td></tr></table></figure>



<p>在<code>nft_set_elem_init()</code>中存在一处memcpy，来源为data，长度为<code>set-&gt;dlen</code>，但ext长度和分配和参数中的<code>tmpl</code>有关，<code>tmpl</code>在上层函数中根据<code>desc</code>进行修改。又因为在<code>nft_setelem_parse_data()</code>中我们提到，<code>set-&gt;dlen</code>和<code>desc-&gt;len</code>可以不同，前者最大可到64，而后者只为16定值，因此此处memcpy会造成堆越界写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; net/netfilter/nf_tables_api.c:5364</span></span><br><span class="line"><span class="comment">/* 5364 */</span> <span class="type">void</span> *<span class="title function_">nft_set_elem_init</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> nft_set *<span class="built_in">set</span>,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5365 */</span> 			<span class="type">const</span> <span class="keyword">struct</span> nft_set_ext_tmpl *tmpl,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5366 */</span> 			<span class="type">const</span> u32 *key, <span class="type">const</span> u32 *key_end,</span></span><br><span class="line"><span class="params"><span class="comment">/* 5367 */</span> 			<span class="type">const</span> u32 *data, u64 timeout, u64 expiration, <span class="type">gfp_t</span> gfp)</span></span><br><span class="line"><span class="comment">/* 5368 */</span> &#123;</span><br><span class="line"><span class="comment">/* 5369 */</span> 	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext</span> *<span class="title">ext</span>;</span></span><br><span class="line"><span class="comment">/* 5370 */</span> 	<span class="type">void</span> *elem;</span><br><span class="line"><span class="comment">/* 5371 */</span> </span><br><span class="line">    		<span class="comment">// 根据 tmpl-&gt;len 分配空间</span></span><br><span class="line"><span class="comment">/* 5372 */</span> 	elem = kzalloc(<span class="built_in">set</span>-&gt;ops-&gt;elemsize + tmpl-&gt;len, gfp);</span><br><span class="line">------</span><br><span class="line">    		<span class="comment">// 初始化 ext</span></span><br><span class="line"><span class="comment">/* 5376 */</span> 	ext = nft_set_elem_ext(<span class="built_in">set</span>, elem);</span><br><span class="line"><span class="comment">/* 5377 */</span> 	nft_set_ext_init(ext, tmpl);</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 5383 */</span> 	<span class="keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_DATA))</span><br><span class="line">    			<span class="comment">// 触发堆越界写</span></span><br><span class="line"><span class="comment">/* 5384 */</span> 		<span class="built_in">memcpy</span>(nft_set_ext_data(ext), data, <span class="built_in">set</span>-&gt;dlen);</span><br></pre></td></tr></table></figure>

<p>根据数据的不同，分配的elem结构体可以位于kmalloc-64、kmalloc-128、kmalloc-192中。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>先观察一下这个发生堆越界写的对象：elem。</p>
<p>如下设置结构体可以在kmalloc-64中发生堆溢出：</p>
<p><img src="/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802165516046.png"></p>
<p>如下设置结构体可以在kmalloc-128中发生堆溢出：</p>
<p><img src="/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802165924035.png"></p>
<p>如下设置结构体可以在kmalloc-192中发生堆溢出：</p>
<p><img src="/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802170139279.png"></p>
<p>这里可以选择kmalloc-64的排布，当然其他的也可以利用成功。</p>
<p>之后我们堆喷结构体<code>user_key_payload</code>，做linux内核利用的朋友应该很熟悉这个结构体了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU destructor */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span>  datalen;    <span class="comment">/* length of this data */</span></span><br><span class="line">    <span class="type">char</span>        data[] __aligned(__alignof__(u64)); <span class="comment">/* actual data */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; pt/o <span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span></span></span><br><span class="line"><span class="class">/* <span class="title">offset</span>      |    <span class="title">size</span> */  <span class="title">type</span> =</span> <span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> &#123;</span></span><br><span class="line"><span class="comment">/*      0      |      16 */</span>    <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> &#123;</span></span><br><span class="line"><span class="comment">/*      0      |       8 */</span>        <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="comment">/*      8      |       8 */</span>        <span class="type">void</span> (*func)(<span class="keyword">struct</span> callback_head *);</span><br><span class="line"></span><br><span class="line">                                   <span class="comment">/* total size (bytes):   16 */</span></span><br><span class="line">                               &#125; rcu;</span><br><span class="line"><span class="comment">/*     16      |       2 */</span>    <span class="type">unsigned</span> <span class="type">short</span> datalen;</span><br><span class="line"><span class="comment">/* XXX  6-byte hole      */</span></span><br><span class="line"><span class="comment">/*     24      |       0 */</span>    <span class="type">char</span> data[];</span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes):   24 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>

<p>结构体中的<code>datalen</code>字段描述了后面data的长度。通过堆越界写修改它就能通过<code>keyctl</code>syscall 来越界读取data中的数据。</p>
<p>我们先堆喷一些<code>user_key_payload</code>来简单的做一下堆风水。然后再喷一些<code>user_key_payload</code>，并隔空释放几个。之后触发<code>nft_add_set_elem()</code>中的kzalloc时大概率会得到如下的堆布局：</p>
<p><img src="/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802170923279.png"></p>
<p>之后越界写就可以修改<code>user_key_payload</code>中的 datalen字段。我们可以使用keyctl遍历读取所有的key，并检查读取的长度。如果长度变成我们修改的长度，则说明修改成功，否则需要重复这一步。</p>
<p>成功后我们把其他所有的<code>user_key_payload</code>通过keyctl的<code>KEYCTL_REVOKE</code>删掉。需要注意的是，这里的删掉并不是直接调用kfree将堆块释放，而是通过向<code>user_key_payload</code>中的rcu写入func值，并让这个key对用户不可见，之后在垃圾回收中将其释放。man中是这样描述的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KEYCTL_REVOKE (since Linux 2.6.10)</span><br><span class="line">       Revoke the key with the ID provided in arg2 (cast to key_serial_t).  The key is scheduled for  garbage  collection;  it will no longer be findable, and will be unavailable for further operations.  Further attempts to use the key will  fail with the error EKEYREVOKED.</span><br></pre></td></tr></table></figure>



<p>此时我们通过corrupted的<code>user_key_payload</code>做越界读，就能读到rcu.func中的<code>user_free_payload_rcu</code>这个函数指针，从而泄露出内核代码段地址。</p>
<blockquote>
<p>稍微提一嘴，原作者博客中使用了另一个结构体作为泄露来源，即通过<code>io_uring</code>来分配<code>percpu_ref_data </code>结构体。但我看了眼这个结构体是在Linux 5.10中加入的，这意味着受影响的5.8~5.9并不能使用这个方法来leak。</p>
</blockquote>
<p>有了leak就是想办法通过越界写来提权了。这边我打算试试360在今年blackhat上提到的新利用思路<a target="_blank" rel="noopener" href="https://vul.360.net/archives/391">USMA</a>。</p>
<p>在raw_packet中存在这样一条路径：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; linux-5.13/net/packet/af_packet.c:3695</span></span><br><span class="line"><span class="comment">/* 3695 */</span> <span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="comment">/* 3696 */</span> packet_setsockopt(<span class="keyword">struct</span> socket *sock, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">sockptr_t</span> optval,</span><br><span class="line"><span class="comment">/* 3697 */</span> 		  <span class="type">unsigned</span> <span class="type">int</span> optlen)</span><br><span class="line"><span class="comment">/* 3698 */</span> &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 3706 */</span> 	<span class="keyword">switch</span> (optname) &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 3711 */</span> 		<span class="type">int</span> len = optlen;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 3728 */</span> 	<span class="keyword">case</span> PACKET_RX_RING:</span><br><span class="line"><span class="comment">/* 3729 */</span> 	<span class="keyword">case</span> PACKET_TX_RING:</span><br><span class="line"><span class="comment">/* 3730 */</span> 	&#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 3735 */</span> 		<span class="keyword">switch</span> (po-&gt;tp_version) &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 3740 */</span> 		<span class="keyword">case</span> TPACKET_V3:</span><br><span class="line">------</span><br><span class="line">    					<span class="comment">// 调用</span></span><br><span class="line"><span class="comment">/* 3751 */</span> 				ret = packet_set_ring(sk, &amp;req_u, <span class="number">0</span>,</span><br><span class="line"><span class="comment">/* 3752 */</span> 						    optname == PACKET_TX_RING);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="comment">// &gt;&gt;&gt; linux-5.13/net/packet/af_packet.c:4306</span></span><br><span class="line"><span class="comment">/* 4306 */</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">packet_set_ring</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span></span><br><span class="line"><span class="params"><span class="comment">/* 4307 */</span> 		<span class="type">int</span> closing, <span class="type">int</span> tx_ring)</span></span><br><span class="line"><span class="comment">/* 4308 */</span> &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 4331 */</span> 	<span class="keyword">if</span> (req-&gt;tp_block_nr) &#123;</span><br><span class="line">------</span><br><span class="line"><span class="comment">/* 4376 */</span> 		order = get_order(req-&gt;tp_block_size);</span><br><span class="line">    			<span class="comment">// 调用</span></span><br><span class="line"><span class="comment">/* 4377 */</span> 		pg_vec = alloc_pg_vec(req, order);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">// &gt;&gt;&gt; linux-5.13/net/packet/af_packet.c:4281</span></span><br><span class="line"><span class="comment">/* 4281 */</span> <span class="type">static</span> <span class="keyword">struct</span> pgv *<span class="title function_">alloc_pg_vec</span><span class="params">(<span class="keyword">struct</span> tpacket_req *req, <span class="type">int</span> order)</span></span><br><span class="line"><span class="comment">/* 4282 */</span> &#123;</span><br><span class="line"><span class="comment">/* 4283 */</span> 	<span class="type">unsigned</span> <span class="type">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line">------</span><br><span class="line">    		<span class="comment">// 在slab中申请一段内存在存放pg_vec</span></span><br><span class="line"><span class="comment">/* 4287 */</span> 	pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">------</span><br><span class="line">    		<span class="comment">// 申请 n 个 page</span></span><br><span class="line"><span class="comment">/* 4291 */</span> 	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line"><span class="comment">/* 4292 */</span> 		pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br></pre></td></tr></table></figure>

<p>平时我们只是拿它来做方便的page level 风水，即4292行的功能。而USMA使用的是4287行分配的数组。</p>
<p>首先我们设置<code>block_nr</code>为5~8，这样<code>pg_vec</code>就能分配到kmalloc-64中。之后我们触发<code>nft_add_set_elem()</code>中的堆溢出就能覆盖到pg_vec中的虚拟地址。</p>
<p>之后通过<code>packet_mmap</code>就能将这些page映射到用户态进行读写。</p>
<p>其中在mmap时还存在如下的校验：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; mm/memory.c:1752</span></span><br><span class="line"><span class="comment">/* 1752 */</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">validate_page_before_insert</span><span class="params">(<span class="keyword">struct</span> page *page)</span></span><br><span class="line"><span class="comment">/* 1753 */</span> &#123;</span><br><span class="line"><span class="comment">/* 1754 */</span> 	<span class="keyword">if</span> (PageAnon(page) || PageSlab(page) || page_has_type(page))</span><br><span class="line"><span class="comment">/* 1755 */</span> 		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="comment">/* 1756 */</span> 	flush_dcache_page(page);</span><br><span class="line"><span class="comment">/* 1757 */</span> 	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* 1758 */</span> &#125;</span><br></pre></td></tr></table></figure>

<p>即检查page是否为匿名页，是否为Slab子系统分配的页，以及page是否含有type，而内存页的type总共有以下四种。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PG_buddy	0x00000080</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_offline	0x00000100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_table	0x00000200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_guard	0x00000400</span></span><br></pre></td></tr></table></figure>

<p>PG_buddy为伙伴系统中的页，PG_offline为内存交换出去的页，PG_table为用作页表的页，PG_guard为用作内存屏障的页。可以看到如果传入的page为内核代码段的页，以上的检查全都可以绕过。</p>
<p>例如我们可以将pg_vec中的页修改为<code>__sys_setresuid()</code>所在的页，从而直接patch它的代码让任意用户都可以直接提权到root。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; kernel/sys.c:652</span></span><br><span class="line"><span class="comment">/* 652 */</span> <span class="type">long</span> __sys_setresuid(<span class="type">uid_t</span> ruid, <span class="type">uid_t</span> euid, <span class="type">uid_t</span> suid)</span><br><span class="line"><span class="comment">/* 653 */</span> &#123;</span><br><span class="line">------</span><br><span class="line">    		<span class="comment">// patch 这个判断</span></span><br><span class="line"><span class="comment">/* 680 */</span> 	<span class="keyword">if</span> (!ns_capable_setid(old-&gt;user_ns, CAP_SETUID)) &#123;</span><br><span class="line"><span class="comment">/* 681 */</span> 		<span class="keyword">if</span> (ruid != (<span class="type">uid_t</span>) <span class="number">-1</span>        &amp;&amp; !uid_eq(kruid, old-&gt;uid) &amp;&amp;</span><br><span class="line"><span class="comment">/* 682 */</span> 		    !uid_eq(kruid, old-&gt;euid) &amp;&amp; !uid_eq(kruid, old-&gt;suid))</span><br><span class="line"><span class="comment">/* 683 */</span> 			<span class="keyword">goto</span> error;</span><br><span class="line"><span class="comment">/* 684 */</span> 		<span class="keyword">if</span> (euid != (<span class="type">uid_t</span>) <span class="number">-1</span>        &amp;&amp; !uid_eq(keuid, old-&gt;uid) &amp;&amp;</span><br><span class="line"><span class="comment">/* 685 */</span> 		    !uid_eq(keuid, old-&gt;euid) &amp;&amp; !uid_eq(keuid, old-&gt;suid))</span><br><span class="line"><span class="comment">/* 686 */</span> 			<span class="keyword">goto</span> error;</span><br><span class="line"><span class="comment">/* 687 */</span> 		<span class="keyword">if</span> (suid != (<span class="type">uid_t</span>) <span class="number">-1</span>        &amp;&amp; !uid_eq(ksuid, old-&gt;uid) &amp;&amp;</span><br><span class="line"><span class="comment">/* 688 */</span> 		    !uid_eq(ksuid, old-&gt;euid) &amp;&amp; !uid_eq(ksuid, old-&gt;suid))</span><br><span class="line"><span class="comment">/* 689 */</span> 			<span class="keyword">goto</span> error;</span><br><span class="line"><span class="comment">/* 690 */</span> 	&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>稍微提一嘴，原作者博客中使用<a target="_blank" rel="noopener" href="https://starlabs.sg/blog/2022/06-io_uring-new-code-new-bugs-and-a-new-exploit-technique/">这篇文章</a>中所描述的手法来实现任意地址写。简单来说是借助了<code>simple_xattr</code>结构体中对<code>list_head</code>的unlink操作，从而修改modprobe_path。</p>
</blockquote>
<p><img src="/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220802174129707.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/veritas501/CVE-2022-34918">https://github.com/veritas501/CVE-2022-34918</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/randorisec/CVE-2022-34918-LPE-PoC">https://github.com/randorisec/CVE-2022-34918-LPE-PoC</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://randorisec.fr/crack-linux-firewall/">https://randorisec.fr/crack-linux-firewall/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://starlabs.sg/blog/2022/06-io_uring-new-code-new-bugs-and-a-new-exploit-technique/">https://starlabs.sg/blog/2022/06-io_uring-new-code-new-bugs-and-a-new-exploit-technique/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://vul.360.net/archives/391">https://vul.360.net/archives/391</a></p>
</li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/veritas501">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-number">1.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88"><span class="toc-number">3.</span> <span class="toc-text">修复方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&text=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&is_video=false&description=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2022-34918 netfilter 分析笔记&body=Check out this article: https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&title=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&name=CVE-2022-34918 netfilter 分析笔记&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://veritas501.github.io/2022_08_02-CVE-2022-34918%20netfilter%20%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/&t=CVE-2022-34918 netfilter 分析笔记"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    veritas501
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/veritas501">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
